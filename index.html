<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
    <title>Sistema de Consultas Campo</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js "></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js "></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2 "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Variables de color para toda la aplicaci√≥n */
        :root {
            --color-azul: #3b54d3;
            --color-verde: #3ac99c;
            --color-fondo: #f0f5f9;
            --color-error: #d32f2f;
            --color-success: #2e7d32;
            --color-naranja: #ff6b35;
            --color-purpura: #8b5cf6;
        }

        /* Estilos globales y de fondo */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            height: 100%;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--color-fondo) 0%, #e3f2fd 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(59, 84, 211, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(58, 201, 156, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        /* Contenedores y Tarjetas */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 40px;
            margin-bottom: 20px;
            width: 100%;
            position: relative;
            overflow: hidden;
            text-align: center;
            animation: slideIn 0.6s ease-out;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--color-azul), var(--color-verde));
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estilos del logo y t√≠tulos */
        .logo {
            height: 70px;
            width: auto;
            max-width: 100%;
            margin-bottom: 20px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .titulo-degradado {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(90deg, var(--color-azul), var(--color-verde));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            user-select: none;
            margin-bottom: 10px;
            margin-top: 0;
        }

        .subtitulo {
            color: #666;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 30px;
        }

        /* Formulario y botones */
        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input:focus, select:focus {
            border-color: var(--color-azul);
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 84, 211, 0.1);
        }

        input::placeholder {
            color: #999;
            font-weight: 500;
        }

        .btn {
            background: linear-gradient(135deg, var(--color-azul), var(--color-verde));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 84, 211, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4299e1, #2b6cb0);
            width: auto;
            min-width: 120px;
            padding: 12px 24px;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            width: auto;
            padding: 8px 16px;
            margin-left: 10px;
        }

        .btn-back {
            background: linear-gradient(135deg, var(--color-naranja), #e55a2b);
            width: auto;
            padding: 10px 20px;
            margin-bottom: 20px;
        }

        /* Selector de tablas */
        .table-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .table-option {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .table-option:hover {
            border-color: var(--color-azul);
            background: linear-gradient(135deg, #ebf8ff, #bee3f8);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 84, 211, 0.15);
        }

        .table-option.selected {
            border-color: var(--color-verde);
            background: linear-gradient(135deg, #f0fff4, #c6f6d5);
        }

        .table-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .table-description {
            color: #666;
            font-size: 0.9rem;
        }

        /* Secciones de la app */
        .table-selection-section, .search-section, .admin-section {
            display: none;
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }
        
        .result-header {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
        }

        .result-item {
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .result-label {
            font-weight: 600;
            color: #4a5568;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .footer {
            margin-top: 30px;
            font-weight: 600;
            color: #666;
            font-size: 14px;
            text-align: center;
        }
        
        /* Loading spinner y mensajes */
        .loading {
            display: none;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Modal para gr√°ficas */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            max-height: 90%;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .chart-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            height: 600px;
        }
        
       @media (max-width: 768px) {
    /* Reducir padding del body y container */
    body {
        padding: 10px;
    }
    
    .container {
        max-width: 100%;
        padding: 5px;
    }
    
    /* Hacer las tarjetas m√°s anchas y con menos padding */
    .card {
        padding: 20px 15px;
        margin-bottom: 15px;
        border-radius: 15px;
    }
    
    /* Ajustar cuadros de resultados */
    .result-card {
        padding: 15px;
        margin-top: 15px;
        border-radius: 10px;
    }
    
    /* Mejorar el espacio de los elementos de resultado */
    .result-item {
        margin-bottom: 15px;
        padding: 8px 0;
        border-bottom: 2px solid #e2e8f0;
        line-height: 1.6;
    }
    
    .result-item strong {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        color: #2d3748;
    }
    
    /* Ajustes para otros elementos */
    .search-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    .table-selector {
        grid-template-columns: 1fr;
    }
    .action-buttons {
        flex-direction: column;
        gap: 8px;
    }
    .btn-secondary, .btn-danger {
        width: 100%;
        margin: 0;
        font-size: 14px !important;
        padding: 10px 15px !important;
    }
    .modal-content {
        width: 95%;
        margin: 5% auto;
        padding: 15px;
    }
    .chart-container {
        height: 500px;
    }
    .user-info {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 15px;
        justify-content: center;
    }
    
    /* Hacer los t√≠tulos m√°s peque√±os en m√≥vil */
    .titulo-degradado {
        font-size: 2rem;
    }
    
    /* Mejorar legibilidad de enlaces */
    .result-item a {
        display: inline-block;
        margin: 5px 0;
        padding: 8px 12px;
        background: #f0f9ff;
        border-radius: 8px;
        border: 1px solid #3b54d3;
    }
    
    .btn-secondary {
        font-size: 14px !important;
        padding: 10px 15px !important;
    }
}


    </style>
</head>
<body>
    <div class="container">
        <div class="user-info hidden" id="userInfo">
            <span id="currentUser"></span>
            <button class="btn btn-danger" onclick="logout()">Salir</button>
        </div>

        <!-- Secci√≥n de Login -->
        <div class="card" id="loginSection">
            <img src="https://cdnimg.bnamericas.com/HFvkiBpeoLTFyPBTjytdbdohtBDrWQsnxgYaUwIlxAEFZVYKsYrwygPFBPYYlShO.png " alt="Logo CLESA" class="logo">
            <h1 class="titulo-degradado">CLESA</h1>
            <p class="subtitulo">Ingrese sus credenciales de acceso</p>

            <div class="login-form">
                <div class="form-group">
                    <label for="username">Usuario:</label>
                    <input type="text" id="username" placeholder="Ingrese su usuario" value="admin">
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                      
                    </small>
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a:</label>
                    <input type="password" id="password" placeholder="Ingrese su contrase√±a">
                </div>
                <button class="btn" id="loginButton">Iniciar Sesi√≥n</button>
            </div>
            <p class="footer">By. Jose Meneses</p>
        </div>

        <!-- Secci√≥n de Selecci√≥n de Tablas -->
        <div class="table-selection-section" id="tableSelectionSection">
            <div class="card">
                <h2>Seleccione el M√≥dulo de Consulta</h2>
                <p class="subtitulo">Elija el tipo de informaci√≥n que desea consultar</p>
                
                <div class="table-selector">
                    <div class="table-option" onclick="seleccionarTabla('consultas_servicios')">
                        <span class="table-icon">üè†</span>
                        <div class="table-title">Consultas de Servicios</div>
                        <div class="table-description">Informaci√≥n general de servicios y clientes</div>
                    </div>
                                        
                    <div class="table-option" onclick="seleccionarTabla('OS Pendientes')">
                        <span class="table-icon">‚è≥</span>
                        <div class="table-title">OS Pendientes</div>
                        <div class="table-description">√ìrdenes de servicio pendientes</div>
                    </div>
                    
                    <div class="table-option" onclick="seleccionarTabla('OSCerradas')">
                        <span class="table-icon">‚úÖ</span>
                        <div class="table-title">OS Cerradas</div>
                        <div class="table-description">√ìrdenes de servicio finalizadas</div>
                    </div>
                    
                    <div class="table-option" onclick="seleccionarTabla('TX y Cortes')">
                        <span class="table-icon">‚ö°</span>
                        <div class="table-title">TX y Cortes</div>
                        <div class="table-description">Transformadores y cortes de energ√≠a</div>
                    </div>

		    <div class="table-option" onclick="seleccionarTabla('usuarios')">
                        <span class="table-icon">üë•</span>
    			<div class="table-title">Gesti√≥n de Usuarios</div>
    			<div class="table-description">Administrar usuarios del sistema</div>
		    </div>

		    <div class="table-option" onclick="seleccionarTabla('kml_ruta')">
    			<span class="table-icon">üìç</span>
    			<div class="table-title">KML Ruta</div>
   			 <div class="table-description">Generar rutas por unidad</div>
		    </div>
		    
		    <div class="table-option" onclick="seleccionarTabla('detalle_os')">
    			<span class="table-icon">üìä</span>
    			<div class="table-title">Detalle OS</div>
    			<div class="table-description">An√°lisis por unidad y estado</div>
		    </div>

		    <div class="table-option" onclick="seleccionarTabla('retiro_medidores')">
    			<span class="table-icon">üì¶</span>
    			<div class="table-title">IPR - Retiro de Medidores</div>
   			 <div class="table-description">Registro de retiro de medidores</div>
		    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de B√∫squeda -->
        <div class="search-section" id="searchSection">
            <div class="card">
                <button class="btn btn-back" onclick="volverATablas()">‚Üê Volver a M√≥dulos</button>
                <div class="header">
                    <h2 id="searchTitle">Consultar Informaci√≥n</h2>
                </div>
                <div class="search-grid" id="searchGrid">
                    <!-- Se genera din√°micamente seg√∫n la tabla seleccionada -->
                </div>
                <div id="searchResults"></div>
            </div>
        </div>

        <!-- Panel de Administraci√≥n -->
        <div class="admin-section" id="adminSection">
            <div class="card">
                <button class="btn btn-back" onclick="volverATablas()">‚Üê Volver a M√≥dulos</button>
                <div class="header">
                    <h2>Panel de Administraci√≥n</h2>
                </div>
                <div class="file-upload">
                    <h3>üìÅ Cargar Archivos Excel</h3>
                    <p>Arrastra tus archivos aqu√≠ o haz click para seleccionar</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" multiple style="margin-top: 15px;">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="procesarArchivos()">üìä Procesar Archivos</button>
                    <button class="btn btn-danger" onclick="limpiarDatos()">üóëÔ∏è Limpiar Datos</button>


                </div>
            </div>
        </div>
    </div>

    <!-- Modal para gr√°ficas -->
    <div id="chartsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarGraficas()">√ó</span>
            <h2 id="modalTitle">Gr√°ficas de Consumo y Lecturas</h2>
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-title">üìä Historial de Consumos (kWh)</div>
                    <div class="chart-container">
                        <canvas id="consumosChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">üìà Historial de Lecturas</div>
                    <div class="chart-container">
                        <canvas id="lecturasChart"></canvas>


                    </div>
                </div>
            </div>
        </div>
    </div>



<script>
    // --- 1. DEFINICI√ìN DE VARIABLES GLOBALES (Usar solo 'let', una vez) ---
    let currentUser = null;
let selectedTable = null;
let tipologiasCache = null;
let consultasData = [];

// === ROLES CON ACCESO A NOMBRE DE CLIENTE ===
const ROLES_CON_ACCESO_TOTAL_NOMBRE = ['Administrador', 'Supervisor', 'Despacho'];



// ========================================
// üÜï CACHE GLOBAL DE TIPOLOG√çAS
// ========================================


/**
 * Funci√≥n para cargar tipolog√≠as desde la BD con sistema de cache.
 * Solo hace la consulta una vez, luego usa el cache.
 */
async function cargarTipologias() {
    if (tipologiasCache) {
        console.log('‚úÖ Usando cache (' + tipologiasCache.length + ' tipolog√≠as)');
        return tipologiasCache;
    }
    
    console.log('üîÑ Cargando tipolog√≠as √∫nicas...');
    
    try {
        const tipologiasSet = new Set();
        let offset = 0;
        const batchSize = 1000; // ‚úÖ Reducir tama√±o de batch
        let hasMore = true;
        let totalProcesados = 0;
        
        while (hasMore) { // ‚úÖ QUITAR l√≠mite artificial
            const { data, error } = await supabaseClient
                .from('OS Pendientes')
                .select('Tipologia')
                .not('Tipologia', 'is', null)
                .range(offset, offset + batchSize - 1);
            
            if (error) {
                console.error('‚ùå Error en batch:', error);
                break; // Solo romper en error
            }
            
            // ‚úÖ Validar que data existe
            if (!data || data.length === 0) {
                console.log('‚ö†Ô∏è No hay m√°s datos');
                break;
            }
            
            // Agregar tipolog√≠as al Set
            data.forEach(item => {
                if (item.Tipologia) {
                    const tip = item.Tipologia.trim();
                    if (tip !== '') tipologiasSet.add(tip);
                }
            });
            
            totalProcesados += data.length;
            
            // ‚úÖ CORRECCI√ìN CLAVE: Continuar solo si se llen√≥ el batch completo
            hasMore = (data.length === batchSize);
            offset += batchSize;
            
            console.log(`üìä Procesados ${totalProcesados} registros - ${tipologiasSet.size} tipolog√≠as √∫nicas`);
            
            // ‚úÖ Peque√±a pausa para no saturar
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        const tipologiasUnicas = Array.from(tipologiasSet).sort();
        tipologiasCache = tipologiasUnicas;
        
        console.log(`‚úÖ ${tipologiasUnicas.length} tipolog√≠as TOTALES de ${totalProcesados} registros`);
        return tipologiasUnicas;
        
    } catch (err) {
        console.error('‚ùå Error cargando tipolog√≠as:', err);
        return [];
    }
}




// ========================================
// üîÑ FUNCI√ìN PARA LIMPIAR CACHE (OPCIONAL)
// ========================================
/**
 * Limpia el cache de tipolog√≠as.
 * Usar cuando se actualice la tabla OS Pendientes.
 */
function limpiarCacheTipologias() {
    console.log('üóëÔ∏è Limpiando cache de tipolog√≠as...');
    tipologiasCache = null;
}

    // --- 2. CONFIGURACI√ìN E INICIALIZACI√ìN DE SUPABASE ---
    const SUPABASE_URL = 'https://bsxllefnehbwkuqbelec.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzeGxsZWZuZWhid2t1cWJlbGVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjQzMTksImV4cCI6MjA3MzA0MDMxOX0.Ma8elbehsraBPzPwSmntE78NaAfTgBKgDW_hMb-ohhg';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // NOTA: Las variables ya fueron declaradas arriba. ¬°No las repitas!

    // === CONFIGURACI√ìN DE TURNOS ATTF (Visibilidad del Bot√≥n) ===
const TURNOS_ATTF = {
    turno1: {
        nombre: "6:00 AM - 2:00 PM",
        codigo: "6am-2pm",
        horaInicio: 6,
        horaFin: 14,
        horaInicioGracia: 4,        // Puede ingresar desde 4 AM
        horaFinGracia: 18,          // Puede trabajar hasta 6 PM (14 + 4h)
        ventanaBotonInicio: 4,      // Bot√≥n visible desde 4 AM
        ventanaBotonFin: 10,        // Bot√≥n visible hasta 10 AM
        esTurnoNocturno: false
    },
    turno4: {
        nombre: "8:00 AM - 4:00 PM",
        codigo: "8am-4pm",
        horaInicio: 8,
        horaFin: 16,
        horaInicioGracia: 6,        // Puede ingresar desde 6 AM
        horaFinGracia: 20,          // Puede trabajar hasta 8 PM (16 + 4h)
        ventanaBotonInicio: 6,
        ventanaBotonFin: 11,
        esTurnoNocturno: false
    },
    turno2: {
        nombre: "2:00 PM - 10:00 PM",
        codigo: "2pm-10pm",
        horaInicio: 14,
        horaFin: 22,
        horaInicioGracia: 12,       // Puede ingresar desde 12 PM
        horaFinGracia: 26,          // Puede trabajar hasta 2 AM (22 + 4h = 26, o sea 02:00)
        ventanaBotonInicio: 12,
        ventanaBotonFin: 17,
        esTurnoNocturno: false
    },
    turno3: {
        nombre: "10:00 PM - 6:00 AM",
        codigo: "10pm-6am",
        horaInicio: 22,
        horaFin: 6,
        horaInicioGracia: 20,       // Puede ingresar desde 8 PM
        horaFinGracia: 9,           // Puede trabajar hasta 9 AM (6 + 3h extra por nocturno)
        ventanaBotonInicio: 18,     // Bot√≥n visible desde 6 PM
        ventanaBotonFin: 24,        // Bot√≥n visible hasta medianoche (23:59)
        esTurnoNocturno: true
    }
};


function cambiarFechasDescansoATTF() {
    // 1. Buscamos el contenedor principal
    const targetSection = document.getElementById('configuracionInicialATTF') || document.getElementById('searchSection');
    if (!targetSection) return;

    // 2. ‚ö° CR√çTICO: Limpiar el contenido previo para que no se encime
    targetSection.innerHTML = ''; 

    const ma√±ana = new Date();
    ma√±ana.setDate(ma√±ana.getDate() + 1);
    const minDate = ma√±ana.toISOString().split('T')[0];

    // 3. Inyectamos la interfaz limpia
    targetSection.innerHTML = `
        <div class="card-configuracion" style="padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: 20px auto;">
            <h2 class="titulo-degradado" style="text-align: center;">Ajustar Descanso</h2>
            <p style="text-align: center; color: #666; font-size: 14px;">Selecciona manualmente tus d√≠as de descanso</p>
            
            <div style="margin-top: 20px;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>üóìÔ∏è Fecha de Inicio:</label>
                    <input type="date" id="fechaInicioInput" min="${minDate}" class="form-control">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>üóìÔ∏è Fecha de Fin:</label>
                    <input type="date" id="fechaFinInput" min="${minDate}" class="form-control">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>üîô Turno de REGRESO:</label>
                    <select id="turnoRegresoInput" class="form-control">
                        <option value="">-- Seleccione --</option>
                        ${Object.entries(TURNOS_ATTF).map(([key, turno]) => 
                            `<option value="${key}">${turno.nombre}</option>`
                        ).join('')}
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn" onclick="procesarCambioFechasManual()" style="background: #4caf50; color: white;">‚úÖ Aplicar</button>
                <button class="btn" onclick="mostrarForzarDescansoATTF()" style="background: #e2e8f0; color: #475569;">‚Ü©Ô∏è Volver</button>
            </div>
        </div>
    `;
}


window.confirmarDescansoAutomaticoATTF = async function(fechaIni, fechaFin) {
    console.log("üì° Procesando confirmaci√≥n de descanso:", { fechaIni, fechaFin });
    
    // 1. Validar sesi√≥n
    if (!currentUser || !currentUser.id) {
        alert("Error: No hay sesi√≥n de usuario activa.");
        location.reload();
        return;
    }

    // 2. Obtener el turno de regreso (de la variable global)
    const turnoRegreso = window.turnoRegresoManual || 'turno1';
    
    // 3. Calcular fecha de regreso (d√≠a despu√©s del fin del descanso)
    const fechaRegresoDate = new Date(fechaFin + 'T00:00:00');
    fechaRegresoDate.setDate(fechaRegresoDate.getDate() + 1);
    const fechaRegreso = fechaRegresoDate.toISOString().split('T')[0];

    try {
        // 4. Guardar en Base de Datos
        const { error } = await supabaseClient
            .from('usuarios')
            .update({
                descanso_fecha_inicio: fechaIni,
                descanso_fecha_fin: fechaFin,
                turno_manana: 'descanso',           // ‚úÖ EXPL√çCITO
                fecha_turno_manana: null,            // ‚úÖ NULL (es descanso)
                turno_regreso: turnoRegreso,         // ‚úÖ DEFINIDO AHORA
                fecha_turno_regreso: fechaRegreso,   // ‚úÖ DEFINIDO AHORA
                estado_ciclo: 'ciclo_normal',        // ‚úÖ CONSISTENTE
                contador_turnos: 0,                  // ‚úÖ RESET
                ultima_actividad: new Date().toISOString()
            })
            .eq('id', currentUser.id);

        if (error) throw error;

        // 5. Guardar localmente
        localStorage.setItem('turno_hoy', 'DESCANSO');
        localStorage.setItem('turno_manana', 'descanso');
        localStorage.setItem('descanso_confirmado', 'true');
        localStorage.setItem('turno_regreso', turnoRegreso);
        localStorage.setItem('fecha_turno_regreso', fechaRegreso);

        // 6. LIMPIEZA DE INTERFAZ
        const configSec = document.getElementById('configuracionInicialATTF') || document.getElementById('searchSection');
        if (configSec) {
            configSec.innerHTML = '';
            configSec.style.display = 'none';
        }

        // 7. Entrar al men√∫
        console.log("‚úÖ Descanso guardado. Accediendo al men√∫...");
        
        if (typeof accederMenuATTF === 'function') {
            accederMenuATTF();
        } else {
            const menu = document.getElementById('menuModulosATTF');
            if (menu) menu.style.display = 'block';
        }

    } catch (err) {
        console.error("‚ùå Error al confirmar descanso:", err);
        alert("Hubo un problema al guardar la informaci√≥n: " + err.message);
    }
};




function procesarCambioFechasManual() {
    const inicio = document.getElementById('fechaInicioInput').value;
    const fin = document.getElementById('fechaFinInput').value;
    const regreso = document.getElementById('turnoRegresoInput').value;

    if (!inicio || !fin || !regreso) {
        alert("‚ö†Ô∏è Por favor completa todos los campos.");
        return;
    }

    // Validaci√≥n l√≥gica de fechas
    if (new Date(inicio) > new Date(fin)) {
        alert("‚ö†Ô∏è La fecha de inicio no puede ser posterior a la de fin.");
        return;
    }

    window.fechasDescansoPersonalizadas = { inicio, fin };
    window.turnoRegresoManual = regreso; 

    confirmarDescansoPersonalizadoATTF();
}


async function confirmarDescansoPersonalizadoATTF() {
    // 1. Obtener el turno de regreso
    const turnoRegreso = window.turnoRegresoManual || 
                         document.getElementById('turnoRegreso')?.value || 
                         document.getElementById('turnoRegresoInput')?.value;

    if (!turnoRegreso) {
        alert('‚ö†Ô∏è Seleccione el turno de regreso');
        return;
    }

    const { inicio, fin } = window.fechasDescansoPersonalizadas || {};
    if (!inicio || !fin) {
        alert('‚ö†Ô∏è No hay fechas seleccionadas');
        return;
    }

    // 2. Confirmaci√≥n al usuario
    const confirmar = confirm(
        `¬øConfirmar descanso personalizado?\n` +
        `üìÖ Inicio: ${inicio}\n` +
        `üìÖ Fin: ${fin}\n` +
        `üîô Regreso: ${TURNOS_ATTF[turnoRegreso]?.nombre || '---'}`
    );

    if (!confirmar) return;

    try {
        console.log(`üíæ Guardando Descanso: ${inicio} al ${fin}...`);

        // Calcular fecha de regreso real (D√≠a despu√©s del fin)
        const fechaRegresoDate = new Date(fin + 'T00:00:00');
        fechaRegresoDate.setDate(fechaRegresoDate.getDate() + 1);
        const fechaRegreso = fechaRegresoDate.toISOString().split('T')[0];

        // 3. Guardar en Supabase
        const { error } = await supabaseClient
            .from('usuarios')
            .update({
                descanso_fecha_inicio: inicio,
                descanso_fecha_fin: fin,
                turno_regreso: turnoRegreso,
                fecha_turno_regreso: fechaRegreso,
                contador_turnos: 0,
                estado_ciclo: 'ciclo_normal',        // ‚úÖ CONSISTENTE
                turno_manana: 'descanso', 
                fecha_turno_manana: null,            // ‚úÖ CONSISTENTE
                ultimaconexion: formatearFechaCompletaElSalvador(getFechaElSalvador())
            })
            .eq('id', currentUser.id);

        if (error) throw error;

        // 4. ACTUALIZAR LOCALSTORAGE
        localStorage.setItem('turno_manana', 'descanso');
        localStorage.setItem('descanso_inicio', inicio);
        localStorage.setItem('descanso_fin', fin);
        localStorage.setItem('turno_regreso', turnoRegreso);
        localStorage.setItem('fecha_turno_regreso', fechaRegreso);

        // 5. LIMPIAR LA INTERFAZ
        const targetSection = document.getElementById('configuracionInicialATTF') || document.getElementById('searchSection');
        if (targetSection) {
            targetSection.innerHTML = '';
            targetSection.style.display = 'none';
        }

        alert('‚úÖ Descanso guardado correctamente');
        
        // 6. Ir al men√∫
        accederMenuATTF();

    } catch (error) {
        console.error("‚ùå Error en el proceso final:", error);
        alert('‚ùå Error al guardar: ' + error.message);
    }
}


function verificarHorarioPermitido(rol, userData = null) {
    // ‚úÖ Obtener fecha/hora exacta de El Salvador (Sincronizaci√≥n SV)
    const opciones = { timeZone: 'America/El_Salvador', hour12: false };
    const ahoraSVString = new Date().toLocaleString('en-US', opciones);
    const fechaSV = new Date(ahoraSVString);
    
    // Extraer datos normalizados
    const fechaHoy = fechaSV.getFullYear() + '-' + 
                     String(fechaSV.getMonth() + 1).padStart(2, '0') + '-' + 
                     String(fechaSV.getDate()).padStart(2, '0');
    const horaActual = fechaSV.getHours();
    const minutoActual = fechaSV.getMinutes();
    const diaActual = fechaSV.getDay(); // 0=Domingo, 1=Lunes...
    
    console.log('üîç Verificando horario (El Salvador):', {
        fecha: fechaHoy,
        hora: `${String(horaActual).padStart(2, '0')}:${String(minutoActual).padStart(2, '0')}`,
        rol: rol,
        fecha_excepcional: userData?.fecha_excepcional,
        horario_excepcional_inicio: userData?.horario_excepcional_inicio,
        horario_excepcional_fin: userData?.horario_excepcional_fin
    });
    
    // ========================================
    // ‚úÖ PRIORIDAD 1: Verificar horario excepcional
    // ========================================
    if (userData && userData.fecha_excepcional) {
        // ‚úÖ NORMALIZAR fecha excepcional a formato YYYY-MM-DD
        const fechaExcepcional = new Date(userData.fecha_excepcional + 'T00:00:00');
        const fechaExcepcionalStr = `${fechaExcepcional.getFullYear()}-${String(fechaExcepcional.getMonth() + 1).padStart(2, '0')}-${String(fechaExcepcional.getDate()).padStart(2, '0')}`;
        
        if (fechaExcepcionalStr === fechaHoy &&
            userData.horario_excepcional_inicio &&
            userData.horario_excepcional_fin) {
            
            // Convertir horas a minutos para comparaci√≥n precisa
            const [horaInicio, minutoInicio] = userData.horario_excepcional_inicio.split(':').map(Number);
            const [horaFin, minutoFin] = userData.horario_excepcional_fin.split(':').map(Number);
            
            const minutosActuales = (horaActual * 60) + minutoActual;
            const minutosInicio = (horaInicio * 60) + minutoInicio;
            const minutosFin = (horaFin * 60) + minutoFin;
            
            console.log('üéØ Horario excepcional configurado para HOY:', {
                fechaConfigurada: fechaExcepcionalStr,
                rango: `${userData.horario_excepcional_inicio} - ${userData.horario_excepcional_fin}`,
                minutosActuales: minutosActuales,
                minutosInicio: minutosInicio,
                minutosFin: minutosFin
            });
            
            // ‚úÖ SI est√° DENTRO del rango excepcional ‚Üí PERMITIR INMEDIATAMENTE
            if (minutosActuales >= minutosInicio && minutosActuales <= minutosFin) {
                console.log(`‚úÖ ACCESO PERMITIDO por horario excepcional: ${userData.horario_excepcional_inicio} - ${userData.horario_excepcional_fin}`);
                return { permitido: true };
            }
            
            // ‚ö†Ô∏è SI est√° FUERA del rango ‚Üí CONTINUAR a validaci√≥n normal (NO bloquear)
            console.log(`‚ö†Ô∏è Fecha excepcional coincide pero hora (${horaActual}:${String(minutoActual).padStart(2, '0')}) fuera de rango excepcional. Evaluando horario regular...`);
        }
    }
    
    // ========================================
    // ‚úÖ PRIORIDAD 2: Validar seg√∫n rol (horario regular)
    // ========================================
    
    // üîπ Roles con acceso ILIMITADO (todos los d√≠as, todas las horas)
    const rolesIlimitados = ['Administrador', 'Supervisor', 'ATTF'];
    if (rolesIlimitados.includes(rol)) {
        console.log(`‚úÖ Rol ${rol} tiene acceso ILIMITADO`);
        return { permitido: true };
    }
    
    // üîπ Roles con acceso Lunes-S√°bado, 6:00 AM - 6:00 PM
    const rolesHorarioDiurno = ['Despacho', 'Consulta', 'Contratista', 'Lectura'];
    if (rolesHorarioDiurno.includes(rol)) {
        if (diaActual === 0) { // Domingo
            return {
                permitido: false,
                mensaje: `El rol ${rol} no tiene acceso los domingos.\nAcceso permitido: Lunes a S√°bado, 6:00 AM - 6:00 PM`
            };
        }
        if (horaActual >= 6 && horaActual < 18) {
            console.log(`‚úÖ Acceso permitido para ${rol} (6:00 AM - 6:00 PM)`);
            return { permitido: true };
        }
        return {
            permitido: false,
            mensaje: `Horario de acceso para ${rol}:\nLunes a S√°bado, 6:00 AM - 6:00 PM\n\nHora actual: ${String(horaActual).padStart(2, '0')}:${String(minutoActual).padStart(2, '0')}`
        };
    }
    
    // üîπ Bodega: Lunes-S√°bado 24/7, Domingo bloqueado
    if (rol === 'Bodega') {
        if (diaActual === 0) {
            return {
                permitido: false,
                mensaje: 'El rol Bodega no tiene acceso los domingos.\nAcceso permitido: Lunes a S√°bado, 24 horas'
            };
        }
        console.log('‚úÖ Acceso permitido para Bodega (Lunes-S√°bado 24/7)');
        return { permitido: true };
    }
    
    // üîπ Poda: Lunes-S√°bado, 5:00 AM - 10:00 PM
    if (rol === 'Poda') {
        if (diaActual === 0) {
            return {
                permitido: false,
                mensaje: 'El rol Poda no tiene acceso los domingos.\nAcceso permitido: Lunes a S√°bado, 5:00 AM - 10:00 PM'
            };
        }
        if (horaActual >= 5 && horaActual < 22) {
            console.log('‚úÖ Acceso permitido para Poda (5:00 AM - 10:00 PM)');
            return { permitido: true };
        }
        return {
            permitido: false,
            mensaje: `Horario de acceso para Poda:\nLunes a S√°bado, 5:00 AM - 10:00 PM\n\nHora actual: ${String(horaActual).padStart(2, '0')}:${String(minutoActual).padStart(2, '0')}`
        };
    }
    
    // üîπ ATTF: Turnos rotativos (Ajuste para cobertura total)
if (rol === 'ATTF') {
    if (diaActual === 0) {
        return { permitido: false, mensaje: 'Acceso no permitido los domingos.' };
    }
    
    const minutosActuales = (horaActual * 60) + minutoActual;

    const turnosATTF = [
        { inicio: 6*60,  fin: 14*60, nombre: '6:00 AM - 2:00 PM' },
        { inicio: 10*60, fin: 18*60, nombre: '10:00 AM - 6:00 PM' },
        { inicio: 14*60, fin: 22*60, nombre: '2:00 PM - 10:00 PM' },
        // Turnos que cruzan medianoche (usamos l√≥gica de "o"):
        { nocturno: true, inicio: 18*60, fin: 2*60,  nombre: '6:00 PM - 2:00 AM' },
        { nocturno: true, inicio: 22*60, fin: 6*60,  nombre: '10:00 PM - 6:00 AM' }
    ];
    
    const enTurno = turnosATTF.some(turno => {
        if (!turno.nocturno) {
            return minutosActuales >= turno.inicio && minutosActuales < turno.fin;
        } else {
            // L√≥gica para turnos que pasan de las 00:00 (ej: 22:00 a 06:00)
            return minutosActuales >= turno.inicio || minutosActuales < turno.fin;
        }
    });

    if (enTurno) return { permitido: true };
    
    return {
        permitido: false,
        mensaje: `No te encuentras en un turno activo.\nHora actual: ${String(horaActual).padStart(2, '0')}:${String(minutoActual).padStart(2, '0')}`
    };
}
        
        const turnosTexto = turnosATTF
            .filter(t => t.inicio < t.fin)
            .map(t => t.nombre)
            .join('\n');
        
        return {
            permitido: false,
            mensaje: `Turnos ATTF permitidos (Lunes a S√°bado):\n${turnosTexto}\n\nHora actual: ${String(horaActual).padStart(2, '0')}:${String(minutoActual).padStart(2, '0')}`
        };
    
    
    // üîπ Rol no reconocido ‚Üí permitir por defecto (o bloquear seg√∫n pol√≠tica)
    console.warn(`‚ö†Ô∏è Rol no configurado expl√≠citamente: ${rol}. Permitiendo acceso por defecto.`);
    return { permitido: true };
}


async function verificarInactividad(userData) {
    if (!userData.ultima_actividad) {
        // Primera vez, actualizar timestamp
        await supabaseClient
            .from('usuarios')
            .update({ ultima_actividad: formatearFechaCompletaElSalvador(getFechaElSalvador())
				 })
            .eq('id', userData.id);
        return { inactivo: false };
    }
    
    const ahora = new Date();
    const ultimaActividad = new Date(userData.ultima_actividad);
    const diasInactivo = Math.floor((ahora - ultimaActividad) / (1000 * 60 * 60 * 24));
    
    console.log(`‚è∞ D√≠as sin actividad: ${diasInactivo}`);
    
    // Supervisor sin l√≠mite
    if (userData.rol === 'Supervisor') {
        return { inactivo: false };
    }
    
    // Todos los dem√°s roles: 5 d√≠as
    if (diasInactivo >= 5) {
    // Bloquear usuario
    await supabaseClient
        .from('usuarios')
        .update({ 
            razon_bloqueo: `Inactividad de ${diasInactivo} d√≠as`,
            sessionactiva: false,
            sessiontoken: null
        })
        .eq('id', userData.id);
        
        return { 
            inactivo: true, 
            dias: diasInactivo,
            mensaje: `Usuario bloqueado por inactividad de ${diasInactivo} d√≠as.\n\nContacte al administrador para desbloquear su cuenta.`
        };
    }
    
    return { inactivo: false };
}



function verificarDiaDescanso(userData) {
    if (!userData.descanso_fecha_inicio || !userData.descanso_fecha_fin) {
        return false;
    }
    
    const ahora = new Date();
    const horaActual = ahora.getHours();
    const fechaHoy = getFechaHoyElSalvador();
    
    // Verificar si hoy est√° en el rango de descanso
    if (fechaHoy < userData.descanso_fecha_inicio || fechaHoy > userData.descanso_fecha_fin) {
        console.log('‚úÖ Fuera del per√≠odo de descanso');
        return false;
    }
    
    // === EXCEPCI√ìN: TURNO NOCTURNO QUE TERMINA EN PRIMER D√çA DE DESCANSO ===
    if (userData.rol === 'ATTF' && fechaHoy === userData.descanso_fecha_inicio) {
        if (userData.turno_hoy === 'turno3') {
            // Si estamos en ventana de gracia del turno nocturno (hasta 9 AM)
            if (horaActual >= 0 && horaActual < 9) {
                console.log('üåô Permitiendo terminar turno nocturno en primer d√≠a de descanso');
                return false; // NO es descanso a√∫n, puede terminar turno
            }
        }
    }
    
    // === EXCEPCI√ìN: TURNO NOCTURNO QUE INICIA EN √öLTIMO D√çA DE DESCANSO ===
    if (userData.rol === 'ATTF' && fechaHoy === userData.descanso_fecha_fin) {
        if (userData.turno_regreso === 'turno3') {
            // Si estamos en ventana de ingreso del turno nocturno (desde 18:00)
            if (horaActual >= 18) {
                console.log('üåô Permitiendo ingresar para turno nocturno en √∫ltimo d√≠a de descanso');
                return false; // NO es descanso, puede ingresar
            }
        }
    }
    
    // Regla general: Est√° en d√≠a de descanso
    console.log(`üìÖ D√≠a de descanso activo: ${fechaHoy}`);
    return true;
}


function validarVentanaTurno(codigoTurno, horaActual) {
    const turno = TURNOS_ATTF[codigoTurno];
    if (!turno) {
        console.error('‚ùå Turno no encontrado:', codigoTurno);
        return false;
    }
    
    // Turno nocturno (cruza medianoche)
    if (turno.esTurnoNocturno) {
        // Ventana: 20:00 ‚Üí 09:00 (d√≠a siguiente)
        if (horaActual >= turno.horaInicioGracia || horaActual < turno.horaFinGracia) {
            console.log(`‚úÖ Dentro de ventana nocturna: ${turno.nombre}`);
            return true;
        }
    } else {
        // Turno diurno normal
        let horaFin = turno.horaFinGracia;
        
        // Si la gracia cruza medianoche (ej: turno 14-22 con gracia hasta 02:00)
        if (horaFin >= 24) {
            if (horaActual >= turno.horaInicioGracia || horaActual < (horaFin - 24)) {
                console.log(`‚úÖ Dentro de ventana con cruce de medianoche: ${turno.nombre}`);
                return true;
            }
        } else {
            if (horaActual >= turno.horaInicioGracia && horaActual < horaFin) {
                console.log(`‚úÖ Dentro de ventana diurna: ${turno.nombre}`);
                return true;
            }
        }
    }
    
    console.log(`‚ùå Fuera de ventana: ${turno.nombre} (hora actual: ${horaActual})`);
    return false;
}


async function login() {
    console.log('üîê Ejecutando login...');
    
    // Limpiar datos viejos antes de iniciar
    await limpiarTurnosViejos();
    await limpiarDiasDescansoViejos();

    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!username || !password) {
        alert('Por favor ingrese usuario y contrase√±a');
        return;
    }

    try {
        // 1. Autenticar usuario
        const { data, error } = await supabaseClient
            .from('usuarios')
            .select('*')
            .eq('usuario', username)
            .eq('password', password)
            .eq('activo', true)
            .single();

        if (error || !data) {
            alert('Usuario o contrase√±a incorrectos');
            return;
        }
        
        // 2. Verificar bloqueo manual
        if (data.razon_bloqueo && data.razon_bloqueo.trim() !== '') {
            alert(`üö´ Usuario bloqueado\n\nMotivo: ${data.razon_bloqueo}`);
            return;
        }
        
        // 3. Verificar inactividad
        const checkInactividad = await verificarInactividad(data);
        if (checkInactividad.inactivo) {
            await supabaseClient
                .from('usuarios')
                .update({ 
                    Bloqueado: true, // Seg√∫n tu esquema es con B may√∫scula
                    razon_bloqueo: checkInactividad.mensaje || 'Inactividad prolongada'
                })
                .eq('id', data.id);
            alert(checkInactividad.mensaje);
            return;
        }

        // 4. Verificar horario permitido
        const verificacion = verificarHorarioPermitido(data.rol, data);
        if (!verificacion.permitido) {
            alert(verificacion.mensaje);
            return;
        }

        // ==========================================================
        // 5. GESTI√ìN DE SESI√ìN √öNICA (CORREGIDO PARA TU TABLA)
        // ==========================================================
        const newToken = Math.random().toString(36).substring(2); 
        const ahoraSV = formatearFechaCompletaElSalvador(getFechaElSalvador());

        // Actualizamos Supabase (sessiontoken SIN guion bajo seg√∫n tu esquema)
        const { error: updateError } = await supabaseClient
            .from('usuarios')
            .update({
                sessionactiva: true,
                sessiontoken: newToken, 
                ultimaconexion: ahoraSV,
                ultima_actividad: ahoraSV
            })
            .eq('id', data.id);

        if (updateError) throw updateError;

        // ACTUALIZAR LOCALMENTE
        data.sessiontoken = newToken; 
        currentUser = data;

        // Guardar en Storage para que no te saque al refrescar
        localStorage.setItem('usuario_logueado', JSON.stringify(currentUser));
        sessionStorage.setItem('cleca_user_session', JSON.stringify({
            user: currentUser,
            timestamp: Date.now()
        }));

        guardarDatosOffline(); 

        console.log(`üë§ Rol detectado: ${data.rol}`);

        // 6. Redirigir seg√∫n rol
        // ... (dentro de la funci√≥n login, despu√©s de validar el usuario) ...

       if (data.rol === 'ATTF') {
            console.log("üõ†Ô∏è Iniciando interfaz para ATTF...");
            
            // 1. Ocultar Login y mostrar Info de Usuario
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('currentUser').textContent = `${data.usuario} (ATTF)`;

            

            // ‚úÖ CORRECTO - Delegar toda la l√≥gica a loginATTF
loginATTF(data);
return;
        }

        if (data.rol === 'Poda') {
            loginPoda(data); 
            return;
        }
        
        // Para otros roles (Admin, etc.)
        document.getElementById('currentUser').textContent = `Bienvenido, ${data.usuario}`;
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('tableSelectionSection').style.display = 'block';

        iniciarVerificacionSesion();
        mostrarTablasSegunRol();

    } catch (err) {
        console.error('Error de login:', err);
        alert('Error de conexi√≥n con la base de datos. Por favor intente nuevamente.');
    }
}

    // ========================================
// üÜï FUNCI√ìN AUXILIAR: Validar fecha m√°xima de descanso
// ========================================
function validarFechaDescansoMaxima(fechaInicio, fechaHoy) {
    const inicio = new Date(fechaInicio + 'T00:00:00');
    const hoy = new Date(fechaHoy + 'T00:00:00');
    
    // Calcular diferencia en d√≠as
    const diffMs = inicio - hoy;
    const diffDias = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
    
    // D√≠a 1 = HOY, D√≠a 6 = m√°ximo permitido
    // diffDias = 1 es ma√±ana (d√≠a 2)
    // diffDias = 5 es d√≠a 6 (m√°ximo)
    if (diffDias < 1 || diffDias > 5) {
        return {
            valido: false,
            mensaje: 'El d√≠a de inicio de descanso debe ser entre ma√±ana (d√≠a 2) y m√°ximo 5 d√≠as despu√©s (d√≠a 6).'
        };
    }
    
    return { valido: true };
}

// ========================================
// üë∑ FUNCI√ìN PRINCIPAL: loginATTF (VERSI√ìN CORREGIDA Y ROBUSTA)
// ========================================
async function loginATTF(userData) {
    console.log('üë∑ ==========================================');
    console.log('üë∑ INICIANDO loginATTF - DATOS RECIBIDOS:');
    console.log('üë∑ Usuario:', userData?.usuario || 'NO DISPONIBLE');
    console.log('üë∑ ID:', userData?.id || 'NO DISPONIBLE');
    console.log('üë∑ Rol:', userData?.rol || 'NO DISPONIBLE');
    console.log('üë∑ ==========================================');

    // ‚úÖ VALIDACI√ìN CR√çTICA 0: Verificar que userData sea v√°lido
    if (!userData || !userData.id) {
        console.error('‚ùå ERROR FATAL: userData inv√°lido en loginATTF');
        alert('Error cr√≠tico: Sesi√≥n corrupta. Por favor, inicie sesi√≥n nuevamente.');
        logout();
        return;
    }

    // ========================================
    // ‚úÖ 1. SINCRONIZACI√ìN DE CONTADOR ENTRE BD Y MEMORIA
    // ========================================
    try {
        console.log('üîÑ Sincronizando contador de turnos con BD...');
        const { data: bdData, error: errorSync } = await supabaseClient
            .from('usuarios')
            .select('contador_turnos, estado_ciclo, turno_hoy, fecha_turno_hoy, turno_manana, fecha_turno_manana')
            .eq('id', userData.id)
            .single();

        if (errorSync) {
            console.warn('‚ö†Ô∏è No se pudo sincronizar con BD:', errorSync.message);
        } else if (bdData) {
            // Comparar y sincronizar contador
            const contadorBD = parseInt(bdData.contador_turnos) || 0;
            const contadorLocal = parseInt(userData.contador_turnos) || 0;
            
            if (contadorBD !== contadorLocal) {
                console.warn('‚ö†Ô∏è Inconsistencia en contador, sincronizando...');
                console.log('üíæ Sync contador:', {
                    local: contadorLocal,
                    bd: contadorBD,
                    accion: 'Actualizando memoria local'
                });
                // Actualizar userData (el objeto principal que usamos)
                userData.contador_turnos = contadorBD;
                // Actualizar currentUser si existe
                if (currentUser && currentUser.id === userData.id) {
                    currentUser.contador_turnos = contadorBD;
                }
                // Actualizar localStorage como backup
                localStorage.setItem('contador_turnos', String(contadorBD));
            }

            // ‚úÖ Sincronizar otros campos cr√≠ticos si hay diferencias
            if (bdData.turno_hoy && !userData.turno_hoy) {
                console.log('üîÑ Sincronizando turno_hoy desde BD');
                userData.turno_hoy = bdData.turno_hoy;
                if (currentUser) currentUser.turno_hoy = bdData.turno_hoy;
            }
            if (bdData.fecha_turno_hoy && !userData.fecha_turno_hoy) {
                console.log('üîÑ Sincronizando fecha_turno_hoy desde BD');
                userData.fecha_turno_hoy = bdData.fecha_turno_hoy;
                if (currentUser) currentUser.fecha_turno_hoy = bdData.fecha_turno_hoy;
            }
        }
    } catch (err) {
        console.warn('‚ö†Ô∏è Error en sincronizaci√≥n de contador:', err.message);
        // No bloquear el flujo, continuar con los datos disponibles
    }

    // ========================================
    // ‚úÖ 2. OBTENER FECHAS Y HORAS DE EL SALVADOR
    // ========================================
    const fechaHoy = getFechaHoyElSalvador();
    const horaActual = new Date().getHours();
    const fechaActualCompleta = getFechaElSalvador();
    
    console.log('üìÖ Fecha hoy (SV):', fechaHoy);
    console.log('üïê Hora actual:', horaActual);

    // ========================================
    // ‚úÖ 3. CORRECCI√ìN DE INTEGRIDAD: fecha_turno_hoy NULL
    // ========================================
    console.log('üîç ==========================================');
    console.log('üîç VALIDACI√ìN DE INTEGRIDAD DE DATOS');
    console.log('üîç turno_hoy:', userData.turno_hoy);
    console.log('üîç fecha_turno_hoy:', userData.fecha_turno_hoy);
    console.log('üîç ==========================================');

    if (userData.turno_hoy && !userData.fecha_turno_hoy) {
        console.warn('‚ö†Ô∏è ALERTA DE INTEGRIDAD: fecha_turno_hoy es NULL pero turno_hoy existe. Corrigiendo...');
        
        // L√≥gica para inferir la fecha correcta
        if (userData.turno_hoy === 'turno3' && horaActual < 9) {
            // Turno nocturno que podr√≠a haber empezado ayer
            const ayer = new Date(fechaActualCompleta);
            ayer.setDate(ayer.getDate() - 1);
            userData.fecha_turno_hoy = ayer.toISOString().split('T')[0];
            console.log(`‚úÖ Corregido: turno3 activo desde AYER (${userData.fecha_turno_hoy})`);
        } else {
            // Asumir que es hoy
            userData.fecha_turno_hoy = fechaHoy;
            console.log(`‚úÖ Corregido: fecha_turno_hoy establecida a HOY (${fechaHoy})`);
        }
        
        // Persistir correcci√≥n en BD
        try {
            console.log('üíæ Guardando correcci√≥n de fecha en BD...');
            const { error } = await supabaseClient
                .from('usuarios')
                .update({ fecha_turno_hoy: userData.fecha_turno_hoy })
                .eq('id', userData.id);
            
            if (error) throw error;
            console.log('‚úÖ fecha_turno_hoy corregida y guardada en BD');
        } catch (err) {
            console.error('‚ùå Error guardando correcci√≥n de fecha:', err.message);
            // No bloquear, continuar con la correcci√≥n en memoria
        }
    }

    // ========================================
    // ‚úÖ 4. ROLL FORWARD: Promover "ma√±ana" a "hoy" si corresponde
    // ========================================
    console.log('üîÑ ==========================================');
    console.log('üîÑ VALIDACI√ìN DE ROLL FORWARD (PROMOCI√ìN DE TURNO)');
    console.log('üîÑ Fecha hoy:', fechaHoy);
    console.log('üîÑ fecha_turno_manana en BD:', userData.fecha_turno_manana);
    console.log('üîÑ turno_manana en BD:', userData.turno_manana);
    console.log('üîÑ ==========================================');

    if (userData.fecha_turno_manana === fechaHoy) {
        console.log('‚úÖ üü¢ CONDICI√ìN CUMPLIDA: fecha_turno_manana === fechaHoy');
        
        // Validar que turno_manana sea v√°lido para promover
        const turnoMananaValido = userData.turno_manana && 
                                  userData.turno_manana !== 'null' && 
                                  userData.turno_manana !== '' && 
                                  userData.turno_manana !== 'descanso';
        
        if (!turnoMananaValido) {
            console.warn('‚ö†Ô∏è üü† Roll forward OMITIDO: turno_manana inv√°lido:', userData.turno_manana);
            // Limpiar campos inconsistentes
            try {
                await supabaseClient
                    .from('usuarios')
                    .update({ 
                        turno_manana: null,
                        fecha_turno_manana: null 
                    })
                    .eq('id', userData.id);
                console.log('üßπ Campos inconsistentes limpiados en BD');
            } catch (err) {
                console.error('‚ùå Error limpiando campos:', err.message);
            }
            userData.turno_manana = null;
            userData.fecha_turno_manana = null;
        } else {
            // ‚úÖ PROMOCIONAR: "ma√±ana" se convierte en "hoy"
            console.log('üîÑ PROMOVIENDO turno_manana a turno_hoy...');
            console.log(`   üìã De: ${userData.turno_manana} (${userData.fecha_turno_manana})`);
            console.log(`   üìã A: ${userData.turno_manana} (${fechaHoy})`);
            
            try {
                const { error } = await supabaseClient
                    .from('usuarios')
                    .update({ 
                        turno_hoy: userData.turno_manana,
                        fecha_turno_hoy: fechaHoy,
                        turno_manana: null,
                        fecha_turno_manana: null,
                        // Mantener el contador actual
                        contador_turnos: userData.contador_turnos
                    })
                    .eq('id', userData.id);
                
                if (error) throw error;
                
                console.log('‚úÖ üéØ ROLL FORWARD EXITOSO');
                console.log(`   ‚úÖ Nuevo turno_hoy: ${userData.turno_manana}`);
                console.log(`   ‚úÖ Nueva fecha_turno_hoy: ${fechaHoy}`);
                console.log(`   ‚úÖ Campos de ma√±ana limpiados`);
                
                // ‚úÖ Sincronizar memoria local con BD
                userData.turno_hoy = userData.turno_manana;
                userData.fecha_turno_hoy = fechaHoy;
                userData.turno_manana = null;
                userData.fecha_turno_manana = null;
                
                if (currentUser && currentUser.id === userData.id) {
                    currentUser.turno_hoy = userData.turno_hoy;
                    currentUser.fecha_turno_hoy = userData.fecha_turno_hoy;
                    currentUser.turno_manana = null;
                    currentUser.fecha_turno_manana = null;
                }
                
            } catch (err) {
                console.error('‚ùå ‚ö†Ô∏è Error en roll forward:', err.message);
                alert('‚ö†Ô∏è Error al actualizar turno. Contacte al administrador.');
            }
        }
    } else {
        console.log('‚ùå üî¥ ROLL FORWARD NO APLICABLE');
        if (userData.fecha_turno_manana) {
            console.log(`   üìÖ fecha_turno_manana (${userData.fecha_turno_manana}) ‚â† HOY (${fechaHoy})`);
        } else {
            console.log('   üìÖ fecha_turno_manana NO DEFINIDA');
        }
    }

    // ========================================
    // ‚úÖ 5. LOG POST-ROLL FORWARD
    // ========================================
    console.log('üìä ==========================================');
    console.log('üìä ESTADO ACTUALIZADO TRAS ROLL FORWARD:');
    console.log('üìä turno_hoy:', userData.turno_hoy);
    console.log('üìä fecha_turno_hoy:', userData.fecha_turno_hoy);
    console.log('üìä turno_manana:', userData.turno_manana);
    console.log('üìä fecha_turno_manana:', userData.fecha_turno_manana);
    console.log('üìä contador_turnos:', userData.contador_turnos);
    console.log('üìä ==========================================');

    // ========================================
    // ‚úÖ 6. ACTUALIZAR √∫ltima_actividad
    // ========================================
    try {
        await supabaseClient
            .from('usuarios')
            .update({ 
                ultima_actividad: formatearFechaCompletaElSalvador(fechaActualCompleta)
            })
            .eq('id', userData.id);
        console.log('‚úÖ ultima_actividad actualizada en BD');
    } catch (err) {
        console.error('‚ö†Ô∏è Error actualizando ultima_actividad:', err.message);
    }

    // ========================================
    // ‚úÖ 7. VERIFICAR D√çA DE DESCANSO (PRIORIDAD M√ÅXIMA)
    // ========================================
    console.log('üîç Verificando d√≠a de descanso programado...');
    
    // ‚úÖ L√≥gica robusta para verificar descanso
    const tieneDescansoActivo = userData.descanso_fecha_inicio && 
                                userData.descanso_fecha_fin &&
                                fechaHoy >= userData.descanso_fecha_inicio && 
                                fechaHoy <= userData.descanso_fecha_fin;
    
    if (tieneDescansoActivo) {
        // üåô Excepci√≥n: turno nocturno que termina en primer d√≠a de descanso
        if (userData.rol === 'ATTF' && 
            fechaHoy === userData.descanso_fecha_inicio && 
            userData.turno_hoy === 'turno3' && 
            horaActual >= 0 && horaActual < 9) {
            console.log('üåô Permitiendo terminar turno nocturno en primer d√≠a de descanso');
        } else {
            console.log('‚úÖ Es d√≠a de descanso - bloqueando acceso');
            alert('üìÖ Hoy es d√≠a de descanso programado.');
            logout();
            return;
        }
    } else {
        console.log('‚úÖ No es d√≠a de descanso programado');
    }

    // ========================================
    // ‚úÖ 8. EVALUACI√ìN DE CONDICIONES DE ACCESO
    // ========================================
    console.log('‚úÖ ==========================================');
    console.log('‚úÖ EVALUACI√ìN DE CONDICIONES DE ACCESO');
    console.log('‚úÖ ==========================================');

    // üåô Validaci√≥n de ventana para turnos nocturnos (turno3)
    let enVentanaTurnoNocturno = false;
    if (userData.turno_hoy === 'turno3' && userData.fecha_turno_hoy) {
        try {
            const fechaTurno = new Date(userData.fecha_turno_hoy + 'T00:00:00');
            const hoyDate = new Date(fechaHoy + 'T00:00:00');
            const diffMs = hoyDate - fechaTurno;
            const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            // CASO A: Mismo d√≠a, entrada despu√©s de 20:00
            if (diffDias === 0 && horaActual >= 20) { 
                enVentanaTurnoNocturno = true;
                console.log('üåô Turno nocturno: entrada v√°lida (mismo d√≠a, >= 20:00)');
            } 
            // CASO B: D√≠a siguiente, ventana de gracia 00:00 - 09:00
            else if (diffDias === 1 && horaActual >= 0 && horaActual < 9) {
                enVentanaTurnoNocturno = true;
                console.log('üåô Turno nocturno: ventana de gracia (00:00 - 09:00)');
            }
        } catch (e) {
            console.error('‚ùå Error calculando ventana nocturna:', e.message);
        }
    }

    // Evaluar condiciones principales
    const tieneHoyAlDia = (userData.turno_hoy && userData.fecha_turno_hoy === fechaHoy) || enVentanaTurnoNocturno;
    
    const tieneTurnoManana = userData.turno_manana && 
                             userData.turno_manana !== 'null' && 
                             userData.turno_manana !== '' &&
                             userData.turno_manana !== 'descanso';
    
    // ‚úÖ L√≥gica de descanso corregida (usa ambas fechas)
    const descansoActivo = userData.descanso_fecha_inicio && 
                          userData.descanso_fecha_fin &&
                          fechaHoy >= userData.descanso_fecha_inicio && 
                          fechaHoy <= userData.descanso_fecha_fin;

    console.log('üìã CONDICIONES EVALUADAS:');
    console.log('   ‚Ä¢ tieneHoyAlDia:', tieneHoyAlDia, `(turno: ${userData.turno_hoy}, fecha: ${userData.fecha_turno_hoy})`);
    console.log('   ‚Ä¢ tieneTurnoManana:', tieneTurnoManana, `(turno: ${userData.turno_manana})`);
    console.log('   ‚Ä¢ descansoActivo:', descansoActivo, `(rango: ${userData.descanso_fecha_inicio} a ${userData.descanso_fecha_fin})`);
    console.log('   ‚Ä¢ enVentanaTurnoNocturno:', enVentanaTurnoNocturno);
    console.log('‚úÖ ==========================================');

    // ========================================
    // ‚úÖ 9. DECISI√ìN DE FLUJO SEG√öN CONDICIONES
    // ========================================

    // üö™ CASO 1: TIENE HOY + (MA√ëANA o DESCANSO) = ACCEDER AL MEN√ö
    if (tieneHoyAlDia && (tieneTurnoManana || descansoActivo)) {
        console.log('üö™ CASO 1: ACCESO CONCEDIDO - Tiene turno hoy + configuraci√≥n futura');
        
        // Validar ventana de turno (excepto en ventana nocturna de gracia)
        if (!enVentanaTurnoNocturno) {
            console.log('üö™ Validando ventana de horario...');
            if (!validarVentanaTurno(userData.turno_hoy, horaActual)) {
                const turnoInfo = TURNOS_ATTF[userData.turno_hoy] || { nombre: userData.turno_hoy };
                console.log('‚ùå Fuera de ventana de turno:', turnoInfo.nombre);
                alert(`‚ö†Ô∏è Fuera de horario permitido para ${turnoInfo.nombre}.`);
                logout();
                return;
            }
            console.log('‚úÖ Dentro de ventana de turno v√°lida');
        } else {
            console.log('üåô Saltando validaci√≥n de ventana (gracia nocturna)');
        }
        
        console.log('‚úÖ ‚úÖ ‚úÖ TODO CONFIGURADO - ACCEDIENDO AL MEN√ö ‚úÖ ‚úÖ ‚úÖ');
        accederMenuATTF();
        return;
    }

    // üö™ CASO 2: NO TIENE TURNO DE HOY = PASO 1 (Configurar turno hoy)
    if (!tieneHoyAlDia) {
        console.log('üö™ CASO 2: NO TIENE TURNO DE HOY - Redirigiendo a Paso 1');
        
        // Limpiar interfaz residual
        const configSec = document.getElementById('configuracionInicialATTF');
        if (configSec) {
            configSec.innerHTML = '';
            configSec.style.display = 'block';
            configSec.classList.remove('hidden');
        }
        
        // Ocultar otros contenedores para evitar superposici√≥n
        const tableSelection = document.getElementById('tableSelectionSection');
        if (tableSelection) tableSelection.style.display = 'none';
        
        const searchSection = document.getElementById('searchSection');
        if (searchSection) {
            searchSection.style.display = 'none';
            searchSection.classList.add('hidden');
        }
        
        console.log('üîß Mostrando configuraci√≥n inicial de turno...');
        mostrarConfiguracionInicialATTF();
        return;
    }

    // üö™ CASO 3: TIENE HOY PERO FALTA MA√ëANA/DESCANSO = PASO 2
console.log('üö™ ==========================================');
console.log('üö™ CASO 3: TIENE TURNO HOY - FALTA CONFIGURAR MA√ëANA');
console.log('üö™ ==========================================');

// ‚úÖ Obtener y validar contador de turnos (DECLARACI√ìN √öNICA)
const contadorTurnos = parseInt(userData.contador_turnos) || 0;
const hoy = getFechaHoyElSalvador();

console.log('üî¢ DIAGN√ìSTICO DE CONTADOR:');
console.log('   ‚Ä¢ Valor en BD:', userData.contador_turnos);
console.log('   ‚Ä¢ Valor parseado:', contadorTurnos);
console.log('   ‚Ä¢ Tipo:', typeof contadorTurnos);

// üîç L√ìGICA CORREGIDA: Diferenciar entre "primer login" y "despu√©s de descanso"
let debeForzarDescanso = false;

if (contadorTurnos >= 5) {
    debeForzarDescanso = true;
    console.log('üìä Contador >= 5: Forzando descanso');
} 
else if (contadorTurnos === 0) {
    const descansoFin = userData.descanso_fecha_fin;
    if (descansoFin && descansoFin <= hoy) {
        debeForzarDescanso = true;
        console.log('üìä Contador=0 + descanso previo terminado: Forzando descanso');
    } else {
        console.log('üìä Contador=0 sin descanso previo: Permitiendo flujo normal');
    }
}

if (debeForzarDescanso) {
    console.log('üèñÔ∏è Redirigiendo a configuraci√≥n de descanso obligatorio');
    mostrarConfiguracionDescansoCiclo();
    return;
} else {
    console.log('‚û°Ô∏è Redirigiendo a Paso 2: Selecci√≥n de turno de ma√±ana');
    mostrarProgramarTurnoMa√±anaConDescanso(userData);
    return;
}
} // ‚úÖ ‚úÖ ‚úÖ CIERRE CORRECTO DE loginATTF ‚úÖ ‚úÖ ‚úÖ




async function resetearTurnosUsuario() {
    if (!currentUser?.id) return;
    
    const confirmar = confirm('¬øResetear configuraci√≥n de turnos? Esto te permitir√° configurar desde cero.');
    if (!confirmar) return;
    
    try {
        await supabaseClient
            .from('usuarios')
            .update({
                turno_hoy: null,
                fecha_turno_hoy: null,
                turno_manana: null,
                fecha_turno_manana: null,
                descanso_fecha_inicio: null,
                descanso_fecha_fin: null,
                turno_regreso: null,
                fecha_turno_regreso: null,
                contador_turnos: 0,
                estado_ciclo: 'primera_vez'
            })
            .eq('id', currentUser.id);
        
        // Limpiar localStorage
        localStorage.removeItem('turno_hoy');
        localStorage.removeItem('turno_manana');
        localStorage.removeItem('descanso_inicio');
        localStorage.removeItem('descanso_fin');
        
        alert('‚úÖ Configuraci√≥n reseteada. Ser√°s redirigido al inicio.');
        logout();
    } catch (err) {
        console.error('Error reseteando turnos:', err);
        alert('‚ùå Error: ' + err.message);
    }
}

function calcularDiasSinActividad(ultimaActividad) {
  if (!ultimaActividad) {
    console.warn('‚ö†Ô∏è ultimaActividad es null/undefined');
    return 999;
  }
  
  const ahora = new Date();
  const ultima = new Date(ultimaActividad);
  
  console.log('üìÖ ==========================================');
  console.log('üìÖ C√ÅLCULO DE D√çAS SIN ACTIVIDAD:');
  console.log('üìÖ ahora (JS):', ahora);
  console.log('üìÖ ultima (JS):', ultima);
  console.log('üìÖ ultimaActividad (raw):', ultimaActividad);
  
  const diffMs = ahora - ultima;
  const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  console.log('üìÖ diffMs:', diffMs);
  console.log('üìÖ diffDias:', diffDias);
  console.log('üìÖ ==========================================');
  
  return diffDias;
}

function mostrarConfiguracionInicialATTF() {
    // ‚úÖ OCULTAR MEN√ö DE M√ìDULOS DURANTE CONFIGURACI√ìN
    const tableSelection = document.getElementById('tableSelectionSection');
    if (tableSelection) tableSelection.style.display = 'none';
    
    // ‚úÖ NUEVO: OCULTAR searchSection PARA ELIMINAR BOT√ìN "VOLVER"
    const searchSection = document.getElementById('searchSection');
    if (searchSection) {
        searchSection.style.display = 'none';
        searchSection.classList.add('hidden');
    }
    
    console.log("üõ†Ô∏è Iniciando Paso 1: Configuraci√≥n de Turno Hoy");
    const ahora = new Date();
    const horaActual = ahora.getHours();
    
    // Determinar qu√© turnos est√°n disponibles seg√∫n la hora
    const turnosDisponibles = [];
    
    Object.entries(TURNOS_ATTF).forEach(([key, turno]) => {
        if (turno.esTurnoNocturno) {
            if (horaActual >= turno.ventanaBotonInicio && horaActual < 24) {
                turnosDisponibles.push({ key, ...turno });
            }
        } else {
            if (horaActual >= turno.ventanaBotonInicio && horaActual < turno.ventanaBotonFin) {
                turnosDisponibles.push({ key, ...turno });
            }
        }
    });
    
    if (turnosDisponibles.length === 0) {
        alert('No hay turnos disponibles en este horario.\n\nIntenta ingresar en el horario de tu turno correspondiente.');
        logout();
        return;
    }
    
   const targetSection = document.getElementById('configuracionInicialATTF');
if (!targetSection) {
    console.error("‚ùå ERROR CR√çTICO: Contenedor 'configuracionInicialATTF' NO EXISTE en el HTML");
    alert("Error de interfaz: Falta el elemento de configuraci√≥n. Contacte al administrador.");
    logout();
    return;
}
const loginSection = document.getElementById('loginSection'); 

    if (targetSection) {
        // 1. Ocultamos el login definitivamente
        if (loginSection) loginSection.style.display = 'none';
        
        // 2. Mostramos el contenedor de destino
        targetSection.style.display = 'block';
        targetSection.classList.remove('hidden');
        
        // 3. Dibujamos la interfaz en el contenedor visible
        targetSection.innerHTML = `
            <div class="card-configuracion" style="max-width: 400px; margin: 20px auto; padding: 25px; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center;">
                <img src="https://cdnimg.bnamericas.com/HFvkiBpeoLTFyPBTjytdbdohtBDrWQsnxgYaUwIlxAEFZVYKsYrwygPFBPYYlShO.png" alt="Logo CLESA" class="logo" style="width: 100px; margin-bottom: 15px;">
                <h1 class="titulo-degradado" style="font-size: 24px; margin-bottom: 5px;">CLESA</h1>
                <p class="subtitulo" style="color: #666; margin-bottom: 20px;">Configura tu Calendario</p>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2196f3; text-align: left;">
                    <strong style="color: #1976d2;">Paso 1 de 2:</strong><br>
                    <span style="font-size: 14px;">Selecciona tu turno de <b>HOY</b></span>
                </div>
                
                <div class="form-group" style="text-align: left; margin-bottom: 20px;">
                    <label style="font-weight: bold; display: block; margin-bottom: 8px; color: #374151;">üåû Turno de HOY:</label>
                    <select id="turnoHoy" class="form-control" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d1d5db; font-size: 16px; background-color: #f9fafb;">
                        <option value="">-- Seleccione su turno --</option>
                        ${turnosDisponibles.map(t => `<option value="${t.key}">${t.nombre}</option>`).join('')}
                    </select>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn" onclick="confirmarTurnoHoyATTF()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 14px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 16px;">
                        Continuar al Paso 2 ‚Üí
                    </button>
                    <button class="btn-link" onclick="logout()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 14px; text-decoration: underline; margin-top: 5px;">
                        Cancelar e ir al inicio
                    </button>
                </div>
            </div>
        `;
    } else {
        console.error("‚ùå ERROR: No se encontr√≥ el contenedor 'configuracionInicialATTF' en el HTML.");
        // Fallback de emergencia por si el desarrollador olvid√≥ el div
        alert("Error de interfaz. Por favor contacte a soporte.");
    }
}


async function confirmarTurnoHoyATTF() {
    console.log("üîç ID del usuario actual:", currentUser?.id);
    console.log("üîç currentUser completo:", currentUser);
    
    // üîç Buscamos el ID correcto (el que se dibuj√≥ en el Paso 1)
    const selectElement = document.getElementById('turnoHoy') || document.getElementById('turnoHoySeleccionado');
    const turnoHoyKey = selectElement?.value;

    if (!turnoHoyKey) {
        alert('Por favor seleccione su turno de hoy');
        return;
    }

    // Confirmaci√≥n visual
    const turnoHoy = TURNOS_ATTF[turnoHoyKey];
    if (!confirm(`¬øConfirmas que tu turno de HOY es:\n\n${turnoHoy.nombre}?`)) return;

    try {
        // Mostrar un peque√±o indicador de carga si tienes uno, o cambiar el texto del bot√≥n
        console.log("‚è≥ Guardando turno de hoy en base de datos...");

        // ‚úÖ CORRECTO - Usa fecha local directamente
const ahora = new Date();
const offset = ahora.getTimezoneOffset() * 60000; // UTC-6 = -360 minutos
const fechaElSalvador = new Date(ahora.getTime() - offset);
const fechaHoyISO = fechaElSalvador.toISOString().split('T')[0];

console.log("üìÖ Fecha calculada:", fechaHoyISO);
console.log("üïê Hora actual SV:", fechaElSalvador.getHours());

        // ‚úÖ GUARDAR EN BD CON MANEJO DE ERRORES
        const { error } = await supabaseClient
            .from('usuarios')
            .update({ 
                turno_hoy: turnoHoyKey,
                fecha_turno_hoy: fechaHoyISO,
                ultima_actividad: new Date().toISOString()
            })
            .eq('id', currentUser.id);

        if (error) {
            console.error("‚ùå Error al guardar en BD:", error);
            throw error;
        }

        console.log("‚úÖ UPDATE ejecutado correctamente");  // ‚Üê AGREGAR ESTA L√çNEA

        // ‚úÖ GUARDADO LOCAL (temporal, se actualizar√° despu√©s con los datos de BD)
        window.turnoHoySeleccionado = turnoHoyKey;
        localStorage.setItem('turno_hoy', turnoHoyKey);
        localStorage.setItem('fecha_turno_hoy', fechaHoyISO);

        console.log("‚úÖ Turno de hoy guardado.");
console.log("üìä Verificando guardado en BD...");

// ‚úÖ CORREGIDO: Desestructuraci√≥n correcta de respuesta Supabase
const { data: verificacion, error: errorVerif } = await supabaseClient
    .from('usuarios')
    .select('turno_hoy, fecha_turno_hoy')
    .eq('id', currentUser.id)
    .single();

if (errorVerif) {
    console.error("‚ùå Error al verificar datos:", errorVerif);
    throw errorVerif;
}

console.log("üîç Datos guardados:", verificacion);

// ‚úÖ ACTUALIZAR currentUser LOCAL
currentUser.turno_hoy = verificacion.turno_hoy;
currentUser.fecha_turno_hoy = verificacion.fecha_turno_hoy;
console.log("üîÑ currentUser actualizado:", currentUser.turno_hoy, currentUser.fecha_turno_hoy);
        // ‚úÖ GUARDAR EN LOCALSTORAGE LA SESI√ìN ACTUALIZADA
        localStorage.setItem('cleca_user_session', JSON.stringify({
            user: currentUser,
            timestamp: Date.now()
        }));
        localStorage.setItem('usuario_logueado', JSON.stringify(currentUser));
        console.log("üíæ Sesi√≥n actualizada en localStorage");

        // ‚úÖ GUARDADO LOCAL DE TURNOS (actualizado con datos de BD)
        window.turnoHoySeleccionado = verificacion.turno_hoy;
        localStorage.setItem('turno_hoy', verificacion.turno_hoy);
        localStorage.setItem('fecha_turno_hoy', verificacion.fecha_turno_hoy);
        localStorage.setItem('turnos_configurados', 'true');

        // üöÄ PASAR AL PASO 2:
        const userDataParaSiguientePaso = {
            turno_hoy: turnoHoyKey,
            contador_turnos: currentUser.contador_turnos || 0
        };

        if (typeof mostrarProgramarTurnoMa√±anaConDescanso === 'function') {
            mostrarProgramarTurnoMa√±anaConDescanso(userDataParaSiguientePaso);
        } else {
            mostrarProgramarTurnoManana(true); 
        }

    } catch (err) {
        console.error('Error cr√≠tico al guardar turno hoy:', err);
        alert('Error de conexi√≥n: No se pudo guardar el turno.');
    }
}


// ========================================
// üîß FUNCI√ìN AUXILIAR BLINDADA: Obtener turnos consecutivos
// ========================================
function getTurnoConsecutivo(turnoHoyKey) {
    // üõ°Ô∏è Seguridad: Si el valor de la tabla es null o undefined, 
    // evitamos que la funci√≥n rompa el resto del c√≥digo.
    if (!turnoHoyKey) return [];

    // Definici√≥n de reglas seg√∫n la operativa de CLESA
    // Aseg√∫rate de que los nombres ("turno3", etc.) coincidan con los IDs 
    // que guardas en la columna 'turno_hoy' de tu tabla 'usuarios'.
    const relaciones = {
        "turno3": ["turno1", "turno4"], // Ejemplo: Saliente de noche no puede entrar a ma√±ana
        "turno1": ["turno3"],           // Ejemplo: Ma√±ana no puede doblar a noche inmediata
        // Puedes agregar m√°s restricciones aqu√≠ abajo:
        // "turno2": ["turno3"], 
    };
    
    // Buscamos si el turno actual tiene restricciones
    const bloqueados = relaciones[turnoHoyKey] || [];
    
    // Log de depuraci√≥n para ver en consola qu√© est√° pasando
    if (bloqueados.length > 0) {
        console.log(`üö´ Restricci√≥n para ${turnoHoyKey}: Bloqueando opciones ${bloqueados.join(', ')}`);
    }

    return bloqueados;
}


// ========================================
// üîÑ FUNCI√ìN MAESTRA UNIFICADA (COMPATIBLE CON AMBAS LLAMADAS)
// ========================================
function mostrarProgramarTurnoManana(userData, mostrarOpcionDescanso = null) {
    
    // === ü™µ LOGS DE ENTRADA ===
    console.log('üîç mostrarProgramarTurnoManana llamada con:', {
        mostrarOpcionDescanso,
        currentUser: currentUser?.usuario,
        turnoHoySeleccionado: window.turnoHoySeleccionado
    });
    
    console.log('üîç DEBUG userData:', JSON.stringify(userData, null, 2));
    console.log('üîç turno_hoy:', userData?.turno_hoy, typeof userData?.turno_hoy);
    console.log('üîç contador_turnos:', userData?.contador_turnos);
    // === FIN LOGS DE ENTRADA ===
    
    // üîÑ DETECTAR MODO DE LLAMADA AUTOM√ÅTICAMENTE
    const esLlamadaLegacy = (typeof userData === 'boolean' || userData === null || userData === undefined);
    
    if (esLlamadaLegacy) {
        // üì¶ MODO LEGACY: Reconstruir userData desde fuentes disponibles
        console.log('üîÑ Modo compatibilidad: reconstruyendo userData');
        
        mostrarOpcionDescanso = (typeof userData === 'boolean') ? userData : mostrarOpcionDescanso;
        
        userData = {
            turno_hoy: window.turnoHoySeleccionado || currentUser?.turno_hoy,
            contador_turnos: parseInt(currentUser?.contador_turnos) || 0,
            estado_ciclo: currentUser?.estado_ciclo || 'ciclo_normal',
            usuario: currentUser?.usuario,
            rol: currentUser?.rol
        };
        
        // === ü™µ LOG POST-RECONSTRUCCI√ìN ===
        console.log('üîÑ userData reconstruido:', {
            turno_hoy: userData.turno_hoy,
            contador_turnos: userData.contador_turnos,
            estado_ciclo: userData.estado_ciclo
        });
    }
    
    // ‚úÖ VALIDACI√ìN CR√çTICA
    if (!userData || !userData.turno_hoy) {
        console.error('‚ùå [DATOS INV√ÅLIDOS] userData no contiene turno_hoy:', userData);
        alert('‚ö†Ô∏è Error: No se pudo cargar la configuraci√≥n. Contacte al administrador.');
        return;
    }
    
    // === ü™µ LOG POST-VALIDACI√ìN ===
    console.log('üõ†Ô∏è INICIANDO: mostrarProgramarTurnoManana (unificada)');
    console.log('üõ†Ô∏è Datos procesados:', {
        turno_hoy: userData.turno_hoy,
        contador: userData.contador_turnos,
        mostrarDescanso: mostrarOpcionDescanso
    });
    
    // ‚úÖ OCULTAR MEN√öS DURANTE CONFIGURACI√ìN
    const tableSelection = document.getElementById('tableSelectionSection');
    if (tableSelection) tableSelection.style.display = 'none';
    
    const searchSection = document.getElementById('searchSection');
    if (searchSection) {
        searchSection.style.display = 'none';
        searchSection.classList.add('hidden');
    }
    
    // ‚úÖ DETERMINAR CONTENEDOR SEG√öN CONTEXTO
    // Prioridad: configuracionInicialATTF > loginSection
    let container = document.getElementById('configuracionInicialATTF');
    let usarLoginSection = false;
    
    if (!container || container.style.display === 'none') {
        container = document.getElementById('loginSection');
        usarLoginSection = true;
    }
    
    if (!container) {
        console.error('‚ùå No se encontr√≥ contenedor v√°lido');
        return;
    }
    
    container.style.display = 'block';
    container.classList.remove('hidden');
    
    // ‚úÖ L√ìGICA DE NEGOCIO
    const turnoHoyKey = userData.turno_hoy;
    const contadorActual = parseInt(userData.contador_turnos) || 0;
    const ahora = new Date();
    
    // Calcular fechas de descanso autom√°tico (solo si aplica)
    const diasHastaDescanso = 5 - contadorActual;
    const fechaDescansoInicio = new Date(ahora);
    fechaDescansoInicio.setDate(fechaDescansoInicio.getDate() + Math.max(1, diasHastaDescanso));
    const fechaDescansoInicioStr = fechaDescansoInicio.toISOString().split('T')[0];
    const fechaDescansoFin = new Date(fechaDescansoInicio);
    fechaDescansoFin.setDate(fechaDescansoFin.getDate() + 1);
    const fechaDescansoFinStr = fechaDescansoFin.toISOString().split('T')[0];
    
    // Obtener turnos consecutivos prohibidos
    const turnosConsecutivos = getTurnoConsecutivo(turnoHoyKey);
    
    // Generar opciones HTML
    let opcionesHTML = '';
    Object.entries(TURNOS_ATTF).forEach(([key, turno]) => {
        if (turnosConsecutivos.includes(key)) {
            opcionesHTML += `<option value="${key}" disabled style="background: #ffdddd; color: #999;">${turno.nombre} (üö´ Consecutivo)</option>`;
        } else {
            opcionesHTML += `<option value="${key}">${turno.nombre}</option>`;
        }
    });
    
    // ‚úÖ AGREGAR OPCI√ìN DE DESCANSO (solo si corresponde)
    const debeMostrarDescanso = (mostrarOpcionDescanso === true) || (contadorActual >= 4);
    if (debeMostrarDescanso) {
        opcionesHTML += `<option value="descanso" style="background: #fff3cd; font-weight: bold; border-top: 2px solid #ffc107; margin-top: 5px;">üèñÔ∏è DESCANSO (D√≠a ${Math.max(2, diasHastaDescanso + 1)})</option>`;
    }
    
    // ‚úÖ DEFINIR T√çTULOS SEG√öN CONTEXTO
    const esPaso2Explicito = mostrarOpcionDescanso === true || userData.forzarPaso2;
    const tituloPaso = esPaso2Explicito ? 'Paso 2 de 2' : `D√≠a ${contadorActual + 1} ‚Üí ${contadorActual + 2}`;
    const instruccion = esPaso2Explicito 
        ? 'Selecciona tu turno de MA√ëANA o configura DESCANSO' 
        : 'Selecciona tu turno de MA√ëANA';
    
    // ‚úÖ INYECTAR HTML (adaptado al contenedor)
    const htmlBase = usarLoginSection ? `
        <img src="https://cdnimg.bnamericas.com/HFvkiBpeoLTFyPBTjytdbdohtBDrWQsnxgYaUwIlxAEFZVYKsYrwygPFBPYYlShO.png" alt="Logo CLESA" class="logo">
        <h1 class="titulo-degradado">CLESA</h1>
    ` : `
        <img src="https://cdnimg.bnamericas.com/HFvkiBpeoLTFyPBTjytdbdohtBDrWQsnxgYaUwIlxAEFZVYKsYrwygPFBPYYlShO.png" alt="Logo CLESA" class="logo" style="width: 80px; display: block; margin: 0 auto;">
        <h2 class="titulo-degradado" style="text-align: center; font-size: 24px;">CLESA</h2>
    `;
    
    container.innerHTML = `
        <div class="card-configuracion" style="animation: slideUp 0.3s ease-out;">
            ${htmlBase}
            <p class="subtitulo" style="text-align: center;">${tituloPaso}</p>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #2196f3; text-align: left;">
                <strong>üìã ${instruccion}</strong><br>
                <small style="color: #666;">Turno actual: ${TURNOS_ATTF[turnoHoyKey]?.nombre || '‚Äî'}</small>
            </div>
            
            <div class="form-group" style="text-align: left;">
                <label style="font-weight: bold; display: block; margin-bottom: 8px;">üîÑ Turno de MA√ëANA:</label>
                <select id="turnoManana" class="form-control" onchange="verificarSeleccionDescanso()" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
                    <option value="">-- Seleccione --</option>
                    ${opcionesHTML}
                </select>
            </div>
            
            <!-- ‚úÖ SECCI√ìN DE DESCANSO (se muestra/oculta din√°micamente) -->
            <div id="seccionDescanso" style="display: none; margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
                <strong style="color: #e65100; display: block; margin-bottom: 10px;">üèñÔ∏è Configuraci√≥n de Descanso</strong>
                
                <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>üìÖ Fechas programadas:</strong><br>
                    <span style="font-size: 14px;">Inicio: <b>${fechaDescansoInicioStr}</b> | Fin: <b>${fechaDescansoFinStr}</b></span>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: bold; display: block; margin-bottom: 8px;">üîô Turno de REGRESO:</label>
                    <select id="turnoRegreso" class="form-control" style="width: 100%; padding: 10px; border-radius: 8px;">
                        <option value="">-- Seleccione --</option>
                        ${Object.entries(TURNOS_ATTF).map(([key, turno]) => 
                            `<option value="${key}">${turno.nombre}</option>`
                        ).join('')}
                    </select>
                </div>
            </div>
            
            <button id="btnConfirmarManana" class="btn" onclick="confirmarTurnoMananaATTF()" style="margin-top: 20px; width: 100%; display: none;">
                ‚úÖ Confirmar y Continuar
            </button>
            
            ${!usarLoginSection ? `
            <button class="btn btn-danger" onclick="logout()" style="margin-top: 10px; width: 100%; padding: 10px; border-radius: 8px; border: none; cursor: pointer;">
                Cancelar y Salir
            </button>
            ` : ''}
        </div>
    `;
    
        // ‚úÖ INICIALIZAR COMPORTAMIENTO DIN√ÅMICO
    if (typeof verificarSeleccionDescanso === 'function') {
        setTimeout(() => verificarSeleccionDescanso(), 100);
    }
    
    // === ü™µ LOG FINAL DE RENDERIZADO ===
    console.log('‚úÖ Interfaz renderizada - Verificando elementos creados:');
    console.log('   ‚Ä¢ #turnoManana:', document.getElementById('turnoManana') ? '‚úÖ Existe' : '‚ùå No existe');
    console.log('   ‚Ä¢ #seccionDescanso:', document.getElementById('seccionDescanso') ? '‚úÖ Existe' : '‚ùå No existe');
    console.log('   ‚Ä¢ #btnConfirmarManana:', document.getElementById('btnConfirmarManana') ? '‚úÖ Existe' : '‚ùå No existe');
    console.log('   ‚Ä¢ Container visible:', container.style.display);
    
    console.log('‚úÖ Interfaz renderizada exitosamente');
}




/**
 * Verifica selecci√≥n de turno y actualiza interfaz din√°micamente
 * - Descanso: Muestra formulario con validaci√≥n de fechas (d√≠a 2-6)
 * - Turno normal: Oculta secci√≥n de descanso
 * - Sin selecci√≥n: Oculta elementos
 */
function verificarSeleccionDescanso() {
    const turnoManana = document.getElementById('turnoManana')?.value;
    const seccionDescanso = document.getElementById('seccionDescanso');
    const btnConfirmar = document.getElementById('btnConfirmarManana');
    
    // üîí Validaci√≥n de seguridad
    if (!seccionDescanso || !btnConfirmar) {
        console.warn('‚ö†Ô∏è Elementos DOM no encontrados');
        return;
    }

// üîç AGREGA ESTE DIAGN√ìSTICO AQU√ç:
    console.group('üîç DIAGN√ìSTICO verifSeleccionDescanso');
    console.log('1. currentUser existe:', !!currentUser);
    console.log('2. Rol:', currentUser?.rol);
    console.log('3. Select turnoManana existe:', !!document.getElementById('turnoManana'));
    console.log('4. Secci√≥n descanso existe:', !!seccionDescanso);
    console.log('5. Valor seleccionado:', turnoManana);
    console.log('6. Descanso activo en BD:', currentUser?.descanso_fecha_inicio);
    console.groupEnd();
    
    if (turnoManana === 'descanso') {
        const { min, max } = obtenerLimitesFechasDescanso();
        seccionDescanso.style.display = 'block';
        seccionDescanso.innerHTML = generarFormularioDescanso(min, max);
        btnConfirmar.style.display = 'block';
        btnConfirmar.textContent = '‚úÖ Confirmar Descanso';
        
    } else if (turnoManana) {
        seccionDescanso.style.display = 'none';
        btnConfirmar.style.display = 'block';
        btnConfirmar.textContent = '‚úÖ Confirmar Turno';
    } else {
        seccionDescanso.style.display = 'none';
        btnConfirmar.style.display = 'none';
    }
}

/**
 * Calcula l√≠mites de fechas para descanso (d√≠a 2 a d√≠a 6)
 * @returns {{min: string, max: string}} Fechas en formato YYYY-MM-DD
 */
function obtenerLimitesFechasDescanso() {
    const ahora = new Date();
    
    const min = new Date(ahora);
    min.setDate(min.getDate() + 1); // D√≠a 2
    
    const max = new Date(ahora);
    max.setDate(max.getDate() + 5); // D√≠a 6
    
    return {
        min: min.toISOString().split('T')[0],
        max: max.toISOString().split('T')[0]
    };
}

/**
 * Genera HTML del formulario de descanso
 */
function generarFormularioDescanso(fechaMin, fechaMax) {
    return `
        <div style="background:#fff3cd;padding:15px;border-radius:10px;margin-bottom:15px;border-left:4px solid #ffc107">
            <strong>Configura tu descanso:</strong>
            <p style="margin:10px 0 0;font-size:14px;color:#666">
                ‚ö†Ô∏è Inicio entre <strong>ma√±ana</strong> (d√≠a 2) y m√°ximo <strong>5 d√≠as despu√©s</strong> (d√≠a 6)
            </p>
        </div>
        <div class="form-group">
            <label>Primer d√≠a de descanso:</label>
            <input type="date" id="fechaDescansoInicio" class="form-control"
                   min="${fechaMin}" max="${fechaMax}" onchange="calcularFechaFin()"
                   style="width:100%;padding:12px;border-radius:8px;border:2px solid #e1e5e9;font-size:16px">
            <small style="color:#666">M√≠n: ${fechaMin} | M√°x: ${fechaMax}</small>
        </div>
        <div class="form-group">
            <label>Segundo d√≠a de descanso:</label>
            <input type="date" id="fechaDescansoFin" class="form-control" readonly
                   style="width:100%;padding:12px;border-radius:8px;border:2px solid #e1e5e9;font-size:16px;background:#f5f5f5">
            <small style="color:#666">Se calcula autom√°ticamente</small>
        </div>
        <div class="form-group">
            <label>Turno de REGRESO:</label>
            <select id="turnoRegreso" class="form-control" style="width:100%;padding:12px;border-radius:8px;border:2px solid #e1e5e9;font-size:16px">
                <option value="">-- Seleccione --</option>
                ${Object.entries(TURNOS_ATTF).map(([k,t])=>`<option value="${k}">${t.nombre}</option>`).join('')}
            </select>
        </div>
    `;
}


/**
 * Calcula fecha de fin de descanso (d√≠a consecutivo)
 */
function calcularFechaFin() {
    const fechaInicio = document.getElementById('fechaDescansoInicio')?.value;
    const inputFin = document.getElementById('fechaDescansoFin');
    
    if (!fechaInicio || !inputFin) {
        console.warn('‚ö†Ô∏è Elementos DOM no encontrados');
        return;
    }
    
    try {
        const fecha = new Date(fechaInicio + 'T00:00:00');
        if (isNaN(fecha.getTime())) throw new Error('Fecha inv√°lida');
        
        fecha.setDate(fecha.getDate() + 1);
        inputFin.value = fecha.toISOString().split('T')[0];
        
    } catch (error) {
        console.error('‚ùå Error calculando fecha:', error);
        alert('‚ö†Ô∏è Error al calcular fecha. Intente nuevamente.');
    }
}

async function confirmarTurnoMananaATTF() {
    console.log('üîç ==========================================');
    console.log('üîç INICIANDO: confirmarTurnoMananaATTF');
    console.log('üîç Usuario:', currentUser?.usuario || 'NO DISPONIBLE');
    console.log('üîç ID Usuario:', currentUser?.id || 'NO DISPONIBLE');
    console.log('üîç Estado currentUser:', currentUser ? '‚úÖ EXISTE' : '‚ùå NULL/UNDEFINED');
    console.log('üîç ==========================================');
    console.log('currentUser:', currentUser);
    console.log('turno_hoy:', currentUser?.turno_hoy);
    console.log('turno_manana:', currentUser?.turno_manana);
    console.log('descanso_fecha_inicio:', currentUser?.descanso_fecha_inicio);
    console.log('descanso_fecha_fin:', currentUser?.descanso_fecha_fin);

    // ‚úÖ VALIDACI√ìN CR√çTICA 0: Verificar sesi√≥n activa
    if (!currentUser || !currentUser.id) {
        console.error('‚ùå [FATAL] Sesi√≥n inv√°lida - currentUser no existe o carece de ID');
        alert('‚ö†Ô∏è Error de sesi√≥n. Por favor, vuelva a iniciar sesi√≥n.');
        logout();
        return;
    }

    // 1. Validaciones Iniciales
    const selectManana = document.getElementById('turnoManana');
    if (!selectManana) {
        console.error('‚ùå [ERROR CR√çTICO] Elemento "turnoManana" NO ENCONTRADO en el DOM');
        alert('‚ö†Ô∏è Error de interfaz: Recargue la p√°gina e intente nuevamente');
        return;
    }

    const turnoManana = selectManana.value;
    if (!turnoManana) {
        console.warn('‚ö†Ô∏è [VALIDACI√ìN] Turno de ma√±ana no seleccionado');
        alert('Por favor seleccione el turno de ma√±ana');
        return;
    }

    const ahora = getFechaElSalvador();
    const fechaHoy = getFechaHoyElSalvador();
    const turnoHoy = window.turnoHoySeleccionado || currentUser.turno_hoy;

    if (!turnoHoy) {
        console.error('‚ùå [DATOS FALTANTES] Turno de hoy no detectado');
        alert("Error: No se detect√≥ el turno de hoy. Reintente el paso 1.");
        return;
    }

    console.log(`üìä Datos iniciales:`, {
        turnoHoy,
        fechaHoy,
        turnoManana,
        contadorActual: currentUser.contador_turnos,
        estadoCiclo: currentUser.estado_ciclo
    });

    // --- CASO 1: TURNO NORMAL ---
    if (turnoManana !== 'descanso') {
        console.log('‚úÖ CASO 1: Guardando TURNO NORMAL (no descanso)');
        
        const turno = TURNOS_ATTF[turnoManana];
        if (!confirm(`¬øConfirmas que tu turno de MA√ëANA ser√°:\n\n${turno.nombre}?`)) {
            console.log('‚ÑπÔ∏è Usuario cancel√≥ la confirmaci√≥n');
            return;
        }

        const manana = new Date(ahora);
        manana.setDate(manana.getDate() + 1);
        const fechaMananaStr = formatearFechaElSalvador(manana);
        
        // ‚úÖ CALCULAR CONTADOR PRIMERO (para que los logs lo puedan usar)
        const contadorActual = parseFloat(currentUser.contador_turnos) || 0;
        const nuevoContador = contadorActual + 1;

        // ‚úÖ LOG DEL CONTADOR (AHORA que nuevoContador ya est√° definido)
        console.log('üíæ Guardando contador:', {
            antes: currentUser.contador_turnos,
            despues: nuevoContador,
            usuario: currentUser.id
        });

        console.log('üíæ Datos a guardar (TURNO NORMAL):', {
            turno_hoy: turnoHoy,
            fecha_turno_hoy: fechaHoy, // ‚úÖ ¬°CR√çTICO! Sincronizar con HOY real
            turno_manana: turnoManana,
            fecha_turno_manana: fechaMananaStr,
            contador_turnos: nuevoContador,
            estado_ciclo: 'ciclo_normal'
        });

        try {
            console.log('‚è≥ Enviando UPDATE a Supabase...');
            const { data, error } = await supabaseClient
                .from('usuarios')
                .update({
                    turno_hoy: turnoHoy,
                    fecha_turno_hoy: fechaHoy, // ‚úÖ ¬°CORREGIDO! Actualizar fecha_turno_hoy a HOY real
                    turno_manana: turnoManana,
                    fecha_turno_manana: fechaMananaStr,
                    contador_turnos: nuevoContador,
                    estado_ciclo: 'ciclo_normal',
                    descanso_fecha_inicio: null,
                    descanso_fecha_fin: null,
                    ultimaconexion: formatearFechaCompletaElSalvador(getFechaElSalvador()),
                    ultima_actividad: formatearFechaCompletaElSalvador(getFechaElSalvador())
                })
                .eq('id', currentUser.id)
                .select('id, turno_hoy, fecha_turno_hoy, turno_manana, fecha_turno_manana, contador_turnos, estado_ciclo');

            if (error) {
                throw new Error(`Supabase: ${error.message} | C√≥digo: ${error.code}`);
            }

            // ‚úÖ SINCRONIZAR currentUser LOCAL (CR√çTICO PARA ROLL FORWARD)
            if (data && data[0]) {
                // Actualizar currentUser con datos frescos de BD
                Object.assign(currentUser, data[0]);

                // ‚úÖ NUEVO: Sincronizaci√≥n inmediata en localStorage
                localStorage.setItem('contador_turnos', nuevoContador.toString());
                console.log('‚úÖ [LOCALSTORAGE] Contador sincronizado:', nuevoContador);
                
                console.log('‚úÖ [√âXITO] Datos sincronizados en currentUser:', {
                    turno_hoy: currentUser.turno_hoy,
                    fecha_turno_hoy: currentUser.fecha_turno_hoy,
                    turno_manana: currentUser.turno_manana,
                    fecha_turno_manana: currentUser.fecha_turno_manana,
                    contador_turnos: currentUser.contador_turnos,
                    estado_ciclo: currentUser.estado_ciclo
                });
                
                // ‚úÖ LOG DE AUDITOR√çA POST-GUARDADO
                console.log('üîç [AUDITOR√çA] Verificaci√≥n post-guardado:');
                console.log(`   ‚Ä¢ Turno HOY: ${currentUser.turno_hoy} (${currentUser.fecha_turno_hoy})`);
                console.log(`   ‚Ä¢ Turno MA√ëANA: ${currentUser.turno_manana} (${currentUser.fecha_turno_manana})`);
                console.log(`   ‚Ä¢ Contador: ${currentUser.contador_turnos}/5`);
            }

            // Guardado Local (Backup)
            localStorage.setItem('turno_hoy', currentUser.turno_hoy);
            localStorage.setItem('fecha_turno_hoy', currentUser.fecha_turno_hoy);
            localStorage.setItem('turno_manana', currentUser.turno_manana);
            localStorage.setItem('fecha_turno_manana', currentUser.fecha_turno_manana);
            localStorage.setItem('contador_turnos', currentUser.contador_turnos.toString());

            console.log('‚úÖ [LOCALSTORAGE] Backup guardado exitosamente');
            cerrarConfiguracionYEntrar();

        } catch (err) {
            console.error('‚ùå [ERROR CASO 1 - TURNO NORMAL]:', {
                mensaje: err.message,
                stack: err.stack?.split('\n').slice(0, 3).join('\n'),
                timestamp: new Date().toISOString(),
                usuario: currentUser.usuario,
                id: currentUser.id
            });
            alert(`‚ùå Error al guardar turno:\n${err.message}\n\nVerifique la consola para detalles.`);
        }

    }


    // --- CASO 2: DESCANSO ---
else {
    console.log('‚úÖ CASO 2: Guardando CONFIGURACI√ìN DE DESCANSO');
    
    // ‚úÖ VALIDACI√ìN MEJORADA CON CAMPOS ESPEC√çFICOS
    const fechaInicioInput = document.getElementById('fechaDescansoInicio');
    const fechaFinInput = document.getElementById('fechaDescansoFin');
    const turnoRegresoInput = document.getElementById('turnoRegreso');

    let fechaInicio = fechaInicioInput?.value?.trim();
    let fechaFin = fechaFinInput?.value?.trim();
    const turnoRegreso = turnoRegresoInput?.value?.trim();

    console.log('üîç DEBUG VALIDACI√ìN:', { fechaInicio, fechaFin, turnoRegreso });

    // Validaci√≥n espec√≠fica por campo
    if (!fechaInicio) {
        alert('‚ö†Ô∏è Por favor selecciona el PRIMER D√çA de descanso');
        fechaInicioInput?.focus();
        return;
    }

    if (!fechaFin) {
        // Intentar calcular autom√°ticamente si falta
        if (fechaInicio) {
            const fecha = new Date(fechaInicio + 'T00:00:00');
            fecha.setDate(fecha.getDate() + 1);
            const fechaCalculada = fecha.toISOString().split('T')[0];
            
            if (fechaFinInput) fechaFinInput.value = fechaCalculada;
            fechaFin = fechaCalculada;
            console.log('‚úÖ Fecha fin calculada autom√°ticamente:', fechaFin);
        } else {
            alert('‚ö†Ô∏è No se pudo calcular la fecha de fin');
            return;
        }
    }

    if (!turnoRegreso) {
        alert('‚ö†Ô∏è Por favor selecciona el turno de REGRESO');
        turnoRegresoInput?.focus();
        return;
    }

        if (!confirm(`¬øConfirmas tu configuraci√≥n de descanso?\nInicio: ${fechaInicio}\nFin: ${fechaFin}`)) {
            console.log('‚ÑπÔ∏è Usuario cancel√≥ la confirmaci√≥n de descanso');
            return;
        }

        const fechaRegresoDate = new Date(fechaFin + 'T00:00:00');
        fechaRegresoDate.setDate(fechaRegresoDate.getDate() + 1);
        const fechaRegresoStr = formatearFechaElSalvador(fechaRegresoDate);
const fechaTurnoMananaStr = formatearFechaElSalvador(new Date(fechaInicio + 'T00:00:00'));

        console.log('üíæ Datos a guardar (DESCANSO):', {
            turno_hoy: turnoHoy,
            fecha_turno_hoy: fechaHoy, // ‚úÖ ¬°CR√çTICO! Sincronizar con HOY real
            descanso_fecha_inicio: fechaInicio,
            descanso_fecha_fin: fechaFin,
            turno_regreso: turnoRegreso,
            fecha_turno_regreso: fechaRegresoStr,
            turno_manana: 'descanso',
            fecha_turno_manana: fechaTurnoMananaStr,
            contador_turnos: 0,
            estado_ciclo: 'ciclo_normal'
        });

        try {
            console.log('‚è≥ Enviando UPDATE de DESCANSO a Supabase...');
            const { data, error } = await supabaseClient
                .from('usuarios')
                .update({
                    turno_hoy: turnoHoy,
                    fecha_turno_hoy: fechaHoy, // ‚úÖ ¬°CORREGIDO! Actualizar fecha_turno_hoy a HOY real
                    descanso_fecha_inicio: fechaInicio,
                    descanso_fecha_fin: fechaFin,
                    turno_regreso: turnoRegreso,
                    fecha_turno_regreso: fechaRegresoStr,
                    contador_turnos: 0,
                    estado_ciclo: 'ciclo_normal',
                    turno_manana: 'descanso',
                    fecha_turno_manana: fechaTurnoMananaStr,
                    ultimaconexion: formatearFechaCompletaElSalvador(getFechaElSalvador()),
                    ultima_actividad: formatearFechaCompletaElSalvador(getFechaElSalvador())
                })
                .eq('id', currentUser.id)
                .select('id, turno_manana, fecha_turno_manana, descanso_fecha_inicio, contador_turnos, estado_ciclo');

            if (error) {
                throw new Error(`Supabase: ${error.message} | C√≥digo: ${error.code}`);
            }

            // ‚úÖ SINCRONIZAR currentUser LOCAL
            if (data && data[0]) {
                Object.assign(currentUser, data[0]);
                
                console.log('‚úÖ [√âXITO] Datos de descanso sincronizados en currentUser:', {
                    turno_manana: currentUser.turno_manana,
                    fecha_turno_manana: currentUser.fecha_turno_manana,
                    descanso_fecha_inicio: currentUser.descanso_fecha_inicio,
                    contador_turnos: currentUser.contador_turnos,
                    estado_ciclo: currentUser.estado_ciclo
                });
                
                // ‚úÖ LOG DE AUDITOR√çA POST-GUARDADO
                console.log('üîç [AUDITOR√çA] Verificaci√≥n post-guardado:');
                console.log(`   ‚Ä¢ Turno HOY: ${currentUser.turno_hoy} (${currentUser.fecha_turno_hoy})`);
                console.log(`   ‚Ä¢ Descanso: ${currentUser.descanso_fecha_inicio} al ${currentUser.descanso_fecha_fin}`);
                console.log(`   ‚Ä¢ Turno regreso: ${currentUser.turno_regreso} (${currentUser.fecha_turno_regreso})`);
            }

            // Guardado Local (Backup)
            localStorage.setItem('turno_hoy', currentUser.turno_hoy);
            localStorage.setItem('fecha_turno_hoy', currentUser.fecha_turno_hoy);
            localStorage.setItem('turno_manana', currentUser.turno_manana);
            localStorage.setItem('fecha_turno_manana', currentUser.fecha_turno_manana);
            localStorage.setItem('descanso_inicio', currentUser.descanso_fecha_inicio);
            localStorage.setItem('descanso_fin', currentUser.descanso_fecha_fin);
            localStorage.setItem('contador_turnos', currentUser.contador_turnos.toString());

            console.log('‚úÖ [LOCALSTORAGE] Backup de descanso guardado exitosamente');
            cerrarConfiguracionYEntrar();

        } catch (err) {
            console.error('‚ùå [ERROR CASO 2 - DESCANSO]:', {
                mensaje: err.message,
                stack: err.stack?.split('\n').slice(0, 3).join('\n'),
                timestamp: new Date().toISOString(),
                usuario: currentUser.usuario,
                id: currentUser.id,
                datosIntentados: {
                    fecha_turno_manana: fechaTurnoMananaStr,
                    descanso_fecha_inicio: fechaInicio
                }
            });
            alert(`‚ùå Error al guardar descanso:\n${err.message}\n\nVerifique la consola para detalles.`);
        }
    }
    
    console.log('üîç ==========================================');
    console.log('üîç FINALIZADO: confirmarTurnoMananaATTF');
    console.log('üîç ==========================================');
}


// ‚úÖ AGREGAR SOLO SI TIENES: mostrarForzarDescansoATTF()
// Estas funciones son para el flujo cuando contador_turnos >= 5

// 1. Funci√≥n auxiliar para guardar descanso (refactorizaci√≥n opcional)
async function guardarConfiguracionDescanso(fechaInicio, fechaFin, turnoRegreso, fechaHoy, turnoHoy) {
    const fechaRegresoDate = new Date(fechaFin + 'T00:00:00');
    fechaRegresoDate.setDate(fechaRegresoDate.getDate() + 1);
    const fechaRegresoStr = formatearFechaElSalvador(fechaRegresoDate);
    const fechaTurnoMananaStr = formatearFechaElSalvador(new Date(fechaInicio + 'T00:00:00'));

    const { error } = await supabaseClient
        .from('usuarios')
        .update({
            turno_hoy: turnoHoy,
            fecha_turno_hoy: fechaHoy,
            descanso_fecha_inicio: fechaInicio,
            descanso_fecha_fin: fechaFin,
            turno_regreso: turnoRegreso,
            fecha_turno_regreso: fechaRegresoStr,
            contador_turnos: 0,
            estado_ciclo: 'ciclo_normal',
            turno_manana: 'descanso',
            fecha_turno_manana: fechaTurnoMananaStr,
            ultimaconexion: formatearFechaCompletaElSalvador(getFechaElSalvador()),
            ultima_actividad: formatearFechaCompletaElSalvador(getFechaElSalvador())
        })
        .eq('id', currentUser.id);

    return { error, fechaRegresoStr, fechaTurnoMananaStr };
}

// 2. Funci√≥n para mostrar interfaz de descanso por ciclo completado
function mostrarConfiguracionDescansoCiclo() {
    const targetSection = document.getElementById('configuracionInicialATTF') || 
                         document.getElementById('searchSection');
    if (!targetSection) return;

    targetSection.innerHTML = `
        <div class="card-configuracion" style="padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: 20px auto;">
            <h2 class="titulo-degradado" style="text-align: center;">üéØ Ciclo Completado - Descanso Obligatorio</h2>
            <p style="text-align: center; color: #666; font-size: 14px; margin-bottom: 20px;">
                Has completado 5 turnos. Configura tu descanso de 2 d√≠as.
            </p>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>üóìÔ∏è Primer d√≠a de descanso:</label>
                <input type="date" id="descansoInicioCiclo" class="form-control" 
                       min="${getFechaHoyElSalvador()}" onchange="calcularFinDescansoCiclo()">
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>üóìÔ∏è Segundo d√≠a de descanso:</label>
                <input type="date" id="descansoFinCiclo" class="form-control" readonly>
            </div>
            <div class="form-group" style="margin-bottom: 20px;">
                <label>üîô Turno de REGRESO:</label>
                <select id="turnoRegresoCiclo" class="form-control">
                    <option value="">-- Seleccione --</option>
                    ${Object.entries(TURNOS_ATTF).map(([key, turno]) => 
                        `<option value="${key}">${turno.nombre}</option>`
                    ).join('')}
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn" onclick="guardarDescansoCiclo()" style="background: #4caf50; color: white;">‚úÖ Confirmar</button>
                <button class="btn" onclick="accederMenuATTF()" style="background: #e2e8f0; color: #475569;">‚Ü© Cancelar</button>
            </div>
        </div>
    `;
    targetSection.style.display = 'block';
}

// 3. Funci√≥n para calcular fecha fin autom√°ticamente
function calcularFinDescansoCiclo() {
    const inicio = document.getElementById('descansoInicioCiclo')?.value;
    const finInput = document.getElementById('descansoFinCiclo');
    
    if (!inicio || !finInput) return;
    
    const fecha = new Date(inicio + 'T00:00:00');
    fecha.setDate(fecha.getDate() + 1);
    finInput.value = fecha.toISOString().split('T')[0];
}

// 4. Funci√≥n para guardar descanso del ciclo
async function guardarDescansoCiclo() {
    const fechaInicio = document.getElementById('descansoInicioCiclo')?.value;
    const fechaFin = document.getElementById('descansoFinCiclo')?.value;
    const turnoRegreso = document.getElementById('turnoRegresoCiclo')?.value;
    
    if (!fechaInicio || !fechaFin || !turnoRegreso) {
        alert('‚ö†Ô∏è Por favor complete todos los campos');
        return;
    }
    
    const { error } = await guardarConfiguracionDescanso(
        fechaInicio, fechaFin, turnoRegreso,
        getFechaHoyElSalvador(), currentUser.turno_hoy
    );
    
    if (error) {
        alert('‚ùå Error al guardar: ' + error.message);
        return;
    }
    
    // Actualizar localStorage
    localStorage.setItem('turno_manana', 'descanso');
    localStorage.setItem('descanso_inicio', fechaInicio);
    localStorage.setItem('descanso_fin', fechaFin);
    
    alert('‚úÖ Descanso obligatorio configurado');
    
    // ‚úÖ NUEVO: Peque√±o delay para asegurar que la BD proces√≥ el update
    await new Promise(resolve => setTimeout(resolve, 100)); // Esperar 100ms
    
    // Ahora s√≠, acceder al men√∫
    accederMenuATTF();
}



// 5. Funci√≥n auxiliar para formatear fecha (si no la tienes)
function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr + 'T00:00:00');
    return date.toLocaleDateString('es-ES', { 
        weekday: 'short', 
        day: 'numeric', 
        month: 'short' 
    });
}


/**
 * Funci√≥n auxiliar para evitar repetir c√≥digo de salida
 */
function cerrarConfiguracionYEntrar() {
    console.log('üö™ ==========================================');
    console.log('üö™ INICIANDO: cerrarConfiguracionYEntrar');
    console.log('üö™ ==========================================');
    
    const configSec = document.getElementById('configuracionInicialATTF') || document.getElementById('searchSection');
    if (configSec) {
        configSec.style.display = 'none';
        configSec.innerHTML = ''; // Limpiar contenido para evitar conflictos
        console.log('‚úÖ Contenedor de configuraci√≥n limpiado y oculto');
    } else {
        console.warn('‚ö†Ô∏è Contenedor de configuraci√≥n no encontrado (ya limpiado)');
    }
    
    if (typeof accederMenuATTF === 'function') {
        console.log('‚úÖ Llamando a accederMenuATTF()');
        try {
            accederMenuATTF();
            console.log('‚úÖ accederMenuATTF() ejecutado exitosamente');
        } catch (err) {
            console.error('‚ùå Error al ejecutar accederMenuATTF:', {
                mensaje: err.message,
                stack: err.stack?.split('\n').slice(0, 3).join('\n')
            });
            alert('‚ö†Ô∏è Error al cargar el men√∫. Recargando p√°gina...');
            location.reload();
        }
    } else {
        console.error('‚ùå accederMenuATTF NO est√° definida');
        console.log("‚úÖ Configuraci√≥n guardada. Refrescando para aplicar cambios...");
        location.reload();
    }
    
    console.log('üö™ ==========================================');
    console.log('üö™ FINALIZADO: cerrarConfiguracionYEntrar');
    console.log('üö™ ==========================================');
}


function mostrarProgramarTurnoMa√±anaConDescanso(userData) {
    if (!userData) {
        console.error('‚ùå userData no proporcionado');
        return;
    }
    if (typeof mostrarProgramarTurnoManana !== 'function') {
        console.error('‚ùå mostrarProgramarTurnoManana no est√° definida');
        alert('Error de sistema. Contacte al administrador.');
        return;
    }
    mostrarProgramarTurnoManana(userData, true);
}



// ========================================
// üÜï FUNCI√ìN AUXILIAR: Verificar y confirmar
// ========================================
function verificarYConfirmarTurnoManana(fechaDescansoInicioStr, fechaDescansoFinStr) {
    const turnoMananaSelect = document.getElementById('turnoManana');
if (!turnoMananaSelect) {
    console.error('‚ùå Select turnoManana no encontrado en DOM');
    return;
}
const turnoManana = turnoMananaSelect.value;
    
    if (turnoManana === 'descanso') {
        // Validar que se seleccion√≥ turno de regreso
        const turnoRegreso = document.getElementById('turnoRegreso').value;
        if (!turnoRegreso) {
            alert('‚ö†Ô∏è Por favor seleccione el turno de regreso');
            return;
        }
        // Llamar a validarDescansoATTF
        validarDescansoATTF(fechaDescansoInicioStr, fechaDescansoFinStr);
    } else {
        // Llamar a confirmarTurnoMananaATTF directamente
        confirmarTurnoMananaATTF();
    }
}

	// ========================================
// ‚ö†Ô∏è VALIDAR DESCANSO PROGRAMADO (CORREGIDA)
// ========================================
function validarDescansoATTF(fechaInicioAuto, fechaFinAuto) {
    console.log('üîç ==========================================');
    console.log('üîç INICIANDO: validarDescansoATTF');
    console.log('üîç Fechas autom√°ticas:', { inicio: fechaInicioAuto, fin: fechaFinAuto });
    console.log('üîç ==========================================');

    // 1. Obtener el turno que seleccion√≥ el usuario
    const turnoMananaSelect = document.getElementById('turnoManana');
    const turnoManana = turnoMananaSelect?.value;
    
    // ‚úÖ VALIDACI√ìN √öNICA (eliminar duplicado)
    if (!turnoManana || !turnoMananaSelect) {
        console.error('‚ùå [VALIDACI√ìN] Turno de ma√±ana no disponible en DOM');
        alert('Por favor seleccione el turno de ma√±ana antes de continuar');
        return;
    }
    
    // Guardar en variable global para el siguiente paso
    window.turnoMa√±anaSeleccionado = turnoManana;
    console.log(`‚úÖ Turno de ma√±ana seleccionado: ${turnoManana}`);
    
    // ‚úÖ VALIDAR CONTENEDOR DE CONFIGURACI√ìN
    const targetSection = document.getElementById('configuracionInicialATTF');
    if (!targetSection) {
        console.error("‚ùå ERROR CR√çTICO: Contenedor 'configuracionInicialATTF' NO EXISTE en el HTML");
        alert("Error de interfaz: Falta el elemento de configuraci√≥n. Contacte al administrador.");
        logout();
        return;
    }
    
    // Aseguramos que sea visible
    targetSection.style.display = 'block';
    targetSection.classList.remove('hidden');

    targetSection.innerHTML = `
        <div class="card-configuracion" style="padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <img src="https://cdnimg.bnamericas.com/HFvkiBpeoLTFyPBTjytdbdohtBDrWQsnxgYaUwIlxAEFZVYKsYrwygPFBPYYlShO.png" alt="Logo CLESA" class="logo" style="width: 80px; display: block; margin: 0 auto;">
            <h2 class="titulo-degradado" style="text-align: center;">Confirmaci√≥n de Descanso</h2>
            
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107; text-align: left;">
                <strong style="font-size: 16px; color: #856404;">‚ö†Ô∏è Tus pr√≥ximos d√≠as de descanso ser√°n:</strong><br><br>
                <div style="font-size: 22px; font-weight: 700; color: #2d3748; text-align: center;">
                    üìÖ ${fechaInicioAuto}<br>
                    üìÖ ${fechaFinAuto}
                </div>
                <p style="margin-top:15px; font-size: 13px; color: #666; text-align: center;">
                    Turno para ma√±ana: <b>${turnoManana}</b>
                </p>
            </div>
            
            <div class="action-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button class="btn" onclick="confirmarDescansoAutomaticoATTF('${fechaInicioAuto}', '${fechaFinAuto}')" 
                        style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    ‚úÖ Aceptar
                </button>
                <button class="btn btn-secondary" onclick="cambiarFechasDescansoATTF()" 
                        style="background: #e2e8f0; color: #475569; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    üîÑ Cambiar
                </button>
            </div>
        </div>
    `;
    
    console.log('‚úÖ Interfaz de confirmaci√≥n de descanso renderizada');
}



// ========================================
// üõ†Ô∏è FUNCIONES AUXILIARES (Agregar en scope global, antes de accederMenuATTF)
// ========================================

/**
 * Controla visibilidad de elementos con reflow forzado
 * @param {string} elementId - ID del elemento DOM
 * @param {boolean} visible - true para mostrar, false para ocultar
 */
function setElementVisibility(elementId, visible) {
    const el = document.getElementById(elementId);
    if (!el) {
        console.warn(`‚ö†Ô∏è Elemento #${elementId} no encontrado`);
        return;
    }
    el.style.display = visible ? 'block' : 'none';
    el.classList.toggle('hidden', !visible);
    // Forzar reflow para aplicar cambios inmediatamente
    void el.offsetHeight;
    console.log(`üé® ${elementId}: ${visible ? 'VISIBLE' : 'OCULTO'}`);
}

/**
 * Reintenta ejecutar una funci√≥n con l√≠mite de intentos
 * @param {Function} fn - Funci√≥n a ejecutar (debe retornar true si √©xito)
 * @param {number} maxRetries - M√°ximo de intentos
 * @param {number} delay - Delay entre intentos en ms
 */
function retryWithLimit(fn, maxRetries = 3, delay = 300) {
    let attempts = 0;
    function attempt() {
        try {
            if (fn()) return; // √âxito
        } catch (e) {
            console.warn(`‚ö†Ô∏è Intento ${attempts + 1} fallido:`, e.message);
        }
        if (++attempts >= maxRetries) {
            console.error(`‚ùå M√°ximos ${maxRetries} intentos fallidos para: ${fn.name || 'funci√≥n an√≥nima'}`);
            return;
        }
        console.log(`üîÑ Reintentando en ${delay}ms... (intento ${attempts + 1}/${maxRetries})`);
        setTimeout(attempt, delay);
    }
    attempt();
}


// ========================================
// üö™ ACCEDER AL MEN√ö ATTF (VERSI√ìN CORREGIDA Y ROBUSTA)
// ========================================
async function accederMenuATTF() {
    console.log('üîê ==========================================');
    console.log('üîê INICIANDO: accederMenuATTF');
    console.log('üîê Usuario actual:', currentUser?.usuario || 'NO DEFINIDO');
    console.log('üîê Rol:', currentUser?.rol || 'NO DEFINIDO');
    console.log('üîê Timestamp:', new Date().toISOString());
    console.log('üîê ==========================================');

    // ========================================
    // ‚úÖ PASO 0: VALIDACI√ìN DE SEGURIDAD B√ÅSICA
    // ========================================
    if (!currentUser || !currentUser.id) {
        console.error('‚ùå [FATAL] currentUser no v√°lido - Redirigiendo a login');
        location.reload();
        return;
    }

    // ========================================
    // ‚úÖ PASO 1: VALIDACI√ìN DE CONFIGURACI√ìN ACTIVA
    // ========================================
    console.log('üîç [PASO 1] Verificando estado de configuraci√≥n...');
    
    const configSection = document.getElementById('configuracionInicialATTF');
    
    // üõ°Ô∏è Verificaci√≥n robusta: ¬øEst√° visible la configuraci√≥n?
    const configEstaVisible = configSection && (
        configSection.style.display !== 'none' && 
        configSection.style.display !== '' && 
        configSection.offsetParent !== null &&
        configSection.offsetHeight > 0
    );
    
    console.log('üìä Estado configSection:', {
        existe: !!configSection,
        display: configSection?.style.display,
        offsetParent: configSection?.offsetParent !== null,
        offsetHeight: configSection?.offsetHeight,
        estaVisible: configEstaVisible
    });
    
    // üö´ Si la configuraci√≥n est√° visible, DETENER ejecuci√≥n (usuario debe completar configuraci√≥n primero)
    if (configEstaVisible) {
        console.warn('‚ö†Ô∏è ACCESO DENEGADO: Configuraci√≥n de turnos activa');
        console.log('üí° El usuario debe completar la configuraci√≥n antes de acceder al men√∫');
        return; // ‚úÖ SALIR SIN MOSTRAR MEN√ö
    }
    
    // ‚úÖ Si existe pero est√° oculto, limpiar contenido por seguridad
    if (configSection) {
        configSection.style.display = 'none';
        configSection.classList.add('hidden');
        if (configSection.innerHTML !== '') {
            configSection.innerHTML = '';
            console.log('üßπ configuracionInicialATTF limpiado');
        }
        // Forzar reflow para aplicar cambios inmediatamente
        void configSection.offsetHeight;
        console.log('‚úÖ Configuraci√≥n forzada a oculto');
    }
    
    console.log('‚úÖ Configuraci√≥n inactiva - Continuando con acceso al men√∫');

    // ========================================
    // ‚úÖ PASO 1.5: ROLL FORWARD + VALIDACI√ìN DE CONFIGURACI√ìN COMPLETA
    // ========================================
    console.log('üîç [PASO 1.5] Ejecutando Roll Forward y validando configuraci√≥n...');
    
    try {
        const fechaHoy = getFechaHoyElSalvador();
        const horaActual = new Date().getHours();
        let necesitaActualizacion = false;
        
        // üîÑ ROLL FORWARD: ¬øEl "ma√±ana" programado AYER es HOY?
        if (currentUser.fecha_turno_manana === fechaHoy && 
            currentUser.turno_manana && 
            currentUser.turno_manana !== 'null' && 
            currentUser.turno_manana !== '' && 
            currentUser.turno_manana !== 'descanso') {
            
            console.log('‚úÖ üü¢ ROLL FORWARD ACTIVADO en accederMenuATTF');
            console.log(`   üìÖ fecha_turno_manana: ${currentUser.fecha_turno_manana} === HOY: ${fechaHoy}`);
            console.log(`   üîÑ Promoviendo: ${currentUser.turno_manana} ‚Üí turno_hoy`);
            
            // Promover turno_manana a turno_hoy
            currentUser.turno_hoy = currentUser.turno_manana;
            currentUser.fecha_turno_hoy = fechaHoy;
            currentUser.contador_turnos = (parseInt(currentUser.contador_turnos) || 0) + 1;
            
            // Limpiar campos de ma√±ana
            currentUser.turno_manana = null;
            currentUser.fecha_turno_manana = null;
            
            // Actualizar BD
            const { error: updateError } = await supabaseClient
                .from('usuarios')
                .update({
                    turno_hoy: currentUser.turno_hoy,
                    fecha_turno_hoy: fechaHoy,
                    turno_manana: null,
                    fecha_turno_manana: null,
                    contador_turnos: currentUser.contador_turnos,
                    ultima_actividad: formatearFechaCompletaElSalvador(getFechaElSalvador())
                })
                .eq('id', currentUser.id);
            
            if (updateError) {
                console.error('‚ùå Error actualizando Roll Forward:', updateError);
            } else {
                console.log('‚úÖ Roll Forward guardado en BD');
            }
            
            // Actualizar localStorage
            localStorage.setItem('turno_hoy', currentUser.turno_hoy);
            localStorage.setItem('fecha_turno_hoy', currentUser.fecha_turno_hoy);
            localStorage.setItem('turno_manana', 'null');
            localStorage.setItem('fecha_turno_manana', 'null');
            localStorage.setItem('contador_turnos', currentUser.contador_turnos.toString());
            
            necesitaActualizacion = true;
        }
        
        // üîç VALIDACI√ìN: ¬øTiene configuraci√≥n completa para acceder al men√∫?
        const tieneHoyAlDia = currentUser.turno_hoy && 
                             currentUser.fecha_turno_hoy === fechaHoy;
        const tieneTurnoManana = currentUser.turno_manana && 
                                currentUser.turno_manana !== 'null' && 
                                currentUser.turno_manana !== '' && 
                                currentUser.turno_manana !== 'descanso';
        const tieneDescansoActivo = currentUser.descanso_fecha_inicio && 
                                   currentUser.descanso_fecha_inicio >= fechaHoy;
        
        console.log('üìä Estado de configuraci√≥n para acceso:', {
            tieneHoyAlDia,
            tieneTurnoManana,
            tieneDescansoActivo,
            turno_hoy: currentUser.turno_hoy,
            fecha_turno_hoy: currentUser.fecha_turno_hoy
        });
        
        // üö´ CASO A: NO TIENE TURNO DE HOY ‚Üí REDIRIGIR A PASO 1
        if (!tieneHoyAlDia) {
            console.log('üö™ CASO A: Usuario sin turno de hoy v√°lido - Redirigiendo a Paso 1');
            
            // Ocultar cualquier men√∫ que pueda estar visible
            const tableSelection = document.getElementById('tableSelectionSection');
            if (tableSelection) {
                tableSelection.style.display = 'none';
                tableSelection.classList.add('hidden');
            }
            
            // Mostrar configuraci√≥n inicial
            const configSection = document.getElementById('configuracionInicialATTF');
            if (configSection) {
                configSection.innerHTML = '';
                configSection.style.display = 'block';
                configSection.classList.remove('hidden');
            }
            
            // Ejecutar funci√≥n de configuraci√≥n
            if (typeof mostrarConfiguracionInicialATTF === 'function') {
                mostrarConfiguracionInicialATTF();
            }
            
            console.log('‚úÖ Redirigido a mostrarConfiguracionInicialATTF()');
            return; // ‚õî DETENER EJECUCI√ìN - No continuar con el men√∫
        }
        
        // üö´ CASO B: TIENE HOY PERO NO TIENE MA√ëANA/DESCANSO ‚Üí REDIRIGIR A PASO 2
        if (!tieneTurnoManana && !tieneDescansoActivo) {
            console.log('üö™ CASO B: Usuario tiene hoy pero falta configurar ma√±ana - Redirigiendo a Paso 2');
            
            // Ocultar men√∫ de m√≥dulos
            const tableSelection = document.getElementById('tableSelectionSection');
            if (tableSelection) {
                tableSelection.style.display = 'none';
                tableSelection.classList.add('hidden');
            }
            
            // Preparar userData para el siguiente paso
            const userDataParaPaso2 = {
                turno_hoy: currentUser.turno_hoy,
                contador_turnos: parseInt(currentUser.contador_turnos) || 0,
                estado_ciclo: currentUser.estado_ciclo || 'ciclo_normal'
            };
            
            // Ejecutar funci√≥n de programaci√≥n de turno ma√±ana
            if (typeof mostrarProgramarTurnoMa√±anaConDescanso === 'function') {
                mostrarProgramarTurnoMa√±anaConDescanso(userDataParaPaso2);
            }
            
            console.log('‚úÖ Redirigido a mostrarProgramarTurnoMa√±anaConDescanso()');
            return; // ‚õî DETENER EJECUCI√ìN - No continuar con el men√∫
        }
        
        // ‚úÖ CASO C: CONFIGURACI√ìN COMPLETA - Puede acceder al men√∫
        if (necesitaActualizacion) {
            console.log('‚úÖ Roll Forward ejecutado - Configuraci√≥n actualizada');
        }
        console.log('‚úÖ Usuario con configuraci√≥n completa - Acceso al men√∫ permitido');
        
    } catch (err) {
        console.error('‚ùå Error en validaci√≥n de configuraci√≥n:', err);
        // En caso de error, continuar con el flujo normal (fail-safe)
    }

    // ========================================
    // ‚úÖ PASO 2: VERIFICAR Y RESTAURAR INTERFAZ DE B√öSQUEDA
    // ========================================
    console.log('üîç [PASO 2] Verificando integridad de searchGrid...');
    
    let searchGrid = document.getElementById('searchGrid');
    
    if (!searchGrid) {
        console.warn('‚ö†Ô∏è searchGrid NO ENCONTRADO - Intentando restaurar...');
        
        const searchSection = document.getElementById('searchSection');
        
        if (searchSection) {
            console.log('üîß Restaurando estructura de searchSection...');
            
            // ‚úÖ Restaurar estructura completa con IDs cr√≠ticos
            searchSection.innerHTML = `
                <div class="card">
                    <button class="btn btn-back" onclick="volverATablas()">‚Üê Volver a M√≥dulos</button>
                    <div class="header">
                        <h2 id="searchTitle">Consultar Informaci√≥n</h2>
                    </div>
                    <div class="search-grid" id="searchGrid"></div>
                    <div id="searchResults"></div>
                </div>
            `;
            
            // ‚úÖ Verificar que se restaur√≥ correctamente
            searchGrid = document.getElementById('searchGrid');
            
            if (searchGrid) {
                console.log('‚úÖ searchGrid restaurado exitosamente');
            } else {
                console.error('‚ùå ERROR CR√çTICO: No se pudo restaurar searchGrid');
                alert('‚ö†Ô∏è Error de interfaz: Recargue la p√°gina para continuar.');
                return;
            }
        } else {
            console.error('‚ùå ERROR CR√çTICO: searchSection no existe en el DOM');
            alert('‚ùå Error cr√≠tico: Interfaz da√±ada. Contacte al administrador.');
            return;
        }
    } else {
        console.log('‚úÖ searchGrid ya existe - No requiere restauraci√≥n');
    }

    // ========================================
    // ‚úÖ PASO 3: SINCRONIZAR DATOS DE TURNO (BD ‚Üî localStorage)
    // ========================================
    console.log('üîç [PASO 3] Sincronizando datos de turno...');
    
    if (currentUser) {
        // üîÅ Sincronizar turno_hoy
        if (currentUser.turno_hoy && !localStorage.getItem('turno_hoy')) {
            localStorage.setItem('turno_hoy', currentUser.turno_hoy);
            console.log('üîÑ turno_hoy sincronizado desde BD:', currentUser.turno_hoy);
        }
        
        // üîÅ Sincronizar fecha_turno_hoy
        if (currentUser.fecha_turno_hoy && !localStorage.getItem('fecha_turno_hoy')) {
            localStorage.setItem('fecha_turno_hoy', currentUser.fecha_turno_hoy);
            console.log('üîÑ fecha_turno_hoy sincronizado desde BD:', currentUser.fecha_turno_hoy);
        }
        
        // üîÅ Sincronizar turno_manana
        if (currentUser.turno_manana && !localStorage.getItem('turno_manana')) {
            localStorage.setItem('turno_manana', currentUser.turno_manana);
            console.log('üîÑ turno_manana sincronizado desde BD:', currentUser.turno_manana);
        }
        
        // üîÅ Sincronizar fecha_turno_manana
        if (currentUser.fecha_turno_manana && !localStorage.getItem('fecha_turno_manana')) {
            localStorage.setItem('fecha_turno_manana', currentUser.fecha_turno_manana);
            console.log('üîÑ fecha_turno_manana sincronizado desde BD:', currentUser.fecha_turno_manana);
        }
        
        // üîÅ Sincronizar datos de descanso si existen
        if (currentUser.descanso_fecha_inicio) {
            localStorage.setItem('descanso_inicio', currentUser.descanso_fecha_inicio);
            console.log('üîÑ descanso_fecha_inicio sincronizado:', currentUser.descanso_fecha_inicio);
        }
        if (currentUser.descanso_fecha_fin) {
            localStorage.setItem('descanso_fin', currentUser.descanso_fecha_fin);
            console.log('üîÑ descanso_fecha_fin sincronizado:', currentUser.descanso_fecha_fin);
        }
        
        console.log('üìä Datos de turno en currentUser:', {
            turno_hoy: currentUser.turno_hoy,
            fecha_turno_hoy: currentUser.fecha_turno_hoy,
            turno_manana: currentUser.turno_manana,
            fecha_turno_manana: currentUser.fecha_turno_manana,
            contador_turnos: currentUser.contador_turnos,
            descanso_inicio: currentUser.descanso_fecha_inicio,
            descanso_fin: currentUser.descanso_fecha_fin
        });
    }

    // ========================================
    // ‚úÖ PASO 4: VERIFICACI√ìN DE DESCANSO (L√ìGICA INTEGRADA)
    // ========================================
    console.log('üîç [PASO 4] Verificando estado de descanso...');
    
    if (currentUser.descanso_fecha_inicio && currentUser.descanso_fecha_fin) {
        try {
            // ‚úÖ Usar funci√≥n del sistema para consistencia de zona horaria
            const fechaHoy = getFechaHoyElSalvador();
            const hoy = new Date(fechaHoy + 'T00:00:00');
            const inicio = new Date(currentUser.descanso_fecha_inicio + 'T00:00:00');
            const fin = new Date(currentUser.descanso_fecha_fin + 'T00:00:00');
            const enDescanso = hoy >= inicio && hoy <= fin;
            
            console.log('üìÖ Verificaci√≥n de descanso:', {
                fechaHoy,
                inicio: currentUser.descanso_fecha_inicio,
                fin: currentUser.descanso_fecha_fin,
                enDescanso
            });
            
            // üö´ Si est√° en descanso, bloquear acceso
            if (enDescanso) {
                console.warn('‚ö†Ô∏è USUARIO EN D√çA DE DESCANSO - Acceso denegado');
                alert(`üìÖ Hoy (${fechaHoy}) es d√≠a de descanso programado.\n\nPr√≥ximo turno: ${currentUser.turno_regreso || 'Por configurar'}`);
                logout();
                return;
            }
            console.log('‚úÖ Usuario NO est√° en descanso - Acceso permitido');
        } catch (err) {
            console.error('‚ùå Error verificando descanso:', err);
            // Continuar si hay error en la verificaci√≥n (fail-safe)
        }
    } else {
        console.log('‚ÑπÔ∏è Usuario sin fechas de descanso configuradas');
    }

    // ========================================
    // ‚úÖ PASO 5: RECUPERACI√ìN DE SESI√ìN (Fallback de seguridad)
    // ========================================
    console.log('üîç [PASO 5] Validando sesi√≥n activa...');
    
    if (!currentUser) {
        console.warn('‚ö†Ô∏è currentUser no definido - Intentando recuperar desde storage...');
        
        const sessionStore = localStorage.getItem('cleca_user_session') || 
                            localStorage.getItem('usuario_logueado');
        
        if (sessionStore) {
            try {
                const parsed = JSON.parse(sessionStore);
                currentUser = parsed.user || parsed;
                console.log('‚úÖ Sesi√≥n recuperada desde storage:', {
                    usuario: currentUser?.usuario,
                    rol: currentUser?.rol
                });
            } catch (err) {
                console.error('‚ùå Error parseando sesi√≥n:', err);
            }
        } else {
            console.error('‚ùå No hay sesi√≥n guardada - Redirigiendo a login');
            location.reload();
            return;
        }
    } else {
        console.log('‚úÖ currentUser ya est√° definido:', currentUser.usuario);
    }

    // ========================================
    // ‚úÖ PASO 6: LIMPIEZA Y RENDERIZADO DE INTERFAZ
    // ========================================
    console.log('üîç [PASO 6] Renderizando interfaz de men√∫...');
    
    try {
        console.log('üßπ Limpiando elementos de configuraci√≥n previa...');
        
        // üÖ∞Ô∏è OCULTAR LOGIN (usando funci√≥n auxiliar)
        setElementVisibility('loginSection', false);
        
        // üÖ±Ô∏è CONFIGURACI√ìN YA LIMPIADA EN PASO 1
        
        // üÜé MOSTRAR MEN√ö DE M√ìDULOS con retry
        retryWithLimit(() => {
            const menuModulos = document.getElementById('menuModulosATTF') || 
                               document.getElementById('tableSelectionSection');
            
            if (menuModulos) {
                menuModulos.style.display = 'block';
                menuModulos.classList.remove('hidden');
                void menuModulos.offsetHeight; // Forzar reflow
                console.log('‚úÖ Men√∫ de m√≥dulos visible');
                return true; // √âxito
            }
            console.warn('‚ö†Ô∏è menuModulosATTF/tableSelectionSection no encontrado, reintentando...');
            return false; // Fall√≥, reintentar
        }, 3, 200);
        
        // üÜë OCULTAR SECCI√ìN DE B√öSQUEDA (inicialmente)
        setElementVisibility('searchSection', false);
        
        // üÜí ACTUALIZAR IDENTIDAD DE USUARIO
        const userLabel = document.getElementById('currentUser');
        if (userLabel && currentUser?.usuario) {
            const nuevoTexto = `Bienvenido, ${currentUser.usuario} (ATTF)`;
            if (userLabel.textContent !== nuevoTexto) {
                userLabel.textContent = nuevoTexto;
                console.log('‚úÖ Etiqueta de usuario actualizada');
            }
        }
        
        // üÜì MOSTRAR INFO DE USUARIO
        setElementVisibility('userInfo', true);
        
        // ========================================
        // ‚úÖ PASO 7: EJECUTAR PROCESOS DE FONDO
        // ========================================
        console.log('‚öôÔ∏è [PASO 7] Ejecutando procesos de fondo...');
        
        // üîÑ Actualizar filtros seg√∫n rol
        if (typeof mostrarTablasSegunRol === 'function') {
            mostrarTablasSegunRol();
            console.log('‚úÖ mostrarTablasSegunRol() ejecutado');
        } else {
            console.warn('‚ö†Ô∏è mostrarTablasSegunRol no est√° definida');
        }
        
        // ‚è∞ Iniciar verificaci√≥n de sesi√≥n
        if (typeof iniciarVerificacionSesion === 'function') {
            iniciarVerificacionSesion();
            console.log('‚úÖ iniciarVerificacionSesion() ejecutado');
        } else {
            console.warn('‚ö†Ô∏è iniciarVerificacionSesion no est√° definida');
        }
        
        console.log('‚úÖ‚úÖ‚úÖ Men√∫ ATTF renderizado correctamente ‚úÖ‚úÖ‚úÖ');
        
    } catch (error) {
        console.error('‚ùå ERROR CR√çTICO en renderizado de men√∫:', {
            mensaje: error.message,
            stack: error.stack?.split('\n').slice(0, 5).join('\n'),
            timestamp: new Date().toISOString()
        });
        
        // üÜò Fallback: Recargar p√°gina si hay error cr√≠tico
        if (confirm('‚ùå Error al cargar el men√∫. ¬øDesea recargar la p√°gina?')) {
            location.reload();
        }
    }

    // ========================================
    // ‚úÖ PASO 8: CHECKLIST POST-FIX (DEBUG FINAL)
    // ========================================
    console.log('üîç ==========================================');
    console.log('üîç CHECKLIST POST-FIX - VERIFICACI√ìN FINAL');
    console.log('üîç ==========================================');
    
    // üîπ Verificar elementos cr√≠ticos
    console.log('1. configSection oculto:', 
        document.getElementById('configuracionInicialATTF')?.style.display === 'none' ? '‚úÖ' : '‚ùå');
    
    const tableSelection = document.getElementById('tableSelectionSection');
    const tableVisible = tableSelection && (
        tableSelection.style.display === 'block' && 
        !tableSelection.classList.contains('hidden') &&
        tableSelection.offsetHeight > 0
    );
    console.log('2. tableSelection visible:', tableVisible ? '‚úÖ' : '‚ö†Ô∏è OCULTO');
    
    // üõ†Ô∏è Si tableSelection est√° oculto, mostrarlo (correcci√≥n adicional)
    if (tableSelection && !tableVisible) {
        console.log('üîß Corrigiendo visibilidad de tableSelection...');
        tableSelection.style.display = 'block';
        tableSelection.classList.remove('hidden');
        void tableSelection.offsetHeight;
    }
    
    console.log('3. searchSection oculto:', 
        document.getElementById('searchSection')?.style.display === 'none' ? '‚úÖ' : '‚ùå');
    
    const userInfo = document.getElementById('userInfo');
    console.log('4. userInfo visible:', 
        userInfo && !userInfo.classList.contains('hidden') ? '‚úÖ' : '‚ùå');
    
    console.log('5. currentUser texto:', 
        document.getElementById('currentUser')?.textContent || '‚ö†Ô∏è VAC√çO');
    
    console.log('üîç ==========================================');
    console.log('üîê FINALIZADO: accederMenuATTF');
    console.log('üîê Timestamp fin:', new Date().toISOString());
    console.log('üîê ==========================================');
}



// ========================================
// üß™ DIAGN√ìSTICO ADICIONAL (Ejecutar en consola si hay problemas)
// ========================================
function diagnosticarMenuATTF() {
    console.group('üîç DIAGN√ìSTICO COMPLETO - accederMenuATTF');
    
    console.log('üì¶ currentUser:', currentUser ? '‚úÖ Definido' : '‚ùå Undefined');
    if (currentUser) {
        console.log('   ‚Ä¢ usuario:', currentUser.usuario);
        console.log('   ‚Ä¢ rol:', currentUser.rol);
        console.log('   ‚Ä¢ turno_hoy:', currentUser.turno_hoy);
    }
    
    console.log('üì¶ Elementos DOM:');
    ['configuracionInicialATTF', 'tableSelectionSection', 'searchSection', 'loginSection', 'userInfo', 'currentUser'].forEach(id => {
        const el = document.getElementById(id);
        console.log(`   ‚Ä¢ #${id}:`, el ? `‚úÖ Existe (display: ${el.style.display || 'auto'})` : '‚ùå No existe');
    });
    
    console.log('üì¶ localStorage:');
    ['turno_hoy', 'turno_manana', 'cleca_user_session'].forEach(key => {
        const val = localStorage.getItem(key);
        console.log(`   ‚Ä¢ ${key}:`, val ? `‚úÖ "${val}"` : '‚ùå Vac√≠o');
    });
    
    console.groupEnd();
}



// Exponer funciones al scope global
window.setElementVisibility = setElementVisibility;
window.retryWithLimit = retryWithLimit;
window.diagnosticarMenuATTF = diagnosticarMenuATTF;

function mostrarForzarDescansoATTF() {
    // ‚úÖ OCULTAR MEN√ö DE M√ìDULOS DURANTE CONFIGURACI√ìN
    const tableSelection = document.getElementById('tableSelectionSection');
    if (tableSelection) tableSelection.style.display = 'none';
    
    // ‚úÖ NUEVO: OCULTAR searchSection PARA ELIMINAR BOT√ìN "VOLVER"
    const searchSection = document.getElementById('searchSection');
    if (searchSection) {
        searchSection.style.display = 'none';
        searchSection.classList.add('hidden');
    }
    
    console.log("üõ†Ô∏è Forzando descanso obligatorio"); 
   // 1. Buscamos los contenedores
    const targetSection = document.getElementById('configuracionInicialATTF');
if (!targetSection) {
    console.error("‚ùå ERROR CR√çTICO: Contenedor 'configuracionInicialATTF' NO EXISTE en el HTML");
    alert("Error de interfaz: Falta el elemento de configuraci√≥n. Contacte al administrador.");
    logout();
    return;
}
    const menuPrincipal = document.getElementById('menuModulosATTF') || document.querySelector('.main-menu-container');

  

    // 2. ‚ö° CR√çTICO: Ocultamos el men√∫ principal para que no se vea doble (Pantalla limpia)
    if (menuPrincipal) {
        menuPrincipal.style.display = 'none';
    }

    // 3. ‚ö° LIMPIEZA: Vaciamos el contenedor y lo preparamos
    targetSection.innerHTML = ''; 
    targetSection.style.display = 'block';
    targetSection.style.paddingBottom = '50px'; // Espacio extra abajo
    targetSection.classList.remove('hidden');

    // 4. L√≥gica de fechas
    const ahora = new Date();
    const fechaManana = new Date(ahora);
    fechaManana.setDate(fechaManana.getDate() + 1);
    const fechaManaanaStr = fechaManana.toISOString().split('T')[0];
    
    const fechaPasado = new Date(ahora);
    fechaPasado.setDate(fechaPasado.getDate() + 2);
    const fechaPasadoStr = fechaPasado.toISOString().split('T')[0];

    // 5. Inyectamos la interfaz
    targetSection.innerHTML = `
        <div class="card-configuracion" style="padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: 20px auto; border-top: 5px solid #1a73e8;">
            <img src="https://cdnimg.bnamericas.com/HFvkiBpeoLTFyPBTjytdbdohtBDrWQsnxgYaUwIlxAEFZVYKsYrwygPFBPYYlShO.png" alt="Logo CLESA" class="logo" style="width: 80px; display: block; margin: 0 auto;">
            <h2 class="titulo-degradado" style="text-align: center; color: #1a73e8; margin-top: 15px;">Descanso Obligatorio</h2>
            
            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107; color: #856404; font-size: 14px; line-height: 1.4;">
                <strong>‚ö†Ô∏è Ciclo Completado</strong><br>
                Has cumplido 5 turnos consecutivos. Debes programar tu descanso de 2 d√≠as.
            </div>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                <strong style="color: #0d47a1;">üìÖ D√≠as de descanso:</strong><br>
                <div style="font-size: 17px; font-weight: 600; color: #2d3748; text-align: center; margin-top: 10px;">
                    üóìÔ∏è 1¬∞ D√≠a: ${fechaManaanaStr}<br>
                    üóìÔ∏è 2¬∞ D√≠a: ${fechaPasadoStr}
                </div>
            </div>
            
            <div class="form-group">
                <label style="font-weight: bold; display: block; margin-bottom: 8px; color: #4a5568;">üîÑ Turno de REGRESO:</label>
                <select id="turnoRegreso" class="form-control" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: white; font-size: 16px;">
                    <option value="">-- Seleccione --</option>
                    ${Object.entries(TURNOS_ATTF).map(([key, turno]) => 
                        `<option value="${key}">${turno.nombre}</option>`
                    ).join('')}
                </select>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="confirmarDescansoObligatorioATTF()" style="background: #1a73e8; color: white; padding: 15px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; font-size: 16px;">
                    ‚úÖ Confirmar y Salir
                </button>
                <button class="btn-link" onclick="cambiarFechasDescansoATTF()" style="background: none; border: none; color: #2196f3; cursor: pointer; text-decoration: underline; font-size: 14px; padding: 5px;">
                    üìÖ Cambiar fechas manualmente
                </button>
            </div>
        </div>
    `;

    // 6. Guardamos en globales para la confirmaci√≥n
    window.fechasDescansoAutomaticas = {
        inicio: fechaManaanaStr,
        fin: fechaPasadoStr
    };
}
    

async function confirmarDescansoObligatorioATTF() {
    const turnoRegreso = document.getElementById('turnoRegreso')?.value;
    
    if (!turnoRegreso) {
        alert('‚ö†Ô∏è Por favor seleccione el turno de regreso');
        return;
    }

    const { inicio, fin } = window.fechasDescansoAutomaticas || {};
    if (!inicio || !fin) {
        alert('‚ùå Error: No se encontraron las fechas de descanso.');
        return;
    }

    // Calcular fecha de regreso real (D√≠a despu√©s del fin)
    const fechaRegresoDate = new Date(fin + 'T00:00:00');
    fechaRegresoDate.setDate(fechaRegresoDate.getDate() + 1);
    const fechaRegreso = fechaRegresoDate.toISOString().split('T')[0];

    try {
        // 1. Guardar en Base de Datos (Supabase)
        const { error } = await supabaseClient
            .from('usuarios')
            .update({
                descanso_fecha_inicio: inicio,
                descanso_fecha_fin: fin,
                turno_regreso: turnoRegreso,
                fecha_turno_regreso: fechaRegreso,
                contador_turnos: 0,
                estado_ciclo: 'ciclo_normal',
                turno_manana: 'descanso',
                ultimaconexion: formatearFechaCompletaElSalvador(getFechaElSalvador())
            })
            if (!currentUser?.id) {
    console.error('‚ùå currentUser.id no disponible');
    alert('Error de sesi√≥n. Por favor, inicie sesi√≥n nuevamente.');
    logout();
    return;
}

        if (error) throw error;

        // ‚ö° 2. ACTUALIZAR LOCALSTORAGE (Para persistencia al reingresar)
        localStorage.setItem('turno_manana', 'descanso');
        localStorage.setItem('descanso_inicio', inicio);
        localStorage.setItem('descanso_fin', fin);
        localStorage.setItem('turnos_configurados', 'true');

        // ‚ö° 3. LIMPIAR LA INTERFAZ (Elimina el problema de las im√°genes encimadas)
        const targetSection = document.getElementById('configuracionInicialATTF') || document.getElementById('searchSection');
        if (targetSection) {
            targetSection.innerHTML = ''; // Borra f√≠sicamente el cuadro
            targetSection.style.display = 'none'; // Oculta el contenedor
        }

        // ‚ö° 4. ASEGURAR QUE EL MEN√ö SE VEA
        const menuPrincipal = document.getElementById('menuModulosATTF');
        if (menuPrincipal) menuPrincipal.style.display = 'block';

        alert('‚úÖ Descanso obligatorio confirmado');
        
        // 5. Ir al men√∫
        accederMenuATTF();

    } catch (err) {
        console.error('‚ùå Error al confirmar descanso:', err);
        alert('‚ùå Error al guardar en base de datos: ' + err.message);
    }
}

async function loginPoda(userData) {
    console.log('üå≥ Iniciando flujo Poda');
    
    const ahora = new Date();
    const fechaHoy = getFechaHoyElSalvador();
    
    // 1. Verificar si est√° en d√≠a de descanso
    if (verificarDiaDescanso(userData)) {
        alert('Hoy es uno de tus d√≠as de descanso. No puedes acceder al sistema.');
        logout();
        return;
    }
    
    // 2. Verificar si necesita configurar d√≠as de descanso
    if (!userData.descanso_fecha_fin || userData.descanso_fecha_fin < fechaHoy) {
        console.log('üîß Poda necesita configurar d√≠as de descanso');
        mostrarConfiguracionDescansoPoda();
        return;
    }
    
    // 3. Acceso directo al men√∫
    document.getElementById('currentUser').textContent = `Bienvenido, ${userData.usuario} (Poda)`;
    document.getElementById('userInfo').classList.remove('hidden');
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('tableSelectionSection').style.display = 'block';
    
    mostrarTablasSegunRol();
    iniciarVerificacionSesion();
    guardarDatosOffline();
    
    console.log('‚úÖ Acceso concedido al men√∫ Poda');
}


function mostrarConfiguracionDescansoPoda() {
    const loginSection = document.getElementById('loginSection');
    
    loginSection.innerHTML = `
        <img src="https://cdnimg.bnamericas.com/HFvkiBpeoLTFyPBTjytdbdohtBDrWQsnxgYaUwIlxAEFZVYKsYrwygPFBPYYlShO.png" alt="Logo CLESA" class="logo">
        <h1 class="titulo-degradado">CLESA</h1>
        <p class="subtitulo">Configura tus D√≠as de Descanso</p>
        
        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
            <strong>Rol Poda:</strong> Selecciona 2 d√≠as consecutivos de descanso para esta semana
        </div>
        
        <div class="form-group">
            <label>Primer d√≠a de descanso:</label>
            <input type="date" id="fechaDescansoPodaInicio" class="form-control" onchange="calcularFechaFinPoda()" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
        </div>
        
        <div class="form-group">
            <label>Segundo d√≠a de descanso:</label>
            <input type="date" id="fechaDescansoPodaFin" class="form-control" readonly style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px; background: #f5f5f5;">
            <small style="color: #666;">Se calcula autom√°ticamente (d√≠a consecutivo)</small>
        </div>
        
        <button class="btn" onclick="confirmarDescansoPoda()" style="margin-top: 20px;">
            ‚úÖ Confirmar D√≠as de Descanso
        </button>
        <button class="btn btn-danger" onclick="logout()" style="margin-top: 10px;">
            Cancelar
        </button>
    `;
}


function calcularFechaFinPoda() {
    const fechaInicio = document.getElementById('fechaDescansoPodaInicio').value;
    const inputFin = document.getElementById('fechaDescansoPodaFin');
    
    if (!fechaInicio) return;
    
    const fecha = new Date(fechaInicio + 'T00:00:00');
    fecha.setDate(fecha.getDate() + 1); // D√≠a consecutivo
    
    const fechaFin = fecha.toISOString().split('T')[0];
    inputFin.value = fechaFin;
}


async function confirmarDescansoPoda() {
    const fechaInicio = document.getElementById('fechaDescansoPodaInicio').value;
    const fechaFin = document.getElementById('fechaDescansoPodaFin').value;
    
    if (!fechaInicio || !fechaFin) {
        alert('Por favor seleccione las fechas de descanso');
        return;
    }
    
    // Validar que sean fechas futuras
    const hoy = new Date().toISOString().split('T')[0];
    if (fechaInicio <= hoy) {
        alert('Las fechas de descanso deben ser futuras (desde ma√±ana en adelante)');
        return;
    }
    
    // Confirmaci√≥n
    const confirmar = confirm(
        `¬øConfirmas tus d√≠as de descanso?\n\n` +
        `üìÖ Primer d√≠a: ${fechaInicio}\n` +
        `üìÖ Segundo d√≠a: ${fechaFin}\n\n` +
        `‚úÖ S√ç - Guardar y acceder\n` +
        `‚ùå NO - Corregir`
    );
    
    if (!confirmar) return;
    
    // Guardar en BD
    const { error } = await supabaseClient
        .from('usuarios')
        .update({
            descanso_fecha_inicio: fechaInicio,
            descanso_fecha_fin: fechaFin,
            ultimaconexion: formatearFechaCompletaElSalvador(getFechaElSalvador()),
ultima_actividad: formatearFechaCompletaElSalvador(getFechaElSalvador())
        })
        .eq('id', currentUser.id);
    
    if (error) {
        alert('Error guardando d√≠as de descanso: ' + error.message);
        return;
    }
    
    console.log('‚úÖ D√≠as de descanso Poda guardados');
    
    // Actualizar currentUser
    currentUser.descanso_fecha_inicio = fechaInicio;
    currentUser.descanso_fecha_fin = fechaFin;
    
    // Acceso al men√∫
    document.getElementById('currentUser').textContent = `Bienvenido, ${currentUser.usuario} (Poda)`;
    document.getElementById('userInfo').classList.remove('hidden');
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('tableSelectionSection').style.display = 'block';
    
    mostrarTablasSegunRol();
    iniciarVerificacionSesion();
    guardarDatosOffline();
}


async function limpiarDiasDescansoViejos() {
    // 1. Obtener la fecha de HOY en formato YYYY-MM-DD para comparaci√≥n
    const ahora = new Date();
    const fechaHoyStr = getFechaHoyElSalvador();
    
    // 2. Buscar usuarios cuyo descanso termin√≥ o termina hoy
    // La fecha de fin de descanso (descanso_fecha_fin) es el √∫ltimo d√≠a libre.
    // El turno de regreso (turno_regreso) est√° programado para el d√≠a siguiente.
    // Por eso, usamos 'lt' (less than, menor que) para fechas pasadas.
    const { data: usuarios, error } = await supabaseClient
        .from('usuarios')
        .select('id, turno_regreso, fecha_turno_regreso, descanso_fecha_fin')
        // Filtramos a los que tienen un descanso_fecha_fin que ya pas√≥ o es hoy
        .lte('descanso_fecha_fin', fechaHoyStr) 
        // y que tienen un turno de regreso programado
        .not('turno_regreso', 'is', null); 
        
    if (error) {
        console.error('Error al consultar usuarios para limpieza de descanso:', error);
        return;
    }
    
    // 3. Procesar cada usuario encontrado (cuyo descanso termin√≥)
    const updates = usuarios.map(usuario => {
        // Promovemos el Turno de Regreso para que se convierta en el Turno de Hoy.
        // Esto reinicia el contador y el ciclo de 5 d√≠as.
        
        // L√≥gica de validaci√≥n de REGRESO:
        // Solo promovemos si la fecha de regreso es HOY. 
        // Si el usuario se ausent√≥ (lleg√≥ m√°s tarde de la fecha_turno_regreso), 
        // la funci√≥n limpiarTurnosViejos() manejar√° la migraci√≥n del turno.
        const fechaRegresoProgramada = usuario.fecha_turno_regreso;

        if (fechaRegresoProgramada === fechaHoyStr) {
            return {
                id: usuario.id,
                // Reinicio del ciclo:
                turno_hoy: usuario.turno_regreso,
                fecha_turno_hoy: usuario.fecha_turno_regreso,
                contador_turnos: 0, // El primer turno despu√©s del descanso es el turno 0/1

                // Limpieza de campos de descanso (muy importante):
                descanso_fecha_inicio: null,
                descanso_fecha_fin: null,
                turno_regreso: null,
                fecha_turno_regreso: null
            };
        }
        
        // Si la fecha de regreso ya pas√≥, se salta este usuario en la limpieza de descanso.
        // Esto evita que se "peguen" turnos viejos si el usuario estuvo inactivo mucho tiempo.
        return null;
    }).filter(update => update !== null); // Eliminar los registros nulos (que no deben actualizarse hoy)


    if (updates.length > 0) {
        // 4. Ejecutar la actualizaci√≥n masiva de los usuarios que regresan
        const { error: updateError } = await supabaseClient
            .from('usuarios')
            .upsert(updates);

        if (updateError) {
            console.error('Error al actualizar limpieza de descanso:', updateError);
        } else {
            console.log(`üå¥ ${updates.length} usuario(s) regresaron de descanso. Ciclo reiniciado.`);
        }
    }
}


async function limpiarTurnosViejos() {
    const ahora = new Date();
    // 1. Obtener la fecha de HOY en formato YYYY-MM-DD para comparaci√≥n
    const fechaHoyStr = getFechaHoyElSalvador();
    
    // Buscar usuarios donde la fecha_turno_hoy no sea hoy (es decir, ya pas√≥)
    const { data: usuarios, error } = await supabaseClient
        .from('usuarios')
        .select('id, fecha_turno_hoy, turno_manana, fecha_turno_manana')
        // Filtramos por usuarios cuya fecha_turno_hoy NO sea la de hoy
        .not('fecha_turno_hoy', 'eq', fechaHoyStr)
        .or('turno_hoy.not.is.null'); // Solo aquellos que alguna vez tuvieron turno hoy
        
    if (error) {
        console.error('Error al consultar usuarios para limpieza de turnos:', error);
        return;
    }
    
    // 2. Procesar cada usuario encontrado
    const updates = usuarios.map(usuario => {
        // La fecha de turno de hoy programada ya pas√≥, o nunca se program√≥ para hoy.
        // Asignamos el turno de MA√ëANA como el turno de HOY.
        const nuevoTurnoHoy = usuario.turno_manana;
        const nuevaFechaTurnoHoy = usuario.fecha_turno_manana;
        
        return {
            id: usuario.id,
            turno_hoy: nuevoTurnoHoy,
            fecha_turno_hoy: nuevaFechaTurnoHoy,
            turno_manana: null, // Limpiamos el turno de ma√±ana
            fecha_turno_manana: null // Limpiamos la fecha de ma√±ana
        };
    });

    if (updates.length > 0) {
        // 3. Ejecutar la actualizaci√≥n masiva de los turnos "viejos"
        const { error: updateError } = await supabaseClient
            .from('usuarios')
            .upsert(updates);

        if (updateError) {
            console.error('Error al actualizar turnos viejos:', updateError);
        } else {
            console.log(`üßπ ${updates.length} turno(s) viejo(s) limpiado(s) y migrado(s).`);
        }
    }
}




// ========================================
// üõ°Ô∏è CONTROL DE VISIBILIDAD POR ROL
// ========================================
function mostrarTablasSegunRol() {
    if (!currentUser || !currentUser.rol) {
        console.log('‚ùå currentUser no est√° disponible');
        return;
    }

// üõ°Ô∏è FILTRO DE SEGURIDAD PARA ATTF (Evita saltarse turnos al actualizar)
    if (currentUser.rol === 'ATTF') {
        const tHoy = localStorage.getItem('turno_hoy');
        const tManana = localStorage.getItem('turno_manana');

        if (!tHoy || !tManana) {
            console.warn('‚ö†Ô∏è Acceso denegado: Faltan turnos en el storage.');
            
            // Ocultamos el men√∫ por si acaso se estaba viendo
            document.getElementById('tableSelectionSection').style.display = 'none';
            
            // Forzamos a que aparezca la selecci√≥n de turnos
            mostrarConfiguracionInicialATTF();
            return; // <--- Bloqueamos el resto de la funci√≥n
        }
    }

    console.log('üîç Filtrando tablas para rol:', currentUser.rol);
    const tableOptions = document.querySelectorAll('.table-option');
    const rol = currentUser.rol;

    // üéØ ADMINISTRADOR - VE TODO
    if (rol === 'Administrador') {
        tableOptions.forEach(opt => opt.style.display = 'block');
        console.log('‚úÖ Administrador: Todas las tablas visibles');
        return;
    }

   // üéØ SUPERVISOR - TODO EXCEPTO usuarios y mapa_rutas
if (rol === 'Supervisor') {
    tableOptions.forEach(option => {
        const action = option.getAttribute('onclick') || '';
        // ‚úÖ EXPL√çCITAMENTE EXCLUIR usuarios y mapa_rutas
        const prohibido = 
            action.includes("'usuarios'") ||      // Gesti√≥n de Usuarios
            action.includes("'mapa_rutas'");       // Mapa de Rutas
        option.style.display = prohibido ? 'none' : 'block';
    });
    console.log('üîí M√≥dulos ocultos para rol Supervisor: usuarios, mapa_rutas');
    return;
}

    // üéØ DESPACHO - Todo excepto usuarios e IPR
    if (rol === 'Despacho') {
        tableOptions.forEach(option => {
            const action = option.getAttribute('onclick') || '';
            const prohibido = 
                action.includes("'usuarios'") || 
                action.includes("'retiro_medidores'");
            option.style.display = prohibido ? 'none' : 'block';
        });
        console.log('‚úÖ Despacho: M√≥dulos visibles (incluye Cargar Asignaciones)');
        return;
    }

    // üéØ BODEGA - SOLO IPR + OS CERRADAS
    if (rol === 'Bodega') {
        tableOptions.forEach(option => {
            const action = option.getAttribute('onclick') || '';
            option.style.display =
                (action.includes('retiro_medidores') || action.includes('OSCerradas'))
                ? 'block'
                : 'none';
        });
        return;
    }

    // üéØ LECTURA - SOLO consultas_servicios
    if (rol === 'Lectura') {
        tableOptions.forEach(option => {
            const action = option.getAttribute('onclick') || '';
            option.style.display = action.includes('consultas_servicios') ? 'block' : 'none';
        });
        return;
    }

    // üéØ ATTF / PODA - servicios + TX y Cortes + IPR (SIN mapa_rutas)
if (rol === 'ATTF' || rol === 'Poda') {
    tableOptions.forEach(option => {
        const action = option.getAttribute('onclick') || '';
        // ‚úÖ EXPL√çCITAMENTE EXCLUIR mapa_rutas
        const esMapaRutas = action.includes('mapa_rutas');
        option.style.display =
            (!esMapaRutas && (
                action.includes('consultas_servicios') ||
                action.includes('TX y Cortes') ||
                action.includes('retiro_medidores')
            ))
            ? 'block'
            : 'none';
    });
    return;
}

    
   // üéØ CONTRATISTA / CONSULTA - TODO EXCEPTO usuarios, detalle_os, cargar_asignaciones, mapa_rutas
if (rol === 'Contratista' || rol === 'Consulta') {
    tableOptions.forEach(option => {
        const action = option.getAttribute('onclick') || '';
        // ‚úÖ CORRECCI√ìN: Validar EXACTAMENTE los nombres de m√≥dulos prohibidos
        const prohibido =
            action.includes("'usuarios'") ||           // Gesti√≥n de Usuarios
            action.includes("'detalle_os'") ||         // Detalle OS
            action.includes("'cargar_asignaciones'") || // Cargar Asignaciones
            action.includes("'mapa_rutas'");           // Mapa de Rutas
        option.style.display = prohibido ? 'none' : 'block';
    });
    console.log(`üîí M√≥dulos ocultos para rol ${rol}: usuarios, detalle_os, cargar_asignaciones, mapa_rutas`);
    return;
}

    // üéØ DEFAULT - TODO EXCEPTO usuarios
    tableOptions.forEach(option => {
        const action = option.getAttribute('onclick') || '';
        option.style.display = action.includes('usuarios') ? 'none' : 'block';
    });
}

// ========================================
// üîì GESTI√ìN DE DESBLOQUEO DE USUARIOS
// ========================================
async function desbloquearUsuario(username) {
    if (!currentUser || (currentUser.rol !== 'Supervisor' && currentUser.rol !== 'Administrador')) {
        alert('Solo los supervisores o administradores pueden desbloquear usuarios');
        return;
    }
    
    // Confirmaci√≥n antes de proceder
    if (!confirm(`¬øEst√°s seguro de desbloquear al usuario ${username}? Se resetear√° su ciclo de turnos.`)) {
        return;
    }

    const { error } = await supabaseClient
        .from('usuarios')
        .update({
            razon_bloqueo: null,
            ultima_actividad: new Date().toISOString(),
            estado_ciclo: 'primera_vez',
            contador_turnos: 0,
            turno_hoy: null,
            fecha_turno_hoy: null,
            turno_manana: null,
            fecha_turno_manana: null,
            descanso_fecha_inicio: null,
            descanso_fecha_fin: null,
            turno_regreso: null,
            fecha_turno_regreso: null
        })
        .eq('usuario', username);
    
    if (error) {
        alert('Error desbloqueando usuario: ' + error.message);
        return;
    }
    
    alert(`Usuario ${username} desbloqueado exitosamente.\n\nSu configuraci√≥n ha sido reseteada.`);
    
    // Opcional: Recargar la tabla si est√°s en la vista de gesti√≥n
    if (typeof buscarEnTabla === 'function') {
        buscarEnTabla('usuarios');
    }
}



async function desbloquearUsuario(username) {
    if (!currentUser || currentUser.rol !== 'Supervisor') {
        alert('Solo los supervisores pueden desbloquear usuarios');
        return;
    }
    
    const { error } = await supabaseClient
    .from('usuarios')
    .update({
        razon_bloqueo: null,
        ultima_actividad: new Date().toISOString(),
        estado_ciclo: 'primera_vez',
        contador_turnos: 0,
        turno_hoy: null,
        fecha_turno_hoy: null,
        turno_manana: null,
        fecha_turno_manana: null,
        descanso_fecha_inicio: null,
        descanso_fecha_fin: null,
        turno_regreso: null,
        fecha_turno_regreso: null
    })
        .eq('usuario', username);
    
    if (error) {
        alert('Error desbloqueando usuario: ' + error.message);
        return;
    }
    
    alert(`Usuario ${username} desbloqueado exitosamente.\n\nSu configuraci√≥n ha sido reseteada.`);
}




// === FUNCI√ìN PARA INCREMENTAR CONTADOR DE B√öSQUEDAS (SOLUCI√ìN A LA CONCATENACI√ìN) ===
async function incrementarContadorBusquedas() {
    if (!currentUser) return;
    
    try {
        // 1. Obtener contador actual
        const { data: usuario, error: errorGet } = await supabaseClient
            .from('usuarios')
            .select('Contador')
            .eq('id', currentUser.id)
            .single();
        
        if (errorGet) {
            console.error('Error obteniendo Contador:', errorGet.message);
            return;
        }
        
        // üí° CAMBIO CLAVE: Usamos parseInt() para garantizar que sea un n√∫mero y no un texto.
        const contadorActual = parseInt(usuario.Contador) || 0; 
        const nuevoContador = contadorActual + 1;
        
        // 2. Actualizar contador
        const { error: errorUpdate } = await supabaseClient
            .from('usuarios')
            .update({ 
                Contador: nuevoContador,
                ultimaconexion: formatearFechaCompletaElSalvador(getFechaElSalvador())
            })
            .eq('id', currentUser.id);
        
        if (errorUpdate) {
            console.error('Error actualizando Contador:', errorUpdate.message);
        } else {
            console.log(`B√∫squeda #${nuevoContador} registrada para ${currentUser.usuario}`);
            currentUser.Contador = nuevoContador; 
        }
        
    } catch (error) {
        console.error('Error general en contador de b√∫squedas:', error.message);
    }
}

    // ========================================
// ‚öôÔ∏è CONFIGURACI√ìN GLOBAL DE TABLAS
// ========================================
const tableConfigs = {
    'consultas_servicios': {
        title: 'Consultas de Servicios',
        icon: 'üè†',
        fields: [
            { key: 'CuentaContrato', label: 'Cuenta/Contrato', type: 'exact' },
            { key: 'Medidor', label: 'Medidor', type: 'exact' },
            { key: 'NombreCliente', label: 'Nombre Cliente', type: 'like', oculto: true }
        ],
        resultFields: ['CuentaContrato', 'Medidor', 'NombreCliente', 'Direccion', 'ComentarioGeneral'],
        actions: ['Coordenadas', 'Coordenadasgis', 'FotoLink', 'Grafica']
    },
    'Consumos': {
        title: 'Consumos',
        icon: 'üìä',
        fields: [
            { key: 'CuentaContrato', label: 'Cuenta/Contrato', type: 'exact' },
            { key: 'Medidor', label: 'Medidor', type: 'exact' }
        ],
        resultFields: ['CuentaContrato', 'Medidor'],
        actions: ['consumos']
    },
    'Coordenadas': {
        title: 'Coordenadas',
        icon: 'üìç',
        fields: [
            { key: 'Medidor', label: 'Medidor', type: 'exact' },
            { key: 'CuentaContrato', label: 'Cuenta/Contrato', type: 'exact' }
        ],
        resultFields: ['Medidor', 'CuentaContrato'],
        actions: ['CoordenadasLector', 'CoordenadasGis']
    },
    'OS Pendientes': {
        title: 'OS Pendientes',
        icon: '‚è≥',
        fields: [
            { key: 'OSATMO', label: 'OS ATOMO', type: 'exact' },
            { key: 'OSSAP', label: 'OS SAP', type: 'exact' },
            { key: 'CuentaContrato', label: 'Cuenta/Contrato', type: 'exact' },
            { key: 'Medidor', label: 'Medidor', type: 'exact' },
            { key: 'NombreCliente', label: 'Nombre Cliente', type: 'like' }
        ],
        resultFields: ['OSATMO', 'OSSAP', 'CuentaContrato', 'Medidor', 'NombreCliente', 'Comentario'],
        actions: ['Coordenadas', 'FotoLink', 'CoordenadasGis']
    },
    'OSCerradas': {
        title: 'OS Cerradas',
        icon: '‚úÖ',
        fields: [
            { key: 'OSATOMO', label: 'OS ATOMO', type: 'exact' },
            { key: 'OSSAP', label: 'OS SAP', type: 'exact' },
            { key: 'CuentaContrato', label: 'Cuenta/Contrato', type: 'exact' },
            { key: 'Medidor', label: 'Medidor', type: 'exact' },
            { key: 'NombreCliente', label: 'Nombre Cliente', type: 'like' }
        ],
        resultFields: ['OSATOMO', 'OSSAP', 'CuentaContrato', 'Medidor', 'NombreCliente', 'Comentario'],
        actions: ['Coordenadas', 'FotoLink']
    },
    'TX y Cortes': {
        title: 'TX y Cortes',
        icon: '‚ö°',
        fields: [
            { key: 'TXCortes', label: 'TX/Cortes', type: 'like' },
            { key: 'Circuitos', label: 'Circuitos', type: 'like' }
        ],
        resultFields: ['TXCortes', 'Circuitos', 'Comentario'],
        actions: ['Coordenadas']
    },
    'usuarios': {
        title: 'Gesti√≥n de Usuarios',
        icon: 'üë•',
        fields: [
            { key: 'usuario', label: 'Usuario', type: 'like' }
        ],
        resultFields: ['usuario', 'rol', 'activo', 'bloqueado'],
        actions: [],
        esAdmin: true
    },
    'kml_ruta': {
        title: 'KML Ruta',
        icon: 'üìç',
        fields: [],
        resultFields: [],
        actions: [],
        esKMLRuta: true
    },
    'detalle_os': {
        title: 'Detalle OS',
        icon: 'üìä',
        fields: [],
        resultFields: [],
        actions: [],
        esDetalleOS: true,
        rolesPermitidos: ['Administrador', 'Supervisor']
    },
    'retiro_medidores': {
        title: 'IPR - Retiro de Medidores',
        icon: 'üì¶',
        fields: [],
        resultFields: [],
        actions: [],
        esIPR: true,
        rolesPermitidos: ['Administrador', 'Supervisor', 'Bodega', 'ATTF', 'Contratista', 'Consulta']
    },
    'mapa_rutas': {
        title: 'Mapa de Rutas',
        icon: 'üó∫Ô∏è',
        fields: [],
        resultFields: [],
        actions: [],
        esMapaRutas: true,
        rolesPermitidos: ['Administrador', 'Despacho']
    },
    'cargar_asignaciones': {
        title: 'Cargar Asignaciones (Admin)',
        icon: 'üì§',
        fields: [],
        resultFields: [],
        actions: [],
        esAdmin: true
    }
};



	// ‚úÖ Funci√≥n para traer todos los datos de una tabla (Paginaci√≥n autom√°tica)
async function fetchAllFromTable(tableName, columns = '*') {
    const batchSize = 1000;
    let allData = [];
    let offset = 0;
    let hasMore = true;

    while (hasMore) {
        const { data, error, count } = await supabaseClient
            .from(tableName)
            .select(columns, { count: offset === 0 ? 'exact' : undefined })
            .range(offset, offset + batchSize - 1);

        if (error) {
            console.error('Error en fetchAllFromTable:', error);
            throw error;
        }

        if (data && data.length > 0) {
            allData = allData.concat(data);
            console.log(`‚úÖ Cargadas ${allData.length} de ${count || '?'} filas...`);
            offset += batchSize;
            hasMore = data.length === batchSize;
        } else {
            hasMore = false;
        }
    }

    return { data: allData, count: allData.length };
}

// ‚úÖ Variables globales para el estado de las gr√°ficas
let consumosChart = null;
let lecturasChart = null;

// ‚úÖ Funci√≥n para parsear datos de gr√°ficas (procesa el texto de consumos hist√≥ricos)
function parsearDatosGrafica(graficaData) {
    if (!graficaData || graficaData.trim() === '') {
        return { meses: [], lecturas: [], consumos: [] };
    }

    const meses = [], lecturas = [], consumos = [];
    // Limpia espacios y l√≠neas vac√≠as
    const lineas = graficaData.split('\n').map(l => l.trim()).filter(l => l);

    for (const linea of lineas) {
        // Correcci√≥n de la expresi√≥n regular (limpia de barras de escape innecesarias)
        const match = linea.match(/^([A-Za-z]+)\.-?(\d+)(?:-(\d+))?/);
        
        if (match) {
            const [, mes, lectura, consumo] = match;
            meses.push(mes);
            lecturas.push(parseInt(lectura));
            
            if (consumo !== undefined) {
                consumos.push(parseInt(consumo));
            } else if (lecturas.length > 1) {
                // C√°lculo autom√°tico si no viene el dato de consumo expl√≠cito
                const consumoCalculado = lecturas[lecturas.length - 1] - lecturas[lecturas.length - 2];
                consumos.push(Math.max(0, consumoCalculado));
            } else {
                consumos.push(0);
            }
        }
    }
    return { meses, lecturas, consumos };
}
    

// Funci√≥n para mostrar gr√°ficas por √≠ndice con uso correcto del dato grafica
function verGraficasPorIndice(dataIndex) {
    if (dataIndex === undefined || dataIndex < 0 || dataIndex >= consultasData.length) {
        alert('Datos de gr√°fica no disponibles');
        return;
    }
    const item = consultasData[dataIndex];
    verGraficas(item.Grafica || item.grafica || '', item.NombreCliente || 'Cliente', item.CuentaContrato || 'N/A');
}

// Funci√≥n para mostrar gr√°ficas usando datos din√°micos de la fila sin caer en ejemplo est√°tico salvo que no haya datos en absoluto
function verGraficas(graficaData, nombreCliente, cuentaContrato) {
    try {
        const modal = document.getElementById('chartsModal');
        const modalTitle = document.getElementById('modalTitle');
        modalTitle.textContent = `Gr√°ficas - ${nombreCliente} (Cuenta: ${cuentaContrato})`;
        modal.style.display = 'block';

        // Parsear los datos din√°micos
        const datos = parsearDatosGrafica(graficaData);

        // Solo si no hay ning√∫n dato v√°lido mostramos mensaje o ejemplo muy discreto
        if (datos.meses.length === 0) {
            alert('No hay datos de consumo y lectura disponibles para esta fila.');
            cerrarGraficas();
            return;
        }

        // Destruir gr√°ficos previos si existen
        if (consumosChart) consumosChart.destroy();
        if (lecturasChart) lecturasChart.destroy();

        // Crear las gr√°ficas con los datos extra√≠dos de la fila
        setTimeout(() => { crearGraficas(datos); }, 100);

    } catch (error) {
        console.error('‚ùå Error mostrando gr√°ficas:', error);
        alert('Error mostrando las gr√°ficas. Por favor intente de nuevo.');
    }
}


   // ‚úÖ Funci√≥n para crear gr√°ficas HORIZONTALES (barras de izq‚Üíder, l√≠neas arriba‚Üíabajo)
function crearGraficas(datos) {
    try {
        const ctxConsumos = document.getElementById('consumosChart');
        if (ctxConsumos) {
            consumosChart = new Chart(ctxConsumos, {
                type: 'bar',
                data: {
                    labels: datos.meses,
                    datasets: [{
                        label: 'Consumo (kWh)',
                        data: datos.consumos,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: 5,
                        borderSkipped: false,
                    }]
                },
                plugins: [ChartDataLabels],
                options: {
                    indexAxis: 'y', // üéØ CLAVE: Cambiar a horizontal (meses en eje Y)
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'},
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'right',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            color: '#2d3748',
                            formatter: function(value) {
                                return value + ' kWh';
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.x} kWh`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { // üéØ Ahora X es el valor (consumo)
                            beginAtZero: true,
                            title: {display: true, text: 'Consumo (kWh)'},
                            suggestedMax: function(context) {
                                const max = Math.max(...datos.consumos);
                                return max * 1.15;
                            }
                        },
                        y: { // üéØ Ahora Y son los meses
                            title: {display: true, text: 'Mes'},
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        const ctxLecturas = document.getElementById('lecturasChart');
        if (ctxLecturas) {
            lecturasChart = new Chart(ctxLecturas, {
                type: 'line',
                data: {
                    labels: datos.meses,
                    datasets: [{
                        label: 'Lectura Acumulada',
                        data: datos.lecturas,
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(118, 75, 162, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }]
                },
                plugins: [ChartDataLabels],
                options: {
                    indexAxis: 'y', // üéØ CLAVE: Cambiar a horizontal (meses en eje Y)
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'},
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'right',
                            offset: 5,
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            color: '#2d3748',
                            backgroundColor: 'rgba(255, 255, 255, 0.8)',
                            borderColor: 'rgba(118, 75, 162, 0.5)',
                            borderWidth: 1,
                            borderRadius: 4,
                            padding: 3,
                            formatter: function(value) {
                                return value.toLocaleString() + ' kWh';
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.x.toLocaleString()} kWh`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { // üéØ Ahora X es el valor (lectura)
                            beginAtZero: false,
                            title: {display: true, text: 'Lectura Acumulada (kWh)'},
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            suggestedMax: function(context) {
                                const max = Math.max(...datos.lecturas);
                                return max * 1.1;
                            }
                        },
                        y: { // üéØ Ahora Y son los meses
                            title: {display: true, text: 'Mes'},
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        console.log('‚úÖ Gr√°ficas creadas exitosamente en formato HORIZONTAL');

    } catch (error) {
        console.error('‚ùå Error creando gr√°ficas:', error);
    }
}

    // ‚úÖ Funci√≥n para cerrar gr√°ficas
    function cerrarGraficas() {
        document.getElementById('chartsModal').style.display = 'none';
        if (consumosChart) { consumosChart.destroy(); consumosChart = null; }
        if (lecturasChart) { lecturasChart.destroy(); lecturasChart = null; }
    }

    // ‚úÖ Cerrar modal al hacer click fuera
    window.onclick = function(event) {
        const modal = document.getElementById('chartsModal');
        if (event.target === modal) cerrarGraficas();
    }

    // Funciones para descarga KML
function descargarKML() {
    if (consultasData.length === 0) {
        alert('No hay datos para descargar');
        return;
    }

    const ubicaciones = [];
    consultasData.forEach((item, index) => {
    const coordenadas = item.Coordenadas || item.coordenadas || item.Coordenadasgis || item.coordenadasgis;
    if (coordenadas) {
        // üéØ CAMBIO: Priorizar Medidor como etiqueta
        const etiqueta = item.Medidor || item.CuentaContrato || `Punto ${index + 1}`;
        ubicaciones.push({ etiqueta, coordenadas });
    }
});

    if (ubicaciones.length === 0) {
        alert('No se encontraron coordenadas v√°lidas para descargar');
        return;
    }

    const kmlString = generarKMLString(ubicaciones);
    const blob = new Blob([kmlString], { type: 'application/vnd.google-earth.kml+xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `coordenadas_${selectedTable}_${new Date().getTime()}.kml`;
    a.click();
    URL.revokeObjectURL(url);
}


function generarKMLString(ubicaciones) {
    if (!ubicaciones || ubicaciones.length === 0) {
        throw new Error("No hay ubicaciones para KML");
    }
    
    let kml = '<?xml version="1.0" encoding="UTF-8"?>\n';
    kml += '<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n';
    kml += '<name>Rutas CLESA - Ordenadas por Cercan√≠a</name>\n';
    
    // üÜï AGREGAR ESTILOS NUMERADOS
    const colores = ['ff0000ff', 'ff00ff00', 'ff00ffff', 'ffffff00']; // Rojo, Verde, Azul, Amarillo
    
    ubicaciones.forEach(({ etiqueta, coordenadas, numeroOrden }, index) => {
        const partes = coordenadas.split(',').map(s => s.trim());
        let coordsKML = partes.length >= 2 
            ? `${partes[1]},${partes[0]}${partes[2] ? ',' + partes[2] : ''}` 
            : coordenadas;
        
        const color = colores[index % colores.length];
        
        kml += '<Placemark>\n';
        kml += `<name>${numeroOrden || index + 1}. ${etiqueta}</name>\n`;  // ‚Üê N√öMERO PRIMERO
        kml += `<description>OS: ${etiqueta} | Orden: ${numeroOrden || index + 1}</description>\n`;
        kml += `<Style><IconStyle><color>${color}</color><scale>1.2</scale></IconStyle></Style>\n`;
        kml += `<Point><coordinates>${coordsKML}</coordinates></Point>\n`;
        kml += '</Placemark>\n';
    });
    
    kml += '</Document>\n</kml>';
    return kml;
}





function iniciarVerificacionSesion() {
    // 1Ô∏è‚É£ INTENTO DE RECUPERACI√ìN INICIAL:
    if (!currentUser) {
        const savedSession = localStorage.getItem('cleca_user_session');
        if (savedSession) {
            try {
                const session = JSON.parse(savedSession);
                currentUser = session.user;
                console.log("üõ°Ô∏è Verificador: Usuario restaurado.");

                // ‚úÖ NUEVO: Si recuperamos al usuario, debemos asegurar visibilidad b√°sica
                // Si el login sigue visible, significa que el sistema se qued√≥ "dormido"
                if (document.getElementById('loginSection').style.display !== 'none') {
                    console.log("üõ†Ô∏è Forzando salida de pantalla blanca desde Verificador...");
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('userInfo').classList.remove('hidden');
                    document.getElementById('currentUser').textContent = `${currentUser.usuario}`;
                }
            } catch (e) {
                console.error("üõ°Ô∏è Verificador: Error al parsear.");
            }
        }
    }

    // El intervalo de 30 segundos est√° perfecto
    setInterval(async () => {
        if (!currentUser) return;

        try {
            // 2Ô∏è‚É£ CONSULTA A SUPABASE
            const { data, error } = await supabaseClient
                .from('usuarios')
                .select('sessionactiva, sessiontoken, ultimaconexion') 
                .eq('id', currentUser.id)
                .maybeSingle();

            if (error || !data) return;

            // 3Ô∏è‚É£ VALIDACI√ìN DE SESI√ìN √öNICA
            if (data.sessiontoken && currentUser.sessiontoken) {
                if (data.sessiontoken !== currentUser.sessiontoken) {
                    alert('‚ö†Ô∏è Seguridad: Sesi√≥n abierta en otro dispositivo.');
                    logout();
                    return;
                }
            }

            // 4Ô∏è‚É£ VALIDACI√ìN DE ESTADO ACTIVO
            if (data.sessionactiva === false) {
                logout();
                return;
            }

            // 5Ô∏è‚É£ VALIDACI√ìN DE TIEMPO (45 min)
            if (data.ultimaconexion) {
                // ‚ö†Ô∏è OJO AQU√ç: Aseg√∫rate que 'ultima' se compare correctamente con la hora actual
                const ultima = new Date(data.ultimaconexion);
                const ahora = new Date();
                const diffMin = (ahora - ultima) / 1000 / 60;

                if (diffMin > 45) {
                    alert('‚åõ Sesi√≥n expirada por inactividad.');
                    logout();
                }
            }

        } catch (err) {
            console.error('Error cr√≠tico en verificador:', err);
        }
    }, 30000); 
}



async function renovarSesion() {
    // 1Ô∏è‚É£ RECONSTRUCCI√ìN DE MEMORIA
    if (!currentUser) {
        const sessionData = localStorage.getItem('cleca_user_session');
        if (sessionData) {
            try {
                const { user } = JSON.parse(sessionData);
                currentUser = user;
                console.log("üë§ Usuario restaurado en memoria.");
            } catch (e) {
                console.error("Error al parsear sesi√≥n:", e);
                return;
            }
        }
    }

    if (!currentUser || !currentUser.id) return;

    try {
        const ahoraSV = formatearFechaCompletaElSalvador(getFechaElSalvador());

        // 2Ô∏è‚É£ ACTUALIZACI√ìN EN BASE DE DATOS (Heartbeat)
        const { error } = await supabaseClient
            .from('usuarios')
            .update({ ultimaconexion: ahoraSV, sessionactiva: true })
            .eq('id', currentUser.id)
            .eq('sessiontoken', currentUser.sessiontoken); 

        if (error) {
            console.warn('‚ö†Ô∏è Error de validaci√≥n: Sesi√≥n posiblemente inv√°lida.');
            return;
        }

        // 3Ô∏è‚É£ CARGA DE DATOS CR√çTICA (Evita el "Vac√≠o ‚ùå")
        if (currentUser.rol === 'ATTF' && (!window.osAsignadasKML || window.osAsignadasKML.length === 0)) {
            console.log("üì• Descargando datos de rutas para la unidad...");
            const miUnidad = transformarUsuarioAUnidad(currentUser.usuario);
            const { data: datosKML } = await supabaseClient
                .from('os_asignadas')
                .select('*')
                .eq('Unidad', miUnidad);
            
            if (datosKML) {
                window.osAsignadasKML = datosKML;
                console.log(`‚úÖ ${datosKML.length} registros cargados correctamente.`);
            }
        }

        // 4Ô∏è‚É£ RECONSTRUCCI√ìN VISUAL
        if (document.getElementById('loginSection').style.display !== 'none') {
            console.log("üõ†Ô∏è Limpiando pantalla blanca...");
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('currentUser').textContent = `${currentUser.usuario} (${currentUser.rol})`;

            if (currentUser.rol === 'ATTF') {
    const searchSection = document.getElementById('searchSection');
    searchSection.style.display = 'block';

    if (!localStorage.getItem('turnos_configurados')) {
        console.log("üìã Cargando selector de turnos...");
        generarInterfazTurnosPaso1();
    } else {
        console.log("‚úÖ Turnos configurados. Mostrando men√∫...");
        // ‚úÖ NO cargar mapa_rutas para ATTF
        document.getElementById('tableSelectionSection').style.display = 'block';
    }
} else {
    // ‚úÖ Mantener esto para otros roles
    document.getElementById('tableSelectionSection').style.display = 'block';
}
        }

    } catch (err) {
        console.error('Error cr√≠tico en renovarSesion:', err);
    }
}

async function verificarSesionReal() {
    const session = localStorage.getItem('cleca_user_session');
    if (!session) return;

    try {
        const user = JSON.parse(session).user || JSON.parse(session);

        // Consultamos estado y si la sesi√≥n sigue marcada como activa en la DB
        const { data, error } = await supabaseClient
            .from('usuarios')
            .select('estado_ciclo, sessionactiva')
            .eq('id', user.id)
            .single();

        // üö® SI EL USUARIO FUE BLOQUEADO, RESETEADO O CERR√ì SESI√ìN EN OTRO LADO:
        if (error || !data || data.sessionactiva === false) {
            console.warn("‚ö†Ô∏è Sesi√≥n invalidada por el servidor o usuario inexistente.");
            
            // Limpiamos TODO para que no pueda volver a entrar por cach√©
            localStorage.removeItem('cleca_user_session');
            localStorage.removeItem('usuario_logueado');
            localStorage.removeItem('turno_hoy');
            localStorage.removeItem('turno_manana');
            
            alert("Tu sesi√≥n ha expirado o ha sido invalidada. Por favor, ingresa de nuevo.");
            location.reload();
        }
    } catch (e) {
        console.error("Error validando sesi√≥n:", e);
    }
}




async function logout() {
    console.log("üö´ Cerrando sesi√≥n y limpiando cach√©...");
    
    // 1. LIMPIEZA TOTAL DEL NAVEGADOR (LocalStorage + SessionStorage)
    // Borramos credenciales
    localStorage.removeItem('cleca_user_session');
    localStorage.removeItem('usuario_logueado');
    
    // Borramos el progreso de turnos y descansos (ESTO EVITA EL INGRESO AUTOM√ÅTICO)
    
    localStorage.removeItem('descanso_confirmado');
    localStorage.removeItem('turno_hoy_registrado'); 

    // Limpiamos cualquier rastro en sessionStorage por si acaso
    sessionStorage.clear();

    // 2. DESACTIVAR EN LA BASE DE DATOS (Seguridad en el Servidor)
    if (currentUser && currentUser.id) {
        try {
            await supabaseClient
                .from('usuarios')
                .update({ 
                    sessionactiva: false, 
                    sessiontoken: null 
                })
                .eq('id', currentUser.id);
            console.log("‚úÖ Sesi√≥n desactivada en servidor.");
        } catch (e) {
            console.error("‚ùå Error al notificar al servidor:", e);
        }
    }

    // 3. RESET DE VARIABLES Y RECARGA
    currentUser = null;
    
    // Usar clear() al final si quieres asegurar que NO quede nada de nada
    // localStorage.clear(); 

    window.location.reload();
}



¬†  function generarCamposBusqueda(config) {
    console.log('üìù Generando campos de b√∫squeda para:', selectedTable);
    
    // ‚úÖ VALIDACI√ìN: Verificar que searchGrid exista
    const searchGrid = document.getElementById('searchGrid');
    if (!searchGrid) {
        console.error('‚ùå Error: searchGrid no encontrado en el DOM');
        alert('Error: La interfaz de b√∫squeda no est√° disponible. Por favor recargue la p√°gina.');
        return;
    }
    
    try {
        // ========================================
        // üéØ CASOS ESPECIALES (mantener intactos)
        // ========================================
        
        if (selectedTable === 'usuarios') {
            searchGrid.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: end;">
                    <div class="form-group" style="margin: 0;">
                        <label>Buscar Usuario:</label>
                        <input type="text" id="searchusuario" placeholder="Ingrese nombre de usuario" />
                    </div>
                    <button class="btn btn-secondary" onclick="buscarUsuarioAdmin()" style="margin: 0;">üîç Buscar</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                    <button class="btn" onclick="mostrarFormularioNuevoUsuario()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                        ‚ûï Crear Nuevo Usuario
                    </button>
                    <button class="btn" onclick="mostrarActualizacionMasiva()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        üì§ Actualizaci√≥n Masiva
                    </button>
                </div>
            `;
            console.log('‚úÖ Campos de b√∫squeda generados para: usuarios');
            return;
        }

        if (selectedTable === 'kml_ruta') { 
            console.log('‚úÖ Cargando interfaz KML Ruta');
            cargarInterfazKMLRuta(); 
            return; 
        }
        
        if (selectedTable === 'detalle_os') { 
            console.log('‚úÖ Cargando interfaz Detalle OS');
            cargarInterfazDetalleOS(); 
            return; 
        }
        
        if (selectedTable === 'retiro_medidores') { 
            console.log('‚úÖ Cargando interfaz IPR');
            cargarInterfazIPR(); 
            return; 
        }
        
        if (selectedTable === 'mapa_rutas') { 
            console.log('‚úÖ Cargando interfaz Mapa de Rutas');
            cargarInterfazMapaRutas(); 
            return; 
        }

        // ========================================
        // üéØ CASO NORMAL: Generar campos din√°micos
        // ========================================
        console.log('üìù Generando campos est√°ndar para:', selectedTable);
        
        let html = '<div class="search-grid">'; 

        config.fields.forEach(field => {
            // üö´ FILTRO DE SEGURIDAD: Ocultar b√∫squeda por NombreCliente para roles no autorizados
            if (
                field.key === 'NombreCliente' &&
                selectedTable === 'consultas_servicios' &&
                !ROLES_CON_ACCESO_TOTAL_NOMBRE.includes(currentUser?.rol)
            ) {
                return; // ‚Üê Saltar este campo, no generar input
            }

            const esNombre = field.key === 'NombreCliente' ? 'full-width' : '';

            html += `
                <div class="search-group ${esNombre}">
                    <label>${field.label}:</label>
                    <input type="text" id="search${field.key}" placeholder="Ingrese ${field.label}">
                    <button class="btn btn-secondary" onclick="buscar('${field.key}', '${field.type}')">üîç Buscar</button>
                </div>
            `;
        }); // ‚úÖ Cierra forEach

        html += '</div>'; // ‚úÖ Cierra search-grid
        searchGrid.innerHTML = html;
        console.log('‚úÖ Campos de b√∫squeda generados correctamente');
        
    } catch (error) {
        console.error('‚ùå Error al generar campos de b√∫squeda:', error);
        alert('Error al generar la interfaz de b√∫squeda: ' + error.message);
        searchGrid.innerHTML = '<div style="color: red; padding: 20px;">Error al cargar la interfaz de b√∫squeda. Por favor recargue la p√°gina.</div>';
    }
} // ‚úÖ Cierra funci√≥n generarCamposBusqueda



¬†   function volverATablas() {
¬†     document.getElementById('searchSection').style.display = 'none';
¬†     document.getElementById('tableSelectionSection').style.display = 'block';
¬†     document.getElementById('searchResults').innerHTML = '';
¬†     selectedTable = null;
¬†   }





¬†	// ========================================
// üÜï GESTI√ìN DE USUARIOS (ADMIN/SUPERVISOR)
// ========================================


async function buscarUsuarioAdmin() {
¬†   // üîí VALIDACI√ìN DE SEGURIDAD
¬†   if (currentUser.rol !== 'Administrador') {
¬†       alert('‚õî ACCESO DENEGADO\n\nSolo usuarios con rol "Administrador" pueden gestionar usuarios.');
¬†       volverATablas();
¬†       return;
¬†   }
¬†
¬†   const busqueda = document.getElementById('searchusuario').value.trim();
¬†
¬†
¬†   if (!busqueda) {
¬†       alert('Por favor ingrese un nombre de usuario');
¬†       return;
¬†   }
¬†
¬†   try {
¬†       const { data, error } = await supabaseClient
¬†           .from('usuarios')
¬†           .select('*')
¬†           .ilike('usuario', `%${busqueda}%`)
¬†           .limit(5);
¬†
¬†       if (error) {
¬†           alert('Error al buscar: ' + error.message);
¬†           return;
¬†       }
¬†
¬†       if (data.length === 0) {
¬†           document.getElementById('searchResults').innerHTML = '<div class="result-card">‚ùå No se encontraron usuarios</div>';
¬†           return;
¬†       }
¬†
¬†       mostrarResultadosUsuarios(data);
¬†
¬†   } catch (err) {
¬†       console.error('Error:', err);
¬†       alert('Error al buscar usuarios');
¬†   }
}

function mostrarResultadosUsuarios(usuarios) {
¬†   const container = document.getElementById('searchResults');
¬†
¬†   let html = `<div class="result-header">‚úÖ Se encontraron ${usuarios.length} usuario(s)</div>`;
¬†
¬†   usuarios.forEach((user, index) => {
¬†       html += `
¬†           <div class="result-card">
¬†               <div class="result-header">Usuario ${index + 1}</div>
¬†               <div class="result-item"><strong>Usuario:</strong> ${user.usuario}</div>
¬†               <div class="result-item"><strong>Rol:</strong> ${user.rol}</div>
¬†               <div class="result-item"><strong>Activo:</strong> ${user.activo ? '‚úÖ S√≠' : '‚ùå No'}</div>
¬†               <div class="result-item"><strong>Bloqueado:</strong> ${user.razon_bloqueo ? 'üö´ S√≠' : '‚úÖ No'}</div>
¬†               <div class="action-buttons">
¬†                   <button class="btn btn-secondary" onclick="editarUsuario(${user.id})">‚úèÔ∏è Editar</button>
¬†               </div>
¬†           </div>
¬†       `;
¬†   });
¬†
¬†   container.innerHTML = html;
}

¬†	// ========================================
// üÜï SECCIONES DEL FORMULARIO DE EDICI√ìN
// ========================================

function seccionComun(user) {
    return `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; color: #2d3748;">üìã Informaci√≥n B√°sica</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <strong>Usuario:</strong> ${user.usuario || ''}
                </div>
                <div>
                    <strong>Rol:</strong> ${user.rol || ''}
                </div>
                <div>
                    <strong>√öltima actividad:</strong> ${user.ultima_actividad ? new Date(user.ultima_actividad).toLocaleString() : 'N/A'}
                </div>
                <div>
                    <strong>√öltima conexi√≥n:</strong> ${user.ultimaconexion ? new Date(user.ultimaconexion).toLocaleString() : 'N/A'}
                </div>
            </div>

            <div class="form-group">
                <label>‚úÖ Activo:</label>
                <select id="edit_activo" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
                    <option value="true" ${user.activo ? 'selected' : ''}>‚úÖ S√≠</option>
                    <option value="false" ${!user.activo ? 'selected' : ''}>‚ùå No</option>
                </select>
            </div>

            <div class="form-group">
                <label>üö´ Estado:</label>
                <div style="padding: 10px; background: ${user.razon_bloqueo ? '#ffebee' : '#e8f5e9'}; border-radius: 8px;">
                    ${user.razon_bloqueo ? 'üö´ <strong>BLOQUEADO</strong>' : '‚úÖ <strong>ACTIVO</strong>'}
                </div>
            </div>

            <div class="form-group">
                <label>üìù Raz√≥n Bloqueo:</label>
                <input type="text" id="edit_razon_bloqueo" value="${user.razon_bloqueo || ''}"
                       placeholder="Motivo del bloqueo"
                       style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
            </div>
        </div>
    `;
}

¬†	function seccionGestionTurnos(user) {
    // Helper para generar opciones de turnos sin errores de escape
    const generarOpciones = (valorSeleccionado) => {
        return `
            <option value="">-- Ninguno --</option>
            ${Object.entries(TURNOS_ATTF).map(([key, turno]) =>
                `<option value="${key}" ${valorSeleccionado === key ? 'selected' : ''}>${turno.nombre}</option>`
            ).join('')}
        `;
    };

    const opcionesTurnos = generarOpciones(user.turno_hoy);
    const opcionesTurnosManana = generarOpciones(user.turno_manana);
    const opcionesTurnosRegreso = generarOpciones(user.turno_regreso);

    return `
        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; color: #1565c0;">‚öôÔ∏è Gesti√≥n de Turnos (${user.rol || 'Sin Rol'})</h3>

            <div class="form-group">
                <label>üîÑ Turno HOY:</label>
                <select id="edit_turno_hoy" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
                    ${opcionesTurnos}
                </select>
            </div>

            <div class="form-group">
                <label>üìÖ Fecha Turno HOY:</label>
                <input type="date" id="edit_fecha_turno_hoy" value="${user.fecha_turno_hoy || ''}"
                       style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
            </div>

            <div class="form-group">
                <label>üîÑ Turno MA√ëANA:</label>
                <select id="edit_turno_manana" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
                    ${opcionesTurnosManana}
                </select>
            </div>

            <div class="form-group">
                <label>üìÖ Fecha Turno MA√ëANA:</label>
                <input type="date" id="edit_fecha_turno_manana" value="${user.fecha_turno_manana || ''}"
                       style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
            </div>

            <hr style="margin: 20px 0; border: 1px solid #90caf9;">

            <div class="form-group">
                <label>üèñÔ∏è Descanso Inicio:</label>
                <input type="date" id="edit_descanso_inicio" value="${user.descanso_fecha_inicio || ''}"
                       style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
            </div>

            <div class="form-group">
                <label>üèñÔ∏è Descanso Fin:</label>
                <input type="date" id="edit_descanso_fin" value="${user.descanso_fecha_fin || ''}"
                       style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
            </div>

            <div class="form-group">
                <label>üîô Turno Regreso:</label>
                <select id="edit_turno_regreso" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
                    ${opcionesTurnosRegreso}
                </select>
            </div>

            <div class="form-group">
                <label>üìÖ Fecha Turno Regreso:</label>
                <input type="date" id="edit_fecha_turno_regreso" value="${user.fecha_turno_regreso || ''}"
                       style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
            </div>

            <hr style="margin: 20px 0; border: 1px solid #90caf9;">

            <div class="form-group">
                <label>üìä Contador Turnos:</label>
                <input type="number" id="edit_contador" value="${user.contador_turnos || 0}" min="0" max="5"
                       style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
            </div>

            <div class="form-group">
                <label>üîÑ Estado Ciclo:</label>
                <select id="edit_estado_ciclo" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
                    <option value="">-- Ninguno --</option>
                    <option value="primera_vez" ${user.estado_ciclo === 'primera_vez' ? 'selected' : ''}>Primera vez</option>
                    <option value="ciclo_normal" ${user.estado_ciclo === 'ciclo_normal' ? 'selected' : ''}>Ciclo normal</option>
                </select>
            </div>
        </div>
    `;
}


function seccionExcepcionesHorario(user) {
¬†   return `
¬†       <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
¬†           <h3 style="margin-top: 0; color: #e65100;">üìÖ Excepciones de Horario (${user.rol})</h3>
¬†
¬†           <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ff9800;">
¬†               <strong>‚ÑπÔ∏è Informaci√≥n:</strong><br>
¬†               Por defecto, ${user.rol} tiene acceso Lun-S√°b de 5:00 AM a 6:00 PM.<br>
¬†               Aqu√≠ puedes habilitar excepciones puntuales.
¬†           </div>
¬†
¬†           <div class="form-group">
¬†               <label>üìÜ Habilitar Domingo Espec√≠fico:</label>
¬†               <input type="date" id="edit_domingo_fecha" value="${user.domingo_fecha || ''}"
¬†                      placeholder="Selecciona un domingo"
¬†                      style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
¬†               <small style="color: #666;">Si seleccionas una fecha, el usuario podr√° ingresar ese domingo</small>
¬†           </div>
¬†
¬†           <div class="form-group">
¬†               <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
¬†                   <input type="checkbox" id="edit_domingo_permitido" ${user.domingo_permitido ? 'checked' : ''}
¬†                          style="width: 20px; height: 20px;">
¬†                   <span>‚úÖ Domingo habilitado actualmente</span>
¬†               </label>
¬†           </div>
¬†
¬†           <hr style="margin: 20px 0; border: 1px solid #ffcc80;">
¬†
¬†           <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
¬†               <strong>‚è∞ Horario Excepcional para D√≠a Espec√≠fico (Opcional)</strong>
¬†           </div>
¬†
¬†           <div class="form-group">
¬†               <label>üìÖ Fecha Excepcional:</label>
¬†               <input type="date" id="edit_fecha_excepcional" value="${user.fecha_excepcional || ''}"
¬†                      style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
¬†               <small style="color: #666;">D√≠a que tendr√° horario diferente</small>
¬†           </div>
¬†
¬†           <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
¬†               <div class="form-group">
¬†                   <label>üïê Hora Inicio:</label>
¬†                   <input type="time" id="edit_horario_excepcional_inicio" value="${user.horario_excepcional_inicio || ''}"
¬†                          style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
¬†               </div>
¬†
¬†               <div class="form-group">
¬†                   <label>üïê Hora Fin:</label>
¬†                   <input type="time" id="edit_horario_excepcional_fin" value="${user.horario_excepcional_fin || ''}"
¬†                          style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
¬†               </div>
¬†           </div>
¬†
¬†           <small style="color: #666;">Ejemplo: Si pones fecha 15-Oct con horario 4:00-20:00, ese d√≠a podr√° ingresar de 4 AM a 8 PM</small>
¬†       </div>
¬†   `;
}
¬†

¬†	async function editarUsuario(userId) {
¬†   // üîí VALIDACI√ìN DE SEGURIDAD
¬†   if (currentUser.rol !== 'Administrador') {
¬†       alert('‚õî ACCESO DENEGADO\n\nSolo usuarios con rol "Administrador" pueden editar usuarios.');
¬†       return;
¬†   }
¬†
¬†
¬†   try {
¬†       const { data, error } = await supabaseClient
¬†   .from('usuarios')
¬†   .select('id, usuario, rol, activo, razon_bloqueo, ultima_actividad, ultimaconexion, turno_hoy, fecha_turno_hoy, turno_manana, fecha_turno_manana, descanso_fecha_inicio, descanso_fecha_fin, turno_regreso, fecha_turno_regreso, contador_turnos, estado_ciclo, domingo_permitido, domingo_fecha, horario_excepcional_inicio, horario_excepcional_fin, fecha_excepcional')
¬†   .eq('id', userId)
¬†   .single();
¬†
¬†       if (error) {
¬†           alert('Error al cargar usuario: ' + error.message);
¬†           return;
¬†       }
¬†
¬†       mostrarFormularioEdicion(data);
¬†
¬†   } catch (err) {
¬†       console.error('Error:', err);
¬†       alert('Error al cargar usuario');
¬†   }
}

function mostrarFormularioEdicion(user) {
¬†   const container = document.getElementById('searchResults');
¬†
¬†   // Determinar qu√© secciones mostrar seg√∫n el rol
¬†   let seccionEspecifica = '';
¬†
¬†   if (user.rol === 'ATTF' || user.rol === 'Poda') {
¬†       seccionEspecifica = seccionGestionTurnos(user);
¬†   } else if (user.rol === 'Lectura' || user.rol === 'Consulta' || user.rol === 'Contratista' || user.rol === 'Despacho') {
¬†       seccionEspecifica = seccionExcepcionesHorario(user);
¬†   } else {
¬†       seccionEspecifica = `
¬†           <div style="background: #f0f0f0; padding: 20px; border-radius: 10px; text-align: center; color: #666;">
¬†               ‚ÑπÔ∏è El rol ${user.rol} no requiere configuraciones especiales de horario
¬†           </div>
¬†       `;
¬†   }
¬†
¬†   container.innerHTML = `
¬†       <div class="result-card" style="background: #ffffff; border: 2px solid #2196f3;">
¬†           <button class="btn btn-back" onclick="buscarUsuarioAdmin()">‚Üê Volver a B√∫squeda</button>
¬†
¬†           <div class="result-header">‚úèÔ∏è Editar Usuario: ${user.usuario}</div>
¬†
¬†           <div style="background: #fff3cd; padding: 10px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
¬†               <strong>‚ö†Ô∏è Ten cuidado al modificar estos datos</strong><br>
¬†               Los cambios afectar√°n el acceso del usuario al sistema.
¬†           </div>
¬†
¬†           ${seccionComun(user)}
¬†
¬†           ${seccionEspecifica}
¬†
¬†           <div class="action-buttons" style="margin-top: 20px;">
¬†               <button class="btn btn-secondary" onclick="guardarCambiosUsuario(${user.id})">üíæ Guardar Cambios</button>
¬†               <button class="btn btn-danger" onclick="resetearUsuario(${user.id})">üîÑ Resetear Usuario</button>
¬†           </div>
¬†       </div>
¬†   `;
¬†
¬†
¬†   // Listener para sincronizar checkbox de domingo con fecha
¬†   const domingoCheckbox = document.getElementById('edit_domingo_permitido');
¬†   const domingoFecha = document.getElementById('edit_domingo_fecha');
¬†
¬†   if (domingoCheckbox && domingoFecha) {
¬†       domingoFecha.addEventListener('change', function() {
¬†           if (this.value) {
¬†               domingoCheckbox.checked = true;
¬†           }
¬†       });
¬†
¬†       domingoCheckbox.addEventListener('change', function() {
¬†           if (!this.checked) {
¬†               domingoFecha.value = '';
¬†           }
¬†       });
¬†   }
}



async function guardarCambiosUsuario(userId) {
¬†   // üîí VALIDACI√ìN DE SEGURIDAD
¬†   if (currentUser.rol !== 'Administrador') {
¬†       alert('‚õî ACCESO DENEGADO\n\nSolo usuarios con rol "Administrador" pueden guardar cambios.');
¬†       return;
¬†   }
¬†
¬†   const confirmar = confirm('¬øEst√°s seguro de guardar los cambios?\n\nEsto modificar√° la configuraci√≥n del usuario.');
¬†
¬†   if (!confirmar) return;
¬†
¬†   try {
¬†       // Obtener usuario actual para saber su rol
¬†       const { data: userData } = await supabaseClient
¬†           .from('usuarios')
¬†           .select('rol')
¬†           .eq('id', userId)
¬†           .single();
¬†
¬†       // Campos comunes para todos
¬†       const cambios = {
¬†   activo: document.getElementById('edit_activo').value === 'true',
¬†   razon_bloqueo: document.getElementById('edit_razon_bloqueo')?.value || null
};
¬†
¬†       // Campos espec√≠ficos seg√∫n rol
¬†       if (userData.rol === 'ATTF' || userData.rol === 'Poda') {
¬†           // Campos de gesti√≥n de turnos
¬†           cambios.turno_hoy = document.getElementById('edit_turno_hoy').value || null;
¬†           cambios.fecha_turno_hoy = document.getElementById('edit_fecha_turno_hoy').value || null;
¬†           cambios.turno_manana = document.getElementById('edit_turno_manana').value || null;
¬†           cambios.fecha_turno_manana = document.getElementById('edit_fecha_turno_manana').value || null;
¬†           cambios.descanso_fecha_inicio = document.getElementById('edit_descanso_inicio').value || null;
¬†           cambios.descanso_fecha_fin = document.getElementById('edit_descanso_fin').value || null;
¬†           cambios.turno_regreso = document.getElementById('edit_turno_regreso').value || null;
¬†           cambios.fecha_turno_regreso = document.getElementById('edit_fecha_turno_regreso').value || null;
¬†           cambios.contador_turnos = parseInt(document.getElementById('edit_contador').value) || 0;
¬†           cambios.estado_ciclo = document.getElementById('edit_estado_ciclo').value || null;
¬†       } else if (userData.rol === 'Lectura' || userData.rol === 'Consulta' || userData.rol === 'Contratista' || userData.rol === 'Despacho') {
¬†   // Campos de excepciones de horario
¬†   cambios.domingo_permitido = document.getElementById('edit_domingo_permitido').checked;
¬†   cambios.domingo_fecha = document.getElementById('edit_domingo_fecha').value || null;
¬†   cambios.horario_excepcional_inicio = document.getElementById('edit_horario_excepcional_inicio').value || null;
¬†   cambios.horario_excepcional_fin = document.getElementById('edit_horario_excepcional_fin').value || null;
¬†   cambios.fecha_excepcional = document.getElementById('edit_fecha_excepcional').value || null;
}
¬†
¬†       const { error } = await supabaseClient
¬†           .from('usuarios')
¬†           .update(cambios)
¬†           .eq('id', userId);
¬†
¬†       if (error) {
¬†           alert('Error al guardar: ' + error.message);
¬†           return;
¬†       }
¬†
¬†       alert('‚úÖ Cambios guardados exitosamente');
¬†       buscarUsuarioAdmin();
¬†
¬†   } catch (err) {
¬†       console.error('Error:', err);
¬†       alert('Error al guardar cambios');
¬†   }
}



async function resetearUsuario(userId) {
¬†   // üîí VALIDACI√ìN DE SEGURIDAD
¬†   if (currentUser.rol !== 'Administrador') {
¬†       alert('‚õî ACCESO DENEGADO\n\nSolo usuarios con rol "Administrador" pueden resetear usuarios.');
¬†       return;
¬†   }
¬†   const confirmar = confirm(
¬†       '‚ö†Ô∏è ¬øRESETEAR USUARIO?\n\n' +
¬†       'Esto eliminar√°:\n' +
¬†       '- Turnos programados\n' +
¬†       '- Descansos programados\n' +
¬†       '- Contador de turnos\n\n' +
¬†       'El usuario deber√° configurar todo de nuevo.\n\n' +
¬†       '¬øContinuar?'
¬†   );
¬†
¬†   if (!confirmar) return;
¬†
¬†   try {
¬†       const { error } = await supabaseClient
¬†   .from('usuarios')
¬†   .update({
¬†       razon_bloqueo: null,
¬†       ultima_actividad: new Date().toISOString(),
¬†       turno_hoy: null,
¬†       fecha_turno_hoy: null,
¬†       turno_manana: null,
¬†       fecha_turno_manana: null,
¬†       descanso_fecha_inicio: null,
¬†       descanso_fecha_fin: null,
¬†       turno_regreso: null,
¬†       fecha_turno_regreso: null,
¬†       contador_turnos: 0,
¬†       estado_ciclo: 'primera_vez'
¬†   })
¬†           .eq('id', userId);
¬†
¬†       if (error) {
¬†           alert('Error: ' + error.message);
¬†           return;
¬†       }
¬†
¬†       alert('‚úÖ Usuario desbloqueado y reseteado');
¬†       buscarUsuarioAdmin();
¬†
¬†   } catch (err) {
¬†       console.error('Error:', err);
¬†   }
}

¬†	// ========================================
// ‚ûï MOSTRAR FORMULARIO NUEVO USUARIO
// ========================================
function mostrarFormularioNuevoUsuario() {
¬†   const resultsContainer = document.getElementById('searchResults');
¬†
¬†   resultsContainer.innerHTML = `
¬†       <div class="result-card" style="background: #f0fff4; border: 2px solid #4caf50;">
¬†           <div class="result-header">‚ûï Crear Nuevo Usuario</div>
¬†
¬†           <div style="max-width: 500px; margin: 0 auto;">
¬†
¬†               <div class="form-group">
¬†                   <label>üë§ Nombre de Usuario:</label>
¬†                   <input type="text" id="nuevo_usuario" placeholder="Ej: CLOPCPAC001"
¬†                          style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†                   <small style="color: #666; display: block; margin-top: 5px;">Sin espacios, solo letras y n√∫meros</small>
¬†               </div>
¬†
¬†               <div class="form-group">
¬†                   <label>üîë Contrase√±a:</label>
¬†                   <input type="password" id="nuevo_password" placeholder="Ingrese contrase√±a"
¬†                          style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†               </div>
¬†
¬†               <div class="form-group">
¬†                   <label>üîë Confirmar Contrase√±a:</label>
¬†                   <input type="password" id="nuevo_password_confirm" placeholder="Confirme contrase√±a"
¬†                          style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†               </div>
¬†
¬†               <div class="form-group">
¬†   <label>üé≠ Rol:</label>
¬†   <select id="nuevo\_rol" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†       <option value="">-- Seleccione un rol --</option>
¬†       <option value="Administrador">Administrador</option>
¬†       <option value="Supervisor">Supervisor</option>
¬†	<option value="Despacho">Despacho</option> <!-- üÜï AGREGAR -->
¬†       <option value="Bodega">Bodega</option>
¬†       <option value="Consulta">Consulta</option>
¬†       <option value="Lectura">Lectura</option>
¬†       <option value="Contratista">Contratista</option>
¬†       <option value="ATTF">ATTF</option>
¬†       <option value="Poda">Poda</option>
¬†   </select>
</div>
¬†
¬†               <div class="action-buttons" style="margin-top: 25px;">
¬†                   <button class="btn btn-secondary" onclick="guardarNuevoUsuario()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
¬†                       üíæ Guardar Usuario
¬†                   </button>
¬†                   <button class="btn btn-danger" onclick="document.getElementById('searchResults').innerHTML = ''">
¬†                       ‚úï Cancelar
¬†                   </button>
¬†               </div>
¬†
¬†           </div>
¬†       </div>
¬†   `;
}

¬†	// ========================================
// üíæ GUARDAR NUEVO USUARIO
// ========================================
async function guardarNuevoUsuario() {
¬†   const usuario = document.getElementById('nuevo_usuario').value.trim();
¬†   const password = document.getElementById('nuevo_password').value.trim();
¬†   const passwordConfirm = document.getElementById('nuevo_password_confirm').value.trim();
¬†   const rol = document.getElementById('nuevo_rol').value;
¬†
¬†   // Validaciones
¬†   if (!usuario || !password || !passwordConfirm || !rol) {
¬†       alert('‚ö†Ô∏è Por favor complete todos los campos');
¬†       return;
¬†   }
¬†
¬†   if (usuario.length < 4) {
¬†       alert('‚ö†Ô∏è El usuario debe tener al menos 4 caracteres');
¬†       return;
¬†   }
¬†
¬†   if (password !== passwordConfirm) {
¬†       alert('‚ö†Ô∏è Las contrase√±as no coinciden');
¬†       return;
¬†   }
¬†
¬†   if (password.length < 6) {
¬†       alert('‚ö†Ô∏è La contrase√±a debe tener al menos 6 caracteres');
¬†       return;
¬†   }
¬†
¬†   // Verificar si el usuario ya existe
¬†   const { data: existente } = await supabaseClient
¬†       .from('usuarios')
¬†       .select('usuario')
¬†       .eq('usuario', usuario)
¬†       .single();
¬†
¬†   if (existente) {
¬†       alert('‚ùå El usuario "' + usuario + '" ya existe');
¬†       return;
¬†   }
¬†
¬†   // Confirmaci√≥n
¬†   const confirmar = confirm(
¬†       `¬øCrear nuevo usuario?\\n\\n` +
¬†       `Usuario: ${usuario}\\n` +
¬†       `Rol: ${rol}\\n\\n` +
¬†       `‚úÖ S√ç - Crear usuario\\n` +
¬†       `‚ùå NO - Cancelar`
¬†   );
¬†
¬†   if (!confirmar) return;
¬†
¬†   // Crear usuario
¬†   const { error } = await supabaseClient
¬†       .from('usuarios')
¬†       .insert({
¬†           usuario: usuario,
¬†           password: password,
¬†           rol: rol,
¬†           activo: true,
¬†           Contador: 0,
¬†           sessionactiva: false,
¬†           ultima_actividad: new Date().toISOString()
¬†       });
¬†
¬†   if (error) {
¬†       alert('‚ùå Error al crear usuario: ' + error.message);
¬†       return;
¬†   }
¬†
¬†   // √âxito
¬†   alert('‚úÖ Usuario creado exitosamente\n\nUsuario: ' + usuario + '\nRol: ' + rol);
¬†
¬†   document.getElementById('searchResults').innerHTML = `
¬†       <div class="result-card" style="background: #e8f5e9; border: 2px solid #4caf50;">
¬†           <div class="result-header">‚úÖ Usuario Creado</div>
¬†           <div style="padding: 20px; text-align: center;">
¬†               <p style="font-size: 18px; color: #2e7d32; margin: 0 0 10px 0;">
¬†                   <strong>Usuario "${usuario}" creado correctamente</strong>
¬†               </p>
¬†               <p style="color: #666; margin: 0;">Rol asignado: <strong>${rol}</strong></p>
¬†           </div>
¬†       </div>
¬†   `;
}

¬†	


¬†	// ========================================
// üìã MOSTRAR INSTRUCCIONES SEG√öN TIPO
// ========================================
function mostrarInstruccionesArchivo() {
¬†   const tipo = document.getElementById('tipoActualizacion').value;
¬†   const contenedor = document.getElementById('instruccionesArchivo');
¬†
¬†   if (!tipo) {
¬†       contenedor.style.display = 'none';
¬†       return;
¬†   }
¬†
¬†   let html = '<strong>üìã Formato requerido del archivo:</strong><br><br>';
¬†
¬†   if (tipo === 'medidor_comentario') {
¬†       html += `
¬†           <strong>Columnas (en este orden):</strong><br>
¬†           1. CuentaContrato<br>
¬†           2. Medidor<br>
¬†           3. ComentarioGeneral<br><br>
¬†           <strong>B√∫squeda:</strong> Por CuentaContrato<br>
¬†           <strong>Actualiza:</strong> Medidor y ComentarioGeneral
¬†       `;
¬†   } else if (tipo === 'nombre_cuenta') {
¬†       html += `
¬†           <strong>Columnas (en este orden):</strong><br>
¬†           1. CuentaContrato<br>
¬†           2. Medidor<br>
¬†           3. NombreCliente<br><br>
¬†           <strong>B√∫squeda:</strong> Por Medidor<br>
¬†           <strong>Actualiza:</strong> CuentaContrato y NombreCliente
¬†       `;
¬†   } else if (tipo === 'grafica') {
¬†       html += `
¬†           <strong>Columnas (en este orden):</strong><br>
¬†           1. CuentaContrato<br>
¬†           2. Grafica<br><br>
¬†           <strong>B√∫squeda:</strong> Por CuentaContrato<br>
¬†           <strong>Actualiza:</strong> Grafica
¬†       `;
¬†   }
¬†
¬†   contenedor.innerHTML = html;
¬†   contenedor.style.display = 'block';
}

¬†
¬†	// ========================================
// ‚ö° PROCESAR ACTUALIZACI√ìN MASIVA
// ========================================
async function procesarActualizacionMasiva() {
¬†   const tipo = document.getElementById('tipoActualizacion').value;
¬†   const archivoInput = document.getElementById('archivoActualizacion');
¬†
¬†   // Validaciones
¬†   if (!tipo) {
¬†       alert('‚ö†Ô∏è Por favor seleccione el tipo de actualizaci√≥n');
¬†       return;
¬†   }
¬†
¬†   if (!archivoInput.files || archivoInput.files.length === 0) {
¬†       alert('‚ö†Ô∏è Por favor seleccione un archivo');
¬†       return;
¬†   }
¬†
¬†   const archivo = archivoInput.files[0];
¬†   const extension = archivo.name.split('.').pop().toLowerCase();
¬†
¬†   if (!['xlsx', 'xls', 'csv'].includes(extension)) {
¬†       alert('‚ö†Ô∏è Formato de archivo no v√°lido. Use Excel (.xlsx, .xls) o CSV');
¬†       return;
¬†   }
¬†
¬†   // Mostrar loading
¬†   const resultsContainer = document.getElementById('searchResults');
¬†   resultsContainer.innerHTML = `
¬†       <div class="result-card" style="background: #e3f2fd; border: 2px solid #2196f3; text-align: center;">
¬†           <div class="loading" style="display: block; margin: 20px auto;"></div>
¬†           <h3 style="color: #1565c0; margin: 20px 0;">Procesando archivo...</h3>
¬†           <p style="color: #666;">Por favor espere, esto puede tomar unos momentos</p>
¬†       </div>
¬†   `;
¬†
¬†   try {
¬†       // Leer archivo
¬†       const datos = await leerArchivoActualizacion(archivo, extension);
¬†
¬†       if (!datos || datos.length === 0) {
¬†           alert('‚ùå El archivo est√° vac√≠o o no se pudo leer');
¬†           mostrarActualizacionMasiva();
¬†           return;
¬†       }
¬†
¬†       // Validar estructura seg√∫n tipo
¬†       const validacion = validarEstructuraArchivo(datos, tipo);
¬†
¬†       if (!validacion.valido) {
¬†           alert(`‚ùå Error en estructura del archivo:\\n\\n${validacion.mensaje}`);
¬†           mostrarActualizacionMasiva();
¬†           return;
¬†       }
¬†
¬†
¬†       // Mostrar progreso de b√∫squeda
resultsContainer.innerHTML = `
¬†   <div class="result-card" style="background: #e3f2fd; border: 2px solid #2196f3; text-align: center;">
¬†       <div class="loading" style="display: block; margin: 20px auto;"></div>
¬†       <h3 style="color: #1565c0; margin: 20px 0;">Buscando coincidencias en base de datos...</h3>
¬†       <p style="color: #666; font-size: 16px;">Esto puede tomar 5-10 minutos para 200k registros</p>
¬†       <p style="color: #666; font-size: 14px; margin-top: 10px;">Por favor no cierres esta ventana</p>
¬†   </div>
`;

const resultado = await buscarCoincidencias(datos, tipo);
¬†
¬†       // Mostrar preview de actualizaci√≥n
¬†       mostrarPreviewActualizacion(resultado, tipo);
¬†
¬†   } catch (error) {
¬†       console.error('Error procesando archivo:', error);
¬†       alert('‚ùå Error al procesar el archivo: ' + error.message);
¬†       mostrarActualizacionMasiva();
¬†   }
}

¬†	// ========================================
// üìñ LEER ARCHIVO (EXCEL O CSV)
// ========================================
async function leerArchivoActualizacion(archivo, extension) {
¬†   return new Promise((resolve, reject) => {
¬†       const reader = new FileReader();
¬†
¬†       reader.onload = async (e) => {
¬†           try {
¬†               let datos = [];
¬†
¬†               if (extension === 'csv') {
¬†                   // Leer CSV
¬†                   const texto = e.target.result;
¬†                   const lineas = texto.split('\n').filter(l => l.trim());
¬†
¬†                   // Saltar header y procesar
¬†                   for (let i = 1; i < lineas.length; i++) {
¬†                       const valores = lineas[i].split(',').map(v => v.trim());
¬†                       if (valores.length > 0 && valores[0]) {
¬†                           datos.push(valores);
¬†                       }
¬†                   }
¬†               } else {
¬†                   // Leer Excel con SheetJS
¬†                   const data = new Uint8Array(e.target.result);
¬†                   const workbook = XLSX.read(data, { type: 'array' });
¬†                   const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
¬†                   const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
¬†
¬†                   // Saltar header
¬†                   datos = jsonData.slice(1).filter(row => row.length > 0 && row[0]);
¬†               }
¬†
¬†               console.log(`‚úÖ Archivo le√≠do: ${datos.length} filas`);
¬†               resolve(datos);
¬†
¬†           } catch (error) {
¬†               reject(error);
¬†           }
¬†       };
¬†
¬†       reader.onerror = () => reject(new Error('Error al leer el archivo'));
¬†
¬†       if (extension === 'csv') {
¬†           reader.readAsText(archivo);
¬†       } else {
¬†           reader.readAsArrayBuffer(archivo);
¬†       }
¬†   });
}


¬†	// ========================================
// ‚úÖ VALIDAR ESTRUCTURA DEL ARCHIVO (CORREGIDA)
// ========================================
function validarEstructuraArchivo(datos, tipo) {
    let columnasRequeridas = 0;
    let nombreColumnas = '';

    if (tipo === 'medidor_comentario') {
        columnasRequeridas = 3;
        nombreColumnas = 'CuentaContrato, Medidor, ComentarioGeneral';
    } else if (tipo === 'nombre_cuenta') {
        columnasRequeridas = 3;
        nombreColumnas = 'CuentaContrato, Medidor, NombreCliente';
    } else if (tipo === 'grafica') {
        columnasRequeridas = 2;
        nombreColumnas = 'CuentaContrato, Grafica';
    }

    // Validar que todas las filas tengan el n√∫mero correcto de columnas
    for (let i = 0; i < datos.length; i++) {
        // CORRECCI√ìN: datos[i].length (sin la barra invertida)
        if (datos[i].length < columnasRequeridas) {
            return {
                valido: false,
                mensaje: `Fila ${i + 2}: Se esperan ${columnasRequeridas} columnas (${nombreColumnas}), pero solo se encontraron ${datos[i].length}`
            };
        }
    }

    return { valido: true };
}


¬†	// ========================================
// üîç BUSCAR COINCIDENCIAS EN BD
// ========================================
async function buscarCoincidencias(datos, tipo) {
¬†   console.log(`üîç Procesando ${datos.length} filas del archivo...`);
¬†
¬†   const encontrados = [];
¬†   const noEncontrados = [];
¬†   const duplicadosEnArchivo = [];
¬†   const BATCH_SIZE = 500;
¬†
¬†   // Normalizar valor
¬†   const normalizarValor = (val) => {
¬†       let str = String(val).trim();
¬†       if (/[eE]\+/.test(str)) {
¬†           str = parseFloat(str).toFixed(0);
¬†       }
¬†       return str;
¬†   };
¬†
¬†   // ‚úÖ PASO 1: Eliminar duplicados del archivo
¬†   const valoresUnicos = new Map(); // clave = valorBusqueda, valor = {primera vez que aparece}
¬†   const mapaTodasFilas = new Map(); // Guardar TODAS las filas (incluso duplicadas)
¬†
¬†   datos.forEach((fila, index) => {
¬†       let campoBusqueda, valorBusqueda, datosActualizar;
¬†
¬†       if (tipo === 'medidor_comentario') {
¬†           campoBusqueda = 'CuentaContrato';
¬†           valorBusqueda = normalizarValor(fila[0]);
¬†           datosActualizar = {
¬†               Medidor: normalizarValor(fila[1]),
¬†               ComentarioGeneral: String(fila[2] || '').trim()
¬†           };
¬†       } else if (tipo === 'nombre_cuenta') {
¬†           campoBusqueda = 'Medidor';
¬†           valorBusqueda = normalizarValor(fila[1]);
¬†           datosActualizar = {
¬†               CuentaContrato: normalizarValor(fila[0]),
¬†               NombreCliente: String(fila[2] || '').trim()
¬†           };
¬†       } else if (tipo === 'grafica') {
¬†           campoBusqueda = 'CuentaContrato';
¬†           valorBusqueda = normalizarValor(fila[0]);
¬†           datosActualizar = {
¬†               Grafica: String(fila[1] || '').trim()
¬†           };
¬†       }
¬†
¬†       // Detectar duplicados
¬†       if (valoresUnicos.has(valorBusqueda)) {
¬†           duplicadosEnArchivo.push({
¬†               valor: valorBusqueda,
¬†               fila: index + 2, // +2 porque Excel empieza en 1 y tiene header
¬†               campo: campoBusqueda
¬†           });
¬†       } else {
¬†           valoresUnicos.set(valorBusqueda, { campoBusqueda, datosActualizar });
¬†       }
¬†
¬†       // Guardar todas las filas para update
¬†       if (!mapaTodasFilas.has(valorBusqueda)) {
¬†           mapaTodasFilas.set(valorBusqueda, []);
¬†       }
¬†       mapaTodasFilas.get(valorBusqueda).push({ index, datosActualizar });
¬†   });
¬†
¬†   console.log(`üìä Valores √∫nicos: ${valoresUnicos.size} (de ${datos.length} filas)`);
¬†   if (duplicadosEnArchivo.length > 0) {
¬†       console.log(`‚ö†Ô∏è Duplicados en archivo: ${duplicadosEnArchivo.length}`);
¬†   }
¬†
¬†   // ‚úÖ PASO 2: Buscar solo valores √∫nicos
¬†   const valoresUnicosArray = Array.from(valoresUnicos.keys());
¬†
¬†   for (let i = 0; i < valoresUnicosArray.length; i += BATCH_SIZE) {
¬†       const batch = valoresUnicosArray.slice(i, i + BATCH_SIZE);
¬†       const campoBusqueda = valoresUnicos.values().next().value.campoBusqueda;
¬†
¬†       const { data, error } = await supabaseClient
¬†           .from('consultas_servicios')
¬†           .select(`id, ${campoBusqueda}`)
¬†           .in(campoBusqueda, batch);
¬†
¬†       if (error) {
¬†           console.error(`Error en batch ${i}:`, error.message);
¬†           batch.forEach(val => {
¬†               noEncontrados.push({ busqueda: val, campo: campoBusqueda });
¬†           });
¬†           continue;
¬†       }
¬†
¬†       // Procesar resultados
¬†       const encontradosSet = new Set();
¬†
¬†       if (data && data.length > 0) {
¬†           data.forEach(registro => {
¬†               const valorEncontrado = String(registro[campoBusqueda]).trim();
¬†               const datosFila = valoresUnicos.get(valorEncontrado);
¬†
¬†               if (datosFila) {
¬†                   // ‚úÖ Agregar UNA SOLA VEZ (aunque haya duplicados en el archivo)
¬†                   encontrados.push({
¬†                       id: registro.id,
¬†                       busqueda: valorEncontrado,
¬†                       datos: datosFila.datosActualizar
¬†                   });
¬†                   encontradosSet.add(valorEncontrado);
¬†               }
¬†           });
¬†       }
¬†
¬†       // Los que no se encontraron
¬†       batch.forEach(val => {
¬†           if (!encontradosSet.has(val)) {
¬†               noEncontrados.push({
¬†                   busqueda: val,
¬†                   campo: campoBusqueda
¬†               });
¬†           }
¬†       });
¬†
¬†       // Progreso cada 5,000
¬†       if ((i + BATCH_SIZE) % 5000 === 0) {
¬†           console.log(`‚úÖ Procesados ${i + BATCH_SIZE} / ${valoresUnicosArray.length} valores √∫nicos`);
¬†       }
¬†   }
¬†
¬†   console.log(`‚úÖ B√∫squeda completa: ${encontrados.length} encontrados, ${noEncontrados.length} no encontrados`);
¬†
¬†   // ‚úÖ Retornar info de duplicados
¬†   return {
¬†       encontrados,
¬†       noEncontrados,
¬†       tipo,
¬†       duplicados: duplicadosEnArchivo.length,
¬†       totalFilas: datos.length,
¬†       valoresUnicos: valoresUnicosArray.length
¬†   };
}



¬†	// ========================================
// üëÅÔ∏è MOSTRAR PREVIEW DE ACTUALIZACI√ìN
// ========================================
function mostrarPreviewActualizacion(resultado, tipo) {
¬†   const { encontrados, noEncontrados } = resultado;
¬†   const resultsContainer = document.getElementById('searchResults');
¬†
¬†   let nombreTipo = '';
¬†   if (tipo === 'medidor_comentario') nombreTipo = 'Medidor + Comentario General';
¬†   else if (tipo === 'nombre_cuenta') nombreTipo = 'Nombre Cliente + Cuenta Contrato';
¬†   else if (tipo === 'grafica') nombreTipo = 'Gr√°fica';
¬†
¬†   let html = `
¬†   <div class="result-card" style="background: #fff3cd; border: 2px solid #ffc107;">
¬†       <div class="result-header">‚ö†Ô∏è Confirmaci√≥n de Actualizaci√≥n</div>
¬†
¬†       <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
¬†           <strong style="font-size: 18px; color: #2d3748;">üìä Resumen:</strong><br><br>
¬†           <div style="font-size: 16px; line-height: 2;">
¬†               ‚Ä¢ Tipo: <strong>${nombreTipo}</strong><br>
¬†               ‚Ä¢ Total de filas en archivo: <strong>${resultado.totalFilas || (encontrados.length + noEncontrados.length)}</strong><br>
¬†               ${resultado.duplicados > 0 ? `‚Ä¢ ‚ö†Ô∏è Duplicados en archivo: <strong style="color: #ff9800;">${resultado.duplicados}</strong><br>` : ''}
¬†               ‚Ä¢ Valores √∫nicos: <strong>${resultado.valoresUnicos || (encontrados.length + noEncontrados.length)}</strong><br>
¬†               ‚Ä¢ ‚úÖ Registros encontrados (se actualizar√°n): <strong style="color: #2e7d32;">${encontrados.length}</strong><br>
¬†                   ‚Ä¢ ‚ùå Registros no encontrados (se ignorar√°n): <strong style="color: #d32f2f;">${noEncontrados.length}</strong>
¬†               </div>
¬†           </div>
¬†   `;
¬†
¬†   // Mostrar no encontrados si existen
¬†   if (noEncontrados.length > 0) {
¬†       html += `
¬†           <div style="background: #ffebee; padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #d32f2f; max-height: 200px; overflow-y: auto;">
¬†               <strong style="color: #c62828;">‚ùå Registros NO encontrados:</strong><br><br>
¬†               <div style="font-size: 14px; line-height: 1.8;">`;
¬†
¬†       noEncontrados.slice(0, 10).forEach(item => {
¬†           html += `‚Ä¢ ${item.campo}: <strong>${item.busqueda}</strong><br>`;
¬†       });
¬†
¬†       if (noEncontrados.length > 10) {
¬†           html += `<br><em>... y ${noEncontrados.length - 10} m√°s</em>`;
¬†       }
¬†
¬†       html += `</div></div>`;
¬†   }
¬†
¬†   // Botones de confirmaci√≥n
¬†   html += `
¬†           <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #2196f3;">
¬†               <strong style="font-size: 16px; color: #1565c0;">‚ö†Ô∏è Esta acci√≥n es IRREVERSIBLE</strong><br>
¬†               <p style="margin: 10px 0 0 0; color: #666;">
¬†                   Los datos actuales ser√°n reemplazados por los del archivo.
¬†               </p>
¬†           </div>
¬†
¬†           <div class="action-buttons" style="margin-top: 25px;">
¬†               <button class="btn btn-secondary" onclick="ejecutarActualizacionMasiva(${JSON.stringify(encontrados).replace(/"/g, '&quot;')}, '${tipo}')"
¬†                       style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); font-size: 18px; padding: 18px 30px;">
¬†                   ‚úÖ Confirmar y Actualizar (${encontrados.length} registros)
¬†               </button>
¬†               <button class="btn btn-danger" onclick="mostrarActualizacionMasiva()" style="font-size: 16px; padding: 15px 25px;">
¬†                   ‚úï Cancelar
¬†               </button>
¬†           </div>
¬†
¬†       </div>
¬†   `;
¬†
¬†   resultsContainer.innerHTML = html;
}

¬†	// ========================================
// üöÄ EJECUTAR ACTUALIZACI√ìN MASIVA
// ========================================
async function ejecutarActualizacionMasiva(encontrados, tipo) {
¬†   const resultsContainer = document.getElementById('searchResults');
¬†
¬†   resultsContainer.innerHTML = `
¬†       <div class="result-card" style="background: #e3f2fd; border: 2px solid #2196f3; text-align: center;">
¬†           <div class="loading" style="display: block; margin: 20px auto;"></div>
¬†           <h3 style="color: #1565c0; margin: 20px 0;">Actualizando registros...</h3>
¬†           <p style="color: #666; font-size: 18px;" id="progresoActualizacion">0 / ${encontrados.length}</p>
¬†           <p style="color: #999; font-size: 14px;" id="velocidadActualizacion">Iniciando...</p>
¬†       </div>
¬†   `;
¬†
¬†   const exitosos = [];
¬†   const fallidos = [];
¬†   const BATCH_SIZE = 250; // ‚úÖ Reducido a 250 (√≥ptimo para evitar timeout)
¬†   const PARALLEL_BATCHES = 10; // ‚úÖ 5 batches en paralelo = 2500 updates simult√°neos
¬†
¬†   const tiempoInicio = Date.now();
¬†
¬†   // Procesar en grupos paralelos
¬†   for (let i = 0; i < encontrados.length; i += (BATCH_SIZE * PARALLEL_BATCHES)) {
¬†       const superBatch = [];
¬†
¬†       // Crear 5 batches de 200
¬†       for (let j = 0; j < PARALLEL_BATCHES; j++) {
¬†           const startIdx = i + (j * BATCH_SIZE);
¬†           if (startIdx < encontrados.length) {
¬†               superBatch.push(encontrados.slice(startIdx, startIdx + BATCH_SIZE));
¬†           }
¬†       }
¬†
¬†       // Ejecutar los 5 batches en paralelo
¬†       const batchPromises = superBatch.map(batch =>
¬†           procesarBatch(batch).catch(err => {
¬†               console.error('Error en batch:', err);
¬†               return { exitosos: [], fallidos: batch.map(b => ({ busqueda: b.busqueda, error: err.message })) };
¬†           })
¬†       );
¬†
¬†       const resultados = await Promise.all(batchPromises);
¬†
¬†       // Consolidar resultados
¬†       resultados.forEach(res => {
¬†           exitosos.push(...res.exitosos);
¬†           fallidos.push(...res.fallidos);
¬†       });
¬†
¬†       // Actualizar progreso
¬†       const progreso = Math.min(i + (BATCH_SIZE * PARALLEL_BATCHES), encontrados.length);
¬†       const tiempoTranscurrido = (Date.now() - tiempoInicio) / 1000;
¬†       const velocidad = Math.round(progreso / tiempoTranscurrido);
¬†       const tiempoRestante = Math.round((encontrados.length - progreso) / velocidad);
¬†
¬†       document.getElementById('progresoActualizacion').textContent =
¬†           `${progreso} / ${encontrados.length}`;
¬†       document.getElementById('velocidadActualizacion').textContent =
¬†           `Velocidad: ${velocidad} reg/seg | Tiempo restante: ~${Math.max(0, tiempoRestante)}s`;
¬†   }
¬†
¬†   // Funci√≥n auxiliar para procesar cada batch
¬†   async function procesarBatch(batch) {
¬†       const exitososBatch = [];
¬†       const fallidosBatch = [];
¬†
¬†       const promises = batch.map(item =>
¬†           supabaseClient
¬†               .from('consultas_servicios')
¬†               .update(item.datos)
¬†               .eq('id', item.id)
¬†               .then(({ error }) => {
¬†                   if (error) {
¬†                       return { success: false, item, error: error.message };
¬†                   }
¬†                   return { success: true, item };
¬†               })
¬†               .catch(err => {
¬†                   return { success: false, item, error: err.message };
¬†               })
¬†       );
¬†
¬†       const resultados = await Promise.all(promises);
¬†
¬†       resultados.forEach(res => {
¬†           if (res.success) {
¬†               exitososBatch.push(res.item.busqueda);
¬†           } else {
¬†               fallidosBatch.push({
¬†                   busqueda: res.item.busqueda,
¬†                   error: res.error
¬†               });
¬†           }
¬†       });
¬†
¬†       return { exitosos: exitososBatch, fallidos: fallidosBatch };
¬†   }
¬†
¬†   // Mostrar resultado final
¬†   const tiempoTotal = Math.round((Date.now() - tiempoInicio) / 1000);
¬†
¬†   resultsContainer.innerHTML = `
¬†       <div class="result-card" style="background: ${fallidos.length === 0 ? '#e8f5e9' : '#fff3cd'}; border: 2px solid ${fallidos.length === 0 ? '#4caf50' : '#ffc107'};">
¬†           <div class="result-header">${fallidos.length === 0 ? '‚úÖ' : '‚ö†Ô∏è'} Actualizaci√≥n Completada</div>
¬†
¬†           <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
¬†               <strong style="font-size: 18px; color: #2d3748;">üìä Resultado Final:</strong><br><br>
¬†               <div style="font-size: 16px; line-height: 2;">
¬†                   ‚Ä¢ Tipo de actualizaci√≥n: <strong>${tipo}</strong><br>
¬†                   ‚Ä¢ ‚úÖ Registros actualizados: <strong style="color: #2e7d32;">${exitosos.length}</strong><br>
¬†                   ‚Ä¢ ‚ùå Registros con errores: <strong style="color: #d32f2f;">${fallidos.length}</strong><br>
¬†                   ‚Ä¢ ‚è±Ô∏è Tiempo total: <strong>${tiempoTotal}s (${Math.round(tiempoTotal/60)} min)</strong><br>
¬†                   ‚Ä¢ ‚ö° Velocidad promedio: <strong>${Math.round(exitosos.length/tiempoTotal)} reg/seg</strong>
¬†               </div>
¬†           </div>
¬†
¬†           ${fallidos.length > 0 ? `
¬†           <div style="background: #ffebee; padding: 15px; border-radius: 10px; margin: 20px 0; max-height: 200px; overflow-y: auto;">
¬†               <strong style="color: #c62828;">‚ùå Primeros errores (${Math.min(10, fallidos.length)} de ${fallidos.length}):</strong><br><br>
¬†               ${fallidos.slice(0, 10).map(f => `‚Ä¢ ${f.busqueda}: ${f.error}`).join('<br>')}
¬†           </div>` : ''}
¬†
¬†           <div style="text-align: center; margin-top: 25px;">
¬†               <button class="btn" onclick="mostrarActualizacionMasiva()">
¬†                   üîÑ Nueva Actualizaci√≥n
¬†               </button>
¬†           </div>
¬†       </div>
¬†   `;
}


// ========================================
// üìä MOSTRAR RESULTADO FINAL
// ========================================
function mostrarResultadoActualizacion(exitosos, fallidos, tipo) {
¬†   const resultsContainer = document.getElementById('searchResults');
¬†
¬†   let nombreTipo = '';
¬†   if (tipo === 'medidor_comentario') nombreTipo = 'Medidor + Comentario General';
¬†   else if (tipo === 'nombre_cuenta') nombreTipo = 'Nombre Cliente + Cuenta Contrato';
¬†   else if (tipo === 'grafica') nombreTipo = 'Gr√°fica';
¬†
¬†   let html = `
¬†       <div class="result-card" style="background: ${fallidos.length === 0 ? '#e8f5e9' : '#fff3cd'}; border: 2px solid ${fallidos.length === 0 ? '#4caf50' : '#ffc107'};">
¬†           <div class="result-header">${fallidos.length === 0 ? '‚úÖ' : '‚ö†Ô∏è'} Actualizaci√≥n Completada</div>
¬†
¬†           <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
¬†               <strong style="font-size: 18px; color: #2d3748;">üìä Resultado Final:</strong><br><br>
¬†               <div style="font-size: 16px; line-height: 2;">
¬†                   ‚Ä¢ Tipo de actualizaci√≥n: <strong>${nombreTipo}</strong><br>
¬†                   ‚Ä¢ ‚úÖ Registros actualizados correctamente: <strong style="color: #2e7d32;">${exitosos.length}</strong><br>
¬†                   ‚Ä¢ ‚ùå Registros con errores: <strong style="color: #d32f2f;">${fallidos.length}</strong>
¬†               </div>
¬†           </div>
¬†   `;
¬†
¬†   // Mostrar fallidos si existen
¬†   if (fallidos.length > 0) {
¬†       html += `
¬†           <div style="background: #ffebee; padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #d32f2f; max-height: 250px; overflow-y: auto;">
¬†               <strong style="color: #c62828;">‚ùå Errores encontrados:</strong><br><br>
¬†               <div style="font-size: 14px; line-height: 1.8;">`;
¬†
¬†       fallidos.forEach(item => {
¬†           html += `‚Ä¢ ${item.busqueda}: <span style="color: #666;">${item.error}</span><br>`;
¬†       });
¬†
¬†       html += `</div></div>`;
¬†   }
¬†
¬†   html += `
¬†           <div style="text-align: center; margin-top: 25px;">
¬†               <button class="btn" onclick="mostrarActualizacionMasiva()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: auto; padding: 15px 30px;">
¬†                   üîÑ Nueva Actualizaci√≥n
¬†               </button>
¬†               <button class="btn btn-secondary" onclick="document.getElementById('searchResults').innerHTML = ''" style="width: auto; padding: 15px 30px; margin-left: 15px;">
¬†                   ‚úï Cerrar
¬†               </button>
¬†           </div>
¬†
¬†       </div>
¬†   `;
¬†
¬†   resultsContainer.innerHTML = html;
¬†
¬†   console.log(`‚úÖ Actualizaci√≥n completada: ${exitosos.length} exitosos, ${fallidos.length} fallidos`);
}

¬†




¬†  // ===================================================================
// üîç FUNCI√ìN UNIFICADA DE B√öSQUEDA (VERSI√ìN COMPLETA Y OPTIMIZADA)
// ===================================================================

async function buscar(campo, tipo) {
¬†   await renovarSesion();
¬†   await capturarCoordenadasGPS();
¬†
¬†   const valor = document.getElementById(`search${campo}`).value.trim();
¬†   if (!valor) {
¬†       alert(`Por favor ingrese un valor para ${campo}`);
¬†       return;
¬†   }

¬†   // üÜï LIMPIAR AUTOM√ÅTICAMENTE OTROS CAMPOS
¬†   limpiarOtrosCampos(campo);

¬†   await incrementarContadorBusquedas();
¬†
¬†   const valores = valor.includes(',') ? valor.split(',').map(v => v.trim()).filter(v => v) : [valor];
¬†
¬†   if (valores.length > 1) {
¬†       // B√∫squeda M√∫ltiple KML
¬†       await busquedaMultipleKML(campo, valores);
¬†   } else {
¬†       // B√∫squeda simple
¬†       let query = supabaseClient.from(selectedTable).select('*');
¬†       if (tipo === 'exact') query = query.eq(campo, valor);
¬†       else query = query.ilike(campo, `%${valor}%`);

¬†       const { data, error } = await query;
¬†       if (error) {
¬†           alert('Error al buscar: ' + error.message);
¬†           return;
¬†       }
¬†
¬†       mostrarResultados(data || []);
¬†
¬†       // B√∫squeda adicional autom√°tica en tablas relacionadas
¬†       busquedaEnTablasRelacionadas(campo, valor, data || []);
¬†   }
}

¬†	// ========================================
// üîÑ TRANSFORMAR USUARIO A FORMATO UNIDAD
// ========================================
/**
 * Transforma nombre de usuario a formato de unidad estandarizado
 * @param {string} usuario - Nombre de usuario (ej: "CLEYBPAC01", "CL-EYB-PAC-01")
 * @returns {string|null} - Unidad formateada CL-XXX-YYY-NNN o null si no se reconoce
 */
function transformarUsuarioAUnidad(usuario) {
    // ‚úÖ Validaci√≥n inicial
    if (!usuario || typeof usuario !== 'string') return null;
    
    // Normalizar: trim + may√∫sculas para comparaci√≥n consistente
    const u = usuario.trim().toUpperCase();
    
    // üö´ Lista de usuarios EXCLUIDOS de transformaci√≥n (casos especiales)
    const usuariosSinTransformar = [
        'ADMIN', 'JMEC6885', 'BODEGA001', 'BODEGA002', 'BODEGA',
        'DONHECTOR', 'DONRIVAS', 'PRUEBA1', 'PRUEBA2',
        'LEDY.S', 'HECTOR.H', 'IMMER.T', 'MOISES.T', 'DIEGO.G', 'SUPERVISOR'
    ];
    
    // Si es usuario especial, retornar tal cual (sin transformar)
    if (usuariosSinTransformar.includes(u)) {
        console.log(`‚úÖ Usuario especial sin transformaci√≥n: ${usuario}`);
        return usuario;
    }
    
    // ‚úÖ CASO 1: Ya tiene formato con guiones ‚Üí Validar y retornar
    // Patr√≥n: CL-XXX-YYY-NNN (XXX=3 letras, YYY=3 letras, NNN=2-3 d√≠gitos)
    if (u.startsWith('CL-')) {
        const patronGuiones = /^CL-[A-Z]{3}-[A-Z]{3}-\d{2,3}$/;
        if (patronGuiones.test(u)) {
            console.log(`‚úÖ Formato ya v√°lido: ${u}`);
            return u;
        }
        // Si tiene guiones pero no coincide, intentar reparar
        const partes = u.split('-').filter(p => p);
        if (partes.length === 4 && partes[0] === 'CL' && 
            /^[A-Z]{3}$/.test(partes[1]) && /^[A-Z]{3}$/.test(partes[2]) && /^\d{2,3}$/.test(partes[3])) {
            const reparado = `CL-${partes[1]}-${partes[2]}-${partes[3]}`;
            console.log(`üîß Formato reparado: ${usuario} ‚Üí ${reparado}`);
            return reparado;
        }
    }
    
    // ‚úÖ CASO 2: Formato compacto SIN guiones ‚Üí Transformar
    // Patr√≥n: CL + 3 letras (zona) + 3 letras (tipo) + 2-3 d√≠gitos (n√∫mero)
    // Ej: CLEYBPAC01 ‚Üí CL-EYB-PAC-01
    const matchCompacto = u.match(/^CL([A-Z]{3})([A-Z]{3})(\d{2,3})$/);
    
    if (matchCompacto) {
        const [, zona, tipo, numero] = matchCompacto;
        const transformado = `CL-${zona}-${tipo}-${numero}`;
        console.log(`‚úÖ Transformado: ${usuario} ‚Üí ${transformado}`);
        return transformado;
    }
    
    // ‚ö†Ô∏è CASO 3: Formato no reconocido ‚Üí Log y retornar null
    console.warn(`‚ö†Ô∏è Formato no reconocido: "${usuario}" (normalizado: "${u}")`);
    return null;
}


async function cargarInterfazKMLRuta() {
    console.log('üöÄ EJECUTANDO: cargarInterfazKMLRuta (Modo Carga Total + Comentarios)');
    
    const chunkArray = (arr, size) => {
        const out = [];
        for (let i = 0; i < arr.length; i += size) {
            out.push(arr.slice(i, i + size));
        }
        return out;
    };

    await limpiarFiltrosObsoletos();
    renovarSesion();

    const searchGrid = document.getElementById('searchGrid');
    const resultsContainer = document.getElementById('searchResults');
    searchGrid.innerHTML = '<div class="loading" style="display: block; margin: 20px auto;"></div><p style="text-align:center;">Cargando universo de √≥rdenes...</p>';
    resultsContainer.innerHTML = '';

    try {
        const miUnidadRaw = transformarUsuarioAUnidad(currentUser.usuario);
        const rol = currentUser?.rol;

        // ========================================
        // 1Ô∏è‚É£ OBTENER TODAS LAS ASIGNACIONES ACTUALES
        // ========================================
        console.log('üì• Cargando os_asignadas...');
        const { data: asignaciones, error: errorAsignadas } = await supabaseClient
            .from('os_asignadas')
            .select('osatomo, Unidad, Estado, Tipologia');

        if (errorAsignadas) throw errorAsignadas;
        console.log(`‚úÖ ${asignaciones?.length || 0} asignaciones cargadas`);

        // ========================================
        // 2Ô∏è‚É£ OBTENER UNIVERSO DE PENDIENTES (PAGINADO)
        // ========================================
        let todasLasPendientes = [];
        let r_inicio = 0, r_fin = 999, hayMas = true;
        console.log("‚è≥ Descargando OS Pendientes por lotes...");
        
        while (hayMas) {
            const { data: lote, error: errorLote } = await supabaseClient
                .from('OS Pendientes')
                .select('OSATMO, Unidad, Tipologia, Tipo_de_OS, Coordenadas, Coordendasgis, Comentario, Deuda, "Fecha Gen.", Medidor, CuentaContrato, Estado_ATOMO, Estado_SAP, Direccion')
                .range(r_inicio, r_fin);

            if (errorLote) throw errorLote;
            if (!lote || lote.length === 0) break;
            
            todasLasPendientes.push(...lote);
            console.log(`üì¶ Lote ${r_inicio}-${r_fin}: ${lote.length} registros. Total: ${todasLasPendientes.length}`);
            
            hayMas = (lote.length === 1000);
            if (hayMas) { r_inicio += 1000; r_fin += 1000; }
        }

        // üîç AUDITOR√çA OPCIONAL (solo para debugging)
        const osAuditoria = todasLasPendientes.find(p => String(p.OSATMO).trim() === '11195544');
        if (osAuditoria) {
            console.group("üéØ AUDITOR√çA: OS 11195544");
            console.log("‚úÖ Encontrada | Unidad:", osAuditoria.Unidad, "| Tipolog√≠a:", osAuditoria.Tipologia);
            console.groupEnd();
        }

        // ========================================
        // üî• 3Ô∏è‚É£ FILTRADO ROBUSTO DE MIS ASIGNADAS (CON NORMALIZACI√ìN)
        // ========================================
        console.log('üîç Filtrando OS asignadas con normalizaci√≥n robusta...');
        
        // Normalizar unidad objetivo para comparaci√≥n
        const unidadObjetivo = miUnidadRaw || String(currentUser.usuario).trim().toUpperCase();
        const unidadObjetivoLimpia = unidadObjetivo.replace(/[^A-Z0-9]/g, '').toUpperCase();
        console.log(`üìä Unidad: "${unidadObjetivo}" ‚Üí Limpia: "${unidadObjetivoLimpia}"`);

        // Filtrar con comparaci√≥n flexible (ignora guiones, espacios, etc.)
        const misAsignacionesPropias = asignaciones
            .filter(asig => {
                const unidadOS = String(asig.Unidad || '').trim();
                if (!unidadOS) return false;
                const unidadOSLimpia = unidadOS.replace(/[^A-Z0-9]/g, '').toUpperCase();
                return unidadOSLimpia === unidadObjetivoLimpia;
            })
            .map(asig => {
                const idAsignada = String(asig.osatomo).trim();
                const detalle = todasLasPendientes.find(p => String(p.OSATMO).trim() === idAsignada);
                
                return {
                    ...asig,
                    OSATMO: idAsignada,
                    Tipologia: detalle?.Tipologia || asig.Tipologia || 'Sin tipolog√≠a',
                    Coordenadas: detalle?.Coordenadas || detalle?.Coordendasgis || null,
                    Coordendasgis: detalle?.Coordendasgis || null,
                    Tipo_de_OS: detalle?.Tipo_de_OS || 'S/D',
                    Medidor: detalle?.Medidor || null,          // ‚Üê IMPORTANTE para comentarios
                    CuentaContrato: detalle?.CuentaContrato || null,
                    Comentario: detalle?.Comentario || '',       // ‚Üê Comentario original de OS Pendientes
                    ComentarioGeneral: detalle?.Comentario || '',
                    esAsignada: true
                };
            });

        console.log(`‚úÖ Mis OS asignadas: ${misAsignacionesPropias.length}`);

        // üîç DEBUG PARA OS ESPEC√çFICA (remover en producci√≥n si no se necesita)
        if (misAsignacionesPropias.length === 0) {
            console.log('üîç Debug: Buscando OS espec√≠ficas en dataset completo...');
            ['11223066', '11195544'].forEach(osBuscada => {
                const encontrada = (asignaciones || []).find(os => 
                    String(os.osatomo).trim() === osBuscada
                );
                if (encontrada) {
                    const coincide = String(encontrada.Unidad).replace(/[^A-Z0-9]/g, '').toUpperCase() === unidadObjetivoLimpia;
                    console.log(`üìã OS ${osBuscada}: Unidad="${encontrada.Unidad}" ‚Üí Coincide: ${coincide ? '‚úÖ' : '‚ùå'}`);
                }
            });
        }

        // ========================================
        // üî• 4Ô∏è‚É£ INYECTAR COMENTARIOS DE CONSULTA_SERVICIOS
        // ========================================
        console.log('üìù Inyectando comentarios desde consultas_servicios...');
        
        // Extraer medidores √∫nicos (excluyendo vac√≠os y "N/A")
        const medidoresUnicos = [...new Set(
            misAsignacionesPropias
                .map(os => os.Medidor)
                .filter(m => m && String(m).trim() !== '' && String(m).trim().toUpperCase() !== 'N/A')
        )];
        
        console.log(`üîç Medidores √∫nicos para consultar: ${medidoresUnicos.length}`);
        
        const comentariosPorMedidor = new Map();
        
        // Consultar en lotes para no saturar la API
        if (medidoresUnicos.length > 0) {
            const BATCH_SIZE = 200;
            for (let i = 0; i < medidoresUnicos.length; i += BATCH_SIZE) {
                const batch = medidoresUnicos.slice(i, i + BATCH_SIZE);
                const { data: comentariosData, error: errorComentarios } = await supabaseClient
                    .from('consultas_servicios')
                    .select('Medidor, ComentarioGeneral')
                    .in('Medidor', batch);
                
                if (!errorComentarios && comentariosData) {
                    comentariosData.forEach(item => {
                        if (item.Medidor && item.ComentarioGeneral) {
                            comentariosPorMedidor.set(
                                String(item.Medidor).trim().toUpperCase(), 
                                item.ComentarioGeneral
                            );
                        }
                    });
                    console.log(`‚úÖ Lote ${Math.floor(i/BATCH_SIZE)+1}: ${comentariosData.length} comentarios obtenidos`);
                }
                // Peque√±a pausa para no saturar
                await new Promise(resolve => setTimeout(resolve, 50));
            }
        }
        
        // Inyectar comentarios en cada OS asignada
        let comentariosInyectados = 0;
        // ‚úÖ INYECTAR COMENTARIOS CON PRIORIDAD CONSISTENTE
misAsignacionesPropias.forEach(os => {
    if (os.Medidor) {
        const medidorKey = String(os.Medidor).trim().toUpperCase();
        const comentarioEncontrado = comentariosPorMedidor.get(medidorKey);
        
        // ‚úÖ PRIORIDAD: Mantener comentario de OS Pendientes si existe
        if (os.Comentario && os.Comentario.trim() !== '' && 
            os.Comentario !== 'N/A' && os.Comentario !== 'Sin comentario disponible') {
            os.ComentarioGeneral = os.Comentario;
            os.esDeConsultasServicios = false;
        } 
        // ‚úÖ FALLBACK: Solo usar consultas_servicios si NO hay comentario en OS Pendientes
        else if (comentarioEncontrado && comentarioEncontrado.trim() !== '') {
            os.Comentario = comentarioEncontrado;
            os.ComentarioGeneral = comentarioEncontrado;
            os.esDeConsultasServicios = true;
            comentariosInyectados++;
        }
    }
});
        
        console.log(`‚úÖ Comentarios inyectados: ${comentariosInyectados} de ${misAsignacionesPropias.length} OS`);

        // ========================================
        // 5Ô∏è‚É£ ASIGNAR A VARIABLES GLOBALES
        // ========================================
        window.osAsignadasKML = misAsignacionesPropias;
        window.todasLasPendientesKML = todasLasPendientes;

        console.log(`‚úÖ Sesi√≥n: ${unidadObjetivo}`);
        console.log(`üìã Mis OS (con comentarios): ${misAsignacionesPropias.length}`);
        console.log(`üîç Universo Pendientes: ${todasLasPendientes.length}`);

        // ========================================
        // 6Ô∏è‚É£ RENDERIZADO SEG√öN ROL
        // ========================================
        if (rol === 'Administrador' || rol === 'Supervisor' || rol === 'Despacho') {
            const unidadesUnicas = [...new Set(asignaciones.map(a => a.Unidad).filter(u => u))].sort();
            generarInterfazAdminKMLRuta(unidadesUnicas, misAsignacionesPropias);
        } 
        else if (rol === 'Consulta' || rol === 'Contratista') {
            if (misAsignacionesPropias.length === 0) {
                searchGrid.innerHTML = `<div class="result-card">‚ö†Ô∏è No se encontraron OS asignadas para la unidad ${unidadObjetivo}</div>`;
                return;
            }
            // ‚úÖ Ahora generarMapaKMLRuta recibir√° OS con comentarios ya inyectados
            generarMapaKMLRuta(misAsignacionesPropias, miUnidadRaw);
        }

    } catch (err) {
        console.error('‚ùå Error en KML Ruta:', err);
        searchGrid.innerHTML = `<div class="result-card">‚ùå Error: ${err.message}</div>`;
    }
}

// ========================================
// üó∫Ô∏è INTERFAZ GENERACI√ìN KML RUTA (OPTIMIZADA)
// ========================================
function generarInterfazAdminKMLRuta(unidades, osAsignadas) {
    console.log('üé® ==========================================');
    console.log('üé® GENERANDO INTERFAZ KML');
    console.log('üé® Unidades disponibles:', unidades?.length || 0);
    console.log('üé® Total OS asignadas:', osAsignadas?.length || 0);
    console.log('üé® ==========================================');

    const searchGrid = document.getElementById('searchGrid');
    const resultsContainer = document.getElementById('searchResults');

    // 1. Limpieza de contenedores para evitar duplicados visuales
    if (resultsContainer) resultsContainer.innerHTML = '';
    if (!searchGrid) return console.error('‚ùå No se encontr√≥ el contenedor searchGrid');

    // 2. Guardar datos globalmente (Sincronizado con el resto del sistema)
    window.osAsignadasKML = osAsignadas;

    // 3. Generar HTML con estructura limpia y profesional
    searchGrid.innerHTML = `
        <div class="result-card" style="background: #ffffff; border: 2px solid #4caf50; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
            
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="https://cdnimg.bnamericas.com/HFvkiBpeoLTFyPBTjytdbdohtBDrWQsnxgYaUwIlxAEFZVYKsYrwygPFBPYYlShO.png" 
                     alt="Logo CLESA" style="height: 60px; margin-bottom: 10px;">
                <h2 style="color: #2e7d32; margin: 0; font-size: 24px; font-weight: 800;">CLESA</h2>
                <p style="color: #64748b; font-size: 14px; margin-top: 5px;">üìç Generaci√≥n de KML por Unidad</p>
            </div>

            <hr style="border: 0; border-top: 1px solid #e2e8f0; margin-bottom: 20px;">

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 700; color: #334155; margin-bottom: 8px;">
                    üìç Seleccionar Unidad Responsable:
                </label>
                <select id="selectUnidadKML" 
                        onchange="actualizarResumenUnidadKML()" 
                        style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #cbd5e1; font-size: 15px; background-color: #f8fafc; cursor: pointer;">
                    <option value="">-- Seleccione una unidad --</option>
                    ${unidades.sort().map(u => `<option value="${u}">${u}</option>`).join('')}
                </select>
            </div>

            <div id="containerSelectorOS" style="display: none; margin-bottom: 20px; padding: 15px; background: #fff7ed; border-radius: 8px; border: 1px solid #fdba74;">
                <label style="display: block; font-weight: 700; color: #9a3412; margin-bottom: 8px;">
                    üö© OS Punto de Partida (Referencia): <span style="color:red">*</span>
                </label>
                <select id="selectPuntoPartidaAdmin" 
                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #fdba74; font-size: 15px;">
                    <option value="">-- Seleccione OS de partida --</option>
                </select>
                <small style="color: #c2410c; display: block; margin-top: 5px;">* Esta OS ser√° el centro de la ruta generada.</small>
            </div>

            <div id="resumenUnidadKML" style="display: none; background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #22c55e;">
                <strong style="color: #166534; display: block; margin-bottom: 5px;">üìä Resumen de OS Asignadas:</strong>
                <div id="contenidoResumenKML" style="font-size: 14px; color: #374151; line-height: 1.5;"></div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 10px;">
                <button class="btn" onclick="generarKMLAdminPorUnidad('lector')" 
                        style="background: #10b981; color: white; padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    üì• KML Lector
                </button>
                
                <button class="btn" onclick="generarKMLAdminPorUnidad('gis')" 
                        style="background: #3b82f6; color: white; padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    üì• KML GIS
                </button>
                
                <button class="btn" onclick="generarMapaAdminKMLRuta()" 
                        style="background: #f59e0b; color: white; padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    üó∫Ô∏è Ver Mapa
                </button>
            </div>
        </div>
    `;
}¬†

// ========================================
// üìä ACTUALIZAR CONTADOR DE UNIDADES SELECCIONADAS
// ========================================
function actualizarContadorUnidadesSeleccionadas() {
¬†   const checkboxes = document.querySelectorAll('.checkbox-unidad-filtro:checked');
¬†   const contador = document.getElementById('contadorUnidadesSeleccionadas');
¬†   if (contador) {
¬†       contador.textContent = checkboxes.length;
¬†   }
}


// ========================================
// üè∑Ô∏è TOGGLE SECCI√ìN TIPOLOG√çAS UNIDAD
// ========================================
function toggleSeccionTipologiasUnidad() {
¬†   const seccion = document.getElementById('seccionTipologiasUnidad');
¬†   if (seccion) {
¬†       seccion.style.display = seccion.style.display === 'none' ? 'block' : 'none';
¬†   }
}


¬†	function parsearCoordenadas(coordString) {
    // 1. Verificaci√≥n b√°sica de existencia y tipo
    if (!coordString || typeof coordString !== 'string') return null;
    
    // 2. Limpieza de caracteres invisibles o espacios
    const limpia = coordString.trim();
    if (!limpia.includes(',')) return null;

    // 3. Extracci√≥n y validaci√≥n
    const partes = limpia.split(',').map(c => parseFloat(c.trim()));
    
    // 4. Validaci√≥n de rango (Latitud entre -90/90 y Longitud entre -180/180)
    // Esto es lo que evita que el mapa "explote" con datos basura
    if (isNaN(partes[0]) || isNaN(partes[1])) return null;
    if (Math.abs(partes[0]) > 90 || Math.abs(partes[1]) > 180) return null;

    return { lat: partes[0], lng: partes[1] };
}



// ========================================
// üìã CARGAR TIPOLOG√çAS PARA FILTROS UNIDAD
// ========================================
async function cargarTipologiasParaFiltrosUnidad() {
¬†   const tipologiasUnicas = await cargarTipologias();
¬†
¬†   const seccion = document.getElementById('seccionTipologiasUnidad');
¬†   if (!seccion) return;
¬†
¬†   if (tipologiasUnicas.length === 0) {
¬†       seccion.innerHTML = '<p style="color: #666; text-align: center;">No hay tipolog√≠as disponibles</p>';
¬†       return;
¬†   }
¬†
¬†   seccion.innerHTML = `
¬†       <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer; padding: 10px; background: white; border-radius: 6px; font-weight: 600;">
¬†           <input type="checkbox" id="todasTipologiasUnidad" onchange="toggleTodasTipologiasUnidad()" style="width: 18px; height: 18px;">
¬†           <strong>Seleccionar todas las tipolog√≠as</strong>
¬†       </label>
¬†       <hr style="margin: 10px 0;">
¬†       ${tipologiasUnicas.map(tip => `
¬†           <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #e1e5e9;">
¬†               <input type="checkbox" class="checkbox-tipologia-unidad" value="${tip}" onchange="actualizarSeleccionTipologiasUnidad()" style="width: 18px; height: 18px; flex-shrink: 0;">
¬†               <span style="font-size: 14px;">${tip}</span>
¬†           </label>
¬†       `).join('')}
¬†   `;
}



// ========================================
// ‚úÖ TOGGLE TODAS LAS TIPOLOG√çAS UNIDAD
// ========================================
function toggleTodasTipologiasUnidad() {
¬†   const todasCheckbox = document.getElementById('todasTipologiasUnidad');
¬†   const checkboxes = document.querySelectorAll('.checkbox-tipologia-unidad');
¬†
¬†   if (todasCheckbox && checkboxes) {
¬†       checkboxes.forEach(cb => {
¬†           cb.checked = todasCheckbox.checked;
¬†       });
¬†   }
}



// ========================================
// üîÑ ACTUALIZAR SELECCI√ìN TIPOLOG√çAS UNIDAD
// ========================================
function actualizarSeleccionTipologiasUnidad() {
¬†   const todasCheckbox = document.getElementById('todasTipologiasUnidad');
¬†   const checkboxes = document.querySelectorAll('.checkbox-tipologia-unidad');
¬†
¬†   if (!todasCheckbox || !checkboxes) return;
¬†
¬†   let todosMarcados = true;
¬†   checkboxes.forEach(cb => {
¬†       if (!cb.checked) todosMarcados = false;
¬†   });
¬†
¬†   todasCheckbox.checked = todosMarcados;
}


// Funci√≥n para generar el campo de b√∫squeda/selector en "Mapa de Rutas"
async function generarCampoMapaRutas(unidad) {
¬†   const rol = currentUser?.rol;
¬†   const container = document.getElementById('searchContainerMapaRutas');

¬†   if (rol === 'Administrador' || rol === 'Supervisor') {
¬†       // Interfaz input manual
¬†       container.innerHTML = `
¬†           <label for="osBusqueda">Ingrese N¬∞ de OS:</label>
¬†           <input type="text" id="osBusqueda" placeholder="Ej: 123456">
¬†           <button onclick="buscarOSParaMapa(document.getElementById('osBusqueda').value)">Generar Mapa</button>
¬†       `;
¬†   }
¬†
¬†   else if (rol === 'Consulta' || rol === 'Contratista') {
¬†
¬†       // ‚úÖ SOLO UNA VEZ
¬†       const unidadUsuario = transformarUsuarioAUnidad(currentUser.usuario);

¬†       // Fetch OS Asignadas
¬†       const { data: osAsignadas, error } = await supabaseClient
¬†           .from('os_asignadas')
¬†           .select('osatomo, Tipologia, OSATMO, Unidad')
¬†           .eq('Unidad', unidadUsuario);

¬†       if (error) {
¬†           console.error('Error cargando OS asignadas para unidad:', error);
¬†           container.innerHTML = `<div class="result-card">‚ùå Error cargando OS asignadas</div>`;
¬†           return;
¬†       }

¬†       // Normalizaci√≥n
¬†       const osParaSelector = (osAsignadas || [])
¬†           .map(os => ({
¬†               osatomo: os.osatomo || os.OSATMO,
¬†               Tipologia: os.Tipologia || 'Sin Tipolog√≠a'
¬†           }))
¬†           .filter(os => os.osatomo);

¬†       // Construcci√≥n del selector
¬†       container.innerHTML = `
¬†           <div class="form-group">
¬†               <label for="selectOSBusqueda">Seleccione OS de Partida (Unidad ${unidadUsuario}):</label>
¬†               <select id="selectOSBusqueda">
¬†                   <option value="">-- Seleccione una OS --</option>
¬†                   ${osParaSelector
¬†                       .map(os => `<option value="${os.osatomo}">${os.osatomo} - ${os.Tipologia}</option>`)
¬†                       .join('')}
¬†               </select>
¬†           </div>
¬†           <button class="btn" onclick="buscarOSParaMapa(document.getElementById('selectOSBusqueda').value, true)">Generar Mapa de Unidad</button>
¬†       `;
¬†   }
}

async function buscarOSParaMapa(osPartida, cargarUnidadCompleta = false) {
¬†   const rol = currentUser?.rol;
¬†   let osData;
¬†   let unidad;

¬†   if (rol === 'Administrador' || rol === 'Supervisor') {
¬†       // L√≥gica actual de Admin: busca una sola OS, luego busca la unidad de esa OS.
¬†       // ... (Tu c√≥digo actual de b√∫squeda y carga del mapa)
¬†       // La unidad se determina por la OS buscada.
¬†       cargarMapaNormal(osData, unidad, osPartida);
¬†
¬†   } else if (cargarUnidadCompleta) { // Para Consulta/Contratista
¬†       unidad = currentUser.unidad;

¬†       // 1. Fetch TODAS las OS de la unidad
¬†       const { data: osAsignadas, error } = await supabaseClient
¬†           .from('OS Asignadas')
¬†           .select('*')
¬†           .eq('Unidad', unidad);
¬†
¬†       if (error || !osAsignadas) { /* manejar error */ return; }
¬†
¬†       // 2. Aplicar la optimizaci√≥n (Vecino Cercano) para generar la ruta
¬†       //    Nota: Debes asegurarte de aplicar los filtros globales cargados aqu√≠ si es necesario.
¬†
¬†       // 3. Cargar Mapa con la ruta optimizada
¬†       const rutaOptimizada = optimizarRutaVecinoCercano(osAsignadas, osPartida);
¬†
¬†       // Asumo que esta funci√≥n existe y dibuja el mapa
¬†       mostrarMapaKMLConNumeracion(rutaOptimizada, unidad, /* lat, lng del osPartida */);
¬†   }
}


async function guardarFiltrosPorUnidad() {
    // 1. Validaci√≥n de permisos
    if (currentUser.rol === 'Despacho') {
        const seleccionadas = document.querySelectorAll('.checkbox-unidad-filtro:checked').length;
        if (seleccionadas === 0) {
            alert('‚ö†Ô∏è Debes seleccionar al menos UNA unidad');
            return;
        }
    }

    const rangos = [];
    const tipologias = [];
    let deudaAmarillo = document.getElementById('deuda_amarillo')?.checked || false;
    let deudaNaranja = document.getElementById('deuda_naranja')?.checked || false;
    let deudaRosado = document.getElementById('deuda_rosado')?.checked || false;

    document.querySelectorAll('.checkbox-rango-unidad:checked').forEach(cb => rangos.push(cb.value));
    document.querySelectorAll('.checkbox-tipologia-unidad:checked').forEach(cb => tipologias.push(cb.value));

    const radioKm = parseInt(document.getElementById('radioKmUnidad')?.value || 3);
    const unidadesDestino = Array.from(document.querySelectorAll('.checkbox-unidad-filtro:checked'))
                                 .map(cb => cb.value);

    let fechaInput = document.getElementById('fechaVigenciaFiltros')?.value;
    const hoy = getFechaElSalvador();
    const fechaHoy = hoy.toISOString().split('T')[0];
    const fechaFinal = fechaInput || fechaHoy;

    // üïµÔ∏è LOG DE PRE-VALIDACI√ìN: Para ver qu√© captur√≥ el c√≥digo antes de procesar
    console.log('--- üìã DATOS CAPTURADOS ---');
    console.log('üìç Unidades:', unidadesDestino);
    console.log('üìè Rangos:', rangos);
    console.log('üè∑Ô∏è Tipolog√≠as:', tipologias);
    console.log('üí∞ Deuda (A/N/R):', deudaAmarillo, deudaNaranja, deudaRosado);
    console.log('üìÖ Fecha:', fechaFinal);
    console.log('---------------------------');

    if (unidadesDestino.length === 0) {
        alert('‚ö†Ô∏è Debe seleccionar al menos una unidad');
        return;
    }
    if (radioKm < 1 || radioKm > 20) {
        alert('‚ö†Ô∏è El radio debe estar entre 1 y 20 km');
        return;
    }

    const mensaje = `¬øGuardar filtros para ${unidadesDestino.length} unidad(es)?\n\n` +
                    `‚Ä¢ Unidades: ${unidadesDestino.slice(0, 3).join(', ')}${unidadesDestino.length > 3 ? '...' : ''}\n` +
                    `‚Ä¢ Rangos: ${rangos.length > 0 ? rangos.join(', ') : 'Todos'}\n` +
                    `‚Ä¢ Tipolog√≠as: ${tipologias.length > 0 ? tipologias.length : 'Todas'}\n` +
                    `‚Ä¢ Deuda: ${ (deudaAmarillo || deudaNaranja || deudaRosado) ? 'S√≠' : 'No' }\n` +
                    `‚Ä¢ Fecha Programada: ${fechaFinal}`;

    if (!confirm(mensaje)) return;

    try {
        const registros = unidadesDestino.map(unidad => ({
            Unidad: unidad,
            rangos: rangos.length > 0 ? rangos : null,
            tipologias: tipologias.length > 0 ? tipologias : null,
            deuda_amarillo: deudaAmarillo,
            deuda_naranja: deudaNaranja,
            deuda_rosado: deudaRosado,
            radio_km: radioKm,
            fecha_actualizacion: new Date().toISOString(),
            configurado_por: currentUser.usuario,
            fecha_programada: fechaFinal
        }));

        console.log('üöÄ Enviando Upsert a Supabase...', registros);

        const { error } = await supabaseClient
            .from('filtros_por_unidad')
            .upsert(registros, { onConflict: 'Unidad,fecha_programada' });

        if (error) throw error;

        // ‚úÖ LOG DE √âXITO FINAL
        console.log('‚úÖ Filtros guardados exitosamente en la base de datos');
        alert('‚úÖ Filtros guardados correctamente');

    } catch (err) {
        console.error('‚ùå ERROR CR√çTICO EN GUARDADO:', err);
        alert('‚ùå Error al guardar en base de datos: ' + err.message);
    }
}




async function borrarTodosFiltrosUnidades() {
    const confirmar = confirm(
        `‚ö†Ô∏è ¬øELIMINAR TODOS LOS FILTROS DE UNIDADES?\n\n` +
        `Esta acci√≥n NO se puede deshacer.\n\n` +
        `¬øContinuar?`
    );

    if (!confirmar) return;

    console.log('üóëÔ∏è Iniciando borrado masivo de filtros_por_unidad...');

    try {
        const { error, count } = await supabaseClient
            .from('filtros_por_unidad')
            .delete()
            .not('Unidad', 'is', null); 

        if (error) throw error;

        // ‚úÖ LOG ESTRAT√âGICO: Nos confirma que la DB respondi√≥ bien
        console.log('‚úÖ Borrado exitoso en Supabase. Tabla limpia.');
        
        alert('‚úÖ Todos los filtros de unidades eliminados');

    } catch (err) {
        // ‚ùå LOG DE ERROR: Fundamental para saber POR QU√â fall√≥ (permisos, red, etc.)
        console.error('‚ùå Error cr√≠tico al borrar filtros:', err);
        alert('‚ùå Error: ' + err.message);
    }
}

// ‚úÖ MANTENEMOS TUS LOGS DE ESTADO (Para depurar el KML)
console.log('‚ñ∂Ô∏è ==========================================');
console.log('‚ñ∂Ô∏è MONITOREO DE CARGA:');
console.log('‚ñ∂Ô∏è window.osAsignadasKML:', window.osAsignadasKML ? 'Cargado ‚úÖ' : 'Vac√≠o ‚ùå');
if (window.osAsignadasKML) {
    console.log('‚ñ∂Ô∏è Registros en memoria:', window.osAsignadasKML.length);
}
console.log('‚ñ∂Ô∏è ==========================================');


// ========================================
// üó∫Ô∏è GENERAR MAPA UNIDAD CON FILTROS (CORREGIDO - VERSI√ìN FINAL)
// ========================================
async function generarMapaUnidadConFiltros(incluirAsignadas = true) {
¬†   console.log('üó∫Ô∏è ==========================================');
¬†   console.log('üó∫Ô∏è EJECUTANDO: generarMapaUnidadConFiltros');
¬†
¬†   // ‚úÖ PASO 1: RESCATE DE DATOS (Si la variable principal falla, buscamos en la alternativa)
¬†   if (!window.osAsignadasKML && window.osKMLData) {
¬†       console.warn('‚ö†Ô∏è window.osAsignadasKML era undefined, rescatando desde window.osKMLData');
¬†       window.osAsignadasKML = window.osKMLData;
¬†   }

¬†   console.log('üó∫Ô∏è window.osAsignadasKML:', window.osAsignadasKML);
¬†   console.log('üó∫Ô∏è window.osAsignadasKML existe:', !!window.osAsignadasKML);
¬†   console.log('üó∫Ô∏è window.osAsignadasKML longitud:', window.osAsignadasKML ? window.osAsignadasKML.length : 'N/A');
¬†   console.log('üó∫Ô∏è ==========================================');

¬†   const unidadSeleccionada = transformarUsuarioAUnidad(currentUser.usuario);
¬†
¬†   if (!unidadSeleccionada) {
¬†       alert('‚ö†Ô∏è Por favor seleccione una unidad');
¬†       return;
¬†   }
¬†
¬†   // ‚úÖ PASO 2: VALIDACI√ìN CR√çTICA DE DATOS ANTES DE SEGUIR
¬†   if (!window.osAsignadasKML || window.osAsignadasKML.length === 0) {
¬†       console.error('‚ùå ERROR: No hay √≥rdenes base cargadas en memoria.');
¬†       const resultsContainer = document.getElementById('searchResults');
¬†       resultsContainer.innerHTML = `
¬†           <div class="result-card" style="background: #fff3cd; border-left: 5px solid #ffc107;">
¬†               <div class="result-header">‚ö†Ô∏è Acci√≥n requerida</div>
¬†               <p style="text-align: center; color: #666;">Primero debe cargar la interfaz de KML Ruta para obtener sus √≥rdenes asignadas antes de aplicar filtros.</p>
¬†           </div>`;
¬†       return;
¬†   }

¬†   const resultsContainer = document.getElementById('searchResults');
¬†   resultsContainer.innerHTML = '<div class="loading" style="display: block; margin: 20px auto;"></div>';
¬†
¬†   
¬†
¬†   try {
¬†      // ‚úÖ 1Ô∏è‚É£ Buscar filtros (Sincronizado con El Salvador)
¬†       const HOY = getFechaHoyElSalvador();
¬†       console.log('üìÖ Consultando filtros para fecha local:', HOY);

¬†       let { data: filtrosUnidadHoy } = await supabaseClient
¬†           .from('filtros_por_unidad')
¬†           .select('*')
¬†           .eq('Unidad', unidadSeleccionada)
¬†           .eq('fecha_programada', HOY)
¬†           .maybeSingle();

¬†       if (!filtrosUnidadHoy) {
¬†           console.warn(`‚ö†Ô∏è Buscando filtro base (null) para ${unidadSeleccionada}...`);
¬†           let { data: filtroBase } = await supabaseClient
¬†               .from('filtros_por_unidad')
¬†               .select('*')
¬†               .eq('Unidad', unidadSeleccionada)
¬†               .is('fecha_programada', null)
¬†               .maybeSingle();
¬†           filtrosUnidadHoy = filtroBase;
¬†       }

¬†       // ‚úÖ VARIABLE CR√çTICA: Definir radioConfigurado aqu√≠ para que el forEach la vea
¬†       window.filtrosAplicados = filtrosUnidadHoy || { tipologias: [], rangos: [], radio_km: 3 };
¬†       const radioConfigurado = window.filtrosAplicados.radio_km || 3;
¬†       console.log(`üéØ Radio configurado: ${radioConfigurado} km`);


¬†      // ========================================
        // ‚úÖ 2Ô∏è‚É£ Determinar qu√© filtros aplicar (ESTRICTO)
        // ========================================
        let filtrosAplicar = filtrosUnidadHoy;

        if (filtrosAplicar && (filtrosAplicar.tipologias?.length > 0 || filtrosAplicar.rangos?.length > 0)) {
            console.log('‚úÖ ==========================================');
            console.log('‚úÖ FILTROS ENCONTRADOS Y VALIDADOS');
            console.log('‚úÖ ==========================================');
        } else {
            // LOG DE ADVERTENCIA EN CONSOLA
            console.error('‚ùå ==========================================');
            console.error('‚ùå NO HAY FILTROS CONFIGURADOS PARA ESTA UNIDAD');
            console.error('‚ùå Abortando generaci√≥n de mapa por seguridad.');
            console.error('‚ùå ==========================================');

            // MENSAJE VISUAL PARA EL USUARIO
            resultsContainer.innerHTML = `
                <div class="result-card" style="background: #fef2f2; border-left: 5px solid #ef4444; padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 24px;">‚ö†Ô∏è</span>
                        <strong style="color: #991b1b; font-size: 18px;">Configuraci√≥n Requerida</strong>
                    </div>
                    <p style="color: #7f1d1d; margin: 0;">
                        La unidad <b>${unidadSeleccionada}</b> no tiene filtros configurados para hoy (<b>${HOY}</b>).
                    </p>
                    <p style="color: #7f1d1d; font-size: 14px; margin-top: 10px;">
                        Vaya a la secci√≥n de <b>Filtros por Unidad</b>, seleccione los criterios y guarde antes de generar el mapa.
                    </p>
                </div>`;
            return; // ‚õî DETIENE LA FUNCI√ìN AQU√ç
        }

        window.filtrosAplicados = filtrosAplicar;

        // ‚úÖ LOG DE FILTROS APLICADOS (Tu tabla de diagn√≥stico)
        console.log('üìã ==========================================');
        console.log('üìã DETALLE DE FILTROS QUE SE APLICAR√ÅN');
        console.log('üìã ==========================================');
        const radioConfig = filtrosAplicar?.radio_km || 3;
        
        console.table({
            'Tipolog√≠as seleccionadas': filtrosAplicar.tipologias?.length > 0 ? filtrosAplicar.tipologias.join(', ') : 'NINGUNA',
            'Rangos seleccionados': filtrosAplicar.rangos?.length > 0 ? filtrosAplicar.rangos.join(', ') : 'NINGUNO',
            'Radio (km)': radioConfig,
            'Fecha programada': filtrosAplicar?.fecha_programada || 'Sin fecha'
        });


¬†
¬†       // ========================================
// ‚úÖ 3Ô∏è‚É£ Cargar OS asignadas EXCLUSIVAS de mi unidad
// ========================================
console.log('üì• Filtrando mis asignadas desde la memoria...');

// Intentamos obtener datos de cualquiera de las dos fuentes globales
const fuenteDatos = window.osAsignadasKML || window.osKMLData || [];
const miUnidadNorm = unidadSeleccionada.trim().toUpperCase();

// Filtramos estrictamente: Solo √≥rdenes donde la Unidad coincida con el usuario actual
// --- AHORA (CON LIMPIEZA) ---
const miUnidadLimpiaComparar = unidadSeleccionada.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();

// ‚úÖ CORREGIDO: Normalizaci√≥n consistente de unidades
const miUnidadLimpia = unidadSeleccionada.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();

const misAsignadasReales = fuenteDatos.filter(os => {
    const uOS = (os.Unidad || os.unidad || "").toString().replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
    // Comparamos versiones limpias para que encuentre √≥rdenes aunque tengan guiones
    return uOS === miUnidadLimpia;
});

console.log(`‚úÖ ${misAsignadasReales.length} OS encontradas para unidad: ${unidadSeleccionada}`);

// Validaci√≥n de seguridad: si no hay √≥rdenes para TU unidad, avisamos al usuario
if (misAsignadasReales.length === 0) {
    console.warn(`‚ö†Ô∏è La unidad ${miUnidadNorm} no tiene √≥rdenes asignadas en el set de datos actual.`);
    resultsContainer.innerHTML = `
        <div class="result-card" style="background: #fff3cd; border-left: 5px solid #ffa000;">
            <div class="result-header" style="color: #856404;">‚ö†Ô∏è Sin √ìrdenes Propias</div>
            <p style="text-align: center; color: #666;">
                No se encontraron √≥rdenes asignadas a la unidad <b>${unidadSeleccionada}</b>.<br>
                <small>Verifique que el nombre de unidad en el Excel coincida exactamente.</small>
            </p>
        </div>`;
    // Opcional: podr√≠as poner un "return;" aqu√≠ si no quieres que el mapa se genere vac√≠o
}

// Para el resto de la funci√≥n (el centro del mapa), usaremos esta variable
const osAsignadasUnidad = misAsignadasReales;
¬†
¬†       // ========================================
// ‚úÖ 4Ô∏è‚É£ Encontrar OS centro y definir Coordenadas Base
// ========================================
console.log('üìç Buscando OS centro con coordenadas...');

let osCentro;
if (window.osPartidaSeleccionada) {
    osCentro = osAsignadasUnidad.find(os => 
        String(os.osatomo || os.OSATMO) === String(window.osPartidaSeleccionada)
    );
}

if (!osCentro) {
    osCentro = osAsignadasUnidad.find(os => {
        const coords = os.Coordenadas || os.Coordendasgis;
        return coords && coords.includes(',');
    });
}

if (!osCentro) {
    console.error('‚ùå No se encontr√≥ OS centro con coordenadas');
    resultsContainer.innerHTML = `<div class="result-card" style="background: #fff3cd;">‚ö†Ô∏è No hay OS base con coordenadas v√°lida en su unidad</div>`;
    return;
}

// üõ†Ô∏è CORRECCI√ìN AQU√ç: Definici√≥n de 'partes', 'latCentro' y 'lngCentro'
const coordsCentro = getCoordsCompat(osCentro, true);
let latCentro, lngCentro;

if (coordsCentro) {
    ({ lat: latCentro, lng: lngCentro } = coordsCentro);
} else {
    const coordsTexto = osCentro.Coordenadas || osCentro.Coordendasgis;
    if (!coordsTexto || !coordsTexto.includes(',')) {
        throw new Error("La OS de partida no tiene coordenadas v√°lidas");
    }
    const partes = coordsTexto.split(',');
    latCentro = parseFloat(partes[0].trim());
    lngCentro = parseFloat(partes[1].trim());
}

if (isNaN(latCentro) || isNaN(lngCentro)) {
    throw new Error("Coordenadas inv√°lidas para el centro del mapa");
}

console.log(`üìç Punto de origen definido en: ${latCentro}, ${lngCentro} (OS: ${osCentro.osatomo || osCentro.OSATMO})`);



¬†       // ========================================
¬†       // ‚úÖ 5Ô∏è‚É£ Cargar TODAS las OS pendientes
¬†       // ========================================
¬†       console.log('üì• Cargando OS pendientes desde base de datos...');
¬†
¬†       // ‚úÖ CORRECTO (sin "D√≠as Vencimiento")
const { data: osPendientes, error: errorPendientes } = await supabaseClient
    .from('OS Pendientes')
    .select('OSATMO, Tipologia, Tipo_de_OS, "Fecha Gen.", Coordenadas, Coordendasgis, Unidad, Deuda, Estado_ATOMO, Comentario')
¬†
¬†       if (errorPendientes) {
¬†           console.error('‚ùå Error cargando OS pendientes:', errorPendientes);
¬†           throw new Error('Error al cargar OS pendientes: ' + errorPendientes.message);
¬†       }
¬†
¬†       console.log(`‚úÖ ${osPendientes.length} OS pendientes cargadas`);

// ‚úÖ Cargar TODAS las OS asignadas (cualquier unidad)
console.log('üì• Cargando OS asignadas de todas las unidades...');
const { data: todasAsignadas, error: errorAsignadas } = await supabaseClient
    .from('os_asignadas')
    .select('osatomo');

if (errorAsignadas) {
    console.error('‚ùå Error cargando os_asignadas:', errorAsignadas);
}

const osatmosAsignadosGlobal = new Set(
    (todasAsignadas || []).map(os => String(os.osatomo).trim())
);
console.log(`‚úÖ ${osatmosAsignadosGlobal.size} OS asignadas globalmente`);


// ========================================
// ‚úÖ üÜï AGREGAR: OBTENER COMENTARIOS DE CONSULTA SUMINISTROS (PARA KML)
// ========================================
console.log('üìù ==========================================');
console.log('üìù OBTENIENDO COMENTARIOS DE CONSULTA SUMINISTROS (KML)');
console.log('üìù ==========================================');

// Extraer medidores √∫nicos de OS Pendientes
const medidoresUnicos = [...new Set(osPendientes
    .map(os => os.Medidor)
    .filter(m => m && String(m).trim() !== '' && String(m).trim() !== 'N/A'))];

console.log(`üîç Medidores √∫nicos para comentarios: ${medidoresUnicos.length}`);

const comentariosPorMedidor = new Map();

// Consultar en lotes para no saturar
if (medidoresUnicos.length > 0) {
    const BATCH_MEDIDORES = 1000;
    for (let i = 0; i < medidoresUnicos.length; i += BATCH_MEDIDORES) {
        const batchMedidores = medidoresUnicos.slice(i, i + BATCH_MEDIDORES);
        
        const { data: comentariosData, error: errorComentarios } = await supabaseClient
            .from('consultas_servicios')
            .select('Medidor, CuentaContrato, ComentarioGeneral')
            .in('Medidor', batchMedidores);
        
        if (!errorComentarios && comentariosData) {
            comentariosData.forEach(item => {
                if (item.Medidor) {
                    comentariosPorMedidor.set(String(item.Medidor).trim(), {
                        ComentarioGeneral: item.ComentarioGeneral || '',
                        CuentaContrato: item.CuentaContrato
                    });
                }
            });
            console.log(`‚úÖ Lote: ${comentariosData.length} comentarios obtenidos`);
        }
        await new Promise(resolve => setTimeout(resolve, 50)); // Pausa anti-saturaci√≥n
    }
}

// ========================================
// ‚úÖ INYECTAR COMENTARIOS EN OS PENDIENTES
// ========================================
// ‚úÖ INYECTAR COMENTARIOS CON FLAG DE ORIGEN
osPendientes.forEach(os => {
    const medidorKey = String(os.Medidor).trim();
    const comentarioData = comentariosPorMedidor.get(medidorKey);
    
    // ‚úÖ PRIORIDAD ABSOLUTA: Comentario de OS Pendientes
    if (os.Comentario && os.Comentario.trim() !== '' && 
        os.Comentario !== 'N/A' && os.Comentario !== 'Sin comentario disponible') {
        os.ComentarioGeneral = os.Comentario;
        os.esDeConsultasServicios = false;  // ‚Üê FLAG: viene de OS Pendientes
        console.log(`üí¨ OS ${os.OSATMO}: Usa comentario de OS Pendientes`);
    } 
    // ‚úÖ FALLBACK: Solo si NO hay comentario en OS Pendientes
    else if (comentarioData?.ComentarioGeneral?.trim()) {
        os.ComentarioGeneral = comentarioData.ComentarioGeneral;
        os.esDeConsultasServicios = true;  // ‚Üê FLAG: viene de consultas_servicios
        console.log(`üí¨ OS ${os.OSATMO}: Usa comentario de consultas_servicios (fallback)`);
    } 
    // ‚úÖ √öLTIMO RECURSO
    else {
        os.Comentario = 'Sin comentario disponible';
        os.ComentarioGeneral = 'Sin comentario disponible';
        os.esDeConsultasServicios = false;
    }
});¬†
¬†       // ========================================
        // ‚úÖ 6Ô∏è‚É£ FILTRAR OS EN RADIO (UNIFICADO Y AUDITADO)
        // ========================================
        console.log('üîç APLICANDO FILTROS A OS EN RADIO');
        console.log('üîç Filtros activos:', {
            tipologias: filtrosAplicar.tipologias,
            rangos: filtrosAplicar.rangos,
            radio: radioConfigurado + ' km'
        });

        const osEnRadio = [];
        const osatmosAsignadosUnidad = new Set(
            osAsignadasUnidad.map(os => String(os.osatomo || os.OSATMO).trim())
        );

        // Inicializaci√≥n de contadores
        let contadorTotal = 0, contadorFiltradas = 0, contadorReguladas = 0, contadorDeudaAlta = 0;
        let contadorFueraRadio = 0, contadorUnidadInvalida = 0, contadorDuplicados = 0;
        let contadorSinCoordenadas = 0, contadorSinFiltro = 0;
        let contadorReguladas_EnRadio = 0, contadorReguladas_Pasaron = 0;
        let contadorNoReguladas_EnRadio = 0, contadorNoReguladas_Pasaron = 0;
        const diagnosticoRangos = {};
        const detallePorRango = {};

        // üî• UNIFICACI√ìN DE UNIVERSOS (Supabase + Memoria/Excel)
        const universoUnificado = [
            ...osPendientes,
            ...(window.universoParaFiltrarKML || [])
        ];

        // Eliminamos duplicados reales por ID para no procesar dos veces la misma OS
        const idsUnicos = new Set();
        const osAPrecesarFinal = universoUnificado.filter(os => {
            const id = String(os.OSATMO || os.osatomo || "").trim();
            if (!id || idsUnicos.has(id)) return false;
            idsUnicos.add(id);
            return true;
        });

        console.log(`üöÄ Universo unificado listo: ${osAPrecesarFinal.length} √≥rdenes √∫nicas.`);
        console.log(`üìã Unidad seleccionada para comparaci√≥n: ${unidadSeleccionada}`);

        const normalizarTexto = (t) => (t || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toUpperCase();

        // üîÑ INICIO DEL PROCESAMIENTO
        osAPrecesarFinal.forEach((os) => {
            
            // ========================================
            // üïµÔ∏è DEBUG ESPEC√çFICO PARA OS 11195544
            // ========================================
            if (String(os.OSATMO || os.osatomo).trim() === '11195544') {
                const coordsPrueba = parsearCoordenadas(os.Coordenadas || os.Coordendasgis);
                const uOS_Prueba = (os.Unidad || "").trim();
                const uOS_Limpia_Prueba = uOS_Prueba.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
                const miUnidadLimpia_Prueba = miUnidadNorm.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
                
                const estaLibre_Prueba = uOS_Limpia_Prueba === "" || uOS_Limpia_Prueba === "PENDIENTE" || uOS_Limpia_Prueba === "SINUNIDAD";
                const esMia_Prueba = uOS_Limpia_Prueba === miUnidadLimpia_Prueba && uOS_Limpia_Prueba !== "";

                console.group("üö® AUDITOR√çA INTEGRAL OS 11195544");
                console.log("üë§ Unidad Original en BD:", `"${uOS_Prueba}"`);
                console.log("üßº Unidad Normalizada:", `"${uOS_Limpia_Prueba}"`);
                console.log("üîì ¬øSe considera LIBRE?:", estaLibre_Prueba ? "SI ‚úÖ (Pasa por vacio/guiones)" : "NO ‚ùå");
                console.log("üôã ¬øEs de mi Unidad?:", esMia_Prueba ? "SI ‚úÖ" : "NO");
                console.log("üö´ ¬øRechazada por Otro?:", (!estaLibre_Prueba && !esMia_Prueba) ? "S√ç ‚õî" : "NO ‚úÖ");
                
                if (coordsPrueba) {
                    const distPrueba = calcularDistancia(latCentro, lngCentro, coordsPrueba.lat, coordsPrueba.lng);
                    console.log("üìè Distancia:", distPrueba.toFixed(2), "km (Radio:", radioConfigurado, "km)");
                    console.log("üìç ¬øEn radio?:", distPrueba <= radioConfigurado ? "S√ç ‚úÖ" : "NO ‚ùå");
                }
                console.groupEnd();
            }

            contadorTotal++;

            // --- A. FILTROS BASE (Coordenadas y Radio) ---
            const coords = parsearCoordenadas(os.Coordenadas || os.Coordendasgis);
            if (!coords) { contadorSinCoordenadas++; return; }

            const dist = calcularDistancia(latCentro, lngCentro, coords.lat, coords.lng);
            if (dist > radioConfigurado) { contadorFueraRadio++; return; }

            // --- B. NORMALIZACI√ìN DE DISPONIBILIDAD ---
            const uOS_Original = (os.Unidad || "").toString().trim();
            const idOS = String(os.OSATMO || os.osatomo || "").trim();
            const uOS_Limpia = uOS_Original.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
            const miUnidadLimpia = miUnidadNorm.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();

            const estaLibre = uOS_Limpia === "" || uOS_Limpia === "PENDIENTE" || uOS_Limpia === "SINUNIDAD" || uOS_Limpia === "NULL";
            const esAsignadaAMi = misAsignadasReales.some(mia => String(mia.osatomo || mia.OSATMO).trim() === idOS) || 
                                 (uOS_Limpia === miUnidadLimpia && uOS_Limpia !== "");
            const estaAsignadaGlobal = osatmosAsignadosGlobal.has(idOS);

            const esDeOtro = !estaLibre && !esAsignadaAMi;

            if (esDeOtro || (estaAsignadaGlobal && !esAsignadaAMi)) {
                if (esDeOtro) contadorUnidadInvalida++; else contadorDuplicados++;
                return; 
            }

            // --- C. DETERMINACI√ìN DE PRIORIDADES ---
            const rangoOS = determinarRangoDias(os['Fecha Gen.'] || os.fecha_generacion);
            const valorTipo = (os.Tipo_de_OS || os.tipo_os || "").toUpperCase();
            const esRegulada = valorTipo.includes("REGULADA") && !valorTipo.includes("NO REGULADA");
            const valorDeuda = parseFloat(os.Deuda || os.deuda || 0);
            const esDeudaAlta = valorDeuda >= 500;

            if (esRegulada) contadorReguladas_EnRadio++; else contadorNoReguladas_EnRadio++;
            const esPrioridad = esRegulada || esDeudaAlta;

            // --- D. FILTROS DE TABLA ---
            let cumpleFiltrosTabla = false;
            if (!esPrioridad) {
                const tipOS_Actual = normalizarTexto(os.Tipologia || os.tipologia || "");
                let tipologiasFiltro = filtrosAplicar.tipologias || [];
                if (typeof tipologiasFiltro === 'string') tipologiasFiltro = tipologiasFiltro.split(',').map(t => t.trim());
                
                const tipOk = tipologiasFiltro.length === 0 || tipologiasFiltro.some(f => normalizarTexto(f) === tipOS_Actual);
                const rangosFiltro = (filtrosAplicar.rangos || []).map(r => r.trim());
                const rangoOk = rangosFiltro.length === 0 || rangosFiltro.includes(rangoOS);

                cumpleFiltrosTabla = tipOk && rangoOk;
            }

            // --- E. DECISI√ìN FINAL ---
            if (esPrioridad || cumpleFiltrosTabla) {
                let estadoFinal = 'no_regulada';
                if (esRegulada) {
                    estadoFinal = 'regulada';
                    contadorReguladas++;
                    contadorReguladas_Pasaron++;
                } else if (esDeudaAlta) {
                    estadoFinal = 'deuda_alta';
                    contadorDeudaAlta++;
                } else {
                    contadorFiltradas++;
                    contadorNoReguladas_Pasaron++;
                }

                if (!detallePorRango[rangoOS]) detallePorRango[rangoOS] = 0;
                detallePorRango[rangoOS]++;

                osEnRadio.push({
                    ...os,
                    lat: coords.lat,
                    lng: coords.lng,
                    distancia: dist,
                    esExtra: true,
                    estado: estadoFinal
                });
            } else {
                contadorSinFiltro++;
            }
        });


¬†       /// ‚úÖ LOG FINAL CON TABLA COMPLETA
console.log('üìä ==========================================');
console.log('üìä RESUMEN FINAL - MAPA DE RUTAS');
console.log('üìä ==========================================');

console.table({
    'Total procesadas': contadorTotal,
    'Sin coordenadas': contadorSinCoordenadas,
    'Fuera de radio': contadorFueraRadio,
    'Ya asignadas/Duplicadas': contadorDuplicados,
    'Unidad ocupada': contadorUnidadInvalida,
    'TOTAL EN RADIO V√ÅLIDAS': contadorReguladas_EnRadio + contadorNoReguladas_EnRadio
});

console.log('\nüìà REGULADAS (pasan autom√°tico):');
console.table({
    'En radio': contadorReguladas_EnRadio,
    'Pasaron al mapa': contadorReguladas_Pasaron,
    '% aprobaci√≥n': `${((contadorReguladas_Pasaron/contadorReguladas_EnRadio)*100).toFixed(1)}%`
});

console.log('\nüìà NO REGULADAS (requieren filtro):');
console.table({
    'En radio': contadorNoReguladas_EnRadio,
    'Pasaron al mapa': contadorNoReguladas_Pasaron,
    'Rechazadas por filtro': contadorSinFiltro,
    '% aprobaci√≥n': `${((contadorNoReguladas_Pasaron/contadorNoReguladas_EnRadio)*100).toFixed(1)}%`
});

console.log('\nüìä DESGLOSE POR RANGO (que pasaron):');
console.table(detallePorRango);

console.log('\n‚úÖ RESULTADO TOTAL:');
console.table({
    'OS mostradas en mapa': osEnRadio.length,
    'Reguladas': contadorReguladas_Pasaron,
    'Deuda >= 500': contadorDeudaAlta,
    'Por filtros de tabla': contadorNoReguladas_Pasaron
});
console.log('üìä ==========================================');

¬†
¬†      // ========================================
        // ‚úÖ 7Ô∏è‚É£ Generar mapa con OS propias + Sugeridas
        // ========================================

        // ‚úÖ 1. Normalizar tus √≥rdenes (las que te pertenecen)
        // Usamos 'misAsignadasReales' que filtramos en el paso 3
        const osAsignadasNormalizadas = misAsignadasReales.map(os => {
            const coords = extraerCoordenadas(os);
            if (!coordsStr || typeof coordsStr !== 'string' || !coordsStr.includes(',')) return null;

            const [lat, lng] = coordsStr.split(',').map(c => parseFloat(c.trim()));
            if (isNaN(lat) || isNaN(lng)) return null;

            return {
                ...os,
                lat,
                lng,
                distancia: 0,
                numeroOrden: 0,
                esAsignada: true, // Esto le dir√° a Leaflet que use un color especial (ej. Azul)
                estado: 'asignada_propia'
            };
        }).filter(Boolean);

        // ‚úÖ 2. Uni√≥n final de puntos para el mapa
        // Si 'incluirAsignadas' es true, suma tus 12 fijas a las pendientes encontradas en el radio
        const osParaMapa = incluirAsignadas
            ? [...osAsignadasNormalizadas, ...osEnRadio]
            : [...osEnRadio];

        // ‚úÖ 3. Reporte final en consola para auditor√≠a
        console.log('üó∫Ô∏è ==========================================');
        console.log('üó∫Ô∏è GENERANDO MAPA FINAL');
        console.log(`üó∫Ô∏è √ìrdenes Propias: ${osAsignadasNormalizadas.length}`);
        console.log(`üó∫Ô∏è √ìrdenes Sugeridas (Filtro): ${osEnRadio.length}`);
        console.log(`üó∫Ô∏è Total en Mapa: ${osParaMapa.length}`);
        console.log('üó∫Ô∏è ==========================================');

// ========================================
// ‚úÖ INYECTAR COMENTARIOS EN OS ASIGNADAS (si no los tienen)
// ========================================
misAsignadasReales.forEach(os => {
    if (!os.ComentarioGeneral && os.Medidor) {
        const medidorKey = String(os.Medidor).trim();
        const comentarioData = comentariosPorMedidor.get(medidorKey);
        
        if (comentarioData && comentarioData.ComentarioGeneral) {
            os.Comentario = comentarioData.ComentarioGeneral;
            os.ComentarioGeneral = comentarioData.ComentarioGeneral;
        } else if (os.Comentario && os.Comentario !== 'N/A') {
            os.ComentarioGeneral = os.Comentario;
        }
    }
});


        // üî• PASO NUEVO: OPTIMIZACI√ìN DE RUTA (Vecino m√°s cercano + 2-OPT)
        console.log("üîÑ Optimizando secuencia de visita para ruta l√≥gica...");
        
        // Esta funci√≥n devolver√° el mismo array pero reordenado y con el campo .numeroOrden actualizado
        const osParaMapaOrdenada = optimizarRutaVecinoCercano(
            osParaMapa, 
            window.osPartidaSeleccionada || (osCentro.osatomo || osCentro.OSATMO),
            { lat: latCentro, lng: lngCentro } // El punto de origen (Marcador Verde)
        );

        // ‚úÖ 4. Dibujar el mapa con la ruta ya ORDENADA
        // Nota: Ahora pasamos 'osParaMapaOrdenada' en lugar de 'osParaMapa'
        generarMapaLeaflet(osCentro, osParaMapaOrdenada, latCentro, lngCentro, radioConfigurado);

    } catch (err) {
        console.error('‚ùå ERROR EN generarMapaUnidadConFiltros:', err);
        resultsContainer.innerHTML = `
            <div class="result-card" style="background: #fee; border-left: 5px solid #c53030;">
                <div class="result-header">‚ùå Error de Generaci√≥n</div>
                <p style="color: #c53030;">${err.message || 'Error desconocido'}</p>
                <p style="color: #777; font-size: 12px; margin-top: 10px;">
                    üí° Verifique que las coordenadas de la OS de partida sean v√°lidas.
                </p>
            </div>`;
    }
}




function determinarRangoDias(fechaGen) {
    if (!fechaGen) return "SIN FECHA";
    try {
        const ahora = new Date();
        const hoyUTC = Date.UTC(ahora.getUTCFullYear(), ahora.getUTCMonth(), ahora.getUTCDate());

        const inicio = new Date(fechaGen);
        const inicioUTC = Date.UTC(inicio.getUTCFullYear(), inicio.getUTCMonth(), inicio.getUTCDate());

        const diferenciaMs = hoyUTC - inicioUTC;
        const dias = Math.floor(diferenciaMs / (1000 * 60 * 60 * 24));

        // Llama a la maestra
        return obtenerRangoPorNumero(dias); 
    } catch (e) {
        return "ERROR FECHA";
    }
}

¬†	// ========================================
// üìä ACTUALIZAR RESUMEN UNIDAD KML (VALIDADA CON LIMPIEZA)
// ========================================
function actualizarResumenUnidadKML() {
    const unidadSeleccionada = document.getElementById('selectUnidadKML').value;
    const resumenDiv = document.getElementById('resumenUnidadKML');
    const contenidoDiv = document.getElementById('contenidoResumenKML');
 
    const containerOS = document.getElementById('containerSelectorOS');
    const selectOS = document.getElementById('selectPuntoPartidaAdmin');
 
    if (!unidadSeleccionada) {
        resumenDiv.style.display = 'none';
        if(containerOS) containerOS.style.display = 'none';
        return;
    }

    // ‚úÖ PASO 1: Normalizamos la unidad del selector (Quitar guiones para comparar)
    const unidadSelLimpia = unidadSeleccionada.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
 
    // ‚úÖ PASO 2: Filtrado con "Limpieza de Guiones" en ambos lados
    const osUnidad = window.osAsignadasKML.filter(os => {
        const uOS = (os.Unidad || os.unidad || "").toString();
        // Limpiamos los guiones de la base de datos (Ej: "---CL-EYB-PAC-03---" -> "CLEYBPAC03")
        const uOSLimpia = uOS.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
        
        // Comparamos versiones limpias
        return uOSLimpia === unidadSelLimpia;
    });
 
    // üÜï LLENAR EL SELECTOR DE OS
    if (selectOS && containerOS) {
        selectOS.innerHTML = '<option value="">-- Seleccione OS de partida --</option>';
 
        // Solo mostramos en la lista las que tienen coordenadas (para que sirvan de centro)
        const osParaLista = osUnidad.filter(os => {
            const num = os.OSATMO || os.osatomo;
            const coords = (os.Coordenadas || os.Coordendasgis || "");
            return num && coords.includes(',');
        });
 
        osParaLista.forEach(os => {
            const numero = os.OSATMO || os.osatomo;
            const tipo = os.Tipologia || 'Sin tipolog√≠a';
            const option = document.createElement('option');
            option.value = numero;
            option.textContent = `${numero} - ${tipo}`;
            selectOS.appendChild(option);
        });
 
        containerOS.style.display = osParaLista.length > 0 ? 'block' : 'none';
    }

    // L√≥gica del resumen basada en el nuevo filtro limpio
    const conCoordenadasLector = osUnidad.filter(os =>
        os.Coordenadas && os.Coordenadas.trim() !== '' && os.Coordenadas.includes(',')
    );
    const conCoordenadasGIS = osUnidad.filter(os =>
        os.Coordendasgis && os.Coordendasgis.trim() !== '' && os.Coordendasgis.includes(',')
    );
 
    contenidoDiv.innerHTML = `
        ‚Ä¢ Total de OS Detectadas: <strong>${osUnidad.length}</strong><br>
        ‚Ä¢ Con Coordenadas Lector: <strong>${conCoordenadasLector.length}</strong><br>
        ‚Ä¢ Con Coordenadas GIS: <strong>${conCoordenadasGIS.length}</strong><br>
        <small style="color: #2e7d32;">‚úî Filtro de normalizaci√≥n aplicado (Inmune a guiones)</small>
    `;
    resumenDiv.style.display = 'block';
}



¬†	// ========================================
// üì• GENERAR KML ADMIN POR UNIDAD
// ========================================
async function generarKMLAdminPorUnidad(tipo) {
¬†   const unidadSeleccionada = document.getElementById('selectUnidadKML').value;
¬†
¬†   if (!unidadSeleccionada) {
¬†       alert('‚ö†Ô∏è Por favor seleccione una unidad');
¬†       return;
¬†   }
¬†
¬†   const osUnidad = window.osAsignadasKML.filter(os => os.Unidad === unidadSeleccionada);
¬†
¬†   if (osUnidad.length === 0) {
¬†       alert('‚ùå No hay OS Asignadas para esta unidad');
¬†       return;
¬†   }
¬†
¬†   // Filtrar por tipo de coordenadas
¬†   let osFiltradas;
¬†   if (tipo === 'lector') {
¬†       osFiltradas = osUnidad.filter(os => os.Coordenadas && os.Coordenadas.includes(','));
¬†   } else {
¬†       osFiltradas = osUnidad.filter(os => os.Coordendasgis && os.Coordendasgis.includes(','));
¬†   }
¬†
¬†   if (osFiltradas.length === 0) {
¬†       alert(`‚ùå No hay coordenadas ${tipo === 'lector' ? 'Lector' : 'GIS'} para esta unidad`);
¬†       return;
¬†   }
¬†
¬†   // Generar KML
¬†   const ubicaciones = osFiltradas.map(os => ({
¬†       etiqueta: os.OSATMO || 'Sin OS',
¬†       coordenadas: tipo === 'lector' ? os.Coordenadas : os.Coordendasgis
¬†   }));
¬†
¬†   const kmlString = generarKMLString(ubicaciones);
¬†   const blob = new Blob([kmlString], { type: 'application/vnd.google-earth.kml+xml' });
¬†   const url = URL.createObjectURL(blob);
¬†   const a = document.createElement('a');
¬†   a.href = url;
¬†   a.download = `KML\_${tipo === 'lector' ? 'Lector' : 'GIS'}\_${unidadSeleccionada}\_${new Date().getTime()}.kml`;
¬†   a.click();
¬†   URL.revokeObjectURL(url);
¬†
¬†   console.log(`‚úÖ KML ${tipo} descargado para ${unidadSeleccionada}`);
}

¬†

// ========================================
// üó∫Ô∏è GENERAR MAPA KML RUTA (VERSI√ìN OPTIMIZADA Y ROBUSTA)
// ========================================
async function generarMapaKMLRuta(osAsignadas, unidad) {
    const resultsContainer = document.getElementById('searchResults');
    const unidadSeleccionada = unidad;
    
    console.group('üó∫Ô∏è ==========================================');
    console.log('üó∫Ô∏è INICIANDO: generarMapaKMLRuta');
    console.log('üó∫Ô∏è Unidad:', unidadSeleccionada);
    console.log('üó∫Ô∏è OS asignadas recibidas:', osAsignadas?.length || 0);
    console.groupEnd();

    // Validaci√≥n inicial
    if (!resultsContainer) {
        console.error('‚ùå Contenedor searchResults no encontrado');
        return;
    }

    if (!osAsignadas || !Array.isArray(osAsignadas) || osAsignadas.length === 0) {
        resultsContainer.innerHTML = '<div class="result-card">‚ö†Ô∏è No hay OS asignadas para procesar</div>';
        return;
    }

    // ========================================
    // ‚úÖ 1Ô∏è‚É£ NORMALIZACI√ìN DE OS ASIGNADAS
    // ========================================
    console.log('üîÑ Normalizando OS asignadas...');
    
    const osNormalizadas = osAsignadas
        .map(os => {
            // Extraer y normalizar ID de OS (prioridad de campos)
            const id = String(os.osatomo || os.OSATMO || os.OSATOMO || '').trim();
            
            // Extraer coordenadas con prioridad expl√≠cita
            const coords = os.Coordenadas || os.Coordendasgis || null;
            
            // Extraer comentario con fallback en cadena
            const comentarioOriginal = os.Comentario || os.ComentarioGeneral || os.comentario || '';
            
            return {
                ...os,  // Mantener todos los campos originales
                osatomo: id,
                OSATMO: id,  // Normalizar para consistencia
                Tipologia: os.Tipologia || os.tipologia || 'Sin tipolog√≠a',
                Coordenadas: coords,
                esAsignada: true,
                // Normalizar comentarios
                Comentario: comentarioOriginal,
                ComentarioGeneral: comentarioOriginal
            };
        })
        .filter(os => {
            // Filtrar OS sin ID v√°lido
            if (!os.OSATMO) {
                console.warn(`‚ö†Ô∏è OS filtrada: Sin ID v√°lido`, os);
                return false;
            }
            // Filtrar OS sin coordenadas (no pueden ser centro de ruta)
            if (!os.Coordenadas || !String(os.Coordenadas).includes(',')) {
                console.warn(`‚ö†Ô∏è OS ${os.OSATMO} sin coordenadas v√°lidas - excluida como centro`);
            }
            return true;
        });

    console.log(`‚úÖ OS normalizadas: ${osNormalizadas.length} de ${osAsignadas.length}`);

    if (osNormalizadas.length === 0) {
        resultsContainer.innerHTML = `
            <div class="result-card" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                <div class="result-header">‚ö†Ô∏è Sin OS v√°lidas</div>
                <p style="text-align: center; color: #666;">
                    No se encontraron OS con coordenadas v√°lidas para la unidad <b>${unidadSeleccionada}</b>.
                </p>
            </div>`;
        return;
    }

    // ========================================
    // ‚úÖ 2Ô∏è‚É£ GUARDAR EN MEMORIA GLOBAL
    // ========================================
    window.osAsignadasKML = osNormalizadas;
    window.osKMLData = osNormalizadas;
    console.log('üíæ OS guardadas en memoria global');

    // ========================================
    // ‚úÖ 3Ô∏è‚É£ OBTENER E INYECTAR COMENTARIOS (OPTIMIZADO)
    // ========================================
    console.group('üìù Obteniendo comentarios de consulta_servicios...');
    
    // Extraer medidores √∫nicos v√°lidos
    const medidoresUnicos = [...new Set(
        osNormalizadas
            .map(os => os.Medidor)
            .filter(m => m && String(m).trim() !== '' && String(m).trim() !== 'N/A')
    )];
    
    console.log(`üîç Medidores √∫nicos para consultar: ${medidoresUnicos.length}`);
    
    // Map local para comentarios (evita conflicto con variable global)
    const comentariosLocales = new Map();
    
    // Consultar en lotes para evitar saturaci√≥n
    if (medidoresUnicos.length > 0) {
        const BATCH_SIZE = 1000;
        let totalObtenidos = 0;
        
        for (let i = 0; i < medidoresUnicos.length; i += BATCH_SIZE) {
            const batch = medidoresUnicos.slice(i, i + BATCH_SIZE);
            
            try {
                const { data: comData, error: errorCom } = await supabaseClient
                    .from('consultas_servicios')
                    .select('Medidor, ComentarioGeneral')
                    .in('Medidor', batch);
                
                if (errorCom) {
                    console.warn(`‚ö†Ô∏è Error en lote ${Math.floor(i/BATCH_SIZE)+1}:`, errorCom.message);
                    continue;
                }
                
                if (comData && comData.length > 0) {
                    comData.forEach(item => {
                        if (item.Medidor && item.ComentarioGeneral) {
                            // Normalizar clave para b√∫squeda consistente (case-insensitive)
                            const key = String(item.Medidor).trim().toUpperCase();
                            comentariosLocales.set(key, String(item.ComentarioGeneral).trim());
                        }
                    });
                    totalObtenidos += comData.length;
                    console.log(`‚úÖ Lote ${Math.floor(i/BATCH_SIZE)+1}: ${comData.length} comentarios`);
                }
                
                // Pausa anti-rate-limiting
                await new Promise(resolve => setTimeout(resolve, 50));
                
            } catch (err) {
                console.error(`‚ùå Error procesando lote:`, err);
            }
        }
        
        console.log(`üìä Total comentarios obtenidos: ${totalObtenidos}`);
    }
    
   // ========================================
// ‚úÖ 3Ô∏è‚É£ INYECTAR COMENTARIO DIRECTO DE OS PENDIENTES (SIN CONSULTA EXTERNA)
// ========================================
console.log('üìù ==========================================');
console.log('üìù USANDO COMENTARIO DIRECTO DE OS PENDIENTES (KML)');
console.log('üìù ==========================================');

let inyeccionesExitosas = 0;
let sinComentario = 0;

osNormalizadas.forEach(os => {
    // ‚úÖ PRIORIDAD ABSOLUTA: Comentario de OS Pendientes
    const comentarioOS = os.Comentario?.trim();
    
    if (comentarioOS && comentarioOS !== '' && comentarioOS !== 'N/A' && comentarioOS !== 'Sin Comentario') {
        // Guardar en campo espec√≠fico para KML (no sobrescribir ComentarioGeneral gen√©rico)
        os.ComentarioKML = comentarioOS;
        os.ComentarioGeneral = comentarioOS;  // Para compatibilidad
        console.log(`üí¨ OS ${os.OSATMO}: Comentario OS Pendientes aplicado`);
        inyeccionesExitosas++;
    } else {
        // Solo como √∫ltimo fallback, consultar consultas_servicios
        os.ComentarioKML = 'Sin comentario disponible';
        os.ComentarioGeneral = 'Sin comentario disponible';
        sinComentario++;
        console.log(`‚ö†Ô∏è OS ${os.OSATMO}: Sin comentario en OS Pendientes`);
    }
});

console.log(`‚úÖ Inyecci√≥n: ${inyeccionesExitosas} exitosas, ${sinComentario} sin comentario`);
console.groupEnd();

    // ========================================
    // ‚úÖ 4Ô∏è‚É£ DIAGN√ìSTICO AUTOM√ÅTICO PARA OS ESPEC√çFICAS
    // ========================================
    const osParaDiagnosticar = ['11126031', '11195544'];
    
    osParaDiagnosticar.forEach(osId => {
        const osPrueba = osNormalizadas.find(o => o.OSATMO === osId);
        if (osPrueba) {
            console.group(`üîç DIAGN√ìSTICO OS ${osId}`);
            console.log('Medidor:', osPrueba.Medidor);
            console.log('Comentario final:', osPrueba.Comentario?.substring(0, 100));
            console.log('Clave de b√∫squeda:', osPrueba.Medidor ? String(osPrueba.Medidor).trim().toUpperCase() : 'N/A');
            console.log('Encontrado en Map:', comentariosLocales.has(osPrueba.Medidor?.toString().trim().toUpperCase()));
            console.groupEnd();
        }
    });

    // ========================================
    // ‚úÖ 5Ô∏è‚É£ CARGAR FILTROS DESDE SUPABASE
    // ========================================
    console.log('üìÖ Consultando filtros para unidad:', unidadSeleccionada);
    
    const HOY = getFechaHoyElSalvador();
    let filtrosUnidadHoy = null;
    
    try {
        // Intentar filtros para hoy primero
        const { data: filtrosHoy } = await supabaseClient
            .from('filtros_por_unidad')
            .select('*')
            .eq('Unidad', unidadSeleccionada)
            .eq('fecha_programada', HOY)
            .maybeSingle();
        
        if (filtrosHoy) {
            filtrosUnidadHoy = filtrosHoy;
            console.log('‚úÖ Filtros encontrados para HOY');
        } else {
            // Fallback a filtros base (fecha_programada = null)
            const { data: filtrosBase } = await supabaseClient
                .from('filtros_por_unidad')
                .select('*')
                .eq('Unidad', unidadSeleccionada)
                .is('fecha_programada', null)
                .maybeSingle();
            
            filtrosUnidadHoy = filtrosBase;
            console.log(filtrosBase ? '‚úÖ Filtros base encontrados' : '‚ÑπÔ∏è Sin filtros configurados');
        }
    } catch (err) {
        console.warn('‚ö†Ô∏è Error consultando filtros:', err.message);
    }
    
    // Configurar filtros finales con valores por defecto
    const filtrosFinales = filtrosUnidadHoy || { 
        tipologias: [], 
        rangos: [], 
        radio_km: 3,
        deuda_amarillo: false,
        deuda_naranja: false,
        deuda_rosado: false
    };
    
    window.filtrosAplicados = filtrosFinales;
    const radioConfigurado = filtrosFinales.radio_km || 3;
    const tieneFiltros = !!(filtrosUnidadHoy && (filtrosUnidadHoy.tipologias?.length > 0 || filtrosUnidadHoy.rangos?.length > 0));

    // ========================================
    // ‚úÖ 6Ô∏è‚É£ GENERAR MENSAJE DIN√ÅMICO DE FILTROS
    // ========================================
    const formatArrayCount = (arr) => {
        if (!arr) return 0;
        if (Array.isArray(arr)) return arr.length;
        if (typeof arr === 'string') return arr.split(',').filter(s => s.trim()).length;
        return 0;
    };
    
    const tCount = formatArrayCount(filtrosFinales.tipologias);
    const rCount = formatArrayCount(filtrosFinales.rangos);
    
    const mensajeFiltros = tieneFiltros 
        ? `‚úÖ <b>${tCount}</b> Tipolog√≠as y <b>${rCount}</b> Rangos permitidos (Radio: ${radioConfigurado}km)`
        : "‚ö†Ô∏è <b>Sin filtros programados:</b> Solo se mostrar√°n Reguladas y Deuda ‚â• $500";

    // ========================================
    // ‚úÖ 7Ô∏è‚É£ GENERAR INTERFAZ HTML
    // ========================================
    const htmlSelector = `
        <div class="result-card" style="background: #ffffff; border: 1px solid #3b82f6; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="color: #1e3a8a; margin-top: 0; margin-bottom: 20px; border-bottom: 2px solid #f0f9ff; padding-bottom: 10px;">
                üìç KML Ruta - <span style="color: #2563eb;">${unidadSeleccionada}</span>
            </h3>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 700; margin-bottom: 8px; color: #4b5563;">
                    Punto de Partida (Tus Asignadas):
                </label>
                <select id="selectPuntoPartidaKML" 
                    onchange="window.osPartidaSeleccionada = this.value; console.log('üìç Punto seleccionado:', this.value);" 
                    style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 15px; background: #f8fafc;">
                    <option value="">-- Seleccione una de las ${osNormalizadas.length} OS --</option>
                    ${osNormalizadas.map(os => 
                        `<option value="${os.OSATMO}">${os.OSATMO} - ${os.Tipologia}</option>`
                    ).join('')}
                </select>
            </div>

            <div style="background: ${tieneFiltros ? '#f0fdf4' : '#fffbeb'}; 
                        border: 1px solid ${tieneFiltros ? '#bbf7d0' : '#fef08a'}; 
                        padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong style="color: #1e293b; display: block; margin-bottom: 5px;">üìä Configuraci√≥n de Filtros:</strong>
                <p style="margin: 0; color: #475569; font-size: 14px;">${mensajeFiltros}</p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                <button class="btn" onclick="generarMapaKMLSoloAsignadas('${unidadSeleccionada}')"
                        style="background: #64748b; color: white; padding: 12px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer;">
                    üìã Solo Mis Asignadas (${osNormalizadas.length})
                </button>
                <button id="btnAplicarFiltro" class="btn" 
                        onclick="generarMapaKMLConFiltrosGuardados('${unidadSeleccionada}')"
                        style="background: #2563eb; color: white; padding: 12px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer;">
                    üéØ Aplicar Filtro Radio
                </button>
            </div>

            <div style="border-top: 1px solid #e2e8f0; padding-top: 15px;">
                <label style="display: block; font-size: 11px; font-weight: 700; color: #94a3b8; margin-bottom: 10px; text-transform: uppercase;">
                    O rutas desde ciudad:
                </label>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <button class="btn-fijo" onclick="generarRutaDesdePuntoFijo('Ahuachap√°n', 13.924670, -89.842820)">üìç Ahuachap√°n</button>
                    <button class="btn-fijo" onclick="generarRutaDesdePuntoFijo('Sonsonate', 13.727937, -89.717790)">üìç Sonsonate</button>
                    <button class="btn-fijo" onclick="generarRutaDesdePuntoFijo('Santa Ana', 13.9680, -89.6240)">üìç Santa Ana</button>
                </div>
            </div>
        </div>

        <style>
            .btn-fijo {
                background: #f1f5f9;
                color: #475569;
                border: 1px solid #e2e8f0;
                padding: 10px 5px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
            }
            .btn-fijo:hover { background: #e2e8f0; transform: translateY(-1px); }
            .btn:active { transform: scale(0.98); }
        </style>
    `;

    resultsContainer.innerHTML = htmlSelector;
    console.log('‚úÖ Interfaz KML Ruta generada exitosamente');
    console.log('üó∫Ô∏è ==========================================');
}



function generarMapaKMLSoloAsignadas(unidad) {
    // Obtenemos el valor directamente para asegurar frescura
    const select = document.getElementById('selectPuntoPartidaKML');
    const osPartida = select?.value;
    
    if (!osPartida || osPartida === "") {
        alert('‚ö†Ô∏è Seleccione un punto de partida para centrar el mapa');
        select?.focus();
        return;
    }

    // ‚úÖ Sincronizaci√≥n global
    window.osPartidaSeleccionada = osPartida;
    window.unidadSeleccionadaKML = unidad; // Guardamos la unidad para la siguiente funci√≥n
    
    console.log(`üó∫Ô∏è Generando mapa solo asignadas para ${unidad}. Centro: ${osPartida}`);
    
    // IMPORTANTE: Aseg√∫rate que esta funci√≥n use window.osAsignadasKML 
    // y no vuelva a filtrar contra la tabla de Pendientes.
    generarMapaKMLConPuntoPartida(unidad);
}



async function generarMapaKMLConFiltrosGuardados(unidad) {
    const btn = document.getElementById('btnAplicarFiltro');
    const select = document.getElementById('selectPuntoPartidaKML');
    const osPartida = select?.value;

    // 1. Validaci√≥n de selecci√≥n
    if (!osPartida) {
        alert('‚ö†Ô∏è Por favor, seleccione una Orden de Servicio (OS) como punto de partida.');
        select?.focus();
        return;
    }

    // üïµÔ∏è VALIDACI√ìN PREVENTIVA DE COORDENADAS (Lo que faltaba)
    const fuente = window.osAsignadasKML || [];
    const osDataPartida = fuente.find(os => String(os.OSATMO || os.osatomo).trim() === String(osPartida).trim());
    
    const coordsValidas = osDataPartida?.Coordenadas || osDataPartida?.Coordendasgis;
    
    if (!coordsValidas || !coordsValidas.includes(',')) {
        alert('‚ùå Error: La OS seleccionada como punto de partida no tiene coordenadas v√°lidas. Por favor seleccione otra.');
        return;
    }

    try {
        if(btn) { 
            btn.disabled = true; 
            btn.innerHTML = '<span class="spinner"></span> Procesando...'; 
            btn.style.opacity = '0.7';
        }
        
        // Sincronizaci√≥n de variables globales
        window.osPartidaSeleccionada = osPartida;
        window.currentUnidadKML = unidad; 

        console.log('--- üöÄ INICIANDO PROCESO DE FILTRADO KML RUTA ---');

        // 2. Uni√≥n de universos
        window.universoParaFiltrarKML = [
            ...(window.osAsignadasKML || []), 
            ...(window.todasLasPendientesKML || [])
        ];

        console.log(`üì¶ Universo Total a procesar: ${window.universoParaFiltrarKML.length} registros.`);

        // 3. Auditor√≠a de seguridad para la OS 11195544
        const check = window.universoParaFiltrarKML.find(p => String(p.OSATMO || p.osatomo).trim() === '11195544');
        
        if (check) {
            const uOriginal = check.Unidad || "VAC√çO";
            const uLimpia = uOriginal.replace(/[^a-zA-Z0-9]/g, "");
            
            console.group("‚úÖ AUDITOR√çA PRE-FILTRADO (OS 11195544)");
            console.log("Unidad en BD:", `"${uOriginal}"`);
            console.log("Status:", uLimpia === "" ? "LIBRE ‚úÖ" : `OCUPADA ‚ùå`);
            console.groupEnd();
        }

        // 4. Ejecuci√≥n del motor (Donde corregimos el error de 'partes')
        await generarMapaUnidadConFiltros(true); 

        console.log('--- ‚úÖ PROCESO FINALIZADO CON √âXITO ---');

    } catch (error) {
        console.error('‚ùå Error cr√≠tico en el controlador de filtros:', error);
        alert('Hubo un problema al procesar los filtros: ' + error.message);
    } finally {
        if(btn) { 
            btn.disabled = false; 
            btn.innerText = 'üéØ Aplicar Filtro Radio'; 
            btn.style.opacity = '1';
        }
    }
}

/**
 * Optimiza la secuencia de la ruta usando Vecino M√°s Cercano y refinamiento 2-OPT.
 * Incluye auditor√≠a de validaci√≥n l√≥gica en consola.
 */
function optimizarRutaVecinoCercano(osData, osPartidaId, puntoPartidaCoordenadas = null) {
    const getOSId = (os) => String(os.OSATMO || os.osatomo || os.OSATOMO || '').trim();
    
    console.log('--- üõ†Ô∏è INICIANDO OPTIMIZACI√ìN DE RUTA ---');

    // 1Ô∏è‚É£ Encontrar OS de partida
    const osPartida = osData.find(os => getOSId(os) === String(osPartidaId).trim());
 
    if (!osPartida) {
        console.warn('‚ö†Ô∏è OS de partida no encontrada, usando primera disponible');
        return osData.length > 0 ? osData : [];
    }

    // 2Ô∏è‚É£ Obtener coordenadas de la OS base
    const coordsCentro = osPartida.Coordenadas || osPartida.Coordendasgis;
    const [latCentro, lngCentro] = (coordsCentro && coordsCentro.split(',').map(c => parseFloat(c.trim()))) || [NaN, NaN];
 
    if (isNaN(latCentro) || isNaN(lngCentro)) {
        console.error(`‚ùå Coordenadas inv√°lidas para OS inicial ${osPartidaId}`);
        return osData;
    }

    // 3Ô∏è‚É£ Definir coordenadas reales de inicio
    let puntoInicialLat = latCentro;
    let puntoInicialLng = lngCentro;
 
    if (puntoPartidaCoordenadas?.lat && puntoPartidaCoordenadas?.lng) {
        puntoInicialLat = puntoPartidaCoordenadas.lat;
        puntoInicialLng = puntoPartidaCoordenadas.lng;
        console.log(`üìç Inicio ajustado a coordenadas personalizadas: ${puntoInicialLat}, ${puntoInicialLng}`);
    }

    // 4Ô∏è‚É£ Preparar objeto de partida
    const osPartidaConDatos = {
        ...osPartida,
        lat: puntoInicialLat,
        lng: puntoInicialLng,
        distancia: 0,
        numeroOrden: 1
    };

    // 5Ô∏è‚É£ Preparar lista de puntos a visitar (Limpieza estricta de coordenadas)
    const puntosNoVisitados = osData
        .filter(os => getOSId(os) !== getOSId(osPartida)) 
        .map(os => {
            const coords = os.Coordenadas || os.Coordendasgis;
            const [lat, lng] = (coords && coords.split(',').map(c => parseFloat(c.trim()))) || [null, null];
            if (lat === null || isNaN(lat)) return null;
            return { ...os, lat, lng };
        })
        .filter(os => os !== null);

    console.log(`üì¶ Procesando ${puntosNoVisitados.length} puntos adicionales.`);

    // 6Ô∏è‚É£ ALGORITMO DEL VECINO M√ÅS CERCANO (Ruta inicial)
    let rutaFinal = [osPartidaConDatos];
    let puntoActual = osPartidaConDatos;
    let orden = 2;

    while (puntosNoVisitados.length > 0) {
        let vecinoMasCercano = null;
        let minDistancia = Infinity;
        let vecinoIndex = -1;

        for (let i = 0; i < puntosNoVisitados.length; i++) {
            const os = puntosNoVisitados[i];
            const dist = calcularDistanciaKm(puntoActual.lat, puntoActual.lng, os.lat, os.lng);
            if (dist < minDistancia) {
                minDistancia = dist;
                vecinoMasCercano = os;
                vecinoIndex = i;
            }
        }

        if (vecinoMasCercano) {
            vecinoMasCercano.numeroOrden = orden++;
            vecinoMasCercano.distancia = minDistancia;
            rutaFinal.push({ ...vecinoMasCercano, numeroOrden: orden++ });
            puntoActual = vecinoMasCercano;
            puntosNoVisitados.splice(vecinoIndex, 1);
        } else break;
    }

    const distInicialTotal = rutaFinal.reduce((sum, os) => sum + (os.distancia || 0), 0);

    // 7Ô∏è‚É£ MEJORA 2-OPT (Refinamiento de cruces)
    let mejorado = true;
    let iteraciones = 0;
    let mejorasRealizadas = 0;
    const MAX_ITERACIONES = 100;

    while (mejorado && iteraciones < MAX_ITERACIONES) {
        mejorado = false;
        iteraciones++;

        for (let i = 0; i < rutaFinal.length - 2; i++) {
            for (let j = i + 2; j < rutaFinal.length - 1; j++) {
                const d_i_next = calcularDistanciaKm(rutaFinal[i].lat, rutaFinal[i].lng, rutaFinal[i+1].lat, rutaFinal[i+1].lng);
                const d_j_next = calcularDistanciaKm(rutaFinal[j].lat, rutaFinal[j].lng, rutaFinal[j+1].lat, rutaFinal[j+1].lng);
                const d_i_j = calcularDistanciaKm(rutaFinal[i].lat, rutaFinal[i].lng, rutaFinal[j].lat, rutaFinal[j].lng);
                const d_next_next = calcularDistanciaKm(rutaFinal[i+1].lat, rutaFinal[i+1].lng, rutaFinal[j+1].lat, rutaFinal[j+1].lng);

                if (d_i_j + d_next_next < d_i_next + d_j_next - 0.0001) {
                    const segmentoInvertido = rutaFinal.slice(i + 1, j + 1).reverse();
                    rutaFinal.splice(i + 1, j - i, ...segmentoInvertido);
                    mejorado = true;
                    mejorasRealizadas++;
                    break;
                }
            }
            if (mejorado) break;
        }
    }

    // 8Ô∏è‚É£ Recalcular n√∫meros de orden y distancias finales
    rutaFinal.forEach((os, i) => {
        os.numeroOrden = i + 1;
        os.distancia = (i === 0) ? 0 : calcularDistanciaKm(rutaFinal[i-1].lat, rutaFinal[i-1].lng, os.lat, os.lng);
    });

    const distFinalTotal = rutaFinal.reduce((sum, os) => sum + (os.distancia || 0), 0);

    // üõ°Ô∏è BLOQUE DE AUDITOR√çA LOG√çSTICA
    console.log('üìã --- AUDITOR√çA DE SECUENCIA L√ìGICA ---');
    console.table(rutaFinal.map(os => ({
        Orden: os.numeroOrden,
        OS: getOSId(os),
        Tipologia: (os.Tipologia || os.tipologia || '').substring(0, 20),
        'Dist. Tramo (km)': os.distancia.toFixed(2),
        'Coord': `${os.lat.toFixed(4)},${os.lng.toFixed(4)}`
    })));

    console.log('--- ‚úÖ OPTIMIZACI√ìN COMPLETADA ---');
    console.log(`üõ£Ô∏è  Distancia Final: ${distFinalTotal.toFixed(2)} km (Ahorro: ${(distInicialTotal - distFinalTotal).toFixed(2)} km)`);
    console.log('----------------------------------');

    return rutaFinal;
}


// ========================================
// üìç GENERAR RUTA DESDE UN PUNTO FIJO (COMPLETO Y MEJORADO)
// ========================================
function generarRutaDesdePuntoFijo(puntoNombre, puntoLat, puntoLng) {
    // 1Ô∏è‚É£ LOGS INICIALES DE CONTROL (Tus üö® originales)
    console.log('üö® ==========================================');
    console.log('üö® EJECUTANDO: generarRutaDesdePuntoFijo');
    console.log('üö® Par√°metros recibidos:', { puntoNombre, puntoLat, puntoLng });
    console.log('üö® window.osAsignadasKML:', window.osAsignadasKML);
    console.log('üö® window.osAsignadasKML existe:', !!window.osAsignadasKML);
    console.log('üö® window.osAsignadasKML es array:', Array.isArray(window.osAsignadasKML));
    console.log('üö® window.osAsignadasKML longitud:', window.osAsignadasKML ? window.osAsignadasKML.length : 'N/A');
    console.log('üö® window.unidadActivaMapaRutas:', window.unidadActivaMapaRutas);
    console.log('üö® ==========================================');

    const resultsContainer = document.getElementById('searchResults');
    
    // Validamos que el contenedor exista antes de escribir en √©l
    if (resultsContainer) {
        resultsContainer.innerHTML = '<div class="loading" style="display: block; margin: 20px auto;"></div>';
    }

    try {
        // 2Ô∏è‚É£ VALIDAR QUE EXISTAN LOS DATOS
        if (!window.osAsignadasKML || !Array.isArray(window.osAsignadasKML)) {
            console.error('‚ùå window.osAsignadasKML no est√° definido o no es un array');
            throw new Error('No hay datos de OS asignadas cargados. Por favor, recargue la p√°gina.');
        }

        if (window.osAsignadasKML.length === 0) {
            console.warn('‚ö†Ô∏è No hay OS asignadas cargadas');
            throw new Error('No hay OS asignadas disponibles en el sistema.');
        }

        console.log(`üìç Iniciando proceso para: ${puntoNombre} (${puntoLat}, ${puntoLng})`);

        // 3Ô∏è‚É£ OBTENER LA UNIDAD ACTIVA (L√≥gica de prioridad)
        const unidadActiva = window.unidadActivaMapaRutas ||
                            (window.osAsignadasKML[0] && window.osAsignadasKML[0].Unidad);

        console.log(`üìä Unidad activa detectada para filtrado: ${unidadActiva || 'TODAS'}`);

        // 4Ô∏è‚É£ FILTRAR OS POR UNIDAD
        let osData = window.osAsignadasKML;
        if (unidadActiva) {
            osData = window.osAsignadasKML.filter(os => os.Unidad === unidadActiva);
            console.log(`‚úÖ ${osData.length} OS filtradas para la unidad: ${unidadActiva}`);
        }

        // Si despu√©s de filtrar no queda nada, volvemos al dataset completo por seguridad
        if (!osData || osData.length === 0) {
            console.warn('‚ö†Ô∏è No se encontraron OS para la unidad activa, usando dataset completo');
            osData = window.osAsignadasKML;
        }

        // 5Ô∏è‚É£ FILTRAR SOLO OS CON COORDENADAS V√ÅLIDAS
        const osConCoordenadas = osData.filter(os => {
            const coords = os.Coordenadas || os.Coordendasgis;
            // Verificaci√≥n robusta: que sea string y contenga coma
            return coords && typeof coords === 'string' && coords.includes(',');
        });

        if (osConCoordenadas.length === 0) {
            console.error('‚ùå Error: Cero puntos con coordenadas procesables');
            throw new Error('No hay OS con coordenadas v√°lidas para generar la ruta.');
        }

        console.log(`‚úÖ ${osConCoordenadas.length} OS v√°lidas encontradas. Aplicando algoritmos...`);

        // 6Ô∏è‚É£ APLICAR ALGORITMO DE OPTIMIZACI√ìN
        // IMPORTANTE: null en el ID porque salimos de una base, no de una OS
        const rutaOptimizada = optimizarRutaVecinoCercano(osConCoordenadas, null, {
            lat: puntoLat,
            lng: puntoLng
        });

        console.log(`‚úÖ Ruta optimizada generada exitosamente: ${rutaOptimizada.length} puntos`);

        // 7Ô∏è‚É£ MOSTRAR MAPA CON LA RUTA
        if (typeof mostrarMapaKMLConNumeracion === 'function') {
            mostrarMapaKMLConNumeracion(rutaOptimizada, puntoNombre, puntoLat, puntoLng);
        } else {
            console.error('‚ùå La funci√≥n mostrarMapaKMLConNumeracion no existe');
            throw new Error('El visualizador de mapas no est√° listo.');
        }

    } catch (err) {
        console.error('‚ùå Error cr√≠tico generando ruta:', err);
        console.error('Stack Trace:', err.stack);
        
        if (resultsContainer) {
            resultsContainer.innerHTML = `
                <div class="result-card" style="background: #fff3cd; border-left: 5px solid #ffa000; padding: 15px;">
                    <div class="result-header" style="font-weight: bold; color: #856404; margin-bottom: 5px;">‚ö†Ô∏è Error de Generaci√≥n</div>
                    <p style="color: #666; margin: 0;">${err.message || 'Error desconocido'}</p>
                    <p style="color: #999; font-size: 11px; margin-top: 10px;">
                        üí° <b>Consejo:</b> Intente refrescar los datos o verificar que la unidad tenga OS con coordenadas en el archivo cargado.
                    </p>
                </div>
            `;
        }
    }
}


// ========================================
// üó∫Ô∏è GENERAR MAPA KML CON PUNTO DE PARTIDA (REVISADO Y FILTRADO)
// ========================================
function generarMapaKMLConPuntoPartida(unidad) {
    const startTime = performance.now();
    const osPartidaId = document.getElementById('selectPuntoPartidaKML')?.value;

    if (!osPartidaId) {
        alert('‚ö†Ô∏è Por favor seleccione un punto de partida');
        return;
    }

    // 1Ô∏è‚É£ VALIDAR DATOS DE ORIGEN
    const osDataOriginal = window.osKMLData;
    if (!osDataOriginal || !Array.isArray(osDataOriginal)) {
        console.error('‚ùå window.osKMLData no disponible');
        alert('‚ùå Error: Datos no cargados. Recargue la p√°gina.');
        return;
    }

    console.log(`üö® --- INICIANDO GENERACI√ìN KML RUTA (SOLO ASIGNADAS) ---`);
    console.log(`üìç Punto partida: ${osPartidaId} | Unidad: ${unidad}`);

    // 2Ô∏è‚É£ APLICAR REGLAS DE NEGOCIO (Recordatorio: Reguladas y > 500 siempre van)
    // Filtramos para asegurar que lo que se muestre cumpla con los requisitos m√≠nimos
    const osFiltradaNegocio = osDataOriginal.filter(os => {
        const esRegulada = String(os.Tipologia || '').toUpperCase().includes('REGULADA');
        const montoDeuda = parseFloat(os.MontoDeuda || os.monto_deuda || 0);
        const esDeudaAlta = montoDeuda > 500;
        
        // En "Solo Asignadas" mostramos lo que trae el KML + validaci√≥n de seguridad
        return true; // Aqu√≠ podr√≠as a√±adir filtros espec√≠ficos si fuera necesario
    });

    // 3Ô∏è‚É£ NORMALIZACI√ìN CR√çTICA
    const osDataNormalizada = osFiltradaNegocio.map(os => ({
        ...os,
        osatomo: String(os.osatomo || os.OSATMO || os.OSATOMO || '').trim()
    })).filter(os => {
        // Solo puntos con coordenadas v√°lidas
        const coords = os.Coordenadas || os.Coordendasgis;
        return coords && String(coords).includes(',');
    });

    console.log(`üìä Puntos normalizados y con coordenadas: ${osDataNormalizada.length}`);

    // 4Ô∏è‚É£ OPTIMIZACI√ìN DE RUTA
    // Usamos nuestra funci√≥n optimizada (Vecino Cercano + 2-OPT)
    const todosLosPuntos = optimizarRutaVecinoCercano(osDataNormalizada, osPartidaId);

    if (todosLosPuntos.length === 0) {
        console.error('‚ùå No se pudieron generar puntos optimizados');
        alert('‚ùå Error: No se encontraron puntos v√°lidos para trazar la ruta.');
        return;
    }

    // 5Ô∏è‚É£ VALIDACI√ìN DEL CENTRO (Primer punto de la ruta)
    const osCentro = todosLosPuntos[0];
    const latCentro = parseFloat(osCentro.lat);
    const lngCentro = parseFloat(osCentro.lng);

    if (isNaN(latCentro) || isNaN(lngCentro)) {
        console.error('‚ùå Centro de mapa inv√°lido:', osCentro);
        alert('‚ùå Error: El punto de partida no tiene coordenadas v√°lidas.');
        return;
    }

    // 6Ô∏è‚É£ LOGS DE RENDIMIENTO Y FINALIZACI√ìN
    const endTime = performance.now();
    const duracion = ((endTime - startTime) / 1000).toFixed(3);
    
    console.log('‚úÖ --- RUTA GENERADA CON √âXITO ---');
    console.log(`‚è±Ô∏è Tiempo total: ${duracion}s`);
    console.log(`üõ£Ô∏è Puntos en mapa: ${todosLosPuntos.length}`);
    console.log(`üìç Coordenadas centro: ${latCentro}, ${lngCentro}`);

    // 7Ô∏è‚É£ RENDERIZADO
    if (typeof mostrarMapaKMLConNumeracion === 'function') {
        mostrarMapaKMLConNumeracion(todosLosPuntos, unidad, latCentro, lngCentro);
    } else {
        console.error('‚ùå mostrarMapaKMLConNumeracion no definida');
    }
}

// ========================================
// üîÑ MOSTRAR MAPA KML CON NUMERACI√ìN (MEJORADO)
// ========================================
function mostrarMapaKMLConNumeracion(todosLosPuntos, unidad, latCentro, lngCentro) {
console.log(`üé® Renderizando mapa para ${unidad} con ${todosLosPuntos.length} puntos.`);
// 1Ô∏è‚É£ Preparar datos para Leaflet
const osCentro = todosLosPuntos[0]; // El punto de partida (Origen)
const osEnRadio = todosLosPuntos.slice(1); // El resto de la secuencia optimizada
// Guardar para la funci√≥n de descarga
window.datosRutaKML = todosLosPuntos;
// 2Ô∏è‚É£ Renderizar el mapa
// Nota: El radioKm se pone alto o se ignora en la l√≥gica interna para mostrar todos los puntos
const radioVisual = 10;
// ‚úÖ PASAR DATOS COMPLETOS CON COMENTARIOS
generarMapaLeaflet(osCentro, osEnRadio, latCentro, lngCentro, radioVisual);

    // 3Ô∏è‚É£ Gestionar el contenedor de resultados y bot√≥n de descarga
    const resultsContainer = document.getElementById('searchResults');
    if (!resultsContainer) return;

    // Limpiamos botones previos si existen para evitar duplicados
    const botonExistente = document.getElementById('contenedorDescargaKML');
    if (botonExistente) botonExistente.remove();

    const descargaHTML = `
        <div id="contenedorDescargaKML" style="text-align: center; margin-top: 25px; padding: 25px; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 16px;">
            <h4 style="margin-bottom: 15px; color: #1e293b;">üìå Ruta Optimizada Lista</h4>
            <button class="btn" onclick="descargarKMLRutaNumerada()"
                    style="background: linear-gradient(135deg, #22c55e 0%, #15803d 100%); 
                           color: white; font-size: 18px; padding: 15px 35px; 
                           border-radius: 10px; border: none; cursor: pointer;
                           box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                üì• Descargar KML Numerado (${todosLosPuntos.length} puntos)
            </button>
            <p style="margin-top: 10px; font-size: 12px; color: #64748b;">
                * El archivo incluir√° la secuencia del 1 al ${todosLosPuntos.length}
            </p>
        </div>
    `;

    // Insertar despu√©s del mapa (no sobreescribir todo el contenedor si hay m√°s info)
    resultsContainer.insertAdjacentHTML('beforeend', descargaHTML);
    
    // Auto-scroll hacia el bot√≥n para que el usuario sepa que termin√≥
    resultsContainer.lastElementChild.scrollIntoView({ behavior: 'smooth' });
}





// ========================================
// üì• DESCARGAR KML RUTA NUMERADA (MEJORADO)
// ========================================
function descargarKMLRutaNumerada() {
    // 1Ô∏è‚É£ Validar existencia de datos
    if (!window.datosRutaKML || window.datosRutaKML.length === 0) {
        alert('‚ö†Ô∏è No hay datos de ruta optimizada para descargar.');
        return;
    }

    console.log(`üì¶ Preparando KML para ${window.datosRutaKML.length} ubicaciones...`);

    try {
        // 2Ô∏è‚É£ Preparar las ubicaciones con el nombre formateado para Google Earth/Maps
        const ubicaciones = window.datosRutaKML.map((os, index) => {
            const numero = os.numeroOrden || (index + 1);
            const idOS = os.OSATMO || os.osatomo || os.OSATOMO || 'Sin ID';
            
            return {
                // Esto har√° que en el mapa aparezca "1 - 20240510"
                etiqueta: `${numero} - ${idOS}`, 
                coordenadas: os.Coordenadas || os.Coordendasgis,
                numeroOrden: numero
            };
        });

        // 3Ô∏è‚É£ Generar el contenido del archivo
        if (typeof generarKMLString !== 'function') {
            throw new Error('La funci√≥n auxiliar generarKMLString no est√° definida.');
        }

        const kmlString = generarKMLString(ubicaciones);
        
        // 4Ô∏è‚É£ Crear el archivo para descarga
        const blob = new Blob([kmlString], { type: 'application/vnd.google-earth.kml+xml' });
        const url = URL.createObjectURL(blob);
        
        // Formatear nombre del archivo con fecha y hora para evitar confusiones
        const fecha = new Date().toISOString().slice(0,10);
        const hora = new Date().getHours() + '-' + new Date().getMinutes();
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `Ruta_Optimizada_${fecha}_${hora}.kml`;
        
        // Ejecutar descarga
        document.body.appendChild(a); // Necesario en algunos navegadores
        a.click();
        document.body.removeChild(a);
        
        // Limpieza de memoria
        URL.revokeObjectURL(url);
        console.log('‚úÖ Archivo KML generado y descargado con √©xito.');

    } catch (error) {
        console.error('‚ùå Error al exportar KML:', error);
        alert('Hubo un problema al generar el archivo KML: ' + error.message);
    }
}


¬†	// ========================================
// üó∫Ô∏è GENERAR KML POR UNIDAD SELECCIONADA (CON FILTROS DE NEGOCIO)
// ========================================
async function generarKMLPorUnidad() {
    const unidadSeleccionada = document.getElementById('selectUnidad').value;

    if (!unidadSeleccionada) {
        alert('Por favor seleccione una unidad');
        return;
    }

    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = '<div class="loading" style="display: block; margin: 20px auto;"></div>';

    try {
        console.log(`üö® Iniciando b√∫squeda para Unidad: ${unidadSeleccionada}`);

        // 1Ô∏è‚É£ BUSCAR OS PENDIENTES
        const { data: osPendientes, error } = await supabaseClient
            .from('OS Pendientes')
            .select('*')
            .eq('Unidad', unidadSeleccionada);

        if (error) throw error;

        if (!osPendientes || osPendientes.length === 0) {
            resultsContainer.innerHTML = `
                <div class="result-card" style="background: #fff3cd; border: 2px solid #ffc107;">
                    <div class="result-header">‚ö†Ô∏è Sin resultados</div>
                    <p>No se encontraron OS Pendientes para la unidad: <strong>${unidadSeleccionada}</strong></p>
                </div>`;
            return;
        }

      // 2Ô∏è‚É£ APLICAR FILTROS DE NEGOCIO (L√≥gica Inclusiva)
const osFiltradasNegocio = osPendientes.filter(os => {
    // Normalizamos valores para evitar errores de null/undefined
    const tipologia = String(os.Tipologia || os.tipologia || '').toUpperCase();
    const monto = parseFloat(os.MontoDeuda || os.monto_deuda || 0);

    const esRegulada = tipologia.includes('REGULADA');
    const esDeudaAlta = monto > 500;

    // üõ°Ô∏è L√ìGICA DE SUPERVIVENCIA:
    // Si cumple cualquiera de las dos, se queda. 
    // No importa si falla una, mientras la otra sea verdadera.
    if (esRegulada || esDeudaAlta) {
        return true; 
    }

    return false; // Solo se elimina si no es ninguna de las dos.
});

console.log(`üìä Filtro completado: Se mantienen ${osFiltradasNegocio.length} OS (Reguladas o >$500)`);

        // 3Ô∏è‚É£ SEPARAR POR TIPO DE COORDENADAS
        let conLector = osFiltradasNegocio.filter(os => 
            os.Coordenadas && os.Coordenadas.includes(',')
        );

        let conGIS = osFiltradasNegocio.filter(os => 
            os.Coordendasgis && os.Coordendasgis.includes(',')
        );

        // 4Ô∏è‚É£ OPTIMIZACI√ìN DE RUTA
        const osPartida = document.getElementById('selectPuntoPartidaKML')?.value;

        if (osPartida && osPartida.trim() !== "") {
            console.log(`‚ú® Optimizando ruta desde: ${osPartida}`);
            
            // Re-ordenar ambas listas con el nuevo algoritmo 2-OPT
            if (conLector.length > 0) {
                conLector = optimizarRutaVecinoCercano(conLector, osPartida);
            }
            if (conGIS.length > 0) {
                conGIS = optimizarRutaVecinoCercano(conGIS, osPartida);
            }
        } else {
            console.log('‚ÑπÔ∏è Sin punto de partida: Se asigna orden secuencial b√°sico.');
            conLector = conLector.map((os, i) => ({ ...os, numeroOrden: i + 1 }));
            conGIS = conGIS.map((os, i) => ({ ...os, numeroOrden: i + 1 }));
        }

        // 5Ô∏è‚É£ GUARDAR GLOBALES PARA DESCARGA
        window.kmlDataLector = conLector;
        window.kmlDataGIS = conGIS;

        // 6Ô∏è‚É£ MOSTRAR RESULTADOS
        resultsContainer.innerHTML = `
            <div class="result-card" style="background: #f0f9ff; border: 2px solid #3b82f6;">
                <div class="result-header">‚úÖ Proceso Completado - ${unidadSeleccionada}</div>

                <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px;">
                    <strong>üìä Resumen de Ruta:</strong><br>
                    ‚Ä¢ OS Totales en Unidad: ${osPendientes.length}<br>
                    ‚Ä¢ OS que cumplen filtros (Reg/+$500): <strong>${osFiltradasNegocio.length}</strong><br>
                    <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
                    ‚Ä¢ Disponibles en KML Lector: <strong>${conLector.length}</strong><br>
                    ‚Ä¢ Disponibles en KML GIS: <strong>${conGIS.length}</strong>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="descargarKMLLector()" 
                        ${conLector.length === 0 ? 'disabled style="opacity: 0.5;"' : ''}>
                        üì• KML Lector<br><small>(${conLector.length} pts)</small>
                    </button>

                    <button class="btn btn-secondary" onclick="descargarKMLGIS()" 
                        ${conGIS.length === 0 ? 'disabled style="opacity: 0.5;"' : ''}>
                        üì• KML GIS<br><small>(${conGIS.length} pts)</small>
                    </button>
                </div>
            </div>
        `;

    } catch (err) {
        console.error('‚ùå Error generando KML:', err);
        resultsContainer.innerHTML = `
            <div class="result-card" style="background: #fee2e2; border: 2px solid #ef4444;">
                <div class="result-header" style="color: #b91c1c;">‚ùå Error de Conexi√≥n</div>
                <p>${err.message || 'No se pudo conectar con la base de datos.'}</p>
            </div>`;
    }
}

¬†	// ========================================
// üì• DESCARGAR KML COORDENADAS LECTOR
// ========================================
function descargarKMLLector() {
¬†   if (!window.kmlDataLector || window.kmlDataLector.length === 0) {
¬†       alert('No hay coordenadas de lector para descargar');
¬†       return;
¬†   }
¬†
¬†   const ubicaciones = window.kmlDataLector.map(os => ({
¬†       etiqueta: os.OSATMO || 'Sin OS',
¬†       coordenadas: os.Coordenadas
¬†   }));
¬†
¬†   const kmlString = generarKMLString(ubicaciones);
¬†   const blob = new Blob([kmlString], { type: 'application/vnd.google-earth.kml+xml' });
¬†   const url = URL.createObjectURL(blob);
¬†   const a = document.createElement('a');
¬†   a.href = url;
¬†   a.download = `KML\_Lector\_${new Date().getTime()}.kml`;
¬†   a.click();
¬†   URL.revokeObjectURL(url);
}

¬†	// ========================================
// üì• DESCARGAR KML COORDENADAS GIS
// ========================================
function descargarKMLGIS() {
¬†   if (!window.kmlDataGIS || window.kmlDataGIS.length === 0) {
¬†       alert('No hay coordenadas GIS para descargar');
¬†       return;
¬†   }
¬†
¬†   const ubicaciones = window.kmlDataGIS.map(os => ({
¬†       etiqueta: os.OSATMO || 'Sin OS',
¬†       coordenadas: os.Coordendasgis
¬†   }));
¬†
¬†   const kmlString = generarKMLString(ubicaciones);
¬†   const blob = new Blob([kmlString], { type: 'application/vnd.google-earth.kml+xml' });
¬†   const url = URL.createObjectURL(blob);
¬†   const a = document.createElement('a');
¬†   a.href = url;
¬†   a.download = `KML\_GIS\_${new Date().getTime()}.kml`;
¬†   a.click();
¬†   URL.revokeObjectURL(url);
}

¬†	// ========================================
// üìä CARGAR INTERFAZ DETALLE OS
// ========================================
async function cargarInterfazDetalleOS() {
    // ‚úÖ Cargar festivos primero
    await cargarFestivos();

    const searchGrid = document.getElementById('searchGrid');
    const resultsContainer = document.getElementById('searchResults');

    // Pantalla de carga
    searchGrid.innerHTML = `
        <div style="background: #e3f2fd; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #2196f3;">
            <h3 style="margin: 0 0 10px 0; color: #1565c0;">üìä An√°lisis de OS Pendientes</h3>
            <p style="margin: 0; color: #666;">Cargando datos de todas las unidades...</p>
            <div class="loading" style="display: block; margin: 20px auto;"></div>
        </div>
    `;
    resultsContainer.innerHTML = '';

    try {
        // ‚úÖ USAR SOLO ESTO:
        const { data: osPendientes, count } = await fetchAllFromTable(
            'OS Pendientes',
            'OSATMO, Unidad, Tipo_de_OS, "Fecha Gen.", Dias_por_OS, Tipologia, Medidor, Estado_ATOMO, Estado_SAP, Comentario, Unicom, Direccion'
        );

        console.log(`‚úÖ Total cargado: ${osPendientes.length} de ${count} registros`);

        if (!osPendientes || osPendientes.length === 0) {
            searchGrid.innerHTML = '<div class="result-card">‚ö†Ô∏è No hay OS Pendientes registradas</div>';
            return;
        }

        // Procesar y agrupar datos
        const datosAgrupados = procesarOSPendientes(osPendientes);

        // Contar totales
        const totalReguladas = Object.values(datosAgrupados.reguladas)
            .reduce((sum, unidad) => {
                return sum + Object.values(unidad.porRango).flat().length;
            }, 0);

        const totalNoReguladas = Object.values(datosAgrupados.noReguladas)
            .reduce((sum, unidad) => {
                return sum + Object.values(unidad.porRango).flat().length;
            }, 0);

        // Obtener lista de unidades √∫nicas
        const unidadesUnicas = [...new Set(osPendientes.map(os => os.Unidad))].filter(u => u).sort();

        // Mostrar resumen con filtro
        searchGrid.innerHTML = `
            <div class="result-card" style="background: #f0f9ff; border: 2px solid #3b82f6;">
                <div class="result-header">‚úÖ An√°lisis completado</div>

                <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>üìä Resumen General:</strong><br>
                    ‚Ä¢ Total de OS: <strong>${osPendientes.length}</strong><br>
                    ‚Ä¢ OS Reguladas: <strong>${totalReguladas}</strong><br>
                    ‚Ä¢ OS No Reguladas: <strong>${totalNoReguladas}</strong><br>
                    ‚Ä¢ Unidades analizadas: <strong>${unidadesUnicas.length}</strong>
                </div>

                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #ffc107;">
                    <strong style="font-size: 16px; color: #2d3748;">üîç Filtrar por Unidad</strong>

                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: end; margin-top: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">
                                Buscar Unidad:
                            </label>
                            <input
                                type="text"
                                id="filtroUnidad"
                                list="listaUnidades"
                                placeholder="Escribe para buscar... (ej: CL-OPC-001)"
                                style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;"
                            >
                            <datalist id="listaUnidades">
                                ${unidadesUnicas.map(u => `<option value="${u}">`).join('')}
                            </datalist>
                            <small style="color: #666; display: block; margin-top: 5px;">
                                ${unidadesUnicas.length} unidades disponibles
                            </small>
                        </div>

                        <button class="btn btn-secondary" onclick="aplicarFiltroUnidad()" style="margin: 0;">
                            üîç Aplicar Filtro
                        </button>
                    </div>

                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn" onclick="limpiarFiltroUnidad()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); width: auto; padding: 10px 20px;">
                            üóëÔ∏è Limpiar Filtro
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Guardar datos procesados globalmente
        window.datosDetalleOS = datosAgrupados;
        window.datosDetalleOS_Original = JSON.parse(JSON.stringify(datosAgrupados));
        window.osPendientes_Original = osPendientes;

        // Generar y mostrar las tablas
        resultsContainer.innerHTML = `
            <div class="result-card" style="background: white; padding: 30px;">
        
        <h2 style="color: #ff9800; margin: 0 0 20px 0; font-size: 22px; border-bottom: 3px solid #ff9800; padding-bottom: 10px;">
            üìã TABLA 1: Tipolog√≠a de OS vs Rangos de D√≠as
        </h2>
        ${generarTablaTipologiaVsRango(osPendientes)}

        <h2 style="color: #26c6da; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #26c6da; padding-bottom: 10px;">
            üì° UNICOM - Por Condici√≥n
        </h2>
                ${generarTablaUnicomPorCondicion(osPendientes)}

                <h2 style="color: #00acc1; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #00acc1; padding-bottom: 10px;">
                    üì° UNICOM - Por Rango de D√≠as
                </h2>
                ${generarTablaUnicomPorRango(osPendientes)}

                <h2 style="color: #f44336; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #f44336; padding-bottom: 10px;">
                    üö´ TABLA 4: OS Bloqueadas por Rango de D√≠as
                </h2>
                ${generarTablaBloqueados(datosAgrupados)}

                <h2 style="color: #0097a7; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #0097a7; padding-bottom: 10px;">
                    üîÑ TABLA 3: Estado SAP vs Estado ATOMO
                </h2>
                ${generarTablaEstadoSapVsAtomo(datosAgrupados)}

                <h2 style="color: #00bcd4; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #00bcd4; padding-bottom: 10px;">
                    üìä TABLA 2: Estado ATOMO vs Rangos de D√≠as
                </h2>
                ${generarTablaEstadoAtomoPorRango(datosAgrupados)}

                <h2 style="color: #f093fb; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #f093fb; padding-bottom: 10px;">
                    ‚ö†Ô∏è REGULADAS - Por Condici√≥n
                </h2>
                ${generarTablaPorCondicion(datosAgrupados.reguladas, 'reguladas')}

                <h2 style="color: #667eea; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #667eea; padding-bottom: 10px;">
                    üìä REGULADAS - Por Rango de D√≠as
                </h2>
                ${generarTablaPorRango(datosAgrupados.reguladas, 'reguladas')}

                <h2 style="color: #f5576c; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #f5576c; padding-bottom: 10px;">
                    ‚ö†Ô∏è NO REGULADAS - Por Condici√≥n
                </h2>
                ${generarTablaPorCondicion(datosAgrupados.noReguladas, 'noReguladas')}

                <h2 style="color: #764ba2; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #764ba2; padding-bottom: 10px;">
                    üìä NO REGULADAS - Por Rango de D√≠as
                </h2>
                ${generarTablaPorRango(datosAgrupados.noReguladas, 'noReguladas')}
            </div>
        `;

    } catch (err) {
        console.error('Error cargando Detalle OS:', err);
        searchGrid.innerHTML = '<div class="result-card">‚ùå Error de conexi√≥n</div>';
    }
}


function generarTablaTipologiaVsRango(osFiltradas) {
    // 1. Definimos los rangos exactos que devuelve tu funci√≥n determinarRangoDias
    const rangos = ['0-5', '6-10', '11-15', '16-20', '21-30', '31-45', '46-180', '>180'];
    
    const matriz = {};
    const totalesVerticales = {};
    rangos.forEach(r => totalesVerticales[r] = 0);
    let granTotal = 0;
    
    osFiltradas.forEach(os => {
        const tipo = os.Tipologia || 'SIN CLASIFICAR';
        
        // 2. üî• USAMOS TU FUNCI√ìN ORIGINAL PARA CALCULAR EL RANGO EN TIEMPO REAL
        // Usamos os["Fecha Gen."] que es el campo que viene de la base de datos
        const rango = determinarRangoDias(os["Fecha Gen."]); 
        
        if (!matriz[tipo]) {
            matriz[tipo] = {};
            rangos.forEach(r => matriz[tipo][r] = 0);
            matriz[tipo].total = 0;
        }
        
        // Solo sumamos si el rango devuelto coincide con nuestros encabezados
        if (matriz[tipo][rango] !== undefined) {
            matriz[tipo][rango]++;
            matriz[tipo].total++;
            totalesVerticales[rango]++;
            granTotal++;
        }
    });

    // 3. Ordenar por total (Mayor a Menor)
    const tipologiasOrdenadas = Object.keys(matriz).sort((a, b) => matriz[b].total - matriz[a].total);

    let tablaHtml = `
        <div style="overflow-x: auto; margin-top: 15px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <thead>
                    <tr style="background: #444; color: white;">
                        <th style="padding: 10px; text-align: left; border: 1px solid #555;">Tipolog√≠a</th>
                        ${rangos.map(r => `<th style="padding: 10px; text-align: center; border: 1px solid #555;">${r}</th>`).join('')}
                        <th style="padding: 10px; text-align: center; border: 1px solid #555; background: #ff9800;">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
    `;

    tipologiasOrdenadas.forEach((tipo, index) => {
        const fondoFila = index % 2 === 0 ? '#ffffff' : '#f9f9f9';
        tablaHtml += `
            <tr style="background: ${fondoFila}; border-bottom: 1px solid #eee;">
                <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #333;">${tipo}</td>
                ${rangos.map(r => {
                    const v = matriz[tipo][r];
                    // Resaltar rangos cr√≠ticos (m√°s de 31 d√≠as) si tienen datos
                    const esCritico = (r === '31-45' || r === '46-180' || r === '>180') && v > 0;
                    const estiloCelda = esCritico ? 'background: #fff5f5; color: #c62828; font-weight: bold;' : (v > 0 ? 'font-weight: bold;' : 'color: #ccc;');
                    
                    return `<td style="padding: 8px; text-align: center; border: 1px solid #ddd; ${estiloCelda}">${v}</td>`;
                }).join('')}
                <td style="padding: 8px; text-align: center; border: 1px solid #ddd; background: #fff8e1; font-weight: 900; color: #000;">${matriz[tipo].total}</td>
            </tr>`;
    });

    tablaHtml += `
                <tr style="background: #eee; font-weight: bold;">
                    <td style="padding: 10px; border: 1px solid #ddd;">TOTALES POR RANGO</td>
                    ${rangos.map(r => `<td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${totalesVerticales[r]}</td>`).join('')}
                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; background: #ff9800; color: white;">${granTotal}</td>
                </tr>
                </tbody>
            </table>
        </div>
    `;
    return tablaHtml;
}


¬†	// ========================================
// üîç APLICAR FILTRO POR UNIDAD
// ========================================
// ========================================
// üîç APLICAR FILTRO POR UNIDAD (CORREGIDO)
// ========================================
function aplicarFiltroUnidad() {
    const unidadSeleccionada = document.getElementById('filtroUnidad').value.trim();

    if (!unidadSeleccionada) {
        alert('Por favor ingrese o seleccione una unidad');
        return;
    }

    // ‚úÖ Normalizamos la entrada del usuario para comparar (Quitar guiones)
    const unidadBusquedaLimpia = unidadSeleccionada.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();

    // 1. Obtener unidades √∫nicas de los datos originales
    const unidadesDisponibles = [...new Set(window.osPendientes_Original.map(os => (os.Unidad || "").toString()))];

    // ‚úÖ CORRECCI√ìN DE LA L√çNEA DEL ERROR:
    // Usamos .find() correctamente con una funci√≥n flecha y limpieza de guiones
    const unidadRealEncontrada = unidadesDisponibles.find(u => {
        const uLimpia = u.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
        return uLimpia === unidadBusquedaLimpia;
    });

    if (!unidadRealEncontrada) {
        alert(`La unidad "${unidadSeleccionada}" no existe en los datos`);
        return;
    }

    console.log(`üîç Filtrando por unidad real encontrada: ${unidadRealEncontrada}`);

    // 2. Filtrar datos estructurados (Usando la unidad real encontrada en la BD)
    const datosFiltrados = {
        reguladas: {},
        noReguladas: {}
    };

    ['reguladas', 'noReguladas'].forEach(tipo => {
        if (window.datosDetalleOS_Original[tipo][unidadRealEncontrada]) {
            datosFiltrados[tipo][unidadRealEncontrada] = window.datosDetalleOS_Original[tipo][unidadRealEncontrada];
        }
    });

    // 3. Filtrar array plano (Usando comparaci√≥n limpia para seguridad total)
    const osFiltradas = window.osPendientes_Original.filter(os => {
        const uOS = (os.Unidad || "").toString().replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
        return uOS === unidadBusquedaLimpia;
    });

    if (osFiltradas.length === 0) {
        alert(`No se encontraron OS para la unidad: ${unidadSeleccionada}`);
        return;
    }

    // 4. Actualizar datos globales y regenerar
    window.datosDetalleOS = datosFiltrados;
    regenerarTablasFiltradas(datosFiltrados, osFiltradas, unidadRealEncontrada);
}



¬†	// ========================================
// üîÑ REGENERAR TABLAS CON FILTRO
// ========================================
function regenerarTablasFiltradas(datosFiltrados, osFiltradas, unidad) {
    const resultsContainer = document.getElementById('searchResults');
    
    // Inicio del HTML con el cabezal del filtro
    let html = `
        <div class="result-card" style="background: #e8f5e9; border: 2px solid #4caf50;">
            <div class="result-header">‚úÖ Filtro aplicado: ${unidad}</div>
            <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <strong>üìä Resultados:</strong><br>
                ‚Ä¢ Total de OS de esta unidad: <strong>${osFiltradas.length}</strong>
            </div>
        </div>

        <div class="result-card" style="background: white; padding: 30px;">
    `;

    // üÜï 0. TABLA DE TIPOLOG√çA (Filtrada por Unidad y Ordenada de Mayor a Menor)
    html += `
        <h2 style="color: #ff9800; margin: 0 0 20px 0; font-size: 22px; border-bottom: 3px solid #ff9800; padding-bottom: 10px;">
            üìã TABLA: Tipolog√≠a de OS vs Rangos de D√≠as (${unidad})
        </h2>
        ${generarTablaTipologiaVsRango(osFiltradas)}`;

    // --- SEPARADOR ---
    html += `<hr style="margin: 40px 0; border: none; border-top: 1px solid #eee;">`;

    // 1. UNICOM por Condici√≥n
    const unicomCondicion = osFiltradas.filter(os => os.Unicom);
    if (unicomCondicion.length > 0) {
        html += `
            <h2 style="color: #26c6da; margin: 0 0 20px 0; font-size: 22px; border-bottom: 3px solid #26c6da; padding-bottom: 10px;">
                üì° UNICOM - Por Condici√≥n
            </h2>
            ${generarTablaUnicomPorCondicion(unicomCondicion)}`;
    }

    // 2. UNICOM por Rango
    if (unicomCondicion.length > 0) {
        html += `
            <h2 style="color: #00acc1; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #00acc1; padding-bottom: 10px;">
                üì° UNICOM - Por Rango de D√≠as
            </h2>
            ${generarTablaUnicomPorRango(unicomCondicion)}`;
    }

    // 3. Reguladas por Condici√≥n
    if (datosFiltrados.reguladas && Object.keys(datosFiltrados.reguladas).length > 0) {
        html += `
            <h2 style="color: #f093fb; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #f093fb; padding-bottom: 10px;">
                ‚ö†Ô∏è REGULADAS - Por Condici√≥n
            </h2>
            ${generarTablaPorCondicion(datosFiltrados.reguladas, 'reguladas')}`;
    }

    // 4. Reguladas por Rango
    if (datosFiltrados.reguladas && Object.keys(datosFiltrados.reguladas).length > 0) {
        html += `
            <h2 style="color: #667eea; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #667eea; padding-bottom: 10px;">
                üìä REGULADAS - Por Rango de D√≠as
            </h2>
            ${generarTablaPorRango(datosFiltrados.reguladas, 'reguladas')}`;
    }

    // 5. No Reguladas por Condici√≥n
    if (datosFiltrados.noReguladas && Object.keys(datosFiltrados.noReguladas).length > 0) {
        html += `
            <h2 style="color: #f5576c; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #f5576c; padding-bottom: 10px;">
                ‚ö†Ô∏è NO REGULADAS - Por Condici√≥n
            </h2>
            ${generarTablaPorCondicion(datosFiltrados.noReguladas, 'noReguladas')}`;
    }

    // 6. No Reguladas por Rango
    if (datosFiltrados.noReguladas && Object.keys(datosFiltrados.noReguladas).length > 0) {
        html += `
            <h2 style="color: #764ba2; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #764ba2; padding-bottom: 10px;">
                üìä NO REGULADAS - Por Rango de D√≠as
            </h2>
            ${generarTablaPorRango(datosFiltrados.noReguladas, 'noReguladas')}`;
    }

    // 7. Estado ATOMO vs Rangos
    html += `
        <h2 style="color: #00bcd4; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #00bcd4; padding-bottom: 10px;">
            üìä TABLA 2: Estado ATOMO vs Rangos de D√≠as
        </h2>
        ${generarTablaEstadoAtomoPorRango(datosFiltrados)}`;

    // 8. Estado SAP vs ATOMO
    html += `
        <h2 style="color: #0097a7; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #0097a7; padding-bottom: 10px;">
            üîÑ TABLA 3: Estado SAP vs Estado ATOMO
        </h2>
        ${generarTablaEstadoSapVsAtomo(datosFiltrados)}`;

    // 9. OS Bloqueadas (Tabla 4)
    html += `
        <h2 style="color: #f44336; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #f44336; padding-bottom: 10px;">
            üö´ TABLA 4: OS Bloqueadas por Rango de D√≠as
        </h2>
        ${generarTablaBloqueados(datosFiltrados)}`;

    // Fechamento do container principal
    html += `</div>`;

    // Renderiza√ß√£o final
    resultsContainer.innerHTML = html;

    console.log(`‚úÖ Tablas regeneradas exitosamente para unidad: ${unidad}`);
}

¬†	// ========================================
// üóëÔ∏è LIMPIAR FILTRO Y RESTAURAR TODAS LAS TABLAS
// ========================================
function limpiarFiltroUnidad() {
    console.log('üóëÔ∏è Limpiando filtro...');

    // 1. Limpiar el campo de texto del buscador
    const filtroInput = document.getElementById('filtroUnidad');
    if (filtroInput) filtroInput.value = '';

    // 2. Restaurar los datos desde la copia de seguridad global
    // Usamos JSON.parse para asegurar que recuperamos una copia limpia
    window.datosDetalleOS = JSON.parse(JSON.stringify(window.datosDetalleOS_Original));

    const osPendientes = window.osPendientes_Original;
    const datosAgrupados = window.datosDetalleOS;

    // 3. Recalcular los totales generales para la consola (opcional)
    const totalReguladas = Object.values(datosAgrupados.reguladas)
        .reduce((sum, unidad) => sum + Object.values(unidad.porRango).flat().length, 0);

    const totalNoReguladas = Object.values(datosAgrupados.noReguladas)
        .reduce((sum, unidad) => sum + Object.values(unidad.porRango).flat().length, 0);

    // 4. Regenerar todas las tablas con la vista completa
    const resultsContainer = document.getElementById('searchResults');

    resultsContainer.innerHTML = `
        <div class="result-card" style="background: white; padding: 30px;">
                
                <h2 style="color: #ff9800; margin: 0 0 20px 0; font-size: 22px; border-bottom: 3px solid #ff9800; padding-bottom: 10px;">
                    üìã RESUMEN INICIAL: Tipolog√≠a de OS vs Rangos de D√≠as
                </h2>
                ${generarTablaTipologiaVsRango(osPendientes)}

                <h2 style="color: #26c6da; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #26c6da; padding-bottom: 10px;">
                    üì° UNICOM - Por Condici√≥n
                </h2>
            ${generarTablaUnicomPorCondicion(osPendientes)}

            <h2 style="color: #00acc1; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #00acc1; padding-bottom: 10px;">
                üì° UNICOM - Por Rango de D√≠as
            </h2>
            ${generarTablaUnicomPorRango(osPendientes)}

            <h2 style="color: #f44336; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #f44336; padding-bottom: 10px;">
                üö´ TABLA 4: OS Bloqueadas por Rango de D√≠as
            </h2>
            ${generarTablaBloqueados(datosAgrupados)}

            <h2 style="color: #0097a7; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #0097a7; padding-bottom: 10px;">
                üîÑ TABLA 3: Estado SAP vs Estado ATOMO
            </h2>
            ${generarTablaEstadoSapVsAtomo(datosAgrupados)}

            <h2 style="color: #00bcd4; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #00bcd4; padding-bottom: 10px;">
                üìä TABLA 2: Estado ATOMO vs Rangos de D√≠as
            </h2>
            ${generarTablaEstadoAtomoPorRango(datosAgrupados)}

            <h2 style="color: #f093fb; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #f093fb; padding-bottom: 10px;">
                ‚ö†Ô∏è REGULADAS - Por Condici√≥n
            </h2>
            ${generarTablaPorCondicion(datosAgrupados.reguladas, 'reguladas')}

            <h2 style="color: #667eea; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #667eea; padding-bottom: 10px;">
                üìä REGULADAS - Por Rango de D√≠as
            </h2>
            ${generarTablaPorRango(datosAgrupados.reguladas, 'reguladas')}

            <h2 style="color: #f5576c; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #f5576c; padding-bottom: 10px;">
                ‚ö†Ô∏è NO REGULADAS - Por Condici√≥n
            </h2>
            ${generarTablaPorCondicion(datosAgrupados.noReguladas, 'noReguladas')}

            <h2 style="color: #764ba2; margin: 40px 0 20px 0; font-size: 22px; border-bottom: 3px solid #764ba2; padding-bottom: 10px;">
                üìä NO REGULADAS - Por Rango de D√≠as
            </h2>
            ${generarTablaPorRango(datosAgrupados.noReguladas, 'noReguladas')}

        </div>
    `;

    console.log('‚úÖ Filtro limpiado - Mostrando todas las unidades');
    // Peque√±a notificaci√≥n visual
    mostrarNotificacion('‚úÖ Filtro eliminado - Vista completa restaurada');
}


¬†	// ========================================
// üì¶ CARGAR INTERFAZ IPR (CORREGIDA)
// ========================================
async function cargarInterfazIPR() {
    const searchGrid = document.getElementById('searchGrid');
    const resultsContainer = document.getElementById('searchResults');

    await limpiarRegistrosViejosIPR();

    const causasRetiro = [
        'Medidor con humedad/agua interna', 'Cambio de CAB a CAT', 'Casos por solicitud/ Campa√±a (SIGET)',
        'Codigo de error', 'Irregularidad en el medidor', 'Medidor con dificultades de lectura',
        'Medidor quebrado', 'Medidor quemado', 'Medidor con partes oxidadas', 'Medidor destruido',
        'Fuera de limites de exactitud', 'Medidor con insectos/animales/partes de animales',
        'Retiro/levantamiento de medidor', 'Provisionales/Abandonados', 'Testigos/En serie',
        'Retiro por cambio de tecnolog√≠a', 'Retiro por proyecto Subterraneo',
        'Retiro de medidor con desperfecto identificado', 'Retiro de medidor por disposicion de seguridad',
        'Por solicitud del cliente', 'Medidor incompatible/inadecuado con el servicio',
        'Cambio a sistema blindado', 'MD parado no registra consumo', 'MD con pantalla apagada',
        'MD con digitos borrosos', 'MD Da√±ado', 'MD con agua interna', 'MEDIDOR FUERA DE ESTANDAR',
        'MD con pintura en pantalla', 'MD con pantalla amarilla', 'MD con borneras sobadas',
        'MD Desprogramado', 'MD con bornera derretida'
    ];

    searchGrid.innerHTML = `
        <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50; margin-bottom: 20px;">
            <h3 style="margin: 0 0 5px 0; color: #2e7d32;">üì¶ Registro de Retiro de Medidores</h3>
            <p style="margin: 0; color: #666; font-size: 0.9rem;">Busque el medidor para autocompletar la informaci√≥n t√©cnica.</p>
        </div>

        <div class="search-group" style="background: white; margin-bottom: 20px;">
            <label style="font-weight: 700;">‚ö° Medidor a Retirar:</label>
            <div style="display: flex; gap: 10px; width: 100%;">
                <input type="text" id="ipr_medidor" placeholder="Ingrese n√∫mero de medidor" style="flex: 1;">
                <button class="btn btn-secondary" onclick="buscarDatosMedidorIPR()" style="width: auto; margin-top:0;">üîç Buscar</button>
            </div>
        </div>

        <div id="datosAutocompletar" style="display: none; animation: slideUp 0.3s ease-out;">
            
            <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
                <strong style="color: #1565c0;">‚úÖ Informaci√≥n T√©cnica Hallada</strong>
            </div>

            <div class="search-grid" style="margin-bottom: 20px;">
                <div class="search-group">
                    <label>üè¢ Unidad:</label>
                    <input type="text" id="ipr_unidad" readonly class="input-readonly">
                </div>
                <div class="search-group">
                    <label>üìÑ NIC (Cuenta):</label>
                    <input type="text" id="ipr_nic" readonly class="input-readonly">
                </div>
                <div class="search-group">
                    <label>üìã Forma:</label>
                    <input type="text" id="ipr_forma" readonly class="input-readonly">
                </div>
                <div class="search-group">
                    <label>‚ö° Voltaje:</label>
                    <input type="text" id="ipr_voltaje" readonly class="input-readonly">
                </div>
                <div class="search-group full-width">
                    <label>üè∑Ô∏è Marca y Tipo:</label>
                    <input type="text" id="ipr_marca" readonly class="input-readonly">
                </div>
            </div>

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #e2e8f0;">

            <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                <strong style="color: #e65100;">üìù Datos de la Orden</strong>
            </div>

            <div class="search-grid">
                <div class="search-group">
                    <label>üìë NUM. O/S: <span style="color: #d32f2f;">*</span></label>
                    <input type="text" id="ipr_numos" placeholder="Ej: 80001234">
                </div>
                <div class="search-group">
                    <label>‚ö†Ô∏è Causa de Retiro: <span style="color: #d32f2f;">*</span></label>
                    <select id="ipr_causa">
                        <option value="">-- Seleccione --</option>
                        ${causasRetiro.map(causa => `<option value="${causa}">${causa}</option>`).join('')}
                    </select>
                </div>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                <button class="btn" onclick="guardarRegistroIPR()" style="max-width: 300px; background: linear-gradient(135deg, #4caf50, #2e7d32);">
                    üíæ Guardar Registro en Sistema
                </button>
            </div>
        </div>
    `;

    cargarRegistrosIPR();
}

¬†


¬†	// ========================================
// üì§ CARGAR INTERFAZ DE ASIGNACIONES (EXCEL/CSV)
// ========================================
async function cargarInterfazAsignaciones() {
    const searchGrid = document.getElementById('searchGrid');
    const resultsContainer = document.getElementById('searchResults');
    
    // ‚úÖ Validaci√≥n de Seguridad por Rol
    const rolesPermitidos = ['Administrador', 'Despacho'];
    if (!rolesPermitidos.includes(currentUser.rol)) {
        searchGrid.innerHTML = `
            <div class="result-card" style="border-left: 5px solid #f44336;">
                ‚ö†Ô∏è <strong>Acceso Denegado:</strong> Solo Administradores y personal de Despacho pueden cargar nuevas asignaciones.
            </div>`;
        return;
    }

    searchGrid.innerHTML = `
        <div class="result-card" style="background: #e3f2fd; border: 2px solid #2196f3;">
            <div class="result-header">üì§ Cargar Asignaciones de OS</div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin: 15px 0;">
                <strong>üìã Formato requerido del archivo:</strong><br>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    ‚Ä¢ <strong>Columna A:</strong> OSATOMO (N√∫mero de la orden)<br>
                    ‚Ä¢ <strong>Columna B:</strong> Unidad (ej: CL-OPC-001)<br>
                    ‚Ä¢ <strong>Columna C:</strong> Estado (ej: Asignada)<br><br>
                    ‚ö†Ô∏è <strong>AVISO:</strong> Al procesar, se validar√°n las OS contra la base de datos de Pendientes.
                </div>
            </div>

            <div class="form-group">
                <label style="font-weight: 600; display: block; margin-bottom: 10px;">üìÅ Seleccionar archivo (Excel o CSV):</label>
                <input type="file" id="archivoAsignaciones" accept=".xlsx,.xls,.csv"
                       style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: white;">
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="procesarArchivoAsignaciones()"
                        style="font-size: 18px; padding: 18px 40px; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); border: none; width: 100%;">
                    ‚ö° Procesar y Validar Archivo
                </button>
            </div>
        </div>
    `;

    resultsContainer.innerHTML = '';
}

async function procesarArchivoAsignaciones() {
    const archivoInput = document.getElementById('archivoAsignaciones');

    if (!archivoInput.files || archivoInput.files.length === 0) {
        alert('‚ö†Ô∏è Por favor, selecciona un archivo antes de continuar.');
        return;
    }

    const archivo = archivoInput.files[0];
    const extension = archivo.name.split('.').pop().toLowerCase();

    if (!['xlsx', 'xls', 'csv'].includes(extension)) {
        alert('‚ö†Ô∏è Formato no v√°lido. Por favor usa archivos .xlsx, .xls o .csv');
        return;
    }

    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = `
        <div class="result-card" style="text-align: center; padding: 40px;">
            <div class="loading" style="display: block; margin: 0 auto 20px auto;"></div>
            <h3 style="color: #1565c0;">Leyendo contenido del archivo...</h3>
            <p>Analizando filas y columnas para procesamiento directo.</p>
        </div>`;

    try {
        // 1Ô∏è‚É£ LEER ARCHIVO
        const datos = await leerArchivoAsignaciones(archivo, extension);

        if (!datos || datos.length === 0) {
            alert('‚ùå El archivo seleccionado parece estar vac√≠o.');
            resultsContainer.innerHTML = '';
            return;
        }

        // 2Ô∏è‚É£ VALIDAR ESTRUCTURA
        if (typeof validarEstructuraAsignaciones === 'function') {
            const validacion = validarEstructuraAsignaciones(datos);
            if (!validacion.valido) {
                alert(`‚ùå Error en la estructura del archivo:\n\n${validacion.mensaje}`);
                return;
            }
        }

        // üéØ CAMBIO CLAVE: YA NO VALIDAMOS CONTRA BD PARA FILTRAR
        // En su lugar, preparamos un objeto de "Simulaci√≥n de Validaci√≥n Positiva" 
        // para que la vista previa (Preview) muestre todo como v√°lido.
        
        const validacionTodoOk = {
            validas: datos,         // Todas las √≥rdenes pasan como v√°lidas
            invalidas: [],          // Cero inv√°lidas
            duplicadas: [],         // (Opcional: podr√≠as validar duplicados en el mismo Excel aqu√≠)
            totalArchivo: datos.length
        };

        // 3Ô∏è‚É£ AVISO DE PROCESAMIENTO
        resultsContainer.innerHTML = `
            <div class="result-card" style="text-align: center; padding: 40px;">
                <h3 style="color: #4caf50;">‚úÖ Archivo analizado correctamente</h3>
                <p style="color: #666;">Se han detectado ${datos.length} registros listos para asignar.</p>
            </div>`;

        // 4Ô∏è‚É£ MOSTRAR VISTA PREVIA (Ahora con todos los datos)
        if (typeof mostrarPreviewAsignaciones === 'function') {
            // Pasamos 'datos' como las √≥rdenes v√°lidas y nuestro objeto simulado
            mostrarPreviewAsignaciones(datos, validacionTodoOk);
        }

    } catch (err) {
        console.error('Error cr√≠tico procesando archivo:', err);
        alert('‚ùå Ocurri√≥ un error inesperado al procesar el archivo.');
        resultsContainer.innerHTML = '';
    }
}


// ========================================
// üìñ LECTOR DE ARCHIVOS (XLSX / CSV)
// ========================================
async function leerArchivoAsignaciones(archivo, extension) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                let datos = [];

                if (extension === 'csv') {
                    const texto = e.target.result;
                    // Dividir por l√≠neas y filtrar vac√≠as
                    const lineas = texto.split(/\r?\n/).filter(l => l.trim());
                    
                    // Saltar encabezado (i=1) y procesar
                    for (let i = 1; i < lineas.length; i++) {
                        const valores = lineas[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                        if (valores.length >= 2 && valores[0]) {
                            datos.push(valores);
                        }
                    }
                } else {
                    // Procesamiento de Excel (XLSX/XLS)
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convertir a matriz de arreglos (header: 1 devuelve arreglos simples)
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Filtrar: saltar encabezado y asegurar que la primera columna tenga datos
                    datos = jsonData.slice(1).filter(row => 
                        row && row.length >= 1 && row[0] !== undefined && row[0].toString().trim() !== ''
                    );
                }

                console.log(`‚úÖ Lectura exitosa: ${datos.length} registros encontrados.`);
                resolve(datos);

            } catch (error) {
                console.error("Error en lectura interna:", error);
                reject(new Error('No se pudo interpretar el contenido del archivo.'));
            }
        };

        reader.onerror = () => reject(new Error('Error de lectura del sistema de archivos.'));

        if (extension === 'csv') {
            reader.readAsText(archivo);
        } else {
            reader.readAsArrayBuffer(archivo);
        }
    });
}

// ========================================
// 1Ô∏è‚É£ FUNCI√ìN MAESTRA: Obtener objeto Date de El Salvador
// ========================================
function getFechaElSalvador() {
¬†   // Usamos el locale para obtener un string exacto de la zona horaria y convertirlo en objeto
¬†   const ahora = new Date();
¬†   const strFecha = ahora.toLocaleString("en-US", { timeZone: "America/El_Salvador" });
¬†   return new Date(strFecha);
}

// ========================================
// 2Ô∏è‚É£ FUNCI√ìN: Formatear fecha simple (YYYY-MM-DD)
// ========================================
function formatearFechaElSalvador(fecha) {
¬†   return new Intl.DateTimeFormat('en-CA', {
¬†       timeZone: 'America/El_Salvador',
¬†       year: 'numeric',
¬†       month: '2-digit',
¬†       day: '2-digit'
¬†   }).format(fecha);
}

// ========================================
// 3Ô∏è‚É£ FUNCI√ìN: Formatear fecha completa (YYYY-MM-DDTHH:mm:ss)
// ========================================
function formatearFechaCompletaElSalvador(fecha) {
¬†   const opciones = {
¬†       timeZone: 'America/El_Salvador',
¬†       year: 'numeric', month: '2-digit', day: '2-digit',
¬†       hour: '2-digit', minute: '2-digit', second: '2-digit',
¬†       hour12: false
¬†   };
¬†   const f = new Intl.DateTimeFormat('en-CA', opciones).formatToParts(fecha);
¬†   const p = {};
¬†   f.forEach(({type, value}) => p[type] = value);
¬†   return `${p.year}-${p.month}-${p.day}T${p.hour}:${p.minute}:${p.second}`;
}

// ========================================
// 4Ô∏è‚É£ FUNCI√ìN: Obtener solo el String de HOY (YYYY-MM-DD)
// ========================================
function getFechaHoyElSalvador() {
¬†   try {
¬†       const hoy = formatearFechaElSalvador(new Date());
¬†       console.log('üïí Sincronizaci√≥n SV:', hoy);
¬†       return hoy;
¬†   } catch (error) {
¬†       console.error("‚ùå Error en getFechaHoyElSalvador:", error);
¬†       return new Date().toLocaleDateString('en-CA', { timeZone: 'America/El_Salvador' });
¬†   }
}


// ========================================
// üÜï FUNCI√ìN: Obtener Fecha Local en Formato ISO (YYYY-MM-DD)
// ========================================
function getFechaLocalISO(fecha) {
    if (!fecha) return getFechaHoyElSalvador();
    
    const opciones = {
        timeZone: 'America/El_Salvador',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    };
    
    const f = new Intl.DateTimeFormat('en-CA', opciones).formatToParts(fecha);
    const p = {};
    f.forEach(({type, value}) => p[type] = value);
    
    return `${p.year}-${p.month}-${p.day}`;
}


// ========================================
// 5Ô∏è‚É£ FUNCI√ìN: Obtener HORA ACTUAL detallada
// ========================================
function getHoraActualElSalvador() {
¬†   const fechaSV = getFechaElSalvador();
¬†   return {
¬†       hora: fechaSV.getHours(),
¬†       minuto: fechaSV.getMinutes(),
¬†       segundo: fechaSV.getSeconds()
¬†   };
}

// ========================================
// 6Ô∏è‚É£ FUNCI√ìN: Verificaci√≥n en Consola
// ========================================
function verificarZonaHoraria() {
¬†   const fechaUTC = new Date();
¬†   const fechaSV = getFechaElSalvador();
¬†
¬†   console.log('=== VERIFICACI√ìN DE ZONA HORARIA ===');
¬†   console.log('Fecha UTC:', fechaUTC.toISOString());
¬†   console.log('Fecha El Salvador:', formatearFechaCompletaElSalvador(new Date()));
¬†   console.log('Diferencia: Forzada a America/El_Salvador (UTC-6)');
¬†   console.log('=====================================');
}

// Ejecuci√≥n inmediata para validar
verificarZonaHoraria();


¬†	function validarEstructuraAsignaciones(datos) {
¬† // Validar que todas las filas tengan 3 columnas
¬† for (let i = 0; i < datos.length; i++) {
¬†   const fila = datos[i];
¬†   if (fila.length < 3) {
¬†     return {
¬†       valido: false,
¬†       mensaje: `Fila ${i + 2}: Se esperan 3 columnas (OSATOMO, Unidad, Estado), solo se encontraron ${fila.length}`
¬†     };
¬†   }
¬†   // Validar que OSATOMO no est√© vac√≠o
¬†   if (!fila[0] || fila[0].toString().trim() === '') {
¬†     return {
¬†       valido: false,
¬†       mensaje: `Fila ${i + 2}: OSATOMO est√° vac√≠o`
¬†     };
¬†   }
¬†   // Validar que Unidad no est√© vac√≠a
¬†   if (!fila[1] || fila[1].toString().trim() === '') {
¬†     return {
¬†       valido: false,
¬†       mensaje: `Fila ${i + 2}: Unidad est√° vac√≠a`
¬†     };
¬†   }

¬†   const unidad = fila[1].toString().trim();

¬†   // ‚úÖ EXCEPCI√ìN ESPECIAL: CL-EYB-PAC-01 a CL-EYB-PAC-07 (1 o 2 d√≠gitos)
¬†   const esExcepcionEYB = /^CL-EYB-PAC-0?[1-7]$/i.test(unidad);

¬†   // ‚úÖ FORMATO GENERAL MEJORADO:
¬†   // - CL-XXX-NNN          ‚Üí Ej: CL-OPC-001
¬†   // - CL-XXX-PAC-NNN      ‚Üí Ej: CL-OPC-PAC-001
¬†   // - CL-XXX-YYY-NNN      ‚Üí Ej: CL-SEM-NTE-001 (ahora permitido)
¬†   //   Donde NNN puede ser 1, 2 o 3 d√≠gitos (01, 5, 123, etc.)
¬†   const formatoGeneral = /^CL-[A-Z]{3}(?:-[A-Z]{3})?-(?:PAC-)?[0-9]{1,3}$/i.test(unidad);

¬†   if (!esExcepcionEYB && !formatoGeneral) {
¬†     return {
¬†       valido: false,
¬†       mensaje: `Fila ${i + 2}: Unidad "${unidad}" no tiene formato v√°lido.\\n\\nFormatos aceptados:\\n‚Ä¢ CL-XXX-NNN (ej: CL-OPC-001)\\n‚Ä¢ CL-XXX-PAC-NNN (ej: CL-OPC-PAC-001)\\n‚Ä¢ CL-XXX-YYY-NNN (ej: CL-SEM-NTE-001)\\n‚Ä¢ CL-EYB-PAC-01 a CL-EYB-PAC-07`
¬†     };
¬†   }
¬† }
¬† return { valido: true };
}




¬†	function detectarDuplicadosAsignaciones(datos) {
¬†   const mapa = new Map();
¬†   const duplicados = [];
¬†
¬†   datos.forEach((fila, idx) => {
¬†       const osatomo = fila[0].toString().trim();
¬†
¬†       if (mapa.has(osatomo)) {
¬†           // OS ya existe en el archivo
¬†           const primeraAparicion = mapa.get(osatomo);
¬†           duplicados.push({
¬†               osatomo: osatomo,
¬†               fila1: primeraAparicion.fila,
¬†               unidad1: primeraAparicion.unidad,
¬†               fila2: idx + 2, // +2 por header y √≠ndice base 0
¬†               unidad2: fila[1].toString().trim()
¬†           });
¬†       } else {
¬†           mapa.set(osatomo, {
¬†               fila: idx + 2,
¬†               unidad: fila[1].toString().trim()
¬†           });
¬†       }
¬†   });
¬†
¬†   return duplicados;
}


¬†	async function resolverDuplicados(duplicados) {
¬†   let mensaje = `‚ö†Ô∏è SE ENCONTRARON ${duplicados.length} OS DUPLICADAS\\n\\n`;
¬†   mensaje += 'Estas OS est√°n asignadas a 2 unidades diferentes:\n\n';
¬†
¬†   duplicados.slice(0, 5).forEach(dup => {
¬†       mensaje += `üìã OS: ${dup.osatomo}\\n`;
¬†       mensaje += `   Fila ${dup.fila1}: ${dup.unidad1}\\n`;
¬†       mensaje += `   Fila ${dup.fila2}: ${dup.unidad2}\\n\\n`;
¬†   });
¬†
¬†   if (duplicados.length > 5) {
¬†       mensaje += `... y ${duplicados.length - 5} m√°s\\n\\n`;
¬†   }
¬†
¬†   mensaje += '‚ùå SOLUCI√ìN: Corrija el archivo antes de continuar\n';
¬†   mensaje += 'Cada OS debe estar asignada a UNA sola unidad';
¬†
¬†   alert(mensaje);
¬†   return false;
}


¬†	async function validarOSEnBD(datos) {
¬†   const osNumeros = datos.map(fila => fila[0].toString().trim());
¬†   const BATCH_SIZE = 500;
¬†
¬†   const osExistentes = [];
¬†   const osNoExistentes = [];
¬†
¬†   console.log(`üîç Validando ${osNumeros.length} OS contra OS Pendientes...`);
¬†
¬†   for (let i = 0; i < osNumeros.length; i += BATCH_SIZE) {
¬†       const batch = osNumeros.slice(i, i + BATCH_SIZE);
¬†
¬†       const { data, error } = await supabaseClient
¬†           .from('OS Pendientes')
¬†           .select('OSATMO')
¬†           .in('OSATMO', batch);
¬†
¬†       if (error) {
¬†           console.error('Error en batch:', error);
¬†           continue;
¬†       }
¬†
¬†       const encontrados = new Set(data.map(os => os.OSATMO));
¬†
¬†       batch.forEach(os => {
¬†           if (encontrados.has(os)) {
¬†               osExistentes.push(os);
¬†           } else {
¬†               osNoExistentes.push(os);
¬†           }
¬†       });
¬†
¬†       console.log(`‚úÖ Validados ${Math.min(i + BATCH_SIZE, osNumeros.length)} / ${osNumeros.length}`);
¬†   }
¬†
¬†   return {
¬†       existentes: osExistentes,
¬†       noExistentes: osNoExistentes
¬†   };
}


¬†	function mostrarPreviewAsignaciones(datos, validacionBD, duplicados) {
    const resultsContainer = document.getElementById('searchResults');
    
    // üõ°Ô∏è ESCUDO 1: Asegurar que los datos sean v√°lidos
    const listaDatos = datos || [];
    const dups = duplicados || [];
    
    // üéØ CAMBIO CLAVE: Ya no filtramos por "existeEnBD". 
    // Solo filtramos filas vac√≠as para que pasen las 395 √≥rdenes.
    const registrosValidos = listaDatos.filter(fila => {
        return fila && fila[0] && fila[0].toString().trim() !== ""; 
    });

    // üé® Generaci√≥n de Interfaz
    let html = `
        <div class="result-card" style="background: #e8f5e9; border: 2px solid #4caf50;">
            <div class="result-header" style="display: flex; align-items: center; gap: 10px;">
                ‚úÖ <span>Validaci√≥n de Carga completada</span>
            </div>

            <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid #e2e8f0;">
                <strong style="font-size: 18px; color: #1e293b; display: block; margin-bottom: 15px;">üìä Resumen de Validaci√≥n:</strong>
                <div style="font-size: 15px; display: grid; gap: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>üìÑ Total de filas en archivo:</span>
                        <strong>${listaDatos.length}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; color: #166534; background: #f0fdf4; padding: 5px 8px; border-radius: 4px;">
                        <span>‚úÖ OS para procesar (Nuevas y Existentes):</span>
                        <strong>${registrosValidos.length}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; color: #64748b;">
                        <span>‚ÑπÔ∏è Estado:</span>
                        <strong>Listo para asignar todo</strong>
                    </div>
                </div>
            </div>`;

    // Botones de acci√≥n
    if (registrosValidos.length > 0) {
        // Limpiamos los datos para el onclick
        const datosLimpios = registrosValidos.map(r => r.map(celda => (celda ? celda.toString().trim() : "")));
        
        html += `
            <div style="background: #eff6ff; padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid #bfdbfe; text-align: center;">
                <strong style="color: #1e40af; font-size: 16px;">üöÄ PROCESAMIENTO MASIVO</strong>
                <p style="margin: 10px 0; color: #64748b; font-size: 14px;">
                    Se asignar√°n <strong style="color: #22c55e;">${registrosValidos.length}</strong> √≥rdenes. Las que no existan se crear√°n autom√°ticamente.
                </p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                    <button class="btn" onclick="confirmarCargaAsignaciones(${JSON.stringify(datosLimpios).replace(/"/g, '&quot;')})"
                            style="background: #22c55e; color: white; padding: 15px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer;">
                        ‚úÖ Confirmar y Cargar
                    </button>
                    <button class="btn" onclick="cargarInterfazAsignaciones()" 
                            style="background: #64748b; color: white; padding: 15px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer;">
                        ‚úï Cancelar
                    </button>
                </div>
            </div>`;
    } else {
        html += `
            <div style="text-align: center; margin-top: 20px;">
                <p style="color: #ef4444; margin-bottom: 10px;">El archivo no contiene registros v√°lidos.</p>
                <button class="btn" onclick="cargarInterfazAsignaciones()" style="background: #3b82f6; color: white; padding: 12px 25px; border-radius: 8px; border: none; cursor: pointer;">
                    ‚Üê Reintentar
                </button>
            </div>`;
    }

    html += `</div>`;
    resultsContainer.innerHTML = html;
}



¬†	async function confirmarCargaAsignaciones(registrosValidos) {
    const resultsContainer = document.getElementById('searchResults');
    
    // üõ°Ô∏è Validaci√≥n inicial para evitar que registrosValidos sea nulo
    if (!registrosValidos || registrosValidos.length === 0) {
        alert("‚ùå No hay registros v√°lidos para procesar.");
        return;
    }

    resultsContainer.innerHTML = `
        <div class="result-card" style="text-align: center; padding: 30px;">
            <div class="loading" style="display: block; margin: 20px auto;"></div>
            <h3 style="color: #1565c0;">Iniciando proceso de actualizaci√≥n...</h3>
            <p style="color: #666;">Preparando base de datos</p>
        </div>`;

    try {
        // 1Ô∏è‚É£ OBTENER FECHA ACTUAL DE EL SALVADOR
        const opciones = { timeZone: 'America/El_Salvador', hour12: false };
        const fechaSV = new Date(new Date().toLocaleString('en-US', opciones)).toISOString();

        // 2Ô∏è‚É£ ELIMINAR TODO DE os_asignadas
        // Usamos un filtro que siempre sea cierto para limpiar la tabla
        const { error: errorDelete } = await supabaseClient
            .from('os_asignadas')
            .delete()
            .neq('osatomo', '0'); 

        if (errorDelete) {
            throw new Error('Error al limpiar tabla: ' + errorDelete.message);
        }

        console.log('‚úÖ Tabla os_asignadas limpiada');

        // 3Ô∏è‚É£ INSERTAR NUEVAS ASIGNACIONES (por lotes)
const BATCH_SIZE = 500;
let insertados = 0;

for (let i = 0; i < registrosValidos.length; i += BATCH_SIZE) {
    const batch = registrosValidos.slice(i, i + BATCH_SIZE);
    
    // Actualizar UI del progreso
    resultsContainer.innerHTML = `
        <div class="result-card" style="text-align: center; padding: 30px;">
            <div class="loading" style="display: block; margin: 20px auto;"></div>
            <h3 style="color: #1565c0;">Insertando datos en la nube...</h3>
            <div style="font-size: 24px; font-weight: bold; color: #2e7d32; margin: 10px 0;">
                ${insertados} / ${registrosValidos.length}
            </div>
            <p style="color: #666;">Procesando bloque de datos. Por favor, no cierre esta ventana.</p>
        </div>`;

    // üéØ MEJORA 1: Mapeo ultra-robusto
    const registros = batch.map(fila => {
        const os = fila[0] ? fila[0].toString().trim() : '';
        const unidad = fila[1] ? fila[1].toString().trim() : 'SIN_UNIDAD';
        const estado = fila[2] ? fila[2].toString().trim() : 'Asignada';

        return {
            osatomo: os,
            Unidad: unidad,
            Estado: estado,
            fecha_asignacion: fechaSV, 
            usuario_asigno: currentUser ? currentUser.usuario : 'Admin_Sistema'
        };
    }).filter(r => r.osatomo && r.osatomo !== '' && r.osatomo.toLowerCase() !== 'undefined');

    // üéØ MEJORA 2: Usar .insert() simple
    // Quitamos .upsert() y el onConflict porque tu tabla no tiene llave primaria √∫nica en osatomo
    // Como borraste todo antes, el .insert() es seguro y no fallar√°.
    const { error } = await supabaseClient
        .from('os_asignadas')
        .insert(registros); 

    if (error) {
        console.error('‚ùå Error en batch:', error);
        // üéØ MEJORA 3: Detalle de error m√°s claro para diagn√≥stico
        throw new Error(`Error en bloque ${i}-${i + BATCH_SIZE}: ${error.message}`);
    }

    insertados += registros.length;
}

        // 4Ô∏è‚É£ √âXITO FINAL
        resultsContainer.innerHTML = `
            <div class="result-card" style="background: #f0fdf4; border: 2px solid #22c55e; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 60px; margin-bottom: 15px;">üöÄ</div>
                    <h2 style="color: #166534; margin: 0 0 10px 0;">¬°Actualizaci√≥n Exitosa!</h2>
                    <p style="color: #374151; font-size: 16px; margin-bottom: 20px;">
                        Se han procesado <strong>${insertados}</strong> registros correctamente en El Salvador.
                    </p>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #dcfce7; margin-bottom: 25px; text-align: left;">
                        <small style="color: #6b7280; display: block; margin-bottom: 5px;">Detalles de la operaci√≥n:</small>
                        <div style="display: flex; justify-content: space-between; font-size: 14px;">
                            <span>üïí Hora SV:</span> <strong>${new Date(fechaSV).toLocaleString()}</strong>
                        </div>
                    </div>

                    <button class="btn" onclick="cargarInterfazAsignaciones()" 
                            style="background: #166534; color: white; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; border: none; cursor: pointer;">
                        Entendido
                    </button>
                </div>
            </div>`;

    } catch (err) {
        console.error('‚ùå Error cr√≠tico en carga:', err);
        resultsContainer.innerHTML = `
            <div class="result-card" style="background: #fef2f2; border: 2px solid #ef4444; padding: 30px; text-align: center;">
                <div style="font-size: 50px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <h3 style="color: #991b1b;">Error en la carga masiva</h3>
                <p style="color: #b91c1c; margin-bottom: 20px;">${err.message}</p>
                <button class="btn" onclick="cargarInterfazAsignaciones()" style="background: #991b1b; color: white; padding: 10px 20px; border-radius: 8px; border: none;">
                    Intentar de nuevo
                </button>
            </div>`;
    }
}

¬†


¬†	// ========================================
// üó∫Ô∏è CARGAR INTERFAZ MAPA DE RUTAS (OPTIMIZADA)
// ========================================
async function cargarInterfazMapaRutas() {
    const searchGrid = document.getElementById('searchGrid');
    const resultsContainer = document.getElementById('searchResults');
 
    searchGrid.innerHTML = '<div class="loading" style="display: block; margin: 20px auto;"></div>';
    resultsContainer.innerHTML = '';
 
    try {
        // 1Ô∏è‚É£ CARGAR FILTROS ACTUALES (Sincronizado por Usuario/Global)
        let filtrosQuery;
        if (currentUser.rol === 'Despacho' || currentUser.rol === 'Contratista') {
            filtrosQuery = supabaseClient
                .from('filtros_mapa')
                .select('*')
                .eq('usuario', currentUser.usuario)
                .maybeSingle(); // Usamos maybeSingle para evitar error si no tiene filtros a√∫n
        } else {
            filtrosQuery = supabaseClient
                .from('filtros_mapa')
                .select('*')
                .is('usuario', null)
                .maybeSingle();
        }

        const { data: filtros, error: errorFiltros } = await filtrosQuery;
 
        // 2Ô∏è‚É£ CARGAR TIPOLOG√çAS
        const tipologiasUnicas = await cargarTipologias();
 
        // 3Ô∏è‚É£ CARGAR UNIDADES (Para el selector de Admin)
        const unidadesUnicas = [];
        let offset = 0;
        const BATCH_SIZE = 1000;

        while (true) {
            const { data, error } = await supabaseClient
                .from('os_asignadas')
                .select('Unidad')
                .range(offset, offset + BATCH_SIZE - 1);
 
            if (error) break;
            if (!data || data.length === 0) break;
 
            data.forEach(row => {
                if (row.Unidad && !unidadesUnicas.includes(row.Unidad)) {
                    unidadesUnicas.push(row.Unidad);
                }
            });
            if (data.length < BATCH_SIZE) break;
            offset += BATCH_SIZE;
        }
        unidadesUnicas.sort();

        // 4Ô∏è‚É£ CARGAR OS ASIGNADAS (Espec√≠fico para Contratista/Lectura/Poda)
        let osAsignadas = [];
        const rolesRestringidos = ['Contratista', 'Lectura', 'Poda', 'Consulta'];
        
        if (rolesRestringidos.includes(currentUser.rol)) {
            const unidadUsuario = transformarUsuarioAUnidad(currentUser.usuario);
            console.log(`üîç Buscando OS Asignadas para unidad: ${unidadUsuario}`);
 
            const { data: asignaciones, error: errorAsig } = await supabaseClient
                .from('os_asignadas')
                .select('osatomo') // Columna en os_asignadas
                .eq('Unidad', unidadUsuario);
 
            if (asignaciones && asignaciones.length > 0) {
                const osNumeros = asignaciones.map(a => a.osatomo).filter(os => os);
                
                // Cargar datos completos desde OS Pendientes en lotes
                const osCompletas = [];
                const grupos = chunkArray(osNumeros, 100);

                for (const grupo of grupos) {
                    const { data, error } = await supabaseClient
                        .from('OS Pendientes')
                        .select('OSATMO, Unidad, Tipologia, Tipo_de_OS, Coordenadas, Coordendasgis, Deuda')
                        .in('OSATMO', grupo);

                    if (data) osCompletas.push(...data);
                }
                
                // Limpiar duplicados y nulos
                osAsignadas = osCompletas.filter(os => os.OSATMO && (os.Coordenadas || os.Coordendasgis));
            }
        }
 
        // 5Ô∏è‚É£ GENERAR INTERFAZ SEG√öN ROL
        const rolesAdmin = ['Administrador', 'Despacho', 'Supervisor'];
        
        if (rolesAdmin.includes(currentUser.rol)) {
            generarInterfazAdminMapaRutas(filtros, tipologiasUnicas, unidadesUnicas);
        } else {
            // Para Contratistas, pasamos sus OS asignadas para que el mapa se centre en ellas
            generarInterfazUnidadMapaRutas(filtros, osAsignadas);
        }
 
    } catch (err) {
        console.error('‚ùå Error cargando Mapa de Rutas:', err);
        searchGrid.innerHTML = '<div class="result-card">‚ùå Error al cargar la interfaz de mapas</div>';
    }
}

/**
 * Busca una OS y muestra el mapa para el rol Administrador/Despacho
 */
async function buscarYMostrarMapaAdmin() {
    console.log("üîç Iniciando b√∫squeda de OS (Admin Mode)...");

    const osInput = document.getElementById('buscarOSAdmin');
    const resultsContainer = document.getElementById('searchResults');
    
    if (!osInput) {
        console.error("‚ùå No se encontr√≥ el input 'buscarOSAdmin'");
        return;
    }

    const osIngresada = osInput.value.trim();
    if (!osIngresada) {
        alert('‚ö†Ô∏è Por favor ingrese un n√∫mero de OS');
        return;
    }
    
    // Feedback visual de carga
    resultsContainer.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div class="loading" style="display: inline-block;"></div>
            <p>Buscando OS ${osIngresada}...</p>
        </div>`;
    
    try {
        // 1Ô∏è‚É£ B√∫squeda de Asignaci√≥n (Informativa)
        let unidadDetectada = null;
        const { data: asignacion, error: errorAsig } = await supabaseClient
            .from('os_asignadas')
            .select('osatomo, Unidad')
            .eq('osatomo', osIngresada)
            .maybeSingle();
            
        if (asignacion) {
            console.log(`‚úÖ Unidad asignada: ${asignacion.Unidad}`);
            unidadDetectada = asignacion.Unidad;

            // Validaci√≥n espec√≠fica para Despacho
            if (currentUser && currentUser.rol === 'Despacho' && unidadDetectada) {
                const { data: filtrosUnidad } = await supabaseClient
                    .from('filtros_por_unidad')
                    .select('*')
                    .eq('Unidad', unidadDetectada)
                    .maybeSingle();
                
                if (!filtrosUnidad) {
                    const confirmar = confirm(
                        `‚ö†Ô∏è No tienes filtros espec√≠ficos para ${unidadDetectada}\n\n` +
                        `¬øDeseas configurarlos ahora? (Cancelar para usar filtros globales)`
                    );
                    if (confirmar) {
                        if (typeof volverATablas === 'function') volverATablas();
                        return;
                    }
                }
            }
        }

        // 2Ô∏è‚É£ B√∫squeda en OS Pendientes (Fuente de Verdad)
        const { data: osCentro, error: errorPend } = await supabaseClient
            .from('OS Pendientes')
            .select('*')
            .eq('OSATMO', osIngresada)
            .maybeSingle();

        if (errorPend) throw errorPend;

        if (!osCentro) {
            resultsContainer.innerHTML = `
                <div class="result-card" style="border-left: 5px solid #f44336; background: #ffebee;">
                    <div class="result-header">‚ùå OS No Encontrada</div>
                    <p>La OS <b>${osIngresada}</b> no existe en el sistema de pendientes.</p>
                </div>`;
            return;
        }
        
        // Sincronizar unidad si no se encontr√≥ en la primera tabla
        if (!unidadDetectada && osCentro.Unidad) {
            unidadDetectada = osCentro.Unidad;
        }

        // 3Ô∏è‚É£ Validaci√≥n de Coordenadas
        const coordenadas = osCentro.Coordenadas || osCentro.Coordendasgis;
        if (!coordenadas || !coordenadas.includes(',')) {
            resultsContainer.innerHTML = `
                <div class="result-card" style="border-left: 5px solid #ff9800; background: #fff3cd;">
                    <div class="result-header">‚ö†Ô∏è Coordenadas Inv√°lidas</div>
                    <p>La OS existe, pero los datos de ubicaci√≥n son incorrectos.</p>
                </div>`;
            return;
        }
        
        // 4Ô∏è‚É£ Renderizado del Mapa
        console.log("üìç Datos listos, llamando al mapa...");
        resultsContainer.innerHTML = ""; // Limpiar el loading
        
        if (typeof cargarYMostrarMapa === 'function') {
            await cargarYMostrarMapa(osCentro, unidadDetectada);
        } else {
            throw new Error("La funci√≥n 'cargarYMostrarMapa' no est√° definida.");
        }

    } catch (err) {
        console.error('‚ùå Error cr√≠tico en b√∫squeda:', err);
        resultsContainer.innerHTML = `
            <div class="result-card" style="background: #f8d7da; color: #721c24;">
                <b>Error de conexi√≥n:</b> No se pudo consultar la base de datos.
            </div>`;
    }
}

// ‚úÖ EXPOSICI√ìN GLOBAL (Esto soluciona el ReferenceError)
window.buscarYMostrarMapaAdmin = buscarYMostrarMapaAdmin;





// ========================================
// üë®‚Äçüíº INTERFAZ ADMINISTRADOR CON FILTROS POR UNIDAD Y DEUDA
// ========================================
async function generarInterfazAdminMapaRutas(filtros, tipologiasDisponibles) {
    const searchGrid = document.getElementById('searchGrid');

    // ‚úÖ CARGAR UNIDADES DESDE os_asignadas (con debug mejorado)
    console.log('üîç Cargando unidades desde os_asignadas...');

    const unidadesUnicas = [];
    let offset = 0;
    const BATCH_SIZE = 1000;
    let totalCargado = 0;

    // ‚úÖ CORRECCI√ìN: Captura de errores en el proceso de carga con try/catch
    try {
        while (true) {
            const { data, error } = await supabaseClient
                .from('os_asignadas')
                .select('Unidad')
                .range(offset, offset + BATCH_SIZE - 1);

            if (error) throw error; 
            
            if (!data || data.length === 0) break;

            data.forEach(row => {
                if (row.Unidad && !unidadesUnicas.includes(row.Unidad)) {
                    unidadesUnicas.push(row.Unidad);
                }
            });

            totalCargado += data.length;
            if (data.length < BATCH_SIZE) break;
            offset += BATCH_SIZE;
        }
    } catch (err) {
        console.error('‚ùå Error cr√≠tico:', err);
        searchGrid.innerHTML = `
            <div class="result-card" style="background: #ffebee; border: 2px solid #f44336; padding: 20px; text-align: center;">
                <h3 style="color: #d32f2f;">‚ùå Error de Conexi√≥n</h3>
                <p>No se pudieron cargar las unidades. Verifica tu conexi√≥n o permisos.</p>
                <code style="display: block; background: white; padding: 10px; margin: 10px 0; font-size: 12px;">${err.message}</code>
                <button onclick="location.reload()" class="btn" style="background: #f44336; color: white;">üîÑ Reintentar</button>
            </div>`;
        return; 
    }

    unidadesUnicas.sort();
    console.log(`‚úÖ ${unidadesUnicas.length} unidades √∫nicas listas.`);

    // üÜï Si no hay unidades, mostrar error
    if (unidadesUnicas.length === 0) {
        searchGrid.innerHTML = `
            <div class="result-card" style="background: #fff3cd; border: 2px solid #ffc107;">
                <div class="result-header">‚ö†Ô∏è Sin unidades asignadas</div>
                <p style="text-align: center; color: #666;">
                    No se encontraron unidades en os_asignadas.<br>
                    Cargue el archivo de asignaciones primero (opci√≥n "Cargar Asignaciones").
                </p>
            </div>`;
        return;
    }

    // ‚úÖ CORRECCI√ìN: Blindaje contra objetos null o undefined
    const filtrosSeguros = filtros || { 
        rangos: [], 
        tipologias: [], 
        radio_km: 3, 
        fecha_actualizacion: null 
    };
    const rangosDisponibles = ['0-5', '6-10', '11-15', '16-20', '21-30', '31-45', '46-180', '>180'];

    searchGrid.innerHTML = `
        <div class="result-card" style="background: #e8f5e9; border: 2px solid #4caf50;">
            <div class="result-header">‚öôÔ∏è Configuraci√≥n de Filtros (Administrador)</div>

            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #2196f3;">
                <strong style="color: #1565c0;">üìä Filtros Globales Actuales:</strong><br>
                <div style="margin-top: 10px; font-size: 14px; color: #666; line-height: 1.8;">
                    ‚Ä¢ <strong>Rangos:</strong> ${filtrosSeguros.rangos?.length > 0 ? filtrosSeguros.rangos.join(', ') : '<em style="color: #999;">Ninguno</em>'}<br>
                    ‚Ä¢ <strong>Tipolog√≠as:</strong> ${filtrosSeguros.tipologias?.length > 0 ? filtrosSeguros.tipologias.length + ' seleccionada(s)' : '<em style="color: #999;">Ninguna</em>'}<br>
                    ‚Ä¢ <strong>Radio:</strong> ${filtrosSeguros.radio_km || 3} km<br>
                    ‚Ä¢ <strong>√öltima actualizaci√≥n:</strong> ${filtrosSeguros.fecha_actualizacion ? new Date(filtrosSeguros.fecha_actualizacion).toLocaleString('es-ES', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '<em style="color: #999;">Sin actualizar</em>'}
                </div>
            </div>            
            
            <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
                <strong>‚ÑπÔ∏è Nota:</strong> Las OS Reguladas siempre se mostrar√°n (prioridad legal)
            </div>

            <div style="background: #f3e5f5; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #9c27b0;">
                <strong style="color: #6a1b9a; font-size: 18px;">üìç Filtros Personalizados por Unidad</strong>
                <p style="color: #666; margin: 10px 0;">Configura filtros espec√≠ficos que solo aplicar√°n a las unidades seleccionadas</p>

                <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <label style="font-weight: 600; color: #2d3748; margin-bottom: 10px; display: block;">
                        Seleccionar Unidades:
                    </label>
                    <div style="max-height: 200px; overflow-y: auto; border: 2px solid #e1e5e9; border-radius: 8px; padding: 10px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px;">
                            ${unidadesUnicas.map(unidad => `
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; background: #f8f9fa; border-radius: 6px;">
                                    <input type="checkbox" class="checkbox-unidad-filtro" value="${unidad}" style="width: 18px; height: 18px;">
                                    <span style="font-size: 13px;">${unidad}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #e3f2fd; border-radius: 8px; margin-top: 10px;">
                        <strong style="color: #1565c0;">üìä Unidades seleccionadas: <span id="contadorUnidadesSeleccionadas">0</span></strong>
                    </div>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: #2d3748;">üìä Rangos de D√≠as:</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px;">
                        ${rangosDisponibles.map(rango => `
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: #f8f9fa; border-radius: 6px;">
                                <input type="checkbox" class="checkbox-rango-unidad" value="${rango}" style="width: 18px; height: 18px;">
                                <span>${rango} d√≠as</span>
                            </label>
                        `).join('')}
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight: 600; color: #2d3748;">üè∑Ô∏è Tipolog√≠as:</label>
                    <button onclick="toggleSeccionTipologiasUnidad()" class="btn btn-secondary" style="margin: 10px 0; width: 100%;">
                        üìã Seleccionar Tipolog√≠as
                    </button>
                    <div id="seccionTipologiasUnidad" style="display: none; max-height: 250px; overflow-y: auto; border: 2px solid #e1e5e9; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                        </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight: 600; color: #2d3748;">üìç Radio de b√∫squeda (km):</label>
                    <input type="number" id="radioKmUnidad" min="1" max="20" value="3"
                           style="width: 100px; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                    <button class="btn" onclick="guardarFiltrosPorUnidad()" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                        üíæ Guardar Filtros para Unidades
                    </button>
                    <button class="btn btn-danger" onclick="borrarTodosFiltrosUnidades()">
                        üóëÔ∏è Borrar TODOS los Filtros de Unidades
                    </button>
                </div>
            </div>

            <div style="background: #fffde7; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #fbc02d;">
                <strong style="color: #f57f17; font-size: 18px;">üí∞ Filtro de Deuda (Suspensi√≥n)</strong>
                <p style="color: #666; margin: 10px 0;">Selecciona rangos de deuda. Se aplicar√° a TODAS las OS con ese monto (prioridad sobre tipolog√≠as)</p>

                <div style="display: grid; gap: 12px; margin-top: 15px;">
                    <label class="filtro-deuda-checkbox" data-color="amarillo" style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 15px; background: white; border-radius: 8px; border: 3px solid #fdd835; transition: all 0.3s;">
                        <input type="checkbox" id="deuda_amarillo" value="500" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #fff176 0%, #fdd835 100%); border-radius: 50%; box-shadow: 0 2px 8px rgba(253,216,53,0.4);"></div>
                        <div style="flex: 1;">
                            <strong style="color: #f57f17; font-size: 16px;">üü° Deuda Alta</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 4px;">M√°s de <strong>$500</strong></div>
                        </div>
                    </label>

                    <label class="filtro-deuda-checkbox" data-color="naranja" style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 15px; background: white; border-radius: 8px; border: 3px solid #ff9800; transition: all 0.3s;">
                        <input type="checkbox" id="deuda_naranja" value="100-500" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #ffb74d 0%, #ff9800 100%); border-radius: 50%; box-shadow: 0 2px 8px rgba(255,152,0,0.4);"></div>
                        <div style="flex: 1;">
                            <strong style="color: #e65100; font-size: 16px;">üü† Deuda Media</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 4px;">Entre <strong>$100 - $500</strong></div>
                        </div>
                    </label>

                    <label class="filtro-deuda-checkbox" data-color="rosado" style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 15px; background: white; border-radius: 8px; border: 3px solid #f48fb1; transition: all 0.3s;">
                        <input type="checkbox" id="deuda_rosado" value="50-100" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #f8bbd0 0%, #f48fb1 100%); border-radius: 50%; box-shadow: 0 2px 8px rgba(244,143,177,0.4);"></div>
                        <div style="flex: 1;">
                            <strong style="color: #c2185b; font-size: 16px;">üå∏ Deuda Baja</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 4px;">Entre <strong>$50 - $100</strong></div>
                        </div>
                    </label>
                </div>

                <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ff6f00;">
                    <strong style="color: #e65100;">‚ö†Ô∏è Importante:</strong><br>
                    <span style="color: #666; font-size: 14px;">
                        ‚Ä¢ Si NO seleccionas deuda ($0) ‚Üí No se aplicar√° filtro de deuda<br>
                        ‚Ä¢ Si seleccionas deuda SIN tipolog√≠as ‚Üí Mostrar√° TODAS las OS con esa deuda<br>
                        ‚Ä¢ Si seleccionas deuda + tipolog√≠as ‚Üí Mostrar√° ambos criterios combinados
                    </span>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 24px;">üßπ</span>
                    <strong style="color: #e65100; font-size: 16px;">Limpieza de Filtros Obsoletos</strong>
                </div>
                <p style="color: #666; margin: 10px 0; font-size: 14px;">
                    <strong>üí° ¬øQu√© hace?</strong><br>
                    Elimina autom√°ticamente los filtros con fecha programada anterior a 2 d√≠as atr√°s.<br>
                    Esto mantiene la base de datos limpia y evita acumulaci√≥n de datos innecesarios.
                </p>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn" onclick="limpiarFiltrosObsoletosConConfirmacion()"
                        style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); width: 100%; padding: 12px; font-size: 16px;">
                        üóëÔ∏è Limpiar Filtros Obsoletos (2+ d√≠as)
                    </button>
                </div>
                <small style="display: block; margin-top: 10px; color: #666; font-size: 12px; text-align: center;">
                    ‚ÑπÔ∏è Tambi√©n se ejecuta autom√°ticamente al cargar KML Ruta
                </small>
            </div>

            <div class="form-group" style="margin-top: 15px;">
                <label style="font-weight: 600; color: #2d3748;">üìÖ Fecha de Vigencia (Opcional):</label>
                <input type="date" id="fechaVigenciaFiltros" placeholder="Seleccione fecha"
                       min="${new Date().toISOString().split('T')[0]}"
                       style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
                <small style="color: #666; display: block; margin-top: 5px;">
                    Dejar vac√≠o para vigencia inmediata.
                </small>
            </div>

            ${currentUser.rol === 'Administrador' ? `
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="guardarFiltrosMapaGlobales()" style="font-size: 16px; padding: 15px 30px;">
                        üíæ Guardar Filtros Globales
                    </button>
                </div>
            `: currentUser.rol === 'Despacho' ? `
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="guardarFiltrosMapaGlobales()" style="font-size: 16px; padding: 15px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        üíæ Guardar MIS Filtros Personales
                    </button>
                </div>
            ` : ''}
        </div>

        <div class="result-card" style="margin-top: 20px;">
            <div class="result-header">üîç Buscar OS para visualizar</div>
            <p style="color: #666; margin-bottom: 15px;">Ingresa CUALQUIER n√∫mero de OS (no necesita estar asignada)</p>
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end;">
                <div class="form-group" style="margin: 0;">
                   <label>N√∫mero de OS:</label>
                   <input type="text" id="buscarOSAdmin" placeholder="Ej: 123456"
                          style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9;">
                </div>
                <button class="btn btn-secondary" onclick="buscarYMostrarMapaAdmin()" style="margin: 0;">
                    üîç Mostrar Mapa
                </button>
            </div>
        </div>
    `;

    // 1. Cargar tipolog√≠as din√°micas
    // ... (aqu√≠ termina tu bloque gigante de searchGrid.innerHTML = ` ... ` )

    // 1. ‚úÖ CORRECCI√ìN: ESTE ES EL LUGAR EXACTO
    // Reemplaza la l√≠nea que dec√≠a: cargarTipologiasParaFiltrosUnidad(); 
    // Por todo este bloque:
    const containerTips = document.getElementById('seccionTipologiasUnidad');
    if (containerTips && tipologiasDisponibles) {
        containerTips.innerHTML = tipologiasDisponibles.map(t => `
            <label style="display: block; font-size: 13px; margin-bottom: 5px; cursor: pointer; background: #fff; padding: 5px; border-radius: 4px; border: 1px solid #eee;">
                <input type="checkbox" class="checkbox-tipologia-unidad" value="${t}" style="margin-right: 8px;"> ${t}
            </label>
        `).join('');
    } else {
        // Fallback: Si no hay datos en memoria, intentamos la carga tradicional
        cargarTipologiasParaFiltrosUnidad();
    }

    // 2. Listener para los checkboxes de unidades
    const checkboxesUnidad = document.querySelectorAll('.checkbox-unidad-filtro');
    if (checkboxesUnidad.length > 0) {
        checkboxesUnidad.forEach(cb => {
            cb.addEventListener('change', actualizarContadorUnidadesSeleccionadas);
        });
    }

    // 3. Listeners para efectos visuales en los filtros de deuda
    const etiquetasDeuda = document.querySelectorAll('.filtro-deuda-checkbox');
    etiquetasDeuda.forEach(label => {
        const checkbox = label.querySelector('input[type="checkbox"]');
        const color = label.getAttribute('data-color');

        if (checkbox) {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    if (color === 'amarillo') label.style.background = 'linear-gradient(135deg, #fff9c4 0%, #fff59d 100%)';
                    else if (color === 'naranja') label.style.background = 'linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%)';
                    else if (color === 'rosado') label.style.background = 'linear-gradient(135deg, #f8bbd0 0%, #f48fb1 100%)';

                    label.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    label.style.transform = 'translateY(-2px)';
                } else {
                    label.style.background = 'white';
                    label.style.boxShadow = 'none';
                    label.style.transform = 'translateY(0)';
                }
            });
        }
    });

    console.log('‚úÖ Interfaz de Administrador y listeners inicializados');
} // <-- AQU√ç TERMINA TU FUNCI√ìN



async function buscarYMostrarMapaUnidad() {
    // ... (Tu l√≥gica para obtener la OS seleccionada y filtrar por radio km) ...
    
    // Suponiendo que 'ordenesCercanas' son los datos que vas a pintar:
    const searchResults = document.getElementById('searchResults');
    searchResults.innerHTML = '<div id="mapUnidad" style="height: 500px; border-radius:15px;"></div>';
    
    const map = L.map('mapUnidad').setView([latPartida, lonPartida], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // --- AQU√ç INSERTAS LA L√ìGICA DE AGRUPAMIENTO ---
    
    // 1. Agrupamos las OS que tienen la misma ubicaci√≥n
    const coordenadasAgrupadas = ordenesCercanas.reduce((acc, os) => {
        // Extraemos lat y lon (aseg√∫rate que los nombres coincidan con tu objeto os)
        // Algunos de tus objetos usan 'latitud'/'longitud' y otros vienen en 'Coordenadas'
        let lat, lon;
        if (os.Coordenadas && os.Coordenadas.includes(',')) {
            [lat, lon] = os.Coordenadas.split(',').map(c => parseFloat(c.trim()));
        } else {
            lat = parseFloat(os.latitud);
            lon = parseFloat(os.longitud);
        }
        
        if (!isNaN(lat) && !isNaN(lon)) {
            const key = `${lat.toFixed(6)}_${lon.toFixed(6)}`;
            if (!acc[key]) acc[key] = [];
            acc[key].push({...os, lat, lon}); // Guardamos lat/lon procesados
        }
        return acc;
    }, {});

    // 2. Dibujamos un solo marcador por ubicaci√≥n
    Object.values(coordenadasAgrupadas).forEach(grupo => {
        const primera = grupo[0];
        
        const marcador = L.marker([primera.lat, primera.lon], { 
            icon: iconoSegunEstado(primera.estado || primera.Estado) 
        }).addTo(map);

        if (grupo.length > 1) {
            // ‚úÖ CASO: M√∫ltiples √≥rdenes en el mismo punto exacto
            let listadoHTML = `
                <div style="max-height:180px; overflow-y:auto; min-width:200px; font-family: sans-serif;">
                    <strong style="color: #1976d2;">üìç ${grupo.length} √ìrdenes encontradas:</strong><hr style="margin: 5px 0;">`;
            
            grupo.forEach(os => {
                const comentarioVerificado = os.comentario || os.Comentario || os.observaciones || "Sin comentario";
                const numOS = os.osatomo || os.osatom || "N/A";

                listadoHTML += `
                    <div style="border-bottom:1px solid #eee; padding: 8px 0;">
                        <b>OS:</b> ${numOS}<br>
                        <small style="color: #666; display: block; margin-bottom: 5px;">${comentarioVerificado}</small>
                        <button onclick="verDetalleOrden('${numOS}')" 
                                style="background:#1976d2; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; width:100%; font-size:12px;">
                            Ver Ficha
                        </button>
                    </div>`;
            });
            listadoHTML += `</div>`;
            marcador.bindPopup(listadoHTML);
        } else {
            // ‚úÖ CASO: Orden √∫nica
            const comentarioUnico = primera.comentario || primera.Comentario || "Sin comentario";
            const numOSUnico = primera.osatomo || primera.osatom || "N/A";

            marcador.bindPopup(`
                <div style="font-family: sans-serif; width: 160px;">
                    <b style="color: #1976d2;">OS: ${numOSUnico}</b><br>
                    <p style="margin: 5px 0; font-size: 12px; color: #444;">${comentarioUnico}</p>
                    <button onclick="verDetalleOrden('${numOSUnico}')" 
                            style="background:#1976d2; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; width:100%; font-size:12px;">
                        Ver Ficha Completa
                    </button>
                </div>
            `);
        }
    });
}


¬†	// ‚úÖ FUNCI√ìN DE DEBUG (agregar temporalmente)
function debugSelectOSBusqueda() {
¬†   const select = document.getElementById('selectOSBusqueda');
¬†   console.log('üîç Debug del selector:');
¬†   console.log('- Elemento existe:', !!select);
¬†   console.log('- Valor actual:', select?.value);
¬†   console.log('- Cantidad de opciones:', select?.options?.length);
¬†
¬†   if (select) {
¬†       console.log('- Opciones disponibles:');
¬†       Array.from(select.options).forEach((opt, i) => {
¬†           console.log(`  ${i}: ${opt.value} - ${opt.text}`);
¬†       });
¬†   }
}


// ========================================
// üîç VERIFICAR TABLA os_asignadas
// ========================================
async function verificarTablaOSAsignadas() {
¬†   const resultsContainer = document.getElementById('searchResults');
¬†
¬†   resultsContainer.innerHTML = `
¬†       <div class="result-card" style="text-align: center;">
¬†           <div class="loading" style="display: block; margin: 20px auto;"></div>
¬†           <h3 style="color: #1565c0;">Verificando tabla os_asignadas...</h3>
¬†       </div>`;
¬†
¬†   try {
¬†       // Test 1: Ver si existe y tiene datos
¬†       const { data, error, count } = await supabaseClient
¬†           .from('os_asignadas')
¬†           .select('*', { count: 'exact', head: true });
¬†
¬†       if (error) {
¬†           resultsContainer.innerHTML = `
¬†               <div class="result-card" style="background: #ffebee; border: 2px solid #f44336;">
¬†                   <div class="result-header">‚ùå Error de Acceso</div>
¬†                   <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
¬†                       <strong style="color: #d32f2f;">Error detectado:</strong><br><br>
¬†                       <code style="font-size: 13px;">${error.message}</code><br><br>
¬†                       <strong>C√≥digo:</strong> ${error.code}<br>
¬†                       <strong>Detalles:</strong> ${error.details || 'N/A'}
¬†                   </div>
¬†                   <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0;">
¬†                       <strong>üí° Soluciones:</strong><br><br>
¬†                       1. Ejecuta en Supabase SQL Editor:<br>
¬†                       <code style="display: block; background: #f5f5f5; padding: 10px; border-radius: 6px; margin: 10px 0;">
¬†                           ALTER TABLE os_asignadas DISABLE ROW LEVEL SECURITY;
¬†                       </code><br>
¬†                       2. Verifica que la tabla existe:<br>
¬†                       <code style="display: block; background: #f5f5f5; padding: 10px; border-radius: 6px; margin: 10px 0;">
¬†                           SELECT * FROM os_asignadas LIMIT 5;
¬†                       </code>
¬†                   </div>
¬†               </div>`;
¬†           return;
¬†       }
¬†
¬†       // Test 2: Mostrar primeros registros
¬†       const { data: registros } = await supabaseClient
¬†           .from('os_asignadas')
¬†           .select('*')
¬†           .limit(5);
¬†
¬†       resultsContainer.innerHTML = `
¬†           <div class="result-card" style="background: #e8f5e9; border: 2px solid #4caf50;">
¬†               <div class="result-header">‚úÖ Tabla Accesible</div>
¬†               <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
¬†                   <strong>üìä Informaci√≥n:</strong><br><br>
¬†                   ‚Ä¢ Total de registros: <strong>${count || 0}</strong><br>
¬†                   ‚Ä¢ Estado: <strong>Accesible</strong><br>
¬†                   ‚Ä¢ Primeros 5 registros:<br><br>
¬†                   <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px;">${JSON.stringify(registros, null, 2)}</pre>
¬†               </div>
¬†               <div style="text-align: center;">
¬†                   <button class="btn" onclick="cargarInterfazMapaRutas()">
¬†                       üîÑ Reintentar Cargar Mapa
¬†                   </button>
¬†               </div>
¬†           </div>`;
¬†
¬†   } catch (err) {
¬†       console.error('Error en verificaci√≥n:', err);
¬†       resultsContainer.innerHTML = `
¬†           <div class="result-card" style="background: #ffebee;">
¬†               <div class="result-header">‚ùå Error Inesperado</div>
¬†               <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; overflow-x: auto;">${err.message}</pre>
¬†           </div>`;
¬†   }
}

// ========================================
// üîÑ ACTUALIZAR SELECCI√ìN DE RANGOS
// ========================================
function actualizarSeleccionRangos() {
¬†   const todosRangos = document.getElementById('todosRangos');
¬†   const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
¬†
¬†   let algunoMarcado = false;
¬†   let todosMarcados = true;
¬†
¬†   checkboxes.forEach(cb => {
¬†       if (cb.value && (cb.value.includes('-') || cb.value.startsWith('>'))) {
¬†           if (cb.checked) {
¬†               algunoMarcado = true;
¬†           } else {
¬†               todosMarcados = false;
¬†           }
¬†       }
¬†   });
¬†
¬†   if (todosRangos) {
¬†       todosRangos.checked = todosMarcados && algunoMarcado;
¬†   }
}

// ========================================
// ‚úÖ TOGGLE TODOS LOS RANGOS
// ========================================
function toggleTodosRangos() {
¬†   const todosRangos = document.getElementById('todosRangos');
¬†   const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
¬†
¬†   checkboxes.forEach(cb => {
¬†       if (cb.value && (cb.value.includes('-') || cb.value.startsWith('>'))) {
¬†           cb.checked = todosRangos.checked;
¬†       }
¬†   });
}

// ========================================
// üîÑ ACTUALIZAR SELECCI√ìN DE TIPOLOG√çAS
// ========================================
function actualizarSeleccionTipologias() {
¬†   const todasTipologias = document.getElementById('todasTipologias');
¬†   const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
¬†
¬†   let algunoMarcado = false;
¬†   let todosMarcados = true;
¬†
¬†   checkboxes.forEach(cb => {
¬†       const valor = cb.value;
¬†       // Solo tipolog√≠as (no rangos)
¬†       if (valor && !valor.includes('-') && !valor.startsWith('>') &&
¬†           !['todosRangos', 'todasTipologias'].includes(cb.id)) {
¬†           if (cb.checked) {
¬†               algunoMarcado = true;
¬†           } else {
¬†               todosMarcados = false;
¬†           }
¬†       }
¬†   });
¬†
¬†   if (todasTipologias) {
¬†       todasTipologias.checked = todosMarcados && algunoMarcado;
¬†   }
}

// ========================================
// ‚úÖ TOGGLE TODAS LAS TIPOLOG√çAS
// ========================================
function toggleTodasTipologias() {
¬†   const todasTipologias = document.getElementById('todasTipologias');
¬†   const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
¬†
¬†   checkboxes.forEach(cb => {
¬†       const valor = cb.value;
¬†       // Solo tipolog√≠as (no rangos)
¬†       if (valor && !valor.includes('-') && !valor.startsWith('>') &&
¬†           !['todosRangos', 'todasTipologias'].includes(cb.id)) {
¬†           cb.checked = todasTipologias.checked;
¬†       }
¬†   });
}



// ========================================
// üíæ GUARDAR FILTROS (VERSI√ìN CORREGIDA - IDENTIDAD TOTAL)
// ========================================
async function guardarFiltrosMapa() {
    if (currentUser.rol !== 'Administrador') {
        alert('‚ö†Ô∏è Solo administradores pueden modificar filtros');
        return;
    }

    const tipologias = [];
    const rangos = [];

    // 1Ô∏è‚É£ Obtener checkboxes seleccionados
    const checkboxes = document.querySelectorAll('.checkbox-rango-unidad:checked');
    
    checkboxes.forEach(cb => {
        if (cb.value && !['todosRangos', 'todasTipologias'].includes(cb.id)) {
            const valor = cb.value;
            
            // Detectar si es un Rango (ej: 0-5, >30)
            if (valor.includes('-') || valor.startsWith('>')) {
                // Solo aceptamos rangos que no sean nombres de unidades
                if (!valor.includes('CL-')) {
                    rangos.push(valor.trim());
                }
            } else {
                // Es una TIPOLOG√çA: Aplicamos normalizaci√≥n estricta
                // Quitamos espacios extra y aseguramos may√∫sculas para que coincida con OS Pendientes
                const tipologiaLimpia = valor.trim().replace(/\s+/g, ' ').toUpperCase();
                tipologias.push(tipologiaLimpia);
            }
        }
    });

    // 2Ô∏è‚É£ Obtener radio
    const radioInput = document.getElementById('radioKm');
    const radioKm = radioInput ? parseInt(radioInput.value) : 3;

    // 3Ô∏è‚É£ Validaciones
    if (isNaN(radioKm) || radioKm < 1 || radioKm > 20) {
        alert('‚ö†Ô∏è El radio debe estar entre 1 y 20 km');
        return;
    }

    if (tipologias.length === 0 && rangos.length === 0) {
        alert('‚ö†Ô∏è Debe seleccionar al menos una tipolog√≠a o un rango');
        return;
    }

    // 4Ô∏è‚É£ Confirmaci√≥n
    const confirmar = confirm(
        `¬øSUSTITUIR configuraci√≥n de filtros?\n\n` +
        `üìä NUEVOS VALORES:\n` +
        `‚Ä¢ Rangos: ${rangos.length > 0 ? rangos.join(', ') : 'Ninguno'}\n` +
        `‚Ä¢ Tipolog√≠as: ${tipologias.length} seleccionada(s)\n` +
        `‚Ä¢ Radio: ${radioKm} km\n\n` +
        `‚ö†Ô∏è Esto REEMPLAZAR√Å los filtros actuales para TODAS las unidades.\n\n` +
        `‚úÖ S√ç - Guardar nuevos filtros\n` +
        `‚ùå NO - Cancelar`
    );

    if (!confirmar) return;

    try {
        // ‚úÖ FORMATEO FINAL: Guardar como Array limpio o NULL
        const rangosAGuardar = rangos.length > 0 ? rangos : null;
        const tipologiasAGuardar = tipologias.length > 0 ? tipologias : null;
 
        console.log('üíæ Enviando a Supabase:', {
            rangos: rangosAGuardar,
            tipologias: tipologiasAGuardar,
            radio_km: radioKm
        });

        // 5Ô∏è‚É£ Ejecutar Actualizaci√≥n en Supabase
        const { error } = await supabaseClient
            .from('filtros_mapa')
            .update({
                rangos: rangosAGuardar,
                tipologias: tipologiasAGuardar,
                radio_km: radioKm,
                fecha_actualizacion: new Date().toISOString()
            })
            .eq('id', 1);

        if (error) {
            console.error('‚ùå Error guardando:', error);
            alert('‚ùå Error al guardar en base de datos: ' + error.message);
            return;
        }

        // ‚úÖ 6Ô∏è‚É£ Verificaci√≥n y Sincronizaci√≥n
        const { data: verificar } = await supabaseClient
            .from('filtros_mapa')
            .select('*')
            .eq('id', 1)
            .single();

        console.log('‚úÖ Verificaci√≥n exitosa en BD:', verificar);

        // Mensaje de √©xito detallado
        alert(
            `‚úÖ Filtros actualizados correctamente\n\n` +
            `üìä CONFIGURACI√ìN ACTIVA:\n` +
            `‚Ä¢ Rangos: ${rangos.length}\n` +
            `‚Ä¢ Tipolog√≠as: ${tipologias.length}\n` +
            `‚Ä¢ Radio: ${radioKm} km\n\n` +
            `El sistema de rutas ahora reconocer√° estas tipolog√≠as exactamente.`
        );

    } catch (err) {
        console.error('‚ùå Error cr√≠tico en guardarFiltrosMapa:', err);
        alert('‚ùå Error de conexi√≥n o de ejecuci√≥n');
    }
}

/**
 * Heartbeat autom√°tico para mantener sesi√≥n activa durante procesos largos
 * @param {number} intervaloMs - Intervalo en milisegundos (default: 25000)
 * @returns {Function} - Funci√≥n para detener el heartbeat
 */
function iniciarHeartbeatSesion(intervaloMs = 25000) {
    if (!currentUser?.id) return () => {};
    
    let heartbeatId = null;
    let ultimoEnvio = 0;
    
    const enviarHeartbeat = async () => {
        // Evitar enviar demasiado seguido
        if (Date.now() - ultimoEnvio < intervaloMs) return;
        
        try {
            await supabaseClient
                .from('usuarios')
                .update({ 
                    ultima_actividad: new Date().toISOString(),
                    ultimaconexion: formatearFechaCompletaElSalvador(getFechaElSalvador())
                })
                .eq('id', currentUser.id);
            ultimoEnvio = Date.now();
            console.log('üíì Heartbeat de sesi√≥n enviado');
        } catch (error) {
            console.warn('‚ö†Ô∏è Error enviando heartbeat:', error.message);
        }
    };
    
    // Enviar inmediatamente al iniciar
    enviarHeartbeat();
    
    // Configurar intervalo
    heartbeatId = setInterval(enviarHeartbeat, intervaloMs);
    
    // Retornar funci√≥n de limpieza
    return () => {
        if (heartbeatId) {
            clearInterval(heartbeatId);
            console.log('üõë Heartbeat detenido');
        }
    };
}



// ========================================
// üó∫Ô∏è FUNCI√ìN PRINCIPAL: cargarYMostrarMapa (VERSI√ìN UNIFICADA Y ROBUSTA)
// ========================================
async function cargarYMostrarMapa(osCentro, unidadFiltro) {
    // ‚úÖ GUARDAR REFERENCIAS GLOBALES PARA RECARGA
    window.osCentroActual = osCentro;
    window.unidadFiltroActual = unidadFiltro;
    // ‚úÖ 1. INICIAR HEARTBEAT PARA MANTENER SESI√ìN ACTIVA
    const detenerHeartbeat = iniciarHeartbeatSesion(25000);
    const resultsContainer = document.getElementById('searchResults');
    
    resultsContainer.innerHTML = `
        <div class="result-card">
            <div class="loading" style="display: block; margin: 20px auto;"></div>
            <p style="text-align: center; color: #666;">Cargando mapa y aplicando filtros de despacho...</p>
        </div>`;
    
    console.log('üó∫Ô∏è --- INICIANDO PROCESAMIENTO DE MAPA ---');
    
    try {
        // ========================================
        // ‚úÖ 2. CARGAR FILTROS UNIVERSALES
        // ========================================
        let filtrosAplicar = await cargarFiltrosUniversales(unidadFiltro);
        if (!filtrosAplicar) {
            console.warn('‚ö†Ô∏è Filtros no encontrados, usando valores por defecto');
            filtrosAplicar = { rangos: null, tipologias: null, radio_km: 3 };
        }
        window.filtrosAplicados = filtrosAplicar;
        const radioKm = filtrosAplicar.radio_km || 3;
        
        // ‚úÖ LOGS DE FILTROS PARA AUDITOR√çA
        console.log('üìã ==========================================');
        console.log('üìã FILTROS CARGADOS DESDE TABLA');
        console.log('üìã ==========================================');
        console.table({
            'Tipolog√≠as seleccionadas': filtrosAplicar.tipologias?.length > 0 ? filtrosAplicar.tipologias.join(', ') : 'NINGUNA',
            'Rangos seleccionados': filtrosAplicar.rangos?.length > 0 ? filtrosAplicar.rangos.join(', ') : 'NINGUNO',
            'Radio (km)': radioKm,
            'Unidad': unidadFiltro
        });
        console.log('üìã ==========================================');
        
        // ========================================
        // ‚úÖ 3. COORDENADAS DEL PUNTO CENTRAL
        // ========================================
        const coordsCentroStr = osCentro.Coordenadas || osCentro.Coordendasgis;
        if (!coordsCentroStr) throw new Error("La OS de referencia no tiene coordenadas.");
        const [latCentro, lngCentro] = coordsCentroStr.split(',').map(c => parseFloat(c.trim()));
        
        // ========================================
        // ‚úÖ 4. CARGAR OS ASIGNADAS PARA BLOQUEO
        // ========================================
        console.log('üì• Sincronizando OS asignadas para bloqueo...');
        const { data: osAsignadasBD } = await supabaseClient.from('os_asignadas').select('osatomo');
        const osAsignadasSet = new Set(osAsignadasBD?.map(a => String(a.osatomo).trim()) || []);
        console.log(`‚úÖ ${osAsignadasSet.size} OS bloqueadas por estar asignadas.`);
        
        // ========================================
        // ‚úÖ 5. CARGAR OS PENDIENTES (PAGINADO)
        // ========================================
        let todasOSRegistradas = [];
        let offset = 0;
        const BATCH_SIZE = 1000;
        
        while (true) {
            const { data, error } = await supabaseClient
                .from('OS Pendientes')
                .select('OSATMO, Tipologia, Tipo_de_OS, "Fecha Gen.", Coordenadas, Coordendasgis, Unidad, Deuda, Estado_ATOMO, Comentario, Medidor, CuentaContrato, Estado_SAP, Direccion, Unicom, Rango, Dias, Condicion')
                .in('Estado_ATOMO', ['Registrada', 'Asignada'])
                .range(offset, offset + BATCH_SIZE - 1);
            
            if (error || !data || data.length === 0) break;
            todasOSRegistradas.push(...data);
            if (data.length < BATCH_SIZE) break;
            offset += BATCH_SIZE;
        }
        console.log(`‚úÖ ${todasOSRegistradas.length} OS Pendientes cargadas`);


// ========================================
// ‚úÖ 6. üÜï USAR COMENTARIO DIRECTO DE OS PENDIENTES (SIN CONSULTA EXTRA)
// ========================================
console.log('üìù ==========================================');
console.log('üìù USANDO COMENTARIO DIRECTO DE OS PENDIENTES');
console.log('üìù ==========================================');

// Procesar OS Pendientes para asegurar que Comentario est√© disponible
todasOSRegistradas.forEach(os => {
    // ‚úÖ PRIORIDAD: Usar Comentario de OS Pendientes directamente
    if (os.Comentario && os.Comentario.trim() !== '' && os.Comentario !== 'N/A' && os.Comentario !== 'Sin comentario disponible') {
        os.ComentarioGeneral = os.Comentario;
        console.log(`üí¨ OS ${os.OSATMO}: Usa comentario directo de OS Pendientes`);
    } else {
        // Fallback solo si est√° vac√≠o
        os.Comentario = 'Sin comentario disponible';
        os.ComentarioGeneral = 'Sin comentario disponible';
    }
});
        
        
        
        
       
        
        // ========================================
        // ‚úÖ 8. FILTRADO INICIAL: RADIO Y ESTADO
        // ========================================
        const osFinalesParaFiltrar = [];
        let stats = { sinCoords: 0, fueraRadio: 0, asignadasOcultas: 0, prohibidas: 0 };
        
        for (const os of todasOSRegistradas) {
            const osatmoActual = String(os.OSATMO).trim();
            if (osatmoActual === String(osCentro.OSATMO).trim()) continue;
            if (osAsignadasSet.has(osatmoActual)) { stats.asignadasOcultas++; continue; }
            
            const cStr = os.Coordenadas || os.Coordendasgis;
            if (!cStr || !cStr.includes(',')) { stats.sinCoords++; continue; }
            
            const [lat, lng] = cStr.split(',').map(c => parseFloat(c.trim()));
            const dist = calcularDistancia(latCentro, lngCentro, lat, lng);
            if (dist > radioKm) { stats.fueraRadio++; continue; }
            
            const tipoOS = (os.Tipo_de_OS || '').toUpperCase();
            const deuda = parseFloat(os.Deuda) || 0;
            const esPrioritaria = (tipoOS.includes('REGULADA') && !tipoOS.includes('NO REGULADA')) || deuda >= 500;
            
            if (esPrioritaria) {
                osFinalesParaFiltrar.push({ ...os, lat, lng, distancia: dist, esPrioritaria: true });
                continue;
            }
            
            const unidad = (os.Unidad || "").trim();
            const estadoAtomo = (os.Estado_ATOMO || "").trim().toUpperCase();
            const esLibre = unidad === "" || unidad === "--------------------" || unidad.includes("---");
            const esRegistradaBD = estadoAtomo === "REGISTRADA";
            
            if (esLibre && esRegistradaBD) {
                osFinalesParaFiltrar.push({ ...os, lat, lng, distancia: dist, esPrioritaria: false });
            } else {
                stats.prohibidas++;
            }
        }
        
        // ========================================
        // ‚úÖ 9. FILTRADO FINAL CON VALIDACI√ìN DE FILTROS
        // ========================================
        let aprobadas = [];
        let resumenFiltrado = { porPrioridad: 0, porFiltroTabla: 0, descartadas: 0 };
        
        osFinalesParaFiltrar.forEach(os => {
            if (os.esPrioritaria) {
                aprobadas.push(os);
                resumenFiltrado.porPrioridad++;
            } else if (validarFiltrosOS(os, filtrosAplicar)) {
                aprobadas.push(os);
                resumenFiltrado.porFiltroTabla++;
            } else {
                resumenFiltrado.descartadas++;
            }
        });
        
        // ‚úÖ LOG FINAL DE AUDITOR√çA
        console.log("%cüìä RESUMEN T√âCNICO DE FILTRADO", "background: #222; color: #bada55; font-size: 12px; padding: 5px;");
        console.table({
            "Total procesadas": todasOSRegistradas.length,
            "Sin coordenadas": stats.sinCoords,
            "Fuera de radio": stats.fueraRadio,
            "Asignadas (ocultas)": stats.asignadasOcultas,
            "Prohibidas por unidad/estado": stats.prohibidas,
            "Total en radio v√°lidas": osFinalesParaFiltrar.length,
            "‚úÖ Pasan por prioridad (Reg/Deuda)": resumenFiltrado.porPrioridad,
            "‚úÖ Pasan por filtro de tabla": resumenFiltrado.porFiltroTabla,
            "‚ùå Descartadas por filtros": resumenFiltrado.descartadas,
            "üéØ TOTAL FINAL EN MAPA": aprobadas.length
        });
        
        // ========================================
        // ‚úÖ 10. GENERAR MAPA
        // ========================================
        console.log('üìä TOTAL FINAL EN MAPA:', aprobadas.length);
        
        if (aprobadas.length === 0) {
            alert('‚ÑπÔ∏è No hay √≥rdenes que cumplan los filtros en este radio.');
        }
        
        const osFinalesMapa = [osCentro, ...aprobadas];
        const osOptimizadas = optimizarRutaVecinoCercano(
            osFinalesMapa, 
            osCentro.OSATMO, 
            { lat: latCentro, lng: lngCentro }
        );
        
        generarMapaLeaflet(osCentro, osOptimizadas, latCentro, lngCentro, radioKm);
        
    } catch (err) {
        console.error('‚ùå Error Cr√≠tico en cargarYMostrarMapa:', err);
        console.error('Stack:', err.stack);
        resultsContainer.innerHTML = `
            <div class="result-card" style="border-left: 5px solid red; background: #fef2f2;">
                <div class="result-header" style="color: #dc2626;">‚ùå Error de Procesamiento</div>
                <p style="color: #7f1d1d; margin: 10px 0;"><strong>Detalle:</strong> ${err.message}</p>
                <p style="color: #991b1b; font-size: 12px;">üí° Verifique la conexi√≥n y los datos de la OS de referencia.</p>
            </div>`;
    } finally {
        // ‚úÖ 11. DETENER HEARTBEAT (LIMPIEZA GARANTIZADA)
        if (typeof detenerHeartbeat === 'function') {
            detenerHeartbeat();
            console.log('üõë Heartbeat detenido');
        }
    }
}



// ========================================
// üó∫Ô∏è BUSCAR Y MOSTRAR MAPA (UNIDAD) - CORREGIDO
// ========================================
async function buscarYMostrarMapaUnidad(osSeleccionada) {
¬†   // ‚úÖ CAMBIO 1: Recibir osSeleccionada como par√°metro
¬†   if (!osSeleccionada) {
¬†       // Si no se pas√≥ por par√°metro, intentar obtenerlo del DOM
¬†       const selectElement = document.getElementById('selectOSBusqueda');
¬†       if (!selectElement) {
¬†           alert('‚ö†Ô∏è Error: No se encontr√≥ el selector de OS');
¬†           console.error('‚ùå Elemento selectOSBusqueda no existe en el DOM');
¬†           return;
¬†       }
¬†       osSeleccionada = selectElement.value;
¬†   }
¬†
¬†   if (!osSeleccionada) {
¬†       alert('‚ö†Ô∏è Por favor seleccione una OS');
¬†       return;
¬†   }
¬†
¬†   const unidadUsuario = transformarUsuarioAUnidad(currentUser.usuario);
¬†   const resultsContainer = document.getElementById('searchResults');
¬†   resultsContainer.innerHTML = '<div class="loading" style="display: block; margin: 20px auto;"></div>';
¬†
¬†   try {
¬†       // 1Ô∏è‚É£ Verificar en os_asignadas
¬†       const { data: asignacion } = await supabaseClient
¬†           .from('os_asignadas')
¬†           .select('osatomo, Unidad')
¬†           .eq('osatomo', osSeleccionada)
¬†           .eq('Unidad', unidadUsuario)
¬†           .maybeSingle();
¬†
¬†       if (!asignacion) {
¬†           resultsContainer.innerHTML = `
¬†               <div class="result-card" style="background: #ffebee;">
¬†                   <div class="result-header">‚ùå OS No Asignada</div>
¬†                   <p style="text-align: center;">Esta OS no est√° asignada a tu unidad (${unidadUsuario})</p>
¬†               </div>`;
¬†           return;
¬†       }
¬†
¬†       // 2Ô∏è‚É£ Buscar en OS Pendientes
¬†       const { data: osCentro } = await supabaseClient
¬†           .from('OS Pendientes')
¬†           .select('*')
¬†           .eq('OSATMO', osSeleccionada)
¬†           .maybeSingle();
¬†
¬†       if (!osCentro) {
¬†           resultsContainer.innerHTML = `
¬†               <div class="result-card" style="background: #ffebee;">
¬†                   <div class="result-header">‚ùå Error</div>
¬†                   <p style="text-align: center;">Esta OS no est√° en OS Pendientes</p>
¬†               </div>`;
¬†           return;
¬†       }
¬†
¬†       // Validar coordenadas
¬†       const coordenadas = osCentro.Coordenadas || osCentro.Coordendasgis;
¬†       if (!coordenadas || !coordenadas.includes(',')) {
¬†           resultsContainer.innerHTML = `
¬†               <div class="result-card" style="background: #fff3cd;">
¬†                   <div class="result-header">‚ö†Ô∏è Sin Coordenadas</div>
¬†                   <p style="text-align: center;">La OS seleccionada no tiene coordenadas</p>
¬†               </div>`;
¬†           return;
¬†       }
¬†
¬†       // Cargar mapa
¬†       await cargarYMostrarMapa(osCentro, unidadUsuario);
¬†
¬†   } catch (err) {
¬†       console.error('Error:', err);
¬†       resultsContainer.innerHTML = '<div class="result-card">‚ùå Error de conexi√≥n</div>';
¬†   }
}



async function cargarFiltrosUniversales(unidad = null) {
¬†   const HOY = new Date().toISOString().split('T')[0];
¬†   const esGestionAdmin = (currentUser.rol === 'Administrador' || currentUser.rol === 'Despacho');
¬†
¬†   console.log('üîç INICIANDO CARGA DE FILTROS:', {
¬†       usuario: currentUser.usuario,
¬†       unidadSolicitada: unidad,
¬†       rol: currentUser.rol,
¬†       modo: esGestionAdmin ? 'GESTI√ìN (Admin/Despacho)' : 'EJECUCI√ìN (Unidad)'
¬†   });
¬†
¬†   // Objeto por defecto (Fallback)
¬†   let filtrosDefault = { rangos: null, tipologias: null, radio_km: 3, fecha_vigencia: null };

¬†   try {
¬†       // ==========================================================
¬†       // ‚úÖ PASO 0: FILTROS POR UNIDAD (Solo para T√©cnicos en campo)
¬†       // ==========================================================
¬†       if (unidad && !esGestionAdmin) {
¬†           console.log(`üì° Modo Ejecuci√≥n: Buscando filtros espec√≠ficos para: ${unidad}`);
¬†           let { data: filtrosUnidad } = await supabaseClient
¬†               .from('filtros_por_unidad')
¬†               .select('*')
¬†               .eq('Unidad', unidad)
¬†               .maybeSingle();

¬†           if (filtrosUnidad) {
¬†               console.log('‚úÖ ¬°ENCONTRADO! Usando filtros de la Unidad:', filtrosUnidad);
¬†               return {
¬†                   ...filtrosUnidad,
¬†                   rangos: filtrosUnidad.rangos || filtrosUnidad.Rangos,
¬†                   tipologias: filtrosUnidad.tipologias || filtrosUnidad.Tipologias
¬†               };
¬†           }
¬†           console.log(`‚ÑπÔ∏è La unidad ${unidad} no tiene filtros espec√≠ficos.`);
¬†       }

¬†       // ==========================================================
¬†       // ‚úÖ PASO 1: FILTROS DEL USUARIO ACTUAL (Admin/Despacho)
¬†       // Buscamos lo que el usuario logueado guard√≥ personalmente
¬†       // ==========================================================
¬†       if (esGestionAdmin) {
¬†           console.log(`üîç Buscando filtros personales de ${currentUser.rol}: ${currentUser.usuario}`);
¬†
¬†           let { data: filtrosPersonales } = await supabaseClient
¬†               .from('filtros_mapa')
¬†               .select('*')
¬†               .eq('usuario', currentUser.usuario)
¬†               .order('fecha_actualizacion', { ascending: false }) // Siempre el √∫ltimo guardado
¬†               .limit(1)
¬†               .maybeSingle();

¬†           if (filtrosPersonales) {
¬†               console.log(`‚úÖ ¬°ENCONTRADO! Usando tus filtros (${currentUser.usuario}):`, filtrosPersonales);
¬†               return filtrosPersonales;
¬†           }
¬†       }

¬†       // ==========================================================
¬†       // ‚úÖ PASO 2: ESTRATEGIA GLOBAL (Respaldo del Sistema)
¬†       // Si el usuario no ha guardado nada, usamos la estrategia general (usuario null)
¬†       // ==========================================================
¬†       console.log('üîç Buscando estrategia GLOBAL (usuario: null)...');
¬†
¬†       // Intentar Global de Hoy
¬†       let { data: globalHoy } = await supabaseClient
¬†           .from('filtros_mapa')
¬†           .select('*')
¬†           .is('usuario', null)
¬†           .eq('fecha_vigencia', HOY)
¬†           .maybeSingle();

¬†       if (globalHoy) {
¬†           console.log('‚úÖ Usando estrategia global de HOY');
¬†           return globalHoy;
¬†       }

¬†       // Intentar Global por Defecto
¬†       let { data: globalDefault } = await supabaseClient
¬†           .from('filtros_mapa')
¬†           .select('*')
¬†           .is('usuario', null)
¬†           .is('fecha_vigencia', null)
¬†           .maybeSingle();

¬†       if (globalDefault) {
¬†           console.log('‚úÖ Usando estrategia global POR DEFECTO');
¬†           return globalDefault;
¬†       }

¬†       // ========================================
¬†       // ‚úÖ PASO 3: FALLBACK FINAL
¬†       // ========================================
¬†       console.warn('‚ö†Ô∏è No se encontr√≥ ninguna configuraci√≥n aplicable. Usando valores limpios.');
¬†       return filtrosDefault;
¬†
¬†   } catch (err) {
¬†       console.error('‚ùå Error cr√≠tico en cargarFiltrosUniversales:', err);
¬†       return filtrosDefault;
¬†   }
}


¬†		// ========================================
// üö´ TIPOLOG√çAS PROHIBIDAS POR ROL
// ========================================
const TIPOLOGIAS_PROHIBIDAS = {
¬†   'Contratista': [
¬†       'VERIFICACION FUNCIONAMIENTO DE MEDIDOR',
¬†       'RECLAMACION POR CONSUMO'
¬†   ],
¬†   'TODAS': [
¬†       'INST. MED/ACOM. M.T. CON MOD. RED',
¬†       'INST. MED/ACOM. B.T. CON MOD. RED'
¬†   ]
};

function tipologiaPermitidaParaRol(tipologia, rol) {
¬†   if (!tipologia) return false;
¬†
¬†   const tipNormalizada = tipologia.trim();
¬†
¬†   // Bloqueadas para todos los roles
¬†   if (TIPOLOGIAS_PROHIBIDAS.TODAS.includes(tipNormalizada)) {
¬†       console.log(`‚ùå Tipolog√≠a bloqueada para todos: ${tipNormalizada}`);
¬†       return false;
¬†   }
¬†
¬†   // Bloqueadas solo para Contratista
¬†   if (rol === 'Contratista' && TIPOLOGIAS_PROHIBIDAS.Contratista.includes(tipNormalizada)) {
¬†       console.log(`‚ùå Tipolog√≠a bloqueada para ${rol}: ${tipNormalizada}`);
¬†       return false;
¬†   }
¬†
¬†   return true;
}



// ========================================
// ‚úÖ VALIDAR FORMATO DE COORDENADAS
// ========================================
function validarFormatoCoordenadas(coordenadas) {
¬†   if (!coordenadas || typeof coordenadas !== 'string') return false;
¬†
¬†   // Formato esperado: "13.6488,-89.9183" o "13.6488, -89.9183"
¬†   const regex = /^-?\d+\.?\d*\s*,\s*-?\d+\.?\d*$/;
¬†
¬†   if (!regex.test(coordenadas.trim())) {
¬†       console.warn('‚ö†Ô∏è Coordenadas con formato incorrecto:', coordenadas);
¬†       return false;
¬†   }
¬†
¬†   // Validar que se puedan convertir a n√∫meros
¬†   const partes = coordenadas.split(',').map(c => parseFloat(c.trim()));
¬†
¬†   if (partes.length !== 2 || isNaN(partes[0]) || isNaN(partes[1])) {
¬†       console.warn('‚ö†Ô∏è Coordenadas no num√©ricas:', coordenadas);
¬†       return false;
¬†   }
¬†
¬†   return true;
}


/**
 * Extrae coordenadas con prioridad EXPL√çCITA y validaci√≥n robusta
 * Prioridad: 1.Coordendasgis ‚Üí 2.Coordenadas ‚Üí 3.Alternativos ‚Üí 4.Separados
 * @param {Object} os - Objeto de Orden de Servicio
 * @returns {Object|null} - { lat, lng, latitud, longitud, campoOrigen, coordenadasRaw }
 */
function extraerCoordenadas(os) {
    // ========================================
    // ‚úÖ PRIORIDAD 1: Coordendasgis (GIS) - EXPL√çCITO
    // ========================================
    if (os.Coordendasgis && typeof os.Coordendasgis === 'string' && os.Coordendasgis.includes(',')) {
        const partes = os.Coordendasgis.split(',').map(c => parseFloat(c.trim()));
        if (partes.length === 2 && !isNaN(partes[0]) && !isNaN(partes[1]) && 
            Math.abs(partes[0]) <= 90 && Math.abs(partes[1]) <= 180) {
            
            const lat = partes[0];
            const lng = partes[1];
            
            console.log(`‚úÖ Coordenadas encontradas en "Coordendasgis": ${os.Coordendasgis}`);
            return {
                // ‚úÖ Compatibilidad con Leaflet y c√≥digo moderno
                lat: lat,
                lng: lng,
                // ‚úÖ Compatibilidad con c√≥digo legacy
                latitud: lat,
                longitud: lng,
                // ‚úÖ Metadatos para debugging
                campoOrigen: 'Coordendasgis',
                coordenadasRaw: os.Coordendasgis
            };
        }
    }
    
    // ========================================
    // ‚úÖ PRIORIDAD 2: Coordenadas (Lector) - EXPL√çCITO
    // ========================================
    if (os.Coordenadas && typeof os.Coordenadas === 'string' && os.Coordenadas.includes(',')) {
        const partes = os.Coordenadas.split(',').map(c => parseFloat(c.trim()));
        if (partes.length === 2 && !isNaN(partes[0]) && !isNaN(partes[1]) && 
            Math.abs(partes[0]) <= 90 && Math.abs(partes[1]) <= 180) {
            
            const lat = partes[0];
            const lng = partes[1];
            
            console.log(`‚úÖ Coordenadas encontradas en "Coordenadas": ${os.Coordenadas}`);
            return {
                lat: lat,
                lng: lng,
                latitud: lat,
                longitud: lng,
                campoOrigen: 'Coordenadas',
                coordenadasRaw: os.Coordenadas
            };
        }
    }
    
    // ========================================
    // ‚úÖ PRIORIDAD 3: Campos alternativos (case-insensitive)
    // ========================================
    const camposAlternativos = [
        'coordenadas', 'coordendasgis', 'Coordenada', 'coordenada',
        'latitud_longitud', 'ubicacion'
    ];
    
    for (const campo of camposAlternativos) {
        if (os[campo] && typeof os[campo] === 'string' && os[campo].includes(',')) {
            const partes = os[campo].split(',').map(c => parseFloat(c.trim()));
            if (partes.length === 2 && !isNaN(partes[0]) && !isNaN(partes[1]) && 
                Math.abs(partes[0]) <= 90 && Math.abs(partes[1]) <= 180) {
                
                const lat = partes[0];
                const lng = partes[1];
                
                console.log(`‚úÖ Coordenadas encontradas en "${campo}": ${os[campo]}`);
                return {
                    lat: lat,
                    lng: lng,
                    latitud: lat,
                    longitud: lng,
                    campoOrigen: campo,
                    coordenadasRaw: os[campo]
                };
            }
        }
    }
    
    // ========================================
    // ‚úÖ PRIORIDAD 4: Campos separados (lat/lng)
    // ========================================
    const latVal = os.Latitud || os.latitud || os.latitude;
    const lngVal = os.Longitud || os.longitud || os.longitude;
    
    if (latVal && lngVal) {
        const lat = parseFloat(latVal);
        const lng = parseFloat(lngVal);
        if (!isNaN(lat) && !isNaN(lng) && Math.abs(lat) <= 90 && Math.abs(lng) <= 180) {
            console.log(`‚úÖ Coordenadas separadas encontradas: ${lat},${lng}`);
            return {
                lat: lat,
                lng: lng,
                latitud: lat,
                longitud: lng,
                campoOrigen: 'campos_separados',
                coordenadasRaw: `${lat},${lng}`
            };
        }
    }
    
    // ========================================
    // ‚ùå Sin coordenadas v√°lidas
    // ========================================
    console.warn(`‚ö†Ô∏è OS ${os.OSATMO || os.OSATOMO || os.osatomo || 'SIN ID'} no tiene coordenadas v√°lidas en ning√∫n campo`);
    return null;
}




// ==========================================
// üõ°Ô∏è MOTOR GEOGR√ÅFICO GLOBAL (Corregido)
// ==========================================

function calcularDistanciaKm(lat1, lon1, lat2, lon2) {
    if (lat1 === undefined || lat2 === undefined || isNaN(lat1) || isNaN(lat2)) return Infinity;
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return parseFloat((R * c).toFixed(2));
}



// Alias globales para que el mapa y los filtros los encuentren siempre
window.calcularDistancia = calcularDistanciaKm;
var calcularDistancia = calcularDistanciaKm; 

function parsearCoordenadas(coordString) {
    if (!coordString || typeof coordString !== 'string') return null;
    const limpia = coordString.trim();
    if (!limpia.includes(',')) return null;
    const partes = limpia.split(',').map(c => parseFloat(c.trim()));
    
    if (isNaN(partes[0]) || isNaN(partes[1])) return null;
    if (Math.abs(partes[0]) > 90 || Math.abs(partes[1]) > 180) return null;

    return { lat: partes[0], lng: partes[1] };
}
window.parsearCoordenadas = parsearCoordenadas;

console.log("‚úÖ Motor de distancias y coordenadas original listo.");



/**
 * Valida si una OS cumple con los filtros aplicados
 * @param {Object} os - Objeto de Orden de Servicio  
 * @param {Object|null} filtros - Objeto de filtros o null
 * @returns {boolean} - true si cumple los filtros o si no hay filtros que aplicar
 */
function validarFiltrosOS(os, filtros) {
    // ‚úÖ Sin filtros = permitir (las OS ya pasaron prioridad y estado)
    if (!filtros) return true;
    
    const normalizar = (texto) => (texto || "")
        .toString()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim()
        .toUpperCase();
    
    const osID = os.OSATMO || "Sin ID";
    
    // ‚úÖ PRIORIDAD: Reguladas y Deuda >= $500 pasan siempre
    const tipoOS_Texto = (os.Tipo_de_OS || '').toLowerCase();
    const esRegulada = tipoOS_Texto.includes('regulad') && !tipoOS_Texto.includes('no');
    const deudaTotal = parseFloat(os.Deuda) || 0;
    const esDeudaAlta = deudaTotal >= 500;
    
    if (esRegulada || esDeudaAlta) return true;
    
    // ‚úÖ Validar disponibilidad
    const unidad = (os.Unidad || "").trim();
    const estado = (os.Estado_ATOMO || "").trim().toUpperCase();
    const estaLibre = unidad === "" || unidad === "--------------------" || unidad.includes("---");
    const esRegistrada = estado === "REGISTRADA";
    
    if (!estaLibre || !esRegistrada) return false;
    
    // ‚úÖ Preparar filtros activos (normalizar UNA vez)
    const tipologiasActivas = Array.isArray(filtros.tipologias) && filtros.tipologias.length > 0 
        ? filtros.tipologias.map(t => normalizar(t)) 
        : null;
    
    const rangosActivos = Array.isArray(filtros.rangos) && filtros.rangos.length > 0 
        ? filtros.rangos 
        : null;
    
    // ‚úÖ Sin criterios activos = permitir
    if (!tipologiasActivas && !rangosActivos) return true;
    
    // ‚úÖ Validar tipolog√≠a
    if (tipologiasActivas) {
        const tipOS_Actual = normalizar(os.Tipologia);
        if (!tipologiasActivas.some(t => tipOS_Actual === t)) return false;
    }
    
    // ‚úÖ Validar rango
    if (rangosActivos) {
        if (!os['Fecha Gen.']) return false;
        const dias = calcularDias(os['Fecha Gen.']);
        const miRango = determinarRango(dias);
        if (!rangosActivos.includes(miRango)) return false;
    }
    
    return true;
}
// ========================================
// üíæ GUARDAR FILTROS (ADMIN GLOBAL / DESPACHO PERSONAL) - CON FECHA DE VIGENCIA
// ========================================
async function guardarFiltrosMapaGlobales() {
¬†   // üîí VALIDAR PERMISOS
¬†   if (currentUser.rol !== 'Administrador' && currentUser.rol !== 'Despacho') {
¬†       alert('‚ö†Ô∏è Solo Administradores y Despacho pueden modificar filtros');
¬†       return;
¬†   }

¬†   // 1Ô∏è‚É£ Obtener rangos y tipolog√≠as seleccionadas
¬†   const rangosCheckboxes = document.querySelectorAll('input[type="checkbox"][value]');
¬†   const rangos = [];
¬†   const tipologias = [];
¬†   rangosCheckboxes.forEach(cb => {
¬†       if (cb.checked && cb.value) {
¬†           const valor = cb.value;
¬†           if (valor.includes('-') || valor.startsWith('>')) {
¬†               rangos.push(valor);
¬†           } else if (!['todosRangos', 'todasTipologias'].includes(cb.id)) {
¬†               tipologias.push(valor);
¬†           }
¬†       }
¬†   });

¬†   // 2Ô∏è‚É£ Obtener radio
¬†   let radioKmElement = document.getElementById('radioKm');
¬†   if (!radioKmElement) radioKmElement = document.getElementById('radioKmGlobal');
¬†   if (!radioKmElement) radioKmElement = document.querySelector('input[type="number"][id*="radio"]');
¬†   const radioKm = radioKmElement ? parseInt(radioKmElement.value) : 3;

¬†   // 3Ô∏è‚É£ üÜï Obtener fecha de vigencia
¬†   const fechaVigenciaInput = document.getElementById('fechaVigenciaFiltros');
¬†   const fechaVigencia = fechaVigenciaInput?.value || null;

¬†   // 4Ô∏è‚É£ Validaciones
¬†   if (radioKm < 1 || radioKm > 20) {
¬†       alert('‚ö†Ô∏è El radio debe estar entre 1 y 20 km');
¬†       return;
¬†   }

¬†   // 5Ô∏è‚É£ Confirmar acci√≥n
¬†   const esDespacho = currentUser.rol === 'Despacho';
¬†   const confirmar = confirm(
¬†       `¬ø${esDespacho ? 'Guardar TUS filtros personales' : 'SUSTITUIR filtros globales'}?\\n` +
¬†       `üìä VALORES:\\n` +
¬†       `‚Ä¢ Rangos: ${rangos.length > 0 ? rangos.join(', ') : 'Ninguno'}\\n` +
¬†       `‚Ä¢ Tipolog√≠as: ${tipologias.length}\\n` +
¬†       `‚Ä¢ Radio: ${radioKm} km\\n` +
¬†       `${fechaVigencia ? `‚Ä¢ Fecha de Vigencia: ${fechaVigencia}\n` : ''}` +
¬†       `${esDespacho ? 'Solo T√ö ver√°s estos filtros' : '‚ö†Ô∏è Esto afectar√° a TODOS los usuarios'}\\n\\n` +
¬†       `‚úÖ S√ç - Guardar\\n‚ùå NO - Cancelar`
¬†   );
¬†
¬†   if (!confirmar) return;

¬†   try {
¬†       const rangosAGuardar = rangos.length > 0 ? rangos : null;
¬†       const tipologiasAGuardar = tipologias.length > 0 ? tipologias : null;
¬†
¬†       // üïµÔ∏è LOG DE AUDITOR√çA PRE-ENV√çO: Verificamos qu√© tiene el objeto currentUser
¬†       console.log("üîç [DEBUG] Verificando sesi√≥n antes de guardar:", {
¬†           usuarioActual: currentUser?.usuario,
¬†           rolActual: currentUser?.rol,
¬†           objetoCompleto: currentUser
¬†       });

¬†       // üÜï L√ìGICA SEPARADA POR ROL
¬†       if (esDespacho) {
¬†           // ‚úÖ DESPACHO: Guardar con su usuario espec√≠fico
¬†           const { data, error } = await supabaseClient
¬†               .from('filtros_mapa')
¬†               .upsert({
¬†                   usuario: currentUser.usuario,
¬†                   rangos: rangosAGuardar,
¬†                   tipologias: tipologiasAGuardar,
¬†                   radio_km: radioKm,
¬†                   fecha_actualizacion: new Date().toISOString(),
¬†                   fecha_vigencia: fechaVigencia
¬†               }, {
¬†                   onConflict: 'usuario'
¬†               })
¬†               .select(); // üïµÔ∏è Log para validar qu√© regres√≥ la DB

¬†           if (error) {
¬†               console.error("‚ùå [ERROR DB - Despacho]:", error.message);
¬†               alert('‚ùå Error: ' + error.message);
¬†               return;
¬†           }
¬†
¬†           console.log("‚úÖ [SUCCESS DB - Despacho]:", data);
¬†           alert('‚úÖ Tus filtros personales fueron guardados correctamente');

¬†       } else {
¬†           // ‚úÖ ADMIN: Actualizar filtro global (ID 1)
¬†           const { data, error } = await supabaseClient
¬†               .from('filtros_mapa')
¬†               .upsert({
¬†                   id: 1,
¬†                   usuario: currentUser.usuario,
¬†                   rangos: rangosAGuardar,
¬†                   tipologias: tipologiasAGuardar,
¬†                   radio_km: radioKm,
¬†                   fecha_actualizacion: new Date().toISOString(),
¬†                   fecha_vigencia: fechaVigencia
¬†               }, {
¬†                   onConflict: 'id'
¬†               })
¬†               .select(); // üïµÔ∏è Log para validar qu√© regres√≥ la DB

¬†           if (error) {
¬†               console.error("‚ùå [ERROR DB - Admin]:", error.message);
¬†               alert('‚ùå Error: ' + error.message);
¬†               return;
¬†           }

¬†           console.log("‚úÖ [SUCCESS DB - Admin]:", data);
¬†           alert(`‚úÖ Filtros globales actualizados por ${currentUser.usuario || 'Sistema'}`);
¬†       }

¬†   } catch (err) {
¬†       console.error('üö® [ERROR CR√çTICO]:', err);
¬†       alert('‚ùå Error de conexi√≥n o ejecuci√≥n');
¬†   }
} // <--- ASEG√öRATE DE QUE ESTA LLAVE CIERRE LA FUNCI√ìN PRINCIPAL (guardarFiltrosMapa)

/**
 * Inicializa variables globales del mapa de forma segura
 */
function inicializarVariablesGlobalesMapa() {
    // ‚úÖ Inicializar solo si no existen (evita sobrescribir durante recargas)
    if (!window.markersPorTipologia) {
        window.markersPorTipologia = {};
    }
    
    if (!window.markersPorEstado) {
        window.markersPorEstado = {
            'centro': [],
            'asignada': [],
            'regulada': [],
            'no_regulada': [],
            'deuda_alta': [],
            'deuda_media': [],
            'deuda_baja': []
        };
    }
    
    if (!window.filtrosAplicados) {
        window.filtrosAplicados = { 
            rangos: null, 
            tipologias: null, 
            radio_km: 3 
        };
    }
    
    // ‚úÖ Limpiar marcadores previos para evitar duplicados
    if (window.mapaLeafletInstance) {
        try {
            Object.values(window.markersPorEstado).forEach(arr => {
                arr.forEach(marker => {
                    if (window.mapaLeafletInstance.hasLayer(marker)) {
                        window.mapaLeafletInstance.removeLayer(marker);
                    }
                });
            });
        } catch (e) {
            console.warn('‚ö†Ô∏è Error limpiando marcadores previos:', e);
        }
    }
}
¬†

function generarMapaLeaflet(osCentro, osEnRadio, latCentro, lngCentro, radioKm) {
    // ‚úÖ Inicializar variables globales primero
    inicializarVariablesGlobalesMapa();
    console.log('üó∫Ô∏è ==========================================');
    console.log('üó∫Ô∏è GENERANDO MAPA LEAFLET');
    console.log('üó∫Ô∏è OS recibidas:', osEnRadio?.length || 0);
    console.log('üó∫Ô∏è ==========================================');

    const resultsContainer = document.getElementById('searchResults');
    const osValidadasParaMapa = osEnRadio || [];

    // üìä C√ÅLCULO DE TOTALES PARA BOTONES DE ESTADO
    const conteoEstados = {
        centro: 1,
        asignada: 0,
        regulada: 0,
        no_regulada: 0,
        deuda_alta: 0
    };

    osValidadasParaMapa.forEach(os => {
        const idActual = String(os.OSATMO || "").trim();
        const idCentro = String(osCentro.OSATMO || "").trim();

        if (idActual === idCentro && idCentro !== "") {
            conteoEstados.centro++;
        } else {
            const tipoBusqueda = (os.Tipo_de_OS || '').toUpperCase();
            const deuda = parseFloat(os.Deuda) || 0;
            const unidad = (os.Unidad || "").trim();
            
            const esRegulada = tipoBusqueda.includes('REGULADA') && !tipoBusqueda.includes('NO');
            const esDeudaAlta = deuda >= 500;
            const estaAsignada = (unidad !== "" && unidad !== "--------------------" && !unidad.includes("---"));

            if (esRegulada) {
                conteoEstados.regulada++;
            } else if (esDeudaAlta) {
                conteoEstados.deuda_alta++;
            } else if (estaAsignada) {
                conteoEstados.asignada++;
            } else {
                conteoEstados.no_regulada++;
            }
        }
    });

    // Limpieza de instancia previa
    if (window.mapaLeafletInstance) {
        try {
            window.mapaLeafletInstance.remove();
        } catch (e) {
            console.warn('‚ö†Ô∏è Error limpiando mapa anterior:', e);
        }
        window.mapaLeafletInstance = null;
    }

    // Contar y Ordenar Tipolog√≠as
    const conteoPorTipologia = {};
    osValidadasParaMapa.forEach(os => {
        const tip = os.Tipologia || 'Sin tipolog√≠a';
        conteoPorTipologia[tip] = (conteoPorTipologia[tip] || 0) + 1;
    });

    console.log('üìä Conteo por estado:');
    console.table(conteoEstados);

    const tipologiasOrdenadas = Object.entries(conteoPorTipologia)
        .sort((a, b) => b[1] - a[1]);

    const radioActual = window.filtrosAplicados?.radio_km || radioKm || 3;

    // 4. Generar HTML con los contadores inyectados
    resultsContainer.innerHTML = `
        <div class="result-card" style="background: #f0f9ff; border: 2px solid #3b82f6;">
            <div class="result-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span>üó∫Ô∏è Mapa de Rutas - OS ${osCentro.OSATMO || osCentro.OS}</span>
                <span style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: bold;">
                    ${osValidadasParaMapa.length} √≥rdenes visibles en ${radioActual} km
                </span>
            </div>

            <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #e2e8f0;">
                <strong style="display: block; margin-bottom: 10px; color: #1e40af;">Leyenda de Estados (Click para filtrar mapa):</strong>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 13px;">
                    <button onclick="filtrarPorEstado('centro')" style="background: #4caf50; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        üü¢ Tu OS <span style="background: rgba(0,0,0,0.2); padding: 1px 6px; border-radius: 4px; font-size: 11px;">${conteoEstados.centro}</span>
                    </button>
                    <button onclick="filtrarPorEstado('asignada')" style="background: #ff9800; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        üü† Asignadas <span style="background: rgba(0,0,0,0.2); padding: 1px 6px; border-radius: 4px; font-size: 11px;">${conteoEstados.asignada}</span>
                    </button>
                    <button onclick="filtrarPorEstado('regulada')" style="background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        üî¥ Reguladas <span style="background: rgba(0,0,0,0.2); padding: 1px 6px; border-radius: 4px; font-size: 11px;">${conteoEstados.regulada}</span>
                    </button>
                    <button onclick="filtrarPorEstado('no_regulada')" style="background: #2196f3; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        üîµ No Reguladas <span style="background: rgba(0,0,0,0.2); padding: 1px 6px; border-radius: 4px; font-size: 11px;">${conteoEstados.no_regulada}</span>
                    </button>
                    <button onclick="filtrarPorEstado('deuda_alta')" style="background: #795548; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        üí∞ Deuda ‚â• 500 <span style="background: rgba(0,0,0,0.2); padding: 1px 6px; border-radius: 4px; font-size: 11px;">${conteoEstados.deuda_alta}</span>
                    </button>
                    <button onclick="filtrarPorEstado('todas')" style="background: #64748b; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        üîÑ Ver Todas <span style="background: rgba(0,0,0,0.2); padding: 1px 6px; border-radius: 4px; font-size: 11px;">${osValidadasParaMapa.length}</span>
                    </button>
                </div>
            </div>

            <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #e2e8f0;">
                <strong style="display: block; margin-bottom: 10px; color: #1e40af;">üìä Tipolog√≠as en radio (Filtradas):</strong>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 8px;">
                    ${tipologiasOrdenadas.map(([tip, count]) => `
                        <div onclick="resaltarTipologiaEnMapa('${tip.replace(/'/g, "\\'")}')"
                             style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px; border-left: 4px solid #3b82f6; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee;">
                            <span style="font-size: 13px; color: #475569; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;" title="${tip}">${tip}</span>
                            <strong style="color: #3b82f6; background: #dbeafe; padding: 2px 8px; border-radius: 4px;">${count}</strong>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div id="mapaLeaflet" style="width: 100%; height: 550px; border-radius: 12px; border: 1px solid #cbd5e1; z-index: 1;"></div>

            <div id="panelDetalleOS" style="margin-top: 20px;">
                <div style="text-align: center; padding: 30px; color: #64748b; background: white; border-radius: 12px; border: 2px dashed #cbd5e1;">
                    <p style="font-size: 15px;">üìç Haz clic en un marcador para ver el detalle de la orden</p>
                </div>
            </div>
        </div>
    `;

    // 5. Inicializaci√≥n diferida - PASAR ARRAY (inicializarMapaLeaflet har√° el agrupamiento)
    setTimeout(() => {
        if (document.getElementById('mapaLeaflet')) {
            try {
                // ‚úÖ PASAR ARRAY DIRECTAMENTE
                inicializarMapaLeaflet(osCentro, osValidadasParaMapa, latCentro, lngCentro, radioActual);
                
                if(window.mapaLeafletInstance) window.mapaLeafletInstance.invalidateSize();
            } catch (error) {
                console.error('‚ùå Error inicializando mapa:', error);
                console.error('Stack:', error.stack);
            }
        }
    }, 700);

    window.datosMapaExportar = osValidadasParaMapa;
}


// ========================================
// üîÑ ACTUALIZAR RADIO DEL MAPA (VERSI√ìN CORREGIDA)
// ========================================
function actualizarRadioMapa(nuevoRadio, actualizarAutomatico = true) {
    // ‚úÖ Convertir a n√∫mero y validar
    const radioNum = parseFloat(nuevoRadio);
    if (isNaN(radioNum) || radioNum < 1 || radioNum > 20) {
        console.error('‚ùå Radio inv√°lido:', nuevoRadio);
        return;
    }

    // ‚úÖ Actualizar UI
    const valorRadioKm = document.getElementById('valorRadioKm');
    const sliderRadioKm = document.getElementById('sliderRadioKm');

    if (valorRadioKm) {
        valorRadioKm.textContent = `${radioNum} km`;
    }

    if (sliderRadioKm) {
        sliderRadioKm.value = radioNum;
    }

    console.log('üìç Radio actualizado a:', radioNum, 'km');

    // ‚úÖ Solo actualizar el mapa si es necesario
    if (actualizarAutomatico &&
        window.mapaLeafletInstance &&
        window.osCentroActual &&
        window.osEnRadioActual) {

        try {
            // ‚úÖ Recalcular OS en radio con el nuevo radio
            const osCentro = window.osCentroActual;
            const coordsCentro = osCentro.Coordenadas || osCentro.Coordendasgis;

            if (!coordsCentro || !coordsCentro.includes(',')) {
                console.error('‚ùå Coordenadas del centro inv√°lidas:', coordsCentro);
                return;
            }

            const [latCentro, lngCentro] = coordsCentro.split(',').map(c => parseFloat(c.trim()));

            const osEnRadio = window.osEnRadioActual.filter(os => {
                if (os.lat && os.lng) {
                    const distancia = calcularDistanciaKm(latCentro, lngCentro, os.lat, os.lng);
                    return distancia <= radioNum;
                }
                return false;
            });

            // ‚úÖ Actualizar el t√≠tulo del mapa
            const header = document.querySelector('.result-header');
            if (header) {
                header.innerHTML = `üó∫Ô∏è Mapa de Rutas - OS ${osCentro.OSATMO} (${osEnRadio.length} OS en ${radioNum} km)`;
            }

            // ‚úÖ 1. Actualizar el c√≠rculo si existe
            if (window.circuloRadio) {
                window.circuloRadio.setRadius(radioNum * 1000);
                window.circuloRadio.setPopupContent(`√Årea de b√∫squeda: ${radioNum} km de radio`);
            }

            // ‚úÖ 2. Eliminar marcadores previos (mejorado con seguridad)
            if (window.markersPorEstado) {
                Object.values(window.markersPorEstado).forEach(markersArray => {
                    markersArray.forEach(marker => {
                        if (marker !== window.markersPorEstado.centro?.[0] &&
                            window.mapaLeafletInstance.hasLayer(marker)) {
                            window.mapaLeafletInstance.removeLayer(marker);
                        }
                    });
                });
            }

            // ‚úÖ RE-INICIALIZAR CONTENEDORES (Crucial para que el filtro no falle)
            window.markersPorTipologia = {};
            window.markersPorEstado = { 
                'centro': [window.markerCentro],
                'asignada': [], 
                'regulada': [], 
                'no_regulada': [], 
                'deuda_alta': [],
                'deuda_media': [],
                'deuda_baja': []
            };

            // ‚úÖ 3. Agregar nuevos marcadores
            osEnRadio.forEach(os => {
                // Uso de parseador para asegurar que lat/lng sean n√∫meros
                const coords = parsearCoordenadas(os.lat + ',' + os.lng) || { lat: os.lat, lng: os.lng };
                if (!coords.lat || !coords.lng) return;

                // --- Determinar estado y color ---
                const tipoOS = (os.Tipo_de_OS || '').toLowerCase();
                const esRegulada = tipoOS.includes('regulad') && !tipoOS.includes('no');
                const deuda = parseFloat(os.Deuda) || 0;

                let colorFondo, labelEstado, estadoKey;

                const estaAsignada = os.Estado_ATOMO === 'Asignada' || 
                                     os.Estado_SAP === 'ASIGNADA' || 
                                     (os.Unidad && os.Unidad.trim() !== "" && !os.Unidad.includes("---"));

                if (estaAsignada) {
                    colorFondo = '#ff9800';
                    labelEstado = 'OS ASIGNADA';
                    estadoKey = 'asignada'; 
                } 
                else if (deuda > 500) {
                    colorFondo = '#fdd835'; 
                    labelEstado = 'DEUDA ALTA (>$500)';
                    estadoKey = 'deuda_alta';
                } else if (deuda >= 100 && deuda <= 500) {
                    colorFondo = '#ff9800'; 
                    labelEstado = 'DEUDA MEDIA ($100-$500)';
                    estadoKey = 'deuda_media';
                } else if (deuda >= 50 && deuda < 100) {
                    colorFondo = '#f48fb1'; 
                    labelEstado = 'DEUDA BAJA ($50-$100)';
                    estadoKey = 'deuda_baja';
                } else if (esRegulada) {
                    colorFondo = '#f44336'; 
                    labelEstado = 'OS REGULADA';
                    estadoKey = 'regulada';
                } else {
                    colorFondo = '#2196f3'; 
                    labelEstado = 'OS NO REGULADA';
                    estadoKey = 'no_regulada';
                }

                // --- Crear icono numerado ---
                const icono = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background: ${colorFondo};
                        color: white;
                        width: 35px;
                        height: 35px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 14px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        border: 3px solid white;
                    ">${os.numeroOrden || 'X'}</div>`,
                    iconSize: [35, 35],
                    iconAnchor: [17.5, 35]
                });

                // ‚úÖ Escape seguro para datos en popup
                const osDataEscaped = typeof escapeJSONForHTMLAttribute === 'function'
                    ? escapeJSONForHTMLAttribute(os, ['OSATMO', 'Tipologia', 'Deuda', 'Coordenadas', 'Coordendasgis', 'Unidad'])
                    : JSON.stringify(os).replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                const marker = L.marker([coords.lat, coords.lng], { icon: icono })
                    .addTo(window.mapaLeafletInstance)
                    .bindPopup(`
                        <div style="min-width: 250px; font-family: sans-serif;">
                            <strong style="color: ${colorFondo};">#${os.numeroOrden || 'X'} - ${labelEstado}</strong><br>
                            <strong>OS:</strong> ${os.OSATMO}<br>
                            <strong>Tipolog√≠a:</strong> ${os.Tipologia || 'N/A'}<br>
                            ${deuda > 0 ? `<strong>Deuda:</strong> $${deuda.toFixed(2)}<br>` : ''}
                            ${os.distancia ? `<strong>Distancia:</strong> ${os.distancia.toFixed(2)} km<br>` : ''}
                            <button onclick="event.stopPropagation(); if(typeof mostrarDetalleOSEnPanel==='function'){mostrarDetalleOSEnPanel(${osDataEscaped}, '${labelEstado.replace(/'/g, "\\'")}');}"
                                style="margin-top: 10px; background: ${colorFondo}; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; width: 100%;">
                                üìã Ver Detalle Completo
                            </button>
                        </div>
                    `);

                // ‚úÖ AGRUPAR por estado y tipolog√≠a
                window.markersPorEstado[estadoKey].push(marker);

                const tip = os.Tipologia || 'Sin tipolog√≠a';
                if (!window.markersPorTipologia[tip]) {
                    window.markersPorTipologia[tip] = [];
                }
                window.markersPorTipologia[tip].push(marker);
            });

            // ‚úÖ 4. Ajustar vista del mapa
            const bounds = L.latLngBounds();
            bounds.extend([latCentro, lngCentro]);

            osEnRadio.forEach(os => {
                if (os.lat && os.lng) {
                    bounds.extend([os.lat, os.lng]);
                }
            });

            if (bounds.isValid()) {
                window.mapaLeafletInstance.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 16
                });
            }

            console.log(`‚úÖ Mapa actualizado con radio de ${radioNum} km (${osEnRadio.length} OS en radio)`);

        } catch (error) {
            console.error('‚ùå Error al actualizar el mapa:', error);
            console.error('Stack:', error.stack);
        }
    }
}


// ========================================
// 3Ô∏è‚É£ NUEVA FUNCI√ìN: FILTRAR MAPA POR ESTADO (CORREGIDA)
// ========================================
function filtrarPorEstado(estado) {
    const mapa = window.mapaLeafletInstance;
    
    // 1. Verificaci√≥n de seguridad
    if (!mapa || !window.markersPorEstado) {
        console.error('‚ùå Mapa o marcadores no inicializados');
        return;
    }

    console.log(`üîç Filtrando por estado: ${estado}`);
    window.estadoFiltrado = estado;

    const bounds = L.latLngBounds();
    let hayMarcadoresVisibles = false;

    // 2. Procesar visibilidad de marcadores
    Object.entries(window.markersPorEstado).forEach(([key, markersArray]) => {
        const debeMostrarse = (estado === 'todas' || key.toLowerCase() === estado.toLowerCase());

    markersArray.forEach(marker => {
        if (debeMostrarse) {
            if (!mapa.hasLayer(marker)) mapa.addLayer(marker);
            bounds.extend(marker.getLatLng());
            hayMarcadoresVisibles = true;
        } else {
            if (mapa.hasLayer(marker)) mapa.removeLayer(marker);
        }
    });
});


    // 3. Ajustar vista SOLO si hay marcadores v√°lidos (Evita el error de consola)
    if (hayMarcadoresVisibles) {
        // Solo hacemos fitBounds si el √°rea es v√°lida
        if (bounds.isValid()) {
            mapa.fitBounds(bounds, { 
                padding: [50, 50], 
                maxZoom: 16,
                animate: true 
            });
        }
    } else {
        console.warn(`‚ö†Ô∏è No hay marcadores para el estado: ${estado}`);
        // Opcional: Si no hay nada que mostrar, centrar en la OS principal
        if (window.markerCentro) {
            mapa.setView(window.markerCentro.getLatLng(), 15);
        }
    }
}


¬†	// ========================================
// üîç BUSCAR OS EN MAPA (Y MOSTRAR DETALLE)
// ========================================
function buscarOSEnMapa() {
¬†   const busqueda = document.getElementById('buscarEnListado').value.trim();
¬†   if (!busqueda) {
¬†       alert('Ingrese una OS');
¬†       return;
¬†   }
¬†
¬†   const mapa = window.mapaLeafletInstance;
¬†   if (!mapa || !window.markersPorTipologia) {
¬†       alert('Mapa no inicializado');
¬†       return;
¬†   }
¬†
¬†   let encontrado = false;
¬†
¬†   // Buscar en todos los markers
¬†   Object.values(window.markersPorTipologia).forEach(markersArray => {
¬†       markersArray.forEach(marker => {
¬†           // Buscar en los datos guardados
¬†           if (window.datosMapaExportar) {
¬†               const os = window.datosMapaExportar.find(o => o.OSATMO && o.OSATMO.includes(busqueda));
¬†
¬†               if (os) {
¬†                   encontrado = true;
¬†
¬†                   // Centrar mapa en el marker
¬†                   mapa.setView([os.lat, os.lng], 16, {
¬†                       animate: true,
¬†                       duration: 1
¬†                   });
¬†
¬†                   // Animar el marker
¬†                   const icon = marker.getElement();
¬†                   if (icon) {
¬†                       icon.style.animation = 'bounce 1s ease-in-out 5';
¬†                       setTimeout(() => {
¬†                           icon.style.animation = '';
¬†                       }, 5000);
¬†                   }
¬†
¬†                   // Mostrar detalle en el panel
¬†                   const labelEstado = os.esRegulada ? 'üî¥ REGULADA' :
¬†                                      (os.Estado_ATOMO === 'Asignada' ? 'üü† ASIGNADA' : 'üîµ NO REGULADA');
¬†                   mostrarDetalleOSEnPanel(os, labelEstado);
¬†               }
¬†           }
¬†       });
¬†   });
¬†
¬†   if (!encontrado) {
¬†       alert(`OS "${busqueda}" no encontrada en el mapa`);
¬†   }
}







// üîÑ RECARGAR MAPA CON FILTROS ACTUALIZADOS
// ========================================
async function recargarMapaConFiltrosActualizados() {
    if (!window.osCentroActual) {
        alert('No hay mapa cargado');
        return;
    }
    
    console.log('üîÑ Recargando mapa con filtros actualizados...');
    await cargarYMostrarMapa(window.osCentroActual, window.unidadFiltroActual);
}

// ‚úÖ Exponer globalmente para que funcione en onclick
window.recargarMapaConFiltrosActualizados = recargarMapaConFiltrosActualizados;





// ========================================
// üóëÔ∏è LIMPIAR FILTROS Y RECARGAR MAPA
// ========================================
async function limpiarFiltrosMapaYRecargar() {
¬†   const confirmar = confirm(
¬†       'üóëÔ∏è ¬øLimpiar TODOS los filtros?\n\n' +
¬†       'Esto eliminar√°:\n' +
¬†       '‚Ä¢ Rangos de d√≠as seleccionados\n' +
¬†       '‚Ä¢ Tipolog√≠as seleccionadas\n\n' +
¬†       'El mapa mostrar√° TODAS las OS en el radio.\n\n' +
¬†       '‚úÖ S√ç - Limpiar y recargar\n' +
¬†       '‚ùå NO - Cancelar'
¬†   );
¬†
¬†   if (!confirmar) return;
¬†
¬†   try {
¬†       // 1Ô∏è‚É£ Actualizar BD con filtros vac√≠os
¬†       const { error } = await supabaseClient
¬†           .from('filtros_mapa')
¬†           .update({
¬†               rangos: null,
¬†               tipologias: null,
¬†               fecha_actualizacion: new Date().toISOString()
¬†           })
¬†           .eq('id', 1);
¬†
¬†       if (error) {
¬†           alert('‚ùå Error limpiando filtros: ' + error.message);
¬†           return;
¬†       }
¬†
¬†       // 2Ô∏è‚É£ Limpiar checkboxes de rangos
¬†       document.querySelectorAll('input[type="checkbox"][value]').forEach(cb => {
¬†           const valor = cb.value;
¬†           if (valor && (valor.includes('-') || valor.startsWith('>'))) {
¬†               cb.checked = false;
¬†           }
¬†       });
¬†
¬†       // 3Ô∏è‚É£ Limpiar checkboxes de tipolog√≠as
¬†       document.querySelectorAll('input[type="checkbox"][value]').forEach(cb => {
¬†           const valor = cb.value;
¬†           if (valor && !valor.includes('-') && !valor.startsWith('>') &&
¬†               !['todosRangos', 'todasTipologias'].includes(cb.id)) {
¬†               cb.checked = false;
¬†           }
¬†       });
¬†
¬†       // 4Ô∏è‚É£ Desmarcar "Seleccionar todos"
¬†       const todosRangos = document.getElementById('todosRangos');
¬†       const todasTipologias = document.getElementById('todasTipologias');
¬†       if (todosRangos) todosRangos.checked = false;
¬†       if (todasTipologias) todasTipologias.checked = false;
¬†
¬†       // 5Ô∏è‚É£ Actualizar cache global
¬†       window.filtrosAplicados = {
¬†           rangos: [],
¬†           tipologias: [],
¬†           radio_km: window.filtrosAplicados.radio_km || 3
¬†       };
¬†
¬†       // 6Ô∏è‚É£ Recargar mapa si existe
¬†       if (window.osCentroActual) {
¬†           await cargarYMostrarMapa(window.osCentroActual, window.unidadFiltroActual);
¬†           alert('‚úÖ Filtros eliminados - Mostrando todas las OS');
¬†       } else {
¬†           alert('‚úÖ Filtros eliminados. Realiza una nueva b√∫squeda para ver los cambios.');
¬†       }
¬†
¬†   } catch (err) {
¬†       console.error('Error limpiando filtros:', err);
¬†       alert('‚ùå Error de conexi√≥n');
¬†   }
}




// ========================================
// üîç BUSCAR OS EN LISTADO
// ========================================
function buscarOSEnListado() {
¬†   const busqueda = document.getElementById('buscarEnListado').value.trim();
¬†   if (!busqueda) {
¬†       alert('Ingrese una OS');
¬†       return;
¬†   }
¬†
¬†   const tabla = document.getElementById('tablaOSMapa');
¬†   const filas = tabla.querySelectorAll('tbody tr');
¬†   let encontrada = false;
¬†
¬†   filas.forEach(fila => {
¬†       const textoOS = fila.cells[0].textContent;
¬†       if (textoOS.includes(busqueda)) {
¬†           fila.style.background = '#fff3cd';
¬†           fila.scrollIntoView({ behavior: 'smooth', block: 'center' });
¬†           encontrada = true;
¬†
¬†           setTimeout(() => { fila.style.background = ''; }, 3000);
¬†       }
¬†   });
¬†
¬†   if (!encontrada) alert(`OS "${busqueda}" no encontrada en el listado`);
}


function dibujarMarcadores(mapa, ordenes) {
    // 1. Limpiar capas anteriores si existen para no duplicar puntos
    if (window.capaMarcadores) {
        mapa.removeLayer(window.capaMarcadores);
    }
    
    // 2. Crear un grupo nuevo y a√±adirlo al mapa
    window.capaMarcadores = L.featureGroup().addTo(mapa);

    ordenes.forEach(os => {
        // Validaci√≥n estricta de coordenadas
        const lat = parseFloat(os.Latitud);
        const lng = parseFloat(os.Longitud);

        if (!isNaN(lat) && !isNaN(lng)) {
            // Determinar color (Usando tu l√≥gica de estados)
            let color = '#2196f3'; // Azul por defecto
            if (os.EsCentro) color = '#4caf50'; // Verde
            else if (os.Condicion?.toUpperCase() === 'REGULADA') color = '#f44336'; // Rojo
            else if (os.Estado_SAP === 'ASIGNADA') color = '#ff9800'; // Naranja

            const marker = L.circleMarker([lat, lng], {
                radius: 9,
                fillColor: color,
                color: "#ffffff",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.9
            });

            // Popup con informaci√≥n clave
            marker.bindPopup(`
                <div style="font-family: sans-serif;">
                    <strong style="color: #1e40af;">OS: ${os.OSATMO || os.OS}</strong><br>
                    <small>${os.Tipologia}</small><br>
                    <hr style="margin: 5px 0;">
                    <b>Estado:</b> ${os.Estado_SAP || 'N/A'}<br>
                    <b>Condici√≥n:</b> ${os.Condicion || 'NORMAL'}
                </div>
            `);

            marker.addTo(window.capaMarcadores);
        }
    });

    // 3. Ajuste de vista SEGURO
    const bounds = window.capaMarcadores.getBounds();
    if (bounds.isValid()) {
        mapa.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
    } else {
        console.warn("‚ö†Ô∏è No hay coordenadas v√°lidas para ajustar el mapa.");
    }
}


// 1. PRIMERO: Definir la funci√≥n de validaci√≥n corregida
function puedeAccederAlMenu() {
    // Buscamos en los mismos lugares donde guardamos (ser consistentes)
    const turnoHoy = localStorage.getItem('turno_hoy');
    const turnoManana = localStorage.getItem('turno_manana');
    
    // IMPORTANTE: Sacamos el rol del objeto currentUser que ya rescatamos
    const rol = currentUser ? currentUser.rol : localStorage.getItem('user_rol');

    // CORRECCI√ìN: Rol es ATTF (con doble T)
    if (rol === 'ATTF') {
        // Validamos que existan y no sean nulos
        const tieneTurnos = (turnoHoy && turnoHoy !== "null" && turnoManana && turnoManana !== "null");
        
        console.log("üõ°Ô∏è Guardia ATTF - ¬øTiene turnos?:", tieneTurnos);
        return tieneTurnos;
    }
    
    return true; // Administradores y otros pasan directo
}

// 2. SEGUNDO: El Guardia ya no te expulsa, te redirige internamente
function ejecutarGuardiaNavegacion() {
    if (!puedeAccederAlMenu()) {
        console.warn("üö´ Acceso restringido: Redirigiendo a configuraci√≥n de turnos.");
        
        // En lugar de recargar la p√°gina (que causa el blanco), 
        // llamamos a la funci√≥n que dibuja los botones.
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('searchSection').style.display = 'block';
        
        if (typeof generarInterfazTurnosPaso1 === 'function') {
            generarInterfazTurnosPaso1();
        }
        return false;
    }
    return true;
}


function escapeJSONForHTMLAttribute(obj, fields = null) {
    if (!obj) return 'null';
    
    // 1. Filtrar campos si se especifica
    const dataToEscape = fields ? 
        fields.reduce((acc, field) => { 
            acc[field] = obj[field]; 
            return acc; 
        }, {}) : 
        obj;

    // 2. Convertir a JSON
    let jsonStr = JSON.stringify(dataToEscape);
    
    // 3. Escapar para atributo HTML (orden correcto)
    return jsonStr
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r')
        .replace(/\t/g, '\\t');
}

// ‚úÖ Exponer globalmente
window.escapeJSONForHTMLAttribute = escapeJSONForHTMLAttribute;

/**
 * Alias para compatibilidad con c√≥digo existente
 * @deprecated Usa directamente extraerCoordenadas()
 */
function obtenerCoordenadasOS(os) {
    const resultado = extraerCoordenadas(os);
    if (resultado) {
        // Normalizar nombres de propiedades si el c√≥digo antiguo espera {lat, lng}
        return {
            lat: resultado.latitud,
            lng: resultado.longitud,
            fuente: resultado.campoOrigen
        };
    }
    return null;
}


// üó∫Ô∏è INICIALIZAR MAPA LEAFLET - VERSI√ìN ROBUSTA Y PROFESIONAL (CORREGIDA)
// ========================================
function inicializarMapaLeaflet(osCentro, osEnRadio, latCentro, lngCentro, radioKm) {
    // ========================================
    // ‚úÖ 0. OBTENER ELEMENTO DOM PRIMERO (para usar en diagn√≥stico)
    // ========================================
    const mapaDiv = document.getElementById('mapaLeaflet');
    
    // ========================================
    // üß™ BLOQUE DE DIAGN√ìSTICO INICIAL
    // ========================================
    console.group('üîç DIAGN√ìSTICO: inicializarMapaLeaflet');
    
    // ‚úÖ 1. Leaflet cargado
    console.log('üó∫Ô∏è Leaflet disponible:', typeof L === 'object' ? '‚úÖ S√ç' : '‚ùå NO');
    
    // ‚úÖ 2. Funciones dependientes definidas
    console.log('üîß extraerCoordenadas:', typeof extraerCoordenadas === 'function' ? '‚úÖ Definida' : '‚ùå NO definida');
    console.log('üîß escapeJSONForHTMLAttribute:', typeof escapeJSONForHTMLAttribute === 'function' ? '‚úÖ Definida' : '‚ùå NO definida');
    console.log('üîß mostrarDetalleOSEnPanel:', typeof mostrarDetalleOSEnPanel === 'function' ? '‚úÖ Definida' : '‚ùå NO definida');
    
    // ‚úÖ 3. Elemento DOM existe
    console.log('üì¶ Div #mapaLeaflet:', mapaDiv ? '‚úÖ Existe' : '‚ùå NO existe');
    
    // ‚úÖ 4. Datos v√°lidos
    console.log('üìä osCentro.OSATMO:', osCentro?.OSATMO || '‚ö†Ô∏è undefined');
    console.log('üìä osEnRadio es array:', Array.isArray(osEnRadio) ? '‚úÖ S√ç' : '‚ùå NO');
    console.log('üìä latCentro:', typeof latCentro, '| lngCentro:', typeof lngCentro);
    console.log('üìä Coordenadas v√°lidas:', !isNaN(latCentro) && !isNaN(lngCentro) ? '‚úÖ S√ç' : '‚ùå NO');
    
    // ‚úÖ 5. Par√°metros adicionales
    console.log('üìä radioKm:', radioKm, 'km');
    console.log('üìä Total OS a procesar:', osEnRadio?.length || 0);
    
    console.groupEnd();
    
    // ========================================
    // ü™µ LOG DE ENTRADA CON DIAGN√ìSTICO COMPLETO
    // ========================================
    console.group('üó∫Ô∏è ==========================================');
    console.log('üó∫Ô∏è INICIALIZANDO MAPA LEAFLET CON AGRUPAMIENTO');
    console.log('üó∫Ô∏è ==========================================');
    console.log('üìä Par√°metros recibidos:', {
        osCentro: osCentro ? { OSATMO: osCentro.OSATMO, Tipologia: osCentro.Tipologia } : null,
        osEnRadioCount: Array.isArray(osEnRadio) ? osEnRadio.length : 'NO ES ARRAY',
        latCentro,
        lngCentro,
        radioKm
    });
    console.log('üó∫Ô∏è ==========================================');
    console.groupEnd();

    // ========================================
    // ‚úÖ VALIDACI√ìN DE DEPENDENCIAS CR√çTICAS
    // ========================================
    if (typeof L === 'undefined') {
        console.error('‚ùå Leaflet no est√° cargado. Verifica que el script de Leaflet se haya incluido correctamente.');
        return;
    }

    if (typeof extraerCoordenadas !== 'function') {
        console.error('‚ùå Funci√≥n extraerCoordenadas no definida. No se pueden procesar coordenadas.');
        return;
    }

    // ‚úÖ Fallback seguro para escapeJSONForHTMLAttribute
    if (typeof escapeJSONForHTMLAttribute !== 'function') {
        console.warn('‚ö†Ô∏è escapeJSONForHTMLAttribute no definida. Usando fallback b√°sico.');
        window.escapeJSONForHTMLAttribute = (obj) => {
            try {
                return JSON.stringify(obj).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            } catch (e) {
                return '{}';
            }
        };
    }

    // ========================================
    // ‚úÖ VALIDACI√ìN DE PAR√ÅMETROS (MEJORADA)
    // ========================================
    if (!osCentro) {
        console.error('‚ùå osCentro es null o undefined');
        return;
    }
    if (!Array.isArray(osEnRadio)) {
        console.error('‚ùå osEnRadio no es un array:', typeof osEnRadio);
        return;
    }
    if (typeof latCentro !== 'number' || isNaN(latCentro)) {
        console.error('‚ùå latCentro no es un n√∫mero v√°lido:', latCentro);
        return;
    }
    if (typeof lngCentro !== 'number' || isNaN(lngCentro)) {
        console.error('‚ùå lngCentro no es un n√∫mero v√°lido:', lngCentro);
        return;
    }
    if (typeof radioKm !== 'number' || radioKm <= 0) {
        console.warn('‚ö†Ô∏è radioKm inv√°lido, usando valor por defecto: 3 km');
        radioKm = 3;
    }

    // ========================================
    // ‚úÖ VALIDAR ELEMENTO DEL DOM (YA OBTENIDO ARRIBA)
    // ========================================
    if (!mapaDiv) {
        console.error('‚ùå Div del mapa no encontrado: #mapaLeaflet');
        console.log('üîç Elementos con id que contienen "mapa":', 
            Array.from(document.querySelectorAll('[id*="mapa"]')).map(el => el.id)
        );
        return;
    }

    // ‚úÖ Validar que el div est√© visible (no display:none)
    if (mapaDiv.offsetParent === null && mapaDiv.style.display !== 'none') {
        console.warn('‚ö†Ô∏è #mapaLeaflet podr√≠a estar oculto. El mapa podr√≠a no renderizarse correctamente.');
    }

    // ========================================
    // ‚úÖ LIMPIAR ESTADO PREVIO COMPLETAMENTE
    // ========================================
    console.log('üßπ Limpiando estado previo del mapa...');
    
    // 1. Remover instancia de mapa
    if (window.mapaLeafletInstance) {
        try {
            console.log('üóëÔ∏è Removiendo instancia previa del mapa');
            window.mapaLeafletInstance.remove();
        } catch (e) {
            console.warn('‚ö†Ô∏è Error removiendo instancia previa:', e.message);
        }
        window.mapaLeafletInstance = null;
    }

    // 2. Limpiar referencias a marcadores y capas
    if (window.circuloRadio) {
        try {
            if (window.mapaLeafletInstance?.hasLayer(window.circuloRadio)) {
                window.mapaLeafletInstance.removeLayer(window.circuloRadio);
            }
        } catch (e) {
            console.warn('‚ö†Ô∏è Error limpiando circuloRadio:', e.message);
        }
        window.circuloRadio = null;
    }

    // 3. Reinicializar agrupaciones de marcadores
    window.markersPorTipologia = {};
    window.markersPorEstado = {
        'centro': [],
        'asignada': [],
        'regulada': [],
        'no_regulada': [],
        'deuda_alta': [],
        'deuda_media': [],
        'deuda_baja': []
    };


    // ========================================
    // ‚úÖ CREAR MAPA CON MANEJO DE ERRORES
    // ========================================
    let mapa;
    try {
        console.log(`üó∫Ô∏è Creando mapa Leaflet en [${latCentro}, ${lngCentro}] zoom 14`);
        mapa = L.map('mapaLeaflet', {
            zoomControl: true,
            attributionControl: true,
            preferCanvas: true // Mejora rendimiento con muchos marcadores
        }).setView([latCentro, lngCentro], 14);
        
        window.mapaLeafletInstance = mapa;
        console.log('‚úÖ Instancia de mapa creada exitosamente');
    } catch (e) {
        console.error('‚ùå Error cr√≠tico creando instancia de Leaflet:', {
            mensaje: e.message,
            stack: e.stack?.split('\n')[0]
        });
        return;
    }

    // ========================================
    // ‚úÖ CAPA DE MAPA BASE
    // ========================================
    try {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19,
            minZoom: 3,
            detectRetina: true
        }).addTo(mapa);
        console.log('‚úÖ Capa de mapa base agregada');
    } catch (e) {
        console.error('‚ùå Error agregando capa de mapa:', e.message);
    }

    // ========================================
    // ‚úÖ DIBUJAR C√çRCULO DEL RADIO DE B√öSQUEDA
    // ========================================
    try {
        console.log(`üîµ Dibujando c√≠rculo de radio: ${radioKm} km`);
        const circuloRadio = L.circle([latCentro, lngCentro], {
            radius: radioKm * 1000,
            color: '#3b82f6',
            weight: 3,
            opacity: 0.8,
            fillOpacity: 0.15,
            fillColor: '#3b82f6',
            interactive: true
        }).addTo(mapa)
        .bindPopup(`
            <div style="min-width: 200px; font-family: sans-serif;">
                <strong style="color: #3b82f6; font-size: 16px; display: block; margin-bottom: 8px;">
                    üìç √ÅREA DE B√öSQUEDA
                </strong>
                <div style="font-size: 14px; line-height: 1.5;">
                    <strong>Radio:</strong> ${radioKm} km<br>
                    <strong>OS en radio:</strong> ${osEnRadio.length}
                </div>
            </div>
        `, { maxWidth: 300 });
        
        window.circuloRadio = circuloRadio;
        console.log('‚úÖ C√≠rculo de b√∫squeda dibujado');
    } catch (e) {
        console.error('‚ùå Error dibujando c√≠rculo de radio:', e.message);
    }

    // ========================================
    // ‚úÖ MARCADOR "0" PARA PUNTO DE PARTIDA (VERDE)
    // ========================================
    let markerCentro;
    try {
        console.log('üü¢ Creando marcador de referencia (OS Centro)');
        
        const iconoVerde = L.divIcon({
            className: 'custom-marker',
            html: `<div style="
                background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
                color: white;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 20px;
                box-shadow: 0 4px 12px rgba(76,175,80,0.6);
                border: 4px solid white;
                user-select: none;
            ">0</div>`,
            iconSize: [50, 50],
            iconAnchor: [25, 50],
            popupAnchor: [0, -50]
        });

        markerCentro = L.marker([latCentro, lngCentro], { 
            icon: iconoVerde,
            zIndexOffset: 1000
        })
        .addTo(mapa)
        .bindPopup(`
            <div style="min-width: 200px; font-family: sans-serif;">
                <strong style="color: #2e7d32; font-size: 16px; display: block; margin-bottom: 8px;">
                    üéØ OS DE REFERENCIA (0)
                </strong>
                <div style="font-size: 14px; line-height: 1.5;">
                    <strong>OS:</strong> ${osCentro.OSATMO || 'N/A'}<br>
                    <strong>Tipolog√≠a:</strong> ${osCentro.Tipologia || 'N/A'}
                </div>
            </div>
        `, { maxWidth: 300 })
        .on('click', function() {
            if (typeof mostrarDetalleOSEnPanel === 'function') {
                mostrarDetalleOSEnPanel(osCentro, 'OS DE REFERENCIA');
            } else {
                console.warn('‚ö†Ô∏è Funci√≥n mostrarDetalleOSEnPanel no disponible');
            }
        });

        window.markersPorEstado['centro'].push(markerCentro);
        console.log('‚úÖ Marcador de referencia creado');
    } catch (e) {
        console.error('‚ùå Error creando marcador de referencia:', e.message);
    }

    // ========================================
    // ‚úÖ AGRUPAR OS POR COORDENADAS EXACTAS
    // ========================================
    console.group('üìç ==========================================');
    console.log('üìç AGRUPANDO OS POR COORDENADAS');
    console.log('üìç Total OS a procesar:', osEnRadio.length);
    console.log('üìç ==========================================');

    const coordenadasAgrupadas = {};
    let osProcesadas = 0;
    let osSinCoordenadas = 0;
    let osCoordenadasInvalidas = 0;

    for (const [index, os] of osEnRadio.entries()) {
        // Saltar la OS centro si est√° en la lista
        if (os.OSATMO === osCentro.OSATMO) {
            console.log(`‚è≠Ô∏è Saltando OS centro: ${os.OSATMO}`);
            continue;
        }

        // ‚úÖ EXTRAER COORDENADAS CON VALIDACI√ìN
        let coords;
        try {
            coords = extraerCoordenadas(os);
        } catch (e) {
            console.warn(`‚ö†Ô∏è Error extrayendo coordenadas para OS ${os.OSATMO || index}:`, e.message);
            coords = null;
        }

        if (!coords) {
            osSinCoordenadas++;
            console.debug(`‚ö†Ô∏è OS ${os.OSATMO || index} sin coordenadas (campo vac√≠o o formato incorrecto)`);
            continue;
        }

        const { latitud: lat, longitud: lng } = coords;

        // Validar que sean n√∫meros
        if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) {
            osCoordenadasInvalidas++;
            console.warn(`‚ö†Ô∏è OS ${os.OSATMO} con coordenadas no num√©ricas: lat=${lat}, lng=${lng}`);
            continue;
        }

        // Validar rango geogr√°fico v√°lido
        if (Math.abs(lat) > 90 || Math.abs(lng) > 180) {
            osCoordenadasInvalidas++;
            console.warn(`‚ö†Ô∏è OS ${os.OSATMO} con coordenadas fuera de rango: [${lat}, ${lng}]`);
            continue;
        }

        // Crear clave √∫nica para coordenadas (6 decimales para precisi√≥n ~11cm)
        const claveCoordenadas = `${lat.toFixed(6)},${lng.toFixed(6)}`;

        // Agrupar OS por coordenadas
        if (!coordenadasAgrupadas[claveCoordenadas]) {
            coordenadasAgrupadas[claveCoordenadas] = {
                lat,
                lng,
                osList: []
            };
        }

        coordenadasAgrupadas[claveCoordenadas].osList.push({
            ...os,
            numeroOrden: index + 1,
            lat,
            lng
        });
        osProcesadas++;
    }

    console.log(`üìç Coordenadas √∫nicas encontradas: ${Object.keys(coordenadasAgrupadas).length}`);
    console.log(`üìç OS agrupadas: ${osProcesadas} | Sin coordenadas: ${osSinCoordenadas} | Inv√°lidas: ${osCoordenadasInvalidas}`);
    console.groupEnd();

    // ========================================
    // ‚úÖ PREPARAR BOUNDS PARA AJUSTE DE VISTA
    // ========================================
    const bounds = L.latLngBounds();
    bounds.extend([latCentro, lngCentro]);

    // ========================================
    // ‚úÖ CREAR MARCADORES CON AGRUPAMIENTO
    // ========================================
    let contadorProcesadas = 0;
    let estadisticas = {
        regulada: 0,
        no_regulada: 0,
        deuda_alta: 0,
        deuda_media: 0,
        deuda_baja: 0,
        asignadas: 0
    };
    let erroresMarcadores = 0;

    for (const grupo of Object.values(coordenadasAgrupadas)) {
        const { lat, lng, osList } = grupo;
        const esMultiple = osList.length > 1;

        // Determinar estado y color del marcador principal
        const primeraOS = osList[0];
        const tipoOS = (primeraOS.Tipo_de_OS || '').toLowerCase();
        const deuda = parseFloat(primeraOS.Deuda) || 0;
        
        let colorFondo, labelEstado, estadoKey;

        if (deuda > 500) {
            colorFondo = '#fdd835';
            labelEstado = 'DEUDA ALTA';
            estadoKey = 'deuda_alta';
        } else if (deuda >= 100 && deuda <= 500) {
            colorFondo = '#ff9800';
            labelEstado = 'DEUDA MEDIA';
            estadoKey = 'deuda_media';
        } else if (deuda >= 50 && deuda < 100) {
            colorFondo = '#f48fb1';
            labelEstado = 'DEUDA BAJA';
            estadoKey = 'deuda_baja';
        } else if (primeraOS.Estado_ATOMO === 'Asignada' || primeraOS.Estado_SAP === 'ASIGNADA') {
            colorFondo = '#ff9800';
            labelEstado = 'OS ASIGNADA';
            estadoKey = 'asignada';
        } else if (tipoOS.includes('regulad') && !tipoOS.includes('no')) {
            colorFondo = '#f44336';
            labelEstado = 'OS REGULADA';
            estadoKey = 'regulada';
        } else {
            colorFondo = '#2196f3';
            labelEstado = 'OS NO REGULADA';
            estadoKey = 'no_regulada';
        }

        // Contabilizar estad√≠sticas
        contadorProcesadas++;
        estadisticas[estadoKey] += osList.length;

        // Crear icono con indicador de m√∫ltiple si aplica
        const iconoConNumero = L.divIcon({
            className: 'custom-marker',
            html: `
                <div style="
                    background-color: ${colorFondo};
                    width: ${esMultiple ? '40px' : '32px'};
                    height: ${esMultiple ? '40px' : '32px'};
                    border-radius: 50% 50% 50% 0;
                    transform: rotate(-45deg);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border: 2px solid white;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                    position: relative;
                    user-select: none;
                ">
                    <span style="
                        transform: rotate(45deg);
                        color: white;
                        font-weight: bold;
                        font-size: ${esMultiple ? '16px' : '13px'};
                        line-height: 1;
                    ">${primeraOS.numeroOrden || '1'}${esMultiple ? '+' : ''}</span>
                    ${esMultiple ? `
                        <div style="
                            position:absolute;
                            top:-5px;
                            right:-5px;
                            background:#ff5722;
                            color:white;
                            border-radius:50%;
                            width:20px;
                            height:20px;
                            font-size:10px;
                            display:flex;
                            align-items:center;
                            justify-content:center;
                            border:2px solid white;
                            font-weight:bold;
                        ">${osList.length}</div>` : ''}
                </div>`,
            iconSize: [esMultiple ? 40 : 32, esMultiple ? 40 : 32],
            iconAnchor: [esMultiple ? 20 : 16, esMultiple ? 40 : 32],
            popupAnchor: [0, esMultiple ? -40 : -32]
        });

        // ========================================
        // ‚úÖ CREAR POPUP CON LISTA DE TODAS LAS OS
        // ========================================
        let popupContent = `
            <div style="min-width: 300px; max-height: 400px; overflow-y: auto; font-family: sans-serif;">
                <strong style="color: ${colorFondo}; font-size: 16px; display: block; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                    üìç ${esMultiple ? osList.length + ' √ìrdenes en este punto' : labelEstado}
                </strong>
        `;

        if (esMultiple) {
            // Mostrar lista de todas las OS en este punto
            for (const [idx, os] of osList.entries()) {
                const osDeuda = parseFloat(os.Deuda) || 0;
                const osTipo = (os.Tipo_de_OS || '').toLowerCase();
                let osColor = '#2196f3';

                if (osDeuda > 500) osColor = '#fdd835';
                else if (osDeuda >= 100) osColor = '#ff9800';
                else if (osDeuda >= 50) osColor = '#f48fb1';
                else if (osTipo.includes('regulad') && !osTipo.includes('no')) osColor = '#f44336';
                else if (os.Estado_ATOMO === 'Asignada') osColor = '#ff9800';

                // ‚úÖ ESCAPE SEGURO PARA DATOS EN POPUP
                const osDataEscaped = typeof escapeJSONForHTMLAttribute === 'function' 
                    ? escapeJSONForHTMLAttribute(os) 
                    : JSON.stringify(os)
                        .replace(/\\/g, '\\\\')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/\n/g, '\\n')
                        .replace(/\r/g, '\\r')
                        .replace(/\t/g, '\\t');

                // Escape seguro para labelEstado en el onclick
                const labelEstadoEscaped = labelEstado.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const osATMO = (os.OSATMO || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                popupContent += `
                    <div style="
                        background: #f8f9fa;
                        padding: 10px;
                        margin-bottom: 8px;
                        border-radius: 6px;
                        border-left: 4px solid ${osColor};
                        cursor: pointer;
                        transition: all 0.2s ease;
                    " onclick="seleccionarOSDeLista('${osATMO}', ${os.lat}, ${os.lng}); return false;"
                       onmouseover="this.style.background='#e3f2fd'; this.style.transform='translateX(3px)';"
                       onmouseout="this.style.background='#f8f9fa'; this.style.transform='translateX(0)';">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; flex-wrap: wrap; gap: 5px;">
                            <strong style="color: #1976d2; font-size: 14px;">#${idx + 1} - OS: ${os.OSATMO || 'N/A'}</strong>
                            <span style="background: ${osColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; white-space: nowrap;">
                                ${os.Tipo_de_OS || 'Normal'}
                            </span>
                        </div>
                        <div style="font-size: 12px; color: #666; line-height: 1.4;">
                            <strong>Tipolog√≠a:</strong> ${os.Tipologia || 'N/A'}<br>
                            ${osDeuda > 0 ? `<strong>Deuda:</strong> $${osDeuda.toFixed(2)}<br>` : ''}
                            ${os.distancia ? `<strong>Distancia:</strong> ${os.distancia.toFixed(2)} km<br>` : ''}
                            <strong>Unidad:</strong> ${os.Unidad || 'N/A'}
                        </div>
                        <button onclick="event.stopPropagation(); if(typeof mostrarDetalleOSEnPanel==='function'){mostrarDetalleOSEnPanel(${osDataEscaped}, '${labelEstadoEscaped}');}"
                            style="margin-top: 8px; background: ${osColor}; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; width: 100%; font-size: 12px; font-weight: 500;">
                            üìã Ver Detalle Completo
                        </button>
                    </div>
                `;
            }
        } else {
            // Popup normal para OS √∫nica
            const os = osList[0];
            const osDataEscaped = typeof escapeJSONForHTMLAttribute === 'function' 
                ? escapeJSONForHTMLAttribute(os) 
                : JSON.stringify(os)
                    .replace(/\\/g, '\\\\')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n/g, '\\n')
                    .replace(/\r/g, '\\r')
                    .replace(/\t/g, '\\t');
            
            const labelEstadoEscaped = labelEstado.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            popupContent += `
                <div style="margin-bottom: 10px; font-size: 14px; line-height: 1.5;">
                    <strong>OS:</strong> ${os.OSATMO || 'N/A'}<br>
                    <strong>Tipolog√≠a:</strong> ${os.Tipologia || 'N/A'}<br>
                    ${deuda > 0 ? `<strong>Deuda:</strong> $${deuda.toFixed(2)}<br>` : ''}
                    ${os.distancia ? `<strong>Distancia:</strong> ${os.distancia.toFixed(2)} km<br>` : ''}
                    ${os.Unidad ? `<strong>Unidad:</strong> ${os.Unidad}<br>` : ''}
                </div>
                <button onclick="if(typeof mostrarDetalleOSEnPanel==='function'){mostrarDetalleOSEnPanel(${osDataEscaped}, '${labelEstadoEscaped}');}"
                    style="background: ${colorFondo}; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: 500; transition: opacity 0.2s;"
                    onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    üìã Ver Detalle Completo
                </button>
            `;
        }

        popupContent += `</div>`;

        // ========================================
        // ‚úÖ CREAR MARCADOR CON POPUP
        // ========================================
        try {
            const marker = L.marker([lat, lng], { 
                icon: iconoConNumero,
                zIndexOffset: esMultiple ? 500 : 100
            })
            .addTo(mapa)
            .bindPopup(popupContent, { maxWidth: 400, minWidth: 300 });

            window.markersPorEstado[estadoKey].push(marker);
            bounds.extend([lat, lng]);

            // Agrupar por tipolog√≠a
            const tip = primeraOS.Tipologia || 'Sin tipolog√≠a';
            if (!window.markersPorTipologia[tip]) {
                window.markersPorTipologia[tip] = [];
            }
            window.markersPorTipologia[tip].push(marker);
            
        } catch (e) {
            erroresMarcadores++;
            console.error(`‚ùå Error creando marcador para OS ${primeraOS?.OSATMO || 'desconocida'}:`, {
                mensaje: e.message,
                coordenadas: [lat, lng],
                estadoKey
            });
        }
    }

    // ========================================
    // üìä LOG FINAL DE MARCADORES
    // ========================================
    console.group('üìç ==========================================');
    console.log('üìç RESUMEN DE MARCADORES CREADOS');
    console.log('üìç ==========================================');
    console.table({
        'Total procesadas': contadorProcesadas,
        'Marcadores creados': Object.keys(coordenadasAgrupadas).length,
        'OS sin coordenadas': osSinCoordenadas,
        'OS coordenadas inv√°lidas': osCoordenadasInvalidas,
        'Errores al crear marcadores': erroresMarcadores
    });
    console.log('üìä DISTRIBUCI√ìN POR ESTADO:');
    console.table(estadisticas);
    console.log('üìç ==========================================');
    console.groupEnd();

    // ========================================
    // ‚úÖ AJUSTAR VISTA DEL MAPA CON VALIDACI√ìN ROBUSTA
    // ========================================
    try {
        // Verificaci√≥n robusta de bounds v√°lido
        const southWest = bounds.getSouthWest();
        const northEast = bounds.getNorthEast();
        const boundsValid = bounds.isValid() && 
                           typeof southWest.lat === 'number' && 
                           typeof northEast.lat === 'number' &&
                           Math.abs(southWest.lat - northEast.lat) > 0.00001; // Evita bounds de un solo punto

        if (boundsValid) {
            console.log('üîç Ajustando vista del mapa a bounds calculados');
            mapa.fitBounds(bounds, { 
                padding: [50, 50],
                maxZoom: 16,
                animate: true
            });
        } else {
            console.warn('‚ö†Ô∏è Bounds inv√°lidos o muy peque√±os, usando vista por defecto');
            console.debug('üîç Debug bounds:', { southWest, northEast, isValid: bounds.isValid() });
            mapa.setView([latCentro, lngCentro], 14);
        }
    } catch (e) {
        console.error('‚ùå Error ajustando vista del mapa:', e.message);
        mapa.setView([latCentro, lngCentro], 14);
    }

    // ========================================
    // ‚úÖ AGREGAR CONTROL DE ESCALA
    // ========================================
    try {
        if (typeof L.control?.scale === 'function') {
            L.control.scale({ 
                position: 'bottomleft',
                metric: true,
                imperial: false,
                maxWidth: 120
            }).addTo(mapa);
            console.log('‚úÖ Control de escala agregado');
        } else {
            console.warn('‚ö†Ô∏è L.control.scale no disponible, omitiendo control de escala');
        }
    } catch (e) {
        console.warn('‚ö†Ô∏è Error agregando control de escala:', e.message);
    }

    // ========================================
    // ‚úÖ LOG DE √âXITO Y EVENTO DE FINALIZACI√ìN
    // ========================================
    console.log(`‚úÖ Mapa inicializado exitosamente con ${Object.keys(coordenadasAgrupadas).length} marcadores.`);
    
    // Disparar evento de mapa listo (con verificaci√≥n de soporte)
    if (typeof window.dispatchEvent === 'function' && typeof CustomEvent === 'function') {
        try {
            window.dispatchEvent(new CustomEvent('mapaLeafletListo', { 
                detail: { 
                    mapa, 
                    totalMarcadores: Object.keys(coordenadasAgrupadas).length,
                    estadisticas 
                } 
            }));
            console.log('üì° Evento mapaLeafletListo disparado');
        } catch (e) {
            console.warn('‚ö†Ô∏è Error disparando evento mapaLeafletListo:', e.message);
        }
    }

    // ========================================
    // ü™µ LOG DE SALIDA
    // ========================================
    console.groupEnd(); // Cierra el grupo inicial
    console.log('üó∫Ô∏è ==========================================');
    console.log('üó∫Ô∏è INICIALIZACI√ìN DE MAPA COMPLETADA');
    console.log('üó∫Ô∏è ==========================================');
}




/**
 * Selecciona una OS espec√≠fica de un grupo de coordenadas y centra el mapa
 * @param {string} osatomo - ID de la OS a seleccionar
 * @param {number} lat - Latitud del punto
 * @param {number} lng - Longitud del punto
 */
function seleccionarOSDeLista(osatomo, lat, lng) {
    if (!window.mapaLeafletInstance) {
        console.error('‚ùå Mapa no inicializado');
        return;
    }
    
    // Centrar mapa en las coordenadas
    window.mapaLeafletInstance.setView([lat, lng], 17, {
        animate: true,
        duration: 0.5
    });
    
    // Buscar el marcador espec√≠fico y abrir su popup
    const markers = Object.values(window.markersPorEstado).flat();
    const markerEncontrado = markers.find(m => {
        const popupContent = m.getPopup()?.getContent();
        return popupContent && popupContent.includes(osatomo);
    });
    
    if (markerEncontrado) {
        markerEncontrado.openPopup();
        
        // Animaci√≥n visual
        const iconEl = markerEncontrado.getElement();
        if (iconEl) {
            iconEl.style.transition = 'transform 0.3s ease';
            iconEl.style.transform = 'scale(1.3)';
            setTimeout(() => {
                iconEl.style.transform = 'scale(1)';
            }, 500);
        }
    }
    
    // Mostrar detalle en panel lateral
    const osData = window.datosMapaExportar?.find(o => o.OSATMO === osatomo);
    if (osData) {
        mostrarDetalleOSEnPanel(osData, 'OS SELECCIONADA');
    }
}

// ‚úÖ Exponer globalmente para que funcione en los onclick del HTML
window.seleccionarOSDeLista = seleccionarOSDeLista;


¬†	// ========================================
// üìã MOSTRAR DETALLE DE OS EN PANEL (VERSI√ìN COMPLETA)
// ========================================
function mostrarDetalleOSEnPanel(os, labelEstado) {
// üö® CORRECCI√ìN INMEDIATA: Forzar prioridad de OS Pendientes
if (os.Comentario && os.Comentario.trim() !== '' && 
    os.Comentario !== 'N/A' && os.Comentario !== 'Sin comentario disponible') {
    os.ComentarioGeneral = os.Comentario;  // Asegurar que ComentarioGeneral refleje OS Pendientes
}

 // üö® CORRECCI√ìN INMEDIATA: Forzar prioridad de comentario de OS Pendientes
    if (os.ComentarioOriginal) {
        os.Comentario = os.ComentarioOriginal;
    }
    if (os.ComentarioKML) {
        os.ComentarioGeneral = os.ComentarioKML;
    }

    const panelDetalle = document.getElementById('panelDetalleOS');

    if (!panelDetalle) {
        console.error('‚ùå Panel de detalle no encontrado');
        return;
    }

// ‚úÖ Escape seguro si el objeto viene de HTML
    const osData = typeof os === 'string' 
        ? JSON.parse(os.replace(/&quot;/g, '"').replace(/&#39;/g, "'"))
        : os;

    // ========================================
    // üïµÔ∏è LOGS DE DEBUG - VER QU√â DATOS RECIBIMOS
    // ========================================
    console.log('üîç ==========================================');
    console.log('üîç MOSTRAR DETALLE OS - DATOS RECIBIDOS');
    console.log('üîç ==========================================');
    console.log('üìã OS:', os.OSATMO || os.osatomo || 'SIN ID');
    console.log('üìä labelEstado:', labelEstado);
    console.log('üí¨ os.Comentario:', os.Comentario);
    console.log('üí¨ os.ComentarioGeneral:', os.ComentarioGeneral);
    console.log('üí¨ os.comentario:', os.comentario);
    console.log('üí¨ os.Observaciones:', os.Observaciones);
    console.log('üìä Todos los campos disponibles:', Object.keys(os));
    console.log('üîç ==========================================');


// ========================================
// ‚úÖ üÜï BUSCAR COMENTARIO CON PRIORIDAD CORREGIDA PARA KML
// ========================================
const comentarioTexto = (() => {
    // ‚úÖ PRIORIDAD 1: Comentario espec√≠fico de KML
    if (os.ComentarioKML && os.ComentarioKML.trim() !== '' && 
        os.ComentarioKML !== 'Sin comentario disponible') {
        return os.ComentarioKML;
    }
    
    // ‚úÖ PRIORIDAD 2: Comentario de OS Pendientes (SIEMPRE prioritario)
    if (os.Comentario && os.Comentario.trim() !== '' && 
        os.Comentario !== 'N/A' && os.Comentario !== 'Sin comentario disponible' &&
        os.esDeConsultasServicios === false) {  // ‚Üê VERIFICAR FLAG
        return os.Comentario;
    }
    
    // ‚úÖ PRIORIDAD 3: ComentarioGeneral SOLO si viene de OS Pendientes
    if (os.ComentarioGeneral && os.ComentarioGeneral.trim() !== '' && 
        os.ComentarioGeneral !== 'Sin comentario disponible' &&
        os.esDeConsultasServicios !== true) {  // ‚Üê NO usar si es de consultas_servicios
        return os.ComentarioGeneral;
    }
    
    // ‚úÖ FALLBACK: Otros campos
    return os.comentario || os.Observaciones || os.comentarioGeneral || 
           os.observaciones || os.Comentarios || os.comentarios ||
           os.Detalle || os.detalle || os.descripcion || os.Descripcion ||
           os.Nota || os.nota || 'Sin comentario disponible';
})();

    

    console.log('üîç DEBUG COMENTARIO:', {
        OS: os.OSATMO || os.osatomo,
        TieneComentario: !!os.Comentario,
        TieneComentarioGeneral: !!os.ComentarioGeneral,
        TieneObservaciones: !!os.Observaciones,
        ComentarioEncontrado: comentarioTexto ? '‚úÖ S√ç' : '‚ùå NO',
        LongitudComentario: comentarioTexto.length
    });

    // ‚úÖ DECLARACI√ìN √öNICA CORREGIDA
const comentarioFormateado = (() => {
    if (!comentarioTexto || comentarioTexto.trim() === '' || 
        comentarioTexto === 'Sin comentario disponible' || comentarioTexto === 'Sin Datos') {
        // Fallback con informaci√≥n alternativa
        return `
        <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 4px solid #ffc107;">
            <strong style="color: #856404;">‚ÑπÔ∏è Sin comentario disponible</strong><br>
            <small style="color: #666;">
                Medidor: ${os.Medidor || 'N/A'}<br>
                Tipolog√≠a: ${os.Tipologia || 'N/A'}
            </small>
        </div>`;
    }
    return formatearComentario(comentarioTexto);
})();


    // ========================================
    // DETERMINAR COLOR SEG√öN ESTADO
    // ========================================
    let colorFondo, colorBorde;
    const deuda = parseFloat(os.Deuda) || 0;

    if (deuda > 500) {
        colorFondo = '#fffde7';
        colorBorde = '#fdd835';
    } else if (deuda >= 100 && deuda <= 500) {
        colorFondo = '#fff3e0';
        colorBorde = '#ff9800';
    } else if (deuda >= 50 && deuda < 100) {
        colorFondo = '#fce4ec';
        colorBorde = '#f48fb1';
    } else if (labelEstado && labelEstado.includes('ASIGNADA')) {
        colorFondo = '#fff3e0';
        colorBorde = '#ff9800';
    } else if (labelEstado && labelEstado.includes('REGULADA')) {
        colorFondo = '#ffebee';
        colorBorde = '#f44336';
    } else if (labelEstado && labelEstado.includes('TU OS')) {
        colorFondo = '#e8f5e9';
        colorBorde = '#4caf50';
    } else {
        colorFondo = '#e3f2fd';
        colorBorde = '#2196f3';
    }

    // ========================================
    // GENERAR HTML DEL PANEL
    // ========================================
    panelDetalle.innerHTML = `
        <div style="background: ${colorFondo}; border: 3px solid ${colorBorde}; border-radius: 12px; padding: 20px; box-shadow: 0 -4px 12px rgba(0,0,0,0.1);">

            <!-- Encabezado con bot√≥n cerrar -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid ${colorBorde};">
                <strong style="color: ${colorBorde === '#4caf50' ? '#2e7d32' : (colorBorde === '#fdd835' ? '#f57f17' : (colorBorde === '#ff9800' ? '#e65100' : (colorBorde === '#f48fb1' ? '#c2185b' : (colorBorde === '#f44336' ? '#c62828' : '#1565c0'))))}; font-size: 18px;">
                    ${labelEstado || 'DETALLE DE OS'}
                </strong>
                <button onclick="cerrarDetalleOS()" style="background: ${colorBorde}; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                    ‚úï Cerrar
                </button>
            </div>

            <!-- Informaci√≥n principal -->
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: grid; gap: 10px; font-size: 15px; line-height: 1.8;">
                    <div><strong style="color: #2d3748;">üìã OS:</strong> <span style="color: #1976d2; font-weight: 600;">${os.OSATMO || os.osatomo || os.OSATOMO || 'N/A'}</span></div>
                    <div><strong style="color: #2d3748;">üè∑Ô∏è Tipolog√≠a:</strong> ${os.Tipologia || os.tipologia || 'N/A'}</div>
                    ${os.Deuda && parseFloat(os.Deuda) > 0 ? `<div><strong style="color: #2d3748;">üí∞ Deuda:</strong> <span style="color: ${deuda > 500 ? '#f57f17' : (deuda >= 100 ? '#e65100' : '#c2185b')}; font-weight: 700; font-size: 16px;">$${parseFloat(os.Deuda).toFixed(2)}</span></div>` : ''}
                    ${os.distancia ? `<div><strong style="color: #2d3748;">üìè Distancia:</strong> <span style="color: #1976d2; font-weight: 600;">${os.distancia} km</span></div>` : ''}
                    <div><strong style="color: #2d3748;">üìç Unidad:</strong> ${os.Unidad || os.unidad || 'N/A'}</div>
                    ${os.Medidor ? `<div><strong style="color: #2d3748;">‚ö° Medidor:</strong> ${os.Medidor}</div>` : ''}
                    ${os.Tipo_de_OS ? `<div><strong style="color: #2d3748;">üìù Tipo OS:</strong> ${os.Tipo_de_OS}</div>` : ''}
                    ${os.Estado_ATOMO ? `<div><strong style="color: #2d3748;">üîÑ Estado ATOMO:</strong> ${os.Estado_ATOMO}</div>` : ''}
                    ${os.Estado_SAP ? `<div><strong style="color: #2d3748;">üîÑ Estado SAP:</strong> ${os.Estado_SAP}</div>` : ''}
                    ${os.CuentaContrato ? `<div><strong style="color: #2d3748;">üìÑ Cuenta Contrato:</strong> ${os.CuentaContrato}</div>` : ''}
                </div>
            </div>

            <!-- Comentario (colapsable en m√≥viles) -->
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${colorBorde};">
                <strong style="color: #2d3748; display: block; margin-bottom: 10px;">üí¨ Comentario:</strong>
                <div style="max-height: 200px; overflow-y: auto; font-size: 14px; color: #555; line-height: 1.6; background: #f8f9fa; padding: 12px; border-radius: 6px;">
                    ${comentarioFormateado}
                </div>
            </div>

            <!-- Bot√≥n Google Maps -->
            <div style="text-align: center;">
                <a href="https://www.google.com/maps/dir/?api=1&destination=${os.lat || os.Latitud},${os.lng || os.Longitud}"
                   target="_blank"
                   style="display: inline-block; background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
                          color: white; padding: 15px 30px; border-radius: 10px; text-decoration: none;
                          font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(66,133,244,0.3);">
                    üó∫Ô∏è Navegar en Google Maps
                </a>
            </div>

        </div>
    `;

    // Hacer scroll suave hacia el panel
    panelDetalle.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    console.log('‚úÖ Detalle de OS mostrado:', os.OSATMO || os.osatomo);
}



// ========================================
// ‚úï CERRAR PANEL DE DETALLE
// ========================================
function cerrarDetalleOS() {
¬†   const panelDetalle = document.getElementById('panelDetalleOS');
¬†   if (panelDetalle) {
¬†       panelDetalle.innerHTML = `
¬†           <div style="text-align: center; padding: 40px; color: #999;">
¬†               <div style="font-size: 48px; margin-bottom: 10px;">üìç</div>
¬†               <p style="font-size: 16px; font-weight: 600;">Haz clic en un punto del mapa para ver detalles</p>
¬†           </div>
¬†       `;
¬†   }
}


¬†
¬†	// ========================================
// üé® RESALTAR TIPOLOG√çA EN MAPA (CON TOGGLE CORREGIDO)
// ========================================
function resaltarTipologiaEnMapa(tipologia) {
¬†   if (!window.markersPorTipologia || !window.markersPorTipologia[tipologia]) {
¬†       alert('No se encontraron markers para esta tipolog√≠a');
¬†       return;
¬†   }
¬†
¬†   const mapa = window.mapaLeafletInstance;
¬†   if (!mapa) {
¬†       alert('Mapa no inicializado');
¬†       return;
¬†   }
¬†
¬†   // üÜï Verificar si esta tipolog√≠a ya est√° filtrada
¬†   const yaFiltrado = window.tipologiaFiltrada === tipologia;
¬†
¬†   // üÜï RESETEAR ESTILOS DE TODOS LOS DIVS
¬†   document.querySelectorAll('[id^="tipologia_"]').forEach(div => {
¬†       div.style.background = '#f8f9fa';
¬†       div.style.transform = 'translateX(0)';
¬†       div.style.boxShadow = 'none';
¬†   });
¬†
¬†   if (yaFiltrado) {
¬†       // üîÑ DESACTIVAR FILTRO: Mostrar TODOS los markers
¬†       console.log('üîÑ DESELECCIONANDO - Mostrando TODOS los markers');
¬†
¬†       // ‚úÖ MOSTRAR TODOS (sin importar tipolog√≠a)
¬†       Object.values(window.markersPorTipologia).forEach(markersArray => {
¬†           markersArray.forEach(marker => {
¬†               if (!mapa.hasLayer(marker)) {
¬†                   mapa.addLayer(marker); // ‚úÖ AGREGAR de vuelta al mapa
¬†               }
¬†               // Quitar animaci√≥n
¬†               const icon = marker.getElement();
¬†               if (icon) {
¬†                   icon.style.animation = '';
¬†                   icon.style.transform = '';
¬†               }
¬†           });
¬†       });
¬†
¬†       // Limpiar filtro activo
¬†       window.tipologiaFiltrada = null;
¬†
¬†       // Reajustar vista a todos los markers
¬†       const allBounds = L.latLngBounds();
¬†       Object.values(window.markersPorTipologia).forEach(markersArray => {
¬†           markersArray.forEach(marker => {
¬†               allBounds.extend(marker.getLatLng());
¬†           });
¬†       });
¬†
¬†       // ‚úÖ Incluir marker central
¬†       if (window.osCentroActual) {
¬†           const coordsCentro = window.osCentroActual.Coordenadas || window.osCentroActual.Coordendasgis;
¬†           if (coordsCentro && coordsCentro.includes(',')) {
¬†               const [lat, lng] = coordsCentro.split(',').map(c => parseFloat(c.trim()));
¬†               allBounds.extend([lat, lng]);
¬†           }
¬†       }
¬†
¬†       mapa.fitBounds(allBounds, { padding: [50, 50], maxZoom: 16 });
¬†
¬†       console.log('‚úÖ Filtro desactivado - Mostrando todo');
¬†
¬†   } else {
¬†       // ‚úÖ ACTIVAR FILTRO: Ocultar otros y resaltar seleccionados
¬†       console.log(`üîç Filtrando por tipolog√≠a: ${tipologia}`);
¬†
¬†       const markersSeleccionados = window.markersPorTipologia[tipologia];
¬†
¬†       // 1Ô∏è‚É£ Ocultar TODOS los markers (excepto los seleccionados)
¬†       Object.entries(window.markersPorTipologia).forEach(([tip, markersArray]) => {
¬†           markersArray.forEach(marker => {
¬†               if (tip !== tipologia) {
¬†                   mapa.removeLayer(marker); // ‚úÖ REMOVER del mapa
¬†               }
¬†           });
¬†       });
¬†
¬†       // 2Ô∏è‚É£ Mostrar y resaltar SOLO los seleccionados
¬†       const bounds = L.latLngBounds();
¬†
¬†       markersSeleccionados.forEach(marker => {
¬†           if (!mapa.hasLayer(marker)) {
¬†               mapa.addLayer(marker); // ‚úÖ AGREGAR de vuelta
¬†           }
¬†
¬†           bounds.extend(marker.getLatLng());
¬†
¬†           // Animaci√≥n de rebote
¬†           const icon = marker.getElement();
¬†           if (icon) {
¬†               icon.style.animation = 'bounce 1s ease-in-out 3';
¬†               setTimeout(() => {
¬†                   icon.style.animation = '';
¬†               }, 3000);
¬†           }
¬†
¬†           // Abrir popup temporalmente
¬†           marker.openPopup();
¬†           setTimeout(() => {
¬†               marker.closePopup();
¬†           }, 2000);
¬†       });
¬†
¬†       // 3Ô∏è‚É£ Centrar mapa en los markers filtrados
¬†       mapa.fitBounds(bounds, {
¬†           padding: [50, 50],
¬†           maxZoom: 16
¬†       });
¬†
¬†       // Guardar filtro activo
¬†       window.tipologiaFiltrada = tipologia;
¬†
¬†       // ‚úÖ Resaltar el div seleccionado
¬†       const divSeleccionado = document.getElementById(`tipologia\_${tipologia.replace(/\[^a-zA-Z0-9]/g, '\_')}`);
¬†       if (divSeleccionado) {
¬†           divSeleccionado.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
¬†           divSeleccionado.style.transform = 'translateX(5px)';
¬†           divSeleccionado.style.boxShadow = '0 4px 12px rgba(33,150,243,0.3)';
¬†       }
¬†
¬†       console.log(`‚úÖ Mostrando ${markersSeleccionados.length} markers de: ${tipologia}`);
¬†   }
}





// Funci√≥n para actualizar el c√≥digo de causa
function actualizarCodigoCausa() {
¬† const index = this.value;
¬† const causas = window.causasIPR;
¬† const inputCodigo = document.getElementById('ipr_codigo_causa');
¬† if (index !== '' && causas && causas[index]) {
¬†   inputCodigo.value = causas[index].codigo;
¬† } else {
¬†   inputCodigo.value = '';
¬† }
}

// Asignar listener al select de causa
const selectCausa = document.getElementById('ipr_causa');
if (selectCausa) {
¬† // Remover listener anterior si existe (evitar duplicados)
¬† const clonedSelect = selectCausa.cloneNode(true);
¬† selectCausa.parentNode.replaceChild(clonedSelect, selectCausa);
¬†
¬† // Asignar nuevo listener
¬† clonedSelect.addEventListener('change', actualizarCodigoCausa);
¬†
¬† // Actualizar inmediatamente si ya hay una causa seleccionada (ej. al editar)
¬† if (clonedSelect.value !== '') {
¬†   actualizarCodigoCausa.call(clonedSelect);
¬† }
}
async function guardarRegistroIPR() {
¬†   // Validar campos obligatorios
¬†   const medidor = document.getElementById('ipr_medidor').value.trim();
¬†   const nic = document.getElementById('ipr_nic').value.trim();
¬†   const forma = document.getElementById('ipr_forma').value.trim();
¬†   const marca = document.getElementById('ipr_marca').value.trim();
¬†
¬†   // ‚úÖ CORREGIDO: Validar existencia de ipr_tipo
¬†   const tipoElement = document.getElementById('ipr_tipo');
¬†   const tipo = tipoElement ? tipoElement.value.trim() : '';
¬†
¬†   const voltaje = document.getElementById('ipr_voltaje').value.trim();
¬†   const numOS = document.getElementById('ipr_numos').value.trim();
¬†   const causaIndex = document.getElementById('ipr_causa').value;
¬†
¬†   // Validaci√≥n completa
¬†   if (!medidor || !nic || !forma || !marca || !tipo || !voltaje || !numOS || !causaIndex) {
¬†       alert('‚ö†Ô∏è Por favor complete TODOS los campos obligatorios:\n\n‚Ä¢ Medidor\n‚Ä¢ NIC\n‚Ä¢ Forma\n‚Ä¢ Marca\n‚Ä¢ Tipo\n‚Ä¢ Voltaje\n‚Ä¢ NUM. O/S\n‚Ä¢ Causa de Retiro');
¬†       return;
¬†   }
¬†
¬†   // Validar que NIC y NUM.OS sean solo n√∫meros
¬†   if (!/^\d+$/.test(nic)) {
¬†       alert('‚ö†Ô∏è El NIC debe contener solo n√∫meros');
¬†       return;
¬†   }
¬†
¬†   if (!/^\d+$/.test(numOS)) {
¬†       alert('‚ö†Ô∏è NUM. O/S debe contener solo n√∫meros');
¬†       return;
¬†   }
¬†
¬†   if (!/^\d+$/.test(medidor)) {
¬†       alert('‚ö†Ô∏è El Medidor debe contener solo n√∫meros');
¬†       return;
¬†   }
¬†
¬†   // ‚úÖ Obtener c√≥digo Y causa SEPARADOS
¬†   const causaSeleccionada = window.causasIPR[parseInt(causaIndex)];
¬†   const codigo = causaSeleccionada.codigo;              // "Z90"
¬†   const causaDescripcion = causaSeleccionada.causa;     // "Medidor sin sello"
¬†
¬†   // Obtener unidad
¬†   const unidad = document.getElementById('ipr_unidad').value;
¬†
¬†   // ‚úÖ Confirmaci√≥n con CODIGO y CAUSA separados
¬†   const confirmar = confirm(
¬†       `¬øGuardar registro de retiro?\\n\\n` +
¬†       `üì¶ Medidor: ${medidor}\\n` +
¬†       `üìÑ NIC: ${nic}\\n` +
¬†       `üìã Forma: ${forma}\\n` +
¬†       `üè∑Ô∏è Marca: ${marca}\\n` +
¬†       `üîß Tipo: ${tipo}\\n` +
¬†       `‚ö° Voltaje: ${voltaje}\\n` +
¬†       `üìë NUM. O/S: ${numOS}\\n` +
¬†       `üî¢ C√≥digo: ${codigo}\\n` +                      // Solo "Z90"
¬†       `‚ö†Ô∏è Causa: ${causaDescripcion}\\n\\n` +           // Solo "Medidor sin sello"
¬†       `‚úÖ S√ç - Guardar\\n` +
¬†       `‚ùå NO - Cancelar`
¬†   );
¬†
¬†   if (!confirmar) return;
¬†
¬†   try {
¬†       // ‚úÖ INSERT con CODIGO y CAUSA en columnas SEPARADAS
¬†       const { error } = await supabaseClient
¬†           .from('retiro_medidores')
¬†           .insert({
¬†               codigo: codigo,                    // Columna "codigo" ‚Üí "Z90"
¬†               unidad: unidad,
¬†               nic: nic,
¬†               num_os: numOS,
¬†               medidor: medidor,
¬†               forma: forma,
¬†               marca: marca,
¬†               tipo: tipo,
¬†               voltaje: voltaje,
¬†               causa_retiro: causaDescripcion,   // Columna "causa_retiro" ‚Üí "Medidor sin sello"
¬†               fecha: new Date().toISOString().split('T')[0],
¬†               usuario_registro: currentUser.usuario
¬†           });
¬†
¬†       if (error) {
¬†           alert('‚ùå Error al guardar: ' + error.message);
¬†           return;
¬†       }
¬†
¬†       // ‚úÖ √âxito
¬†       alert('‚úÖ Registro guardado correctamente');
¬†
¬†       // Limpiar formulario y recargar
¬†       document.getElementById('ipr_medidor').value = '';
¬†       document.getElementById('datosAutocompletar').style.display = 'none';
¬†       cargarRegistrosIPR();
¬†
¬†   } catch (err) {
¬†       console.error('Error guardando registro:', err);
¬†       alert('‚ùå Error de conexi√≥n. Intente nuevamente.');
¬†   }
}


¬†	function procesarMedidorUnico(data) {
¬†   console.log('‚úÖ Medidor √∫nico encontrado');
¬†
¬†   // Validar si ya fue retirado
¬†   verificarRetiroPrevio(data.Medidor).then(existente => {
¬†       if (existente) return;
¬†
¬†       const datosExtraidos = extraerDatosComentario(data.ComentarioGeneral);
¬†       const unidadTransformada = transformarUsuarioAUnidad(currentUser.usuario);
¬†
¬†       const datosDiv = document.getElementById('datosAutocompletar');
¬†       datosDiv.innerHTML = generarFormularioIPRAutomatico(unidadTransformada, data.CuentaContrato, datosExtraidos);
¬†   });
}

¬†	function mostrarSelectorMedidores(resultados, medidor) {
¬†   console.log(`‚ö†Ô∏è ${resultados.length} registros encontrados para medidor ${medidor}`);
¬†
¬†   const datosDiv = document.getElementById('datosAutocompletar');
¬†   datosDiv.style.display = 'block';
¬†
¬†   let html = `
¬†       <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
¬†           <strong style="color: #e65100;">‚ö†Ô∏è MEDIDOR DUPLICADO</strong><br>
¬†           <p style="margin: 10px 0 0 0; color: #666;">
¬†               Se encontraron <strong>${resultados.length}</strong> registros con el medidor <strong>${medidor}</strong>.<br>
¬†               Selecciona el correcto seg√∫n la Cuenta (NIC):
¬†           </p>
¬†       </div>
¬†
¬†       <div style="display: grid; gap: 15px;">`;
¬†
¬†   resultados.forEach((item, idx) => {
¬†       html += `
¬†           <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #e1e5e9; cursor: pointer; transition: all 0.3s;"
¬†                onclick="seleccionarMedidor(${idx})"
¬†                onmouseover="this.style.borderColor='#3b54d3'; this.style.background='#f0f9ff'"
¬†                onmouseout="this.style.borderColor='#e1e5e9'; this.style.background='#f8f9fa'">
¬†
¬†               <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: start;">
¬†                   <div style="background: #3b54d3; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">
¬†                       ${idx + 1}
¬†                   </div>
¬†                   <div>
¬†                       <strong style="color: #1976d2; font-size: 16px;">üìÑ NIC: ${item.CuentaContrato}</strong><br>
¬†                       <span style="color: #666; font-size: 14px;">‚ö° Medidor: ${item.Medidor}</span>
¬†                   </div>
¬†               </div>
¬†           </div>`;
¬†   });
¬†
¬†   html += `</div>`;
¬†
¬†   datosDiv.innerHTML = html;
¬†
¬†   // Guardar resultados globalmente
¬†   window.medidoresDuplicados = resultados;
}


¬†	async function seleccionarMedidor(index) {
¬†   if (!window.medidoresDuplicados || !window.medidoresDuplicados[index]) {
¬†       alert('Error: Datos no disponibles');
¬†       return;
¬†   }
¬†
¬†   const medidorSeleccionado = window.medidoresDuplicados[index];
¬†
¬†   console.log(`‚úÖ Medidor seleccionado: NIC ${medidorSeleccionado.CuentaContrato}`);
¬†
¬†   // Validar retiro previo
¬†   const { data: existente } = await supabaseClient
¬†       .from('retiro_medidores')
¬†       .select('nic, num_os, fecha')
¬†       .eq('medidor', medidorSeleccionado.Medidor)
¬†       .eq('nic', medidorSeleccionado.CuentaContrato)  // ‚Üê Validar con NIC espec√≠fico
¬†       .order('fecha', { ascending: false })
¬†       .limit(1);
¬†
¬†   if (existente && existente.length > 0) {
¬†       const registro = existente[0];
¬†       const fechaRetiro = new Date(registro.fecha + 'T00:00:00').toLocaleDateString('es-ES');
¬†       const confirmar = confirm(
¬†           `‚ö†Ô∏è ADVERTENCIA\\n\\n` +
¬†           `Este medidor YA fue retirado para esta cuenta:\\n\\n` +
¬†           `‚Ä¢ NIC: ${registro.nic}\\n` +
¬†           `‚Ä¢ Fecha: ${fechaRetiro}\\n` +
¬†           `‚Ä¢ NUM. O/S: ${registro.num_os}\n\n` +
¬†           `¬øRegistrarlo nuevamente?`
¬†       );
¬†
¬†       if (!confirmar) {
¬†           document.getElementById('datosAutocompletar').style.display = 'none';
¬†           document.getElementById('ipr_medidor').value = '';
¬†           return;
¬†       }
¬†   }
¬†
¬†   // Procesar medidor seleccionado
¬†   const datosExtraidos = extraerDatosComentario(medidorSeleccionado.ComentarioGeneral);
¬†   const unidadTransformada = transformarUsuarioAUnidad(currentUser.usuario);
¬†
¬†   const datosDiv = document.getElementById('datosAutocompletar');
¬†   datosDiv.innerHTML = generarFormularioIPRAutomatico(
¬†       unidadTransformada,
¬†       medidorSeleccionado.CuentaContrato,
¬†       datosExtraidos
¬†   );
¬†
¬†   // Limpiar variable global
¬†   delete window.medidoresDuplicados;
}

¬†	async function verificarRetiroPrevio(medidor) {
¬†   const { data: existente } = await supabaseClient
¬†       .from('retiro_medidores')
¬†       .select('nic, num_os, fecha')
¬†       .eq('medidor', medidor)
¬†       .order('fecha', { ascending: false })
¬†       .limit(1);
¬†
¬†   if (existente && existente.length > 0) {
¬†       const registro = existente[0];
¬†       const fechaRetiro = new Date(registro.fecha + 'T00:00:00').toLocaleDateString('es-ES');
¬†       const confirmar = confirm(
¬†           `‚ö†Ô∏è ADVERTENCIA\\n\\n` +
¬†           `Este medidor YA fue retirado:\\n\\n` +
¬†           `‚Ä¢ Cuenta: ${registro.nic}\\n` +
¬†           `‚Ä¢ Fecha: ${fechaRetiro}\\n` +
¬†           `‚Ä¢ NUM. O/S: ${registro.num_os}\\n\\n` +
¬†           `¬øRegistrarlo nuevamente?`
¬†       );
¬†
¬†       if (!confirmar) {
¬†           document.getElementById('datosAutocompletar').style.display = 'none';
¬†           document.getElementById('ipr_medidor').value = '';
¬†           return true;
¬†       }
¬†   }
¬†   return false;
}

// ========================================
// üîç BUSCAR DATOS DE MEDIDOR EN CONSULTA SUMINISTRO
// ========================================
async function buscarDatosMedidorIPR() {
¬†   const inputMedidor = document.getElementById('ipr_medidor');
¬†   if (!inputMedidor) {
¬†       console.error('‚ùå Input medidor no existe');
¬†       return;
¬†   }

¬†   const medidor = inputMedidor.value.trim();
¬†   if (!medidor) {
¬†       alert('‚ö†Ô∏è Por favor ingrese un n√∫mero de medidor');
¬†       return;
¬†   }

¬†   const datosDiv = document.getElementById('datosAutocompletar');
¬†   if (!datosDiv) {
¬†       console.error('‚ùå Contenedor datosAutocompletar no existe');
¬†       return;
¬†   }

¬†   datosDiv.style.display = 'block';
¬†   datosDiv.innerHTML = '<div class="loading" style="display: block; margin: 20px auto;"></div><p style="text-align: center; color: #666;">Buscando medidor en Consulta Suministro...</p>';

¬†   try {
¬†       console.log('üîç Buscando medidor:', medidor);

¬†       const { data, error } = await supabaseClient
¬†           .from('consultas_servicios')
¬†           .select('id, CuentaContrato, Medidor, ComentarioGeneral')
¬†           .eq('Medidor', medidor);

¬†       // ‚úÖ Manejo de error o sin resultados
¬†       if (error || !data || data.length === 0) {
¬†           console.log('‚ö†Ô∏è Medidor NO encontrado - Activando modo manual');
¬†           const confirmar = confirm(
¬†               '‚ö†Ô∏è MODO MANUAL ACTIVADO\n\n' +
¬†               `El medidor "${medidor}" NO existe en Consulta Suministro.\\n\\n` +
¬†               'Deber√°s completar TODOS los campos manualmente.\n\n' +
¬†               '¬øDeseas continuar?'
¬†           );

¬†           if (!confirmar) {
¬†               datosDiv.style.display = 'none';
¬†               inputMedidor.value = '';
¬†               return;
¬†           }

¬†           const unidadTransformada = transformarUsuarioAUnidad(currentUser.usuario);
¬†           datosDiv.innerHTML = generarFormularioIPRManual(unidadTransformada, medidor);
¬†           return;
¬†       }

¬†       // ‚úÖ Caso con resultados
¬†       if (data.length === 1) {
¬†           procesarMedidorUnico(data[0]);
¬†       } else {
¬†           mostrarSelectorMedidores(data, medidor);
¬†       }

¬†   } catch (err) {
¬†       console.error('‚ùå Error en b√∫squeda:', err);
¬†       datosDiv.innerHTML = `
¬†           <div style="background: #ffebee; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336; margin-top: 20px;">
¬†               <strong style="color: #c62828;">‚ùå Error de conexi√≥n</strong><br>
¬†               <p style="margin: 10px 0 0 0; color: #666;">Intente nuevamente</p>
¬†           </div>`;
¬†   }
}


¬†		function generarFormularioIPRAutomatico(unidad, nic, datosExtraidos) {
¬†   return `
¬†       <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
¬†           <strong style="color: #2e7d32;">‚úÖ Datos encontrados en Consulta Suministro</strong>
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üè¢ Unidad:</label>
¬†           <input type="text" id="ipr_unidad" readonly value="${unidad}"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üìÑ NIC (Cuenta Contrato):</label>
¬†           <input type="text" id="ipr_nic" readonly value="${nic || 'N/A'}"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üìã Forma:</label>
¬†           <input type="text" id="ipr_forma" readonly value="${datosExtraidos.forma}"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üè∑Ô∏è Marca:</label>
¬†           <input type="text" id="ipr_marca" readonly value="${datosExtraidos.marca}"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†       </div>
¬†
¬†       <!-- ‚úÖ AGREGADO: Campo Tipo -->
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üîß Tipo:</label>
¬†           <input type="text" id="ipr_tipo" readonly value="${datosExtraidos.tipo}"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">‚ö° Voltaje:</label>
¬†           <input type="text" id="ipr_voltaje" readonly value="${datosExtraidos.voltaje}"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†       </div>
¬†
¬†       <hr style="margin: 30px 0; border: 1px solid #e2e8f0;">
¬†
¬†       <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
¬†           <strong style="color: #e65100;">üìù Completar informaci√≥n manualmente</strong>
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üìë NUM. O/S: <span style="color: #d32f2f;">*</span></label>
¬†           <input type="text" id="ipr_numos" placeholder="Ingrese n√∫mero de orden de servicio (solo n√∫meros)"
¬†                  oninput="this.value = this.value.replace(/[^0-9]/g, '')" maxlength="15"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">‚ö†Ô∏è Causa de Retiro: <span style="color: #d32f2f;">*</span></label>
¬†           <select id="ipr\_causa" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†               <option value="">-- Seleccione una causa --</option>
¬†               ${generarOpcionesCausaRetiro()}
¬†           </select>
¬†       </div>
¬†
¬†       <div style="text-align: center; margin-top: 30px;">
¬†           <button class="btn" onclick="guardarRegistroIPR()" style="font-size: 18px; padding: 18px 40px; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
¬†               üíæ Guardar Registro
¬†           </button>
¬†       </div>
¬†   `;
}




¬†	// ========================================
// üìã GENERAR FORMULARIO IPR MANUAL (Todos los campos editables)
// ========================================
function generarFormularioIPRManual(unidad, medidor) {
¬†   return `
¬†       <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
¬†           <strong style="color: #e65100;">‚ö†Ô∏è MODO MANUAL ACTIVADO</strong><br>
¬†           <p style="margin: 10px 0 0 0; color: #666;">El medidor "${medidor}" no est√° en Consulta Suministro. Complete TODOS los campos manualmente.</p>
¬†       </div>


¬†	<div class="form-group">
¬† <label style="font-weight: 600; color: #2d3748;">üî¢ C√≥digo de Causa:</label>
¬† <input type="text" id="ipr_codigo_causa" readonly
¬†        style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
</div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üè¢ Unidad:</label>
¬†           <input type="text" id="ipr_unidad" readonly value="${unidad}"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†           <small style="color: #666; display: block; margin-top: 5px;">Unidad autom√°tica (usuario logueado)</small>
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üìÑ NIC (Cuenta Contrato): <span style="color: #d32f2f;">*</span></label>
¬†           <input type="text" id="ipr_nic" placeholder="Ingrese NIC (solo n√∫meros)"
¬†                  oninput="validarNICManual(this)" maxlength="15"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†           <small id="nic\_validacion" style="display: block; margin-top: 5px;"></small>
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üìã Forma: <span style="color: #d32f2f;">*</span></label>
¬†           <input type="text" id="ipr_forma" placeholder="Ej: 233-15S"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üè∑Ô∏è Marca: <span style="color: #d32f2f;">*</span></label>
¬†           <input type="text" id="ipr_marca" placeholder="Ej: LANDIS+GYR"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üîß Tipo: <span style="color: #d32f2f;">*</span></label>
¬†           <input type="text" id="ipr_tipo" placeholder="Ej: E650 S4X RXR"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">‚ö° Voltaje: <span style="color: #d32f2f;">*</span></label>
¬†           <input type="text" id="ipr_voltaje" placeholder="Ej: 120/480V"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†       </div>
¬†
¬†       <hr style="margin: 30px 0; border: 1px solid #e2e8f0;">
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üìë NUM. O/S: <span style="color: #d32f2f;">*</span></label>
¬†           <input type="text" id="ipr_numos" placeholder="Ingrese n√∫mero de orden de servicio (solo n√∫meros)"
¬†                  oninput="this.value = this.value.replace(/[^0-9]/g, '')" maxlength="15"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">‚ö†Ô∏è Causa de Retiro: <span style="color: #d32f2f;">*</span></label>
¬†           <select id="ipr\_causa" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†               <option value="">-- Seleccione una causa --</option>
¬†               ${generarOpcionesCausaRetiro()}
¬†           </select>
¬†       </div>
¬†
¬†       <div style="text-align: center; margin-top: 30px;">
¬†           <button class="btn" onclick="guardarRegistroIPR()" style="font-size: 18px; padding: 18px 40px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
¬†               üíæ Guardar Registro (Modo Manual)
¬†           </button>
¬†       </div>
¬†   `;
}



// ========================================
// ‚úÖ VALIDAR NIC MANUAL (Solo n√∫meros + Validar en BD)
// ========================================
async function validarNICManual(input) {
¬†   const valor = input.value;
¬†   const validacion = document.getElementById('nic_validacion');
¬†
¬†   // Permitir solo n√∫meros
¬†   input.value = valor.replace(/[^0-9]/g, '');
¬†
¬†   if (input.value.length === 0) {
¬†       validacion.innerHTML = '';
¬†       validacion.style.color = '#666';
¬†       return;
¬†   }
¬†
¬†   // Validar longitud m√≠nima (12 d√≠gitos)
¬†   if (input.value.length < 12) {
¬†       validacion.innerHTML = '‚ö†Ô∏è El NIC debe tener al menos 12 d√≠gitos';
¬†       validacion.style.color = '#ff9800';
¬†       return;
¬†   }
¬†
¬†   // Validar contra Consulta Suministro
¬†   try {
¬†       const { data, error } = await supabaseClient
¬†           .from('consultas_servicios')
¬†           .select('CuentaContrato')
¬†           .eq('CuentaContrato', input.value)
¬†           .single();
¬†
¬†       if (data) {
¬†           validacion.innerHTML = '‚úÖ NIC v√°lido (existe en sistema)';
¬†           validacion.style.color = '#4caf50';
¬†       } else {
¬†           validacion.innerHTML = '‚ö†Ô∏è NIC no encontrado en sistema (se guardar√° de todas formas)';
¬†           validacion.style.color = '#ff9800';
¬†       }
¬†   } catch (err) {
¬†       validacion.innerHTML = '‚ö†Ô∏è Error validando NIC';
¬†       validacion.style.color = '#f44336';
¬†   }
}




¬†	// ========================================
// üìã GENERAR FORMULARIO IPR CON DATOS
// ========================================
function generarFormularioIPRConDatos(unidad, nic, datosExtraidos) {
¬†   return `
¬†       <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
¬†           <strong style="color: #2e7d32;">‚úÖ Datos encontrados - Verificar informaci√≥n</strong>
¬†       </div>

¬†	<div class="form-group">
¬†     <label style="font-weight: 600; color: #2d3748;">üî¢ C√≥digo de Causa:</label>
¬†     <input type="text" id="ipr_codigo_causa" readonly
¬†            style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†   </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üè¢ Unidad:</label>
¬†           <input type="text" id="ipr_unidad" readonly value="${unidad}"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üìÑ NIC (Cuenta Contrato):</label>
¬†           <input type="text" id="ipr_nic" readonly value="${nic || 'N/A'}"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üìã Forma:</label>
¬†           <input type="text" id="ipr_forma" readonly value="${datosExtraidos.forma}"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üè∑Ô∏è Marca y Tipo:</label>
¬†           <input type="text" id="ipr_marca" readonly value="${datosExtraidos.marca}"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">‚ö° Voltaje:</label>
¬†           <input type="text" id="ipr_voltaje" readonly value="${datosExtraidos.voltaje}"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; background: #f5f5f5; font-size: 16px;">
¬†       </div>
¬†
¬†       <hr style="margin: 30px 0; border: 1px solid #e2e8f0;">
¬†
¬†       <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
¬†           <strong style="color: #e65100;">üìù Completar informaci√≥n manualmente</strong>
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">üìë NUM. O/S: <span style="color: #d32f2f;">*</span></label>
¬†           <input type="text" id="ipr_numos" placeholder="Ingrese n√∫mero de orden de servicio"
¬†                  style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†       </div>
¬†
¬†       <div class="form-group">
¬†           <label style="font-weight: 600; color: #2d3748;">‚ö†Ô∏è Causa de Retiro: <span style="color: #d32f2f;">*</span></label>
¬†           <select id="ipr\_causa" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e1e5e9; font-size: 16px;">
¬†               <option value="">-- Seleccione una causa --</option>
¬†               ${generarOpcionesCausaRetiro()}
¬†           </select>
¬†       </div>
¬†
¬†       <div style="text-align: center; margin-top: 30px;">
¬†           <button class="btn" onclick="guardarRegistroIPR()" style="font-size: 18px; padding: 18px 40px; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
¬†               üíæ Guardar Registro
¬†           </button>
¬†       </div>
¬†   `;
}


¬†	// ========================================
// üìã GENERAR OPCIONES DE CAUSA DE RETIRO CON C√ìDIGOS
// ========================================
function generarOpcionesCausaRetiro() {
¬†   const causasConCodigo = [
¬†       { codigo: 'Z87', causa: 'Medidores provisionales o abandonados' },
¬†       { codigo: 'Z87', causa: 'Medidores testigos' },
¬†       { codigo: 'Z88', causa: 'Partes quebradas' },
¬†       { codigo: 'Z88', causa: 'Solo se entrega placa (destruido)' },
¬†       { codigo: 'Z89', causa: 'Pantalla da√±ada' },
¬†       { codigo: 'Z89', causa: 'Digitos cortados' },
¬†       { codigo: 'Z89', causa: 'Pantalla apagada/parpadea' },
¬†       { codigo: 'Z89', causa: 'Integrador da√±ado' },
¬†       { codigo: 'Z89', causa: 'Pantalla amarilla/empa√±ado' },
¬†       { codigo: 'Z90', causa: 'Linea directa' },
¬†       { codigo: 'Z90', causa: 'Medidor sin sello' },
¬†       { codigo: 'Z90', causa: 'Manipulado' },
¬†       { codigo: 'Z91', causa: 'Partes oxidadas' },
¬†       { codigo: 'Z91', causa: 'Agua interna' },
¬†       { codigo: 'Z92', causa: 'Cambio de medidor analogo a digital' },
¬†       { codigo: 'Z92', causa: 'Cambio a medidor bidireccional' },
¬†       { codigo: 'Z92', causa: 'Cambio de medidor por proyectos de telemedici√≥n' },
¬†       { codigo: 'Z93', causa: 'El cliente solicita el cambio' },
¬†       { codigo: 'Z94', causa: 'Medidor inadecuado con servicio' },
¬†       { codigo: 'Z95', causa: 'Cambio a sistema blindado' },
¬†       { codigo: 'Z96', causa: 'Caso SIGET' },
¬†       { codigo: 'Z97', causa: 'Por incremento de carga/cambio de tarifa' },
¬†       { codigo: 'Z97', causa: 'Levantamiento de medidor/Retiro' },
¬†       { codigo: 'Z97', causa: 'CAB x CAT' },
¬†       { codigo: 'Z98', causa: 'Cambio de medidor por sistema subterraneo' },
¬†       { codigo: 'Z99', causa: 'Retiro de medidores de la marca NANSEN M1AT' },
¬†       { codigo: 'Z99', causa: 'Retiro de medidores de la marca LANDIS+GYR E23A' },
¬†       { codigo: 'Z100', causa: 'Retiro de medidores de la marca IMTECH HX13D' },
¬†       { codigo: 'Z100', causa: 'Retiro de medidores de la marca VOLTREX DD9557 (240V)' },
¬†       { codigo: 'Z101', causa: 'No encontrado en campo' },
¬†       { codigo: 'Z102', causa: 'Queda instalado en campo' },
¬†       { codigo: 'Z103', causa: 'N√∫mero distinto entre f√≠sico y sistema' },
¬†       { codigo: 'Z104', causa: 'Medidor completamente quemado y no se observa el numero' },
¬†       { codigo: 'Z105', causa: 'Parte del cuerpo del medidor esta quemado' },
¬†       { codigo: 'Z105', causa: 'Bornera del medidor se encuentra quemada' }
¬†   ];
¬†
¬†   // Guardar globalmente para usar al guardar
¬†   window.causasIPR = causasConCodigo;
¬†
¬†   return causasConCodigo.map((item, index) =>
¬†       `<option value="${index}">${item.codigo} - ${item.causa}</option>`
¬†   ).join('');
}
¬†


¬†	// ========================================
// üìä EXTRAER DATOS DEL COMENTARIO GENERAL
// ========================================
function extraerDatosComentario(comentario) {
¬†   console.log('üìù Procesando comentario:', comentario);
¬†
¬†   const resultado = {
¬†       forma: 'N/A',
¬†       marca: 'N/A',
¬†       tipo: 'N/A',
¬†       voltaje: 'N/A'
¬†   };
¬†
¬†   if (!comentario) {
¬†       console.log('‚ö†Ô∏è Comentario vac√≠o');
¬†       return resultado;
¬†   }
¬†
¬†   // üîç Buscar Forma: "Forma 233-15S ." o "Forma: 233-15S"
¬†   const matchForma = comentario.match(/Forma[:\s]+([^\n\r.]+)/i);
¬†   if (matchForma) {
¬†       resultado.forma = matchForma[1].trim();
¬†       console.log('‚úÖ Forma encontrada:', resultado.forma);
¬†   }
¬†
¬†   // üîç Buscar Marca y Tipo: "Medidor: 97208817 - LANDIS+GYR E650 S4X RXR ."
¬†   const matchMarcaTipo = comentario.match(/Medidor[:\s]+\d+\s*-\s*([^\n\r.]+)/i);
¬†   if (matchMarcaTipo) {
¬†       const marcaTipoCompleto = matchMarcaTipo[1].trim();
¬†
¬†       // Separar Marca (primera palabra) y Tipo (resto)
¬†       const partes = marcaTipoCompleto.split(/\s+/);
¬†
¬†       if (partes.length > 0) {
¬†           resultado.marca = partes[0]; // Primera palabra = Marca
¬†           console.log('‚úÖ Marca encontrada:', resultado.marca);
¬†       }
¬†
¬†       if (partes.length > 1) {
¬†           resultado.tipo = partes.slice(1).join(' '); // Resto = Tipo
¬†           console.log('‚úÖ Tipo encontrado:', resultado.tipo);
¬†       }
¬†   } else {
¬†       console.log('‚ö†Ô∏è Marca/Tipo NO encontrados');
¬†   }
¬†
¬†   // üîç Buscar Voltaje: "Tension 120/480V ." o "Tension: 120/480V"
¬†   const matchVoltaje = comentario.match(/Tension[:\s]+([^\n\r.]+)/i);
¬†   if (matchVoltaje) {
¬†       resultado.voltaje = matchVoltaje[1].trim();
¬†       console.log('‚úÖ Voltaje encontrado:', resultado.voltaje);
¬†   }
¬†
¬†   console.log('üìä Resultado final:', resultado);
¬†   return resultado;
}

¬†
¬†	// ========================================
// üóëÔ∏è LIMPIAR REGISTROS VIEJOS (30+ D√çAS)
// ========================================
// ========================================
// üóëÔ∏è LIMPIAR REGISTROS VIEJOS (30+ D√çAS)
// ========================================
async function limpiarRegistrosViejosIPR() {
    try {
        // ‚úÖ √öNICA declaraci√≥n de fechaLimite
        const fechaLimite = new Date();
        fechaLimite.setDate(fechaLimite.getDate() - 30); // ‚Üê 30 d√≠as atr√°s
        
        const fechaLimiteStr = formatearFechaElSalvador(fechaLimite);
        
        const { error } = await supabaseClient
            .from('retiro_medidores')
            .delete()
            .lt('fecha', fechaLimiteStr);
        
        if (error) {
            console.error('Error limpiando registros viejos:', error);
        } else {
            console.log('üóëÔ∏è Registros viejos limpiados (30+ d√≠as)');
        }
    } catch (err) {
        console.error('Error en limpieza autom√°tica:', err);
    }
}
¬†	// ========================================
// üìã CARGAR REGISTROS IPR
// ========================================
async function cargarRegistrosIPR() {
¬†   const resultsContainer = document.getElementById('searchResults');
¬†
¬†   resultsContainer.innerHTML = '<div class="loading" style="display: block; margin: 20px auto;"></div>';
¬†
¬†   try {
¬†       let query = supabaseClient
¬†           .from('retiro_medidores')
¬†           .select('*')
¬†           .order('fecha', { ascending: false });
¬†
¬†       // üîí Filtrar por unidad seg√∫n rol
¬†       if (currentUser.rol !== 'Administrador' &&
¬†           currentUser.rol !== 'Supervisor' &&
¬†           currentUser.rol !== 'Bodega') {
¬†           const unidadUsuario = transformarUsuarioAUnidad(currentUser.usuario);
¬†           query = query.eq('unidad', unidadUsuario);
¬†       }
¬†
¬†       const { data, error } = await query;
¬†
¬†       if (error) {
¬†           resultsContainer.innerHTML = '<div class="result-card">‚ùå Error al cargar registros</div>';
¬†           return;
¬†       }
¬†
¬†       if (!data || data.length === 0) {
¬†           resultsContainer.innerHTML = `
¬†               <div class="result-card" style="background: #f0f9ff; border: 2px solid #2196f3;">
¬†                   <div class="result-header">‚ÑπÔ∏è Sin registros</div>
¬†                   <p style="text-align: center; color: #666;">No hay registros de retiro de medidores</p>
¬†               </div>`;
¬†           return;
¬†       }
¬†
¬†       // Guardar datos globalmente
¬†       window.registrosIPR = data;
¬†
¬†       // Generar interfaz
¬†       mostrarRegistrosIPR(data);
¬†
¬†   } catch (err) {
¬†       console.error('Error cargando registros IPR:', err);
¬†       resultsContainer.innerHTML = '<div class="result-card">‚ùå Error de conexi√≥n</div>';
¬†   }
}


¬†	// ========================================
// üìä MOSTRAR REGISTROS IPR CON FILTROS
// ========================================
function mostrarRegistrosIPR(registros) {
¬†   const resultsContainer = document.getElementById('searchResults');
¬†
¬†   // Obtener unidades y fechas √∫nicas para filtros
¬†   const unidadesUnicas = [...new Set(registros.map(r => r.unidad))].sort();
¬†   const fechasUnicas = [...new Set(registros.map(r => r.fecha))].sort().reverse();
¬†
¬†   // Determinar si mostrar filtro de unidad
¬†   const mostrarFiltroUnidad = (currentUser.rol === 'Administrador' ||
¬†                                currentUser.rol === 'Supervisor' ||
¬†                                currentUser.rol === 'Bodega');
¬†
¬†   let html = `
¬†       <div class="result-card" style="background: #f0f9ff; border: 2px solid #2196f3;">
¬†           <div class="result-header">üìã Registros de Retiro de Medidores (${registros.length})</div>
¬†
¬†           <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
¬†               <strong style="font-size: 16px; color: #2d3748;">üîç Filtros</strong>
¬†
¬†               <div style="display: grid; grid-template-columns: ${mostrarFiltroUnidad ? '1fr 1fr' : '1fr'}; gap: 15px; margin-top: 15px;">`;
¬†
¬†   // Filtro de unidad (solo para Admin/Supervisor/Bodega)
¬†   if (mostrarFiltroUnidad) {
¬†       html += `
¬†           <div>
¬†               <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">Filtrar por Unidad:</label>
¬†               <select id="filtro\_unidad\_ipr" onchange="aplicarFiltrosIPR()" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
¬†                   <option value="">-- Todas las unidades --</option>
¬†                   ${unidadesUnicas.map(u => `<option value="${u}">${u}</option>`).join('')}
¬†               </select>
¬†           </div>`;
¬†   }
¬†
¬†   // Filtro de fecha
¬†   html += `
¬†           <div>
¬†               <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">Filtrar por Fecha:</label>
¬†               <select id="filtro\_fecha\_ipr" onchange="aplicarFiltrosIPR()" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e1e5e9;">
¬†                   <option value="">-- Todas las fechas --</option>
¬†                   ${fechasUnicas.map(f => {
¬†                       const fechaFormateada = new Date(f + 'T00:00:00').toLocaleDateString('es-ES');
¬†                       return `<option value="${f}">${fechaFormateada}</option>`;
¬†                   }).join('')}
¬†               </select>
¬†           </div>
¬†       </div>
¬†
¬†       <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
¬†           <button class="btn btn-secondary" onclick="limpiarFiltrosIPR()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">
¬†               üóëÔ∏è Limpiar Filtros
¬†           </button>
¬†           <button class="btn btn-secondary" onclick="exportarExcelIPR()" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
¬†               üì• Exportar Excel
¬†           </button>
¬†       </div>
¬†
¬†   </div>
</div>`;
¬†
¬†   // Tabla de registros
¬†   html += generarTablaRegistrosIPR(registros);
¬†
¬†   resultsContainer.innerHTML = html;
}



¬†	function generarTablaRegistrosIPR(registros) {
¬†   if (!registros || registros.length === 0) {
¬†       return `<div class="result-card" style="background: #fff3cd;">
¬†                   <p style="text-align: center; color: #666;">No hay registros que coincidan con los filtros</p>
¬†               </div>`;
¬†   }
¬†
¬†   const registrosPorPagina = 20;
¬†   const paginaActual = window.paginaActualIPR || 1;
¬†   const totalPaginas = Math.ceil(registros.length / registrosPorPagina);
¬†
¬†   const inicio = (paginaActual - 1) * registrosPorPagina;
¬†   const fin = inicio + registrosPorPagina;
¬†   const registrosPagina = registros.slice(inicio, fin);
¬†
¬†   let html = `
¬†       <div class="result-card" style="background: white;">
¬†           <div style="overflow-x: auto;">
¬†               <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
¬†                   <thead>
¬†   <tr style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white;">
¬†       <th style="padding: 10px; text-align: center;">CODIGO</th>  <!-- ‚úÖ AGREGAR -->
¬†       <th style="padding: 10px; text-align: center;">ID</th>
¬†       <th style="padding: 10px; text-align: left;">Unidad</th>
¬†       <th style="padding: 10px; text-align: left;">NIC</th>
¬†       <th style="padding: 10px; text-align: left;">NUM. O/S</th>
¬†       <th style="padding: 10px; text-align: left;">Medidor</th>
¬†       <th style="padding: 10px; text-align: left;">Forma</th>
¬†       <th style="padding: 10px; text-align: left;">Marca</th>
¬†       <th style="padding: 10px; text-align: left;">Tipo</th>
¬†       <th style="padding: 10px; text-align: left;">Voltaje</th>
¬†       <th style="padding: 10px; text-align: left;">Causa de Retiro</th> <!-- ‚úÖ RENOMBRAR -->
¬†   </tr>
</thead>                    <tbody>`;
¬†
¬†   registrosPagina.forEach((registro, idx) => {
¬†   const bgColor = idx % 2 === 0 ? '#f8f9fa' : 'white';
¬†   const fechaFormateada = new Date(registro.fecha + 'T00:00:00').toLocaleDateString('es-ES');
¬†
¬†   html += `
¬†       <tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;">
¬†           <td style="padding: 10px; text-align: center; font-weight: 700; color: #1976d2;">${registro.codigo || 'N/A'}</td>  <!-- ‚úÖ AGREGAR -->
¬†           <td style="padding: 10px; text-align: center; font-weight: 600;">${registro.id}</td>
¬†           <td style="padding: 10px;">${registro.unidad || 'N/A'}</td>
¬†           <td style="padding: 10px;">${registro.nic || 'N/A'}</td>
¬†           <td style="padding: 10px; font-weight: 600; color: #1976d2;">${registro.num_os}</td>
¬†           <td style="padding: 10px; font-weight: 600;">${registro.medidor}</td>
¬†           <td style="padding: 10px;">${registro.forma || 'N/A'}</td>
¬†           <td style="padding: 10px;">${registro.marca || 'N/A'}</td>
¬†           <td style="padding: 10px;">${registro.tipo || 'N/A'}</td>
¬†           <td style="padding: 10px;">${registro.voltaje || 'N/A'}</td>
¬†           <td style="padding: 10px; max-width: 250px; overflow: hidden; text-overflow: ellipsis;"
¬†               title="${registro.causa_retiro}">
¬†               ${registro.causa_retiro}  <!-- ‚úÖ SOLO LA CAUSA -->
¬†           </td>
¬†       </tr>`;
});
¬†   html += `
¬†                   </tbody>
¬†               </table>
¬†           </div>`;
¬†
¬†   if (totalPaginas > 1) {
¬†       html += `
¬†           <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 15px; border-top: 2px solid #e2e8f0;">
¬†               <button class="btn btn-secondary" onclick="cambiarPaginaIPR(${paginaActual - 1})"
¬†                       ${paginaActual === 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
¬†                   ‚Üê Anterior
¬†               </button>
¬†               <span style="font-weight: 600; color: #2d3748;">
¬†                   P√°gina ${paginaActual} de ${totalPaginas} (${registros.length} registros)
¬†               </span>
¬†               <button class="btn btn-secondary" onclick="cambiarPaginaIPR(${paginaActual + 1})"
¬†                       ${paginaActual === totalPaginas ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
¬†                   Siguiente ‚Üí
¬†               </button>
¬†           </div>`;
¬†   }
¬†
¬†   html += `</div>`;
¬†
¬†   return html;
}



¬†	// ========================================
// üîÑ APLICAR FILTROS IPR
// ========================================
// ========================================
// üîÑ APLICAR FILTROS IPR
// ========================================
function aplicarFiltrosIPR() {
¬†   if (!window.registrosIPR) return;
¬†
¬†   let registrosFiltrados = [...window.registrosIPR];
¬†
¬†   // Filtro por unidad
¬†   const filtroUnidad = document.getElementById('filtro_unidad_ipr');
¬†   if (filtroUnidad && filtroUnidad.value) {
¬†       registrosFiltrados = registrosFiltrados.filter(r => r.unidad === filtroUnidad.value);
¬†   }
¬†
¬†   // Filtro por fecha
¬†   const filtroFecha = document.getElementById('filtro_fecha_ipr');
¬†   if (filtroFecha && filtroFecha.value) {
¬†       registrosFiltrados = registrosFiltrados.filter(r => r.fecha === filtroFecha.value);
¬†   }
¬†
¬†   // üÜï Filtro por medidor (busca en TODOS los registros)
¬†   const filtroMedidor = document.getElementById('filtro_medidor_ipr');
¬†   if (filtroMedidor && filtroMedidor.value.trim()) {
¬†       const busqueda = filtroMedidor.value.trim().toLowerCase();
¬†       registrosFiltrados = registrosFiltrados.filter(r =>
¬†           r.medidor && r.medidor.toLowerCase().includes(busqueda)
¬†       );
¬†   }
¬†
¬†   // Resetear paginaci√≥n
¬†   window.paginaActualIPR = 1;
¬†
¬†   // Actualizar solo la tabla
¬†   const resultsContainer = document.getElementById('searchResults');
¬†   const tablaHTML = generarTablaRegistrosIPR(registrosFiltrados);
¬†   const tablaExistente = resultsContainer.querySelector('.result-card:last-child');
¬†   if (tablaExistente) {
¬†       tablaExistente.outerHTML = tablaHTML;
¬†   }
}




// ========================================
// üóëÔ∏è LIMPIAR FILTROS IPR
// ========================================
function limpiarFiltrosIPR() {
¬†   const filtroUnidad = document.getElementById('filtro_unidad_ipr');
¬†   const filtroFecha = document.getElementById('filtro_fecha_ipr');
¬†   const filtroMedidor = document.getElementById('filtro_medidor_ipr');
¬†
¬†   if (filtroUnidad) filtroUnidad.value = '';
¬†   if (filtroFecha) filtroFecha.value = '';
¬†   if (filtroMedidor) filtroMedidor.value = '';
¬†
¬†   window.paginaActualIPR = 1;
¬†
¬†   mostrarRegistrosIPR(window.registrosIPR);
}



// ========================================
// üìÑ CAMBIAR P√ÅGINA IPR
// ========================================
function cambiarPaginaIPR(nuevaPagina) {
¬†   window.paginaActualIPR = nuevaPagina;
¬†
¬†   // Obtener registros actuales (con filtros aplicados si existen)
¬†   let registrosMostrar = [...window.registrosIPR];
¬†
¬†   // Aplicar filtros si existen
¬†   const filtroUnidad = document.getElementById('filtro_unidad_ipr');
¬†   const filtroFecha = document.getElementById('filtro_fecha_ipr');
¬†   const filtroMedidor = document.getElementById('filtro_medidor_ipr');
¬†
¬†   if (filtroUnidad && filtroUnidad.value) {
¬†       registrosMostrar = registrosMostrar.filter(r => r.unidad === filtroUnidad.value);
¬†   }
¬†
¬†   if (filtroFecha && filtroFecha.value) {
¬†       registrosMostrar = registrosMostrar.filter(r => r.fecha === filtroFecha.value);
¬†   }
¬†
¬†   if (filtroMedidor && filtroMedidor.value.trim()) {
¬†       const busqueda = filtroMedidor.value.trim().toLowerCase();
¬†       registrosMostrar = registrosMostrar.filter(r =>
¬†           r.medidor && r.medidor.toLowerCase().includes(busqueda)
¬†       );
¬†   }
¬†
¬†   // Actualizar solo la tabla
¬†   const resultsContainer = document.getElementById('searchResults');
¬†   const tablaHTML = generarTablaRegistrosIPR(registrosMostrar);
¬†   const tablaExistente = resultsContainer.querySelector('.result-card:last-child');
¬†
¬†   if (tablaExistente) {
¬†       tablaExistente.outerHTML = tablaHTML;
¬†   }
}


¬†	// ========================================
// üì• EXPORTAR EXCEL IPR
// ========================================
function exportarExcelIPR() {
¬†   if (!window.registrosIPR || window.registrosIPR.length === 0) {
¬†       alert('‚ö†Ô∏è No hay registros para exportar');
¬†       return;
¬†   }
¬†
¬†   let registrosExportar = [...window.registrosIPR];
¬†   // Aplicar filtros si existen
¬†   const filtroUnidad = document.getElementById('filtro_unidad_ipr');
¬†   const filtroFecha = document.getElementById('filtro_fecha_ipr');
¬†   const filtroMedidor = document.getElementById('filtro_medidor_ipr');
¬†
¬†   if (filtroUnidad && filtroUnidad.value) {
¬†       registrosExportar = registrosExportar.filter(r => r.unidad === filtroUnidad.value);
¬†   }
¬†
¬†   if (filtroFecha && filtroFecha.value) {
¬†       registrosExportar = registrosExportar.filter(r => r.fecha === filtroFecha.value);
¬†   }
¬†
¬†   if (filtroMedidor && filtroMedidor.value.trim()) {
¬†       const busqueda = filtroMedidor.value.trim().toLowerCase();
¬†       registrosExportar = registrosExportar.filter(r =>
¬†           r.medidor && r.medidor.toLowerCase().includes(busqueda)
¬†       );
¬†   }
¬†
¬†   if (registrosExportar.length === 0) {
¬†       alert('‚ö†Ô∏è No hay registros que coincidan con los filtros aplicados');
¬†       return;
¬†   }
¬†
¬†   const confirmar = confirm(
¬†       `üì• Exportar registros a Excel\\n\\n` +
¬†       `Total de registros: ${registrosExportar.length}\\n\\n` +
¬†       `¬øContinuar?`
¬†   );
¬†
¬†   if (!confirmar) return;
¬†
¬†   try {
¬†       // ‚úÖ ORDEN CORRECTO DE COLUMNAS
¬†       const datosExcel = registrosExportar.map(registro => ({
¬†           'CODIGO': registro.codigo || 'N/A',              // 1
¬†           'ID': registro.id,                               // 2
¬†           'Unidad': registro.unidad || 'N/A',              // 3
¬†           'NIC': registro.nic || 'N/A',                    // 4
¬†           'NUM. O/S': registro.num_os,                     // 5
¬†           'Medidor': registro.medidor,                     // 6
¬†           'Forma': registro.forma || 'N/A',                // 7
¬†           'Marca': registro.marca || 'N/A',                // 8
¬†           'Tipo': registro.tipo || 'N/A',                  // 9
¬†           'Voltaje': registro.voltaje || 'N/A',            // 10
¬†           'Causa de Retiro': registro.causa_retiro,        // 11 ‚úÖ SOLO CAUSA
¬†           'Fecha': new Date(registro.fecha + 'T00:00:00').toLocaleDateString('es-ES') // 12
¬†       }));
¬†
¬†       // Crear libro de Excel
¬†       const wb = XLSX.utils.book_new();
¬†       const ws = XLSX.utils.json_to_sheet(datosExcel);
¬†
¬†       // ‚úÖ AJUSTAR ANCHO DE COLUMNAS (12 columnas)
¬†       const columnWidths = [
¬†           { wch: 8 },   // CODIGO
¬†           { wch: 8 },   // ID
¬†           { wch: 15 },  // Unidad
¬†           { wch: 15 },  // NIC
¬†           { wch: 12 },  // NUM. O/S
¬†           { wch: 12 },  // Medidor
¬†           { wch: 12 },  // Forma
¬†           { wch: 20 },  // Marca
¬†           { wch: 20 },  // Tipo
¬†           { wch: 12 },  // Voltaje
¬†           { wch: 45 },  // Causa de Retiro
¬†           { wch: 12 }   // Fecha
¬†       ];
¬†       ws['!cols'] = columnWidths;
¬†
¬†       // Agregar hoja al libro
¬†       XLSX.utils.book_append_sheet(wb, ws, 'Retiro Medidores');
¬†
¬†       // Generar nombre de archivo
¬†       const fechaHoy = new Date().toISOString().split('T')[0];
¬†       let nombreArchivo = `IPR\_${fechaHoy}`;
¬†
¬†       const filtroUnidad = document.getElementById('filtro_unidad_ipr');
¬†       const filtroFecha = document.getElementById('filtro_fecha_ipr');
¬†
¬†       if (filtroUnidad && filtroUnidad.value) {
¬†           nombreArchivo += `\_${filtroUnidad.value}`;
¬†       }
¬†
¬†       if (filtroFecha && filtroFecha.value) {
¬†           nombreArchivo += `\_${filtroFecha.value}`;
¬†       }
¬†
¬†       nombreArchivo += '.xlsx';
¬†
¬†       // Descargar archivo
¬†       XLSX.writeFile(wb, nombreArchivo);
¬†
¬†       console.log(`‚úÖ Excel exportado: ${nombreArchivo}`);
¬†
¬†   } catch (err) {
¬†       console.error('Error exportando Excel:', err);
¬†       alert('‚ùå Error al generar Excel. Intente nuevamente.');
¬†   }
}


¬†	// ========================================
// üìÖ CARGAR FESTIVOS DESDE SUPABASE
// ========================================
let festivosCache = [];

async function cargarFestivos() {
¬†   try {
¬†       const { data, error } = await supabaseClient
¬†           .from('festivos')
¬†           .select('fecha')
¬†           .eq('activo', true);
¬†
¬†       if (!error && data) {
¬†           festivosCache = data.map(f => f.fecha);
¬†           console.log('‚úÖ Festivos cargados:', festivosCache);
¬†       }
¬†   } catch (err) {
¬†       console.error('Error cargando festivos:', err);
¬†   }
}

// ========================================
// üìÖ CALCULAR D√çAS H√ÅBILES (EXCLUYE S√ÅB/DOM/FESTIVOS)
// ========================================
function calcularDiasHabiles(fechaGen) {
¬†   if (!fechaGen) return null;
¬†
¬†   const hoy = getFechaElSalvador();
¬†   hoy.setHours(0, 0, 0, 0);
¬†
¬†   const fechaInicio = new Date(fechaGen);
¬†   fechaInicio.setHours(0, 0, 0, 0);
¬†
¬†   let diasHabiles = 0;
¬†   let fechaActual = new Date(fechaInicio);
¬†
¬†   while (fechaActual <= hoy) {
¬†       const diaSemana = fechaActual.getDay(); // 0=Domingo, 6=S√°bado
¬†       const fechaStr = fechaActual.toISOString().split('T')[0];
¬†
¬†       // Contar si NO es s√°bado, NO es domingo, NO es festivo
¬†       if (diaSemana !== 0 && diaSemana !== 6 && !festivosCache.includes(fechaStr)) {
¬†           diasHabiles++;
¬†       }
¬†
¬†       fechaActual.setDate(fechaActual.getDate() + 1);
¬†   }
¬†
¬†   return diasHabiles;
}
¬†

¬†	// ========================================
// üìÖ CALCULAR D√çAS DESDE GENERACI√ìN
// ========================================
function calcularDias(fechaGen) {
¬†   if (!fechaGen) return 999;
¬†
¬†   const fechaGeneracion = new Date(fechaGen);
¬†   const hoy = getFechaElSalvador();
¬†
¬†   const diffMs = hoy - fechaGeneracion;
¬†   const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
¬†
¬†   return diffDias;
}

¬†function determinarRango(dias) {
    return obtenerRangoPorNumero(dias);
}



// √öNICA FUENTE DE VERDAD PARA LOS RANGOS
function obtenerRangoPorNumero(dias) {
    const d = parseInt(dias);
    if (isNaN(d) || d < 0) return "FUERA DE RANGO";

    if (d <= 5) return '0-5';
    if (d <= 10) return '6-10';
    if (d <= 15) return '11-15';
    if (d <= 20) return '16-20';
    if (d <= 30) return '21-30';
    if (d <= 45) return '31-45';
    if (d <= 180) return '46-180';
    return '>180';
}

// ========================================
// ‚ö†Ô∏è DETERMINAR CONDICI√ìN (TEMPORAL - Sin Dias_por_OS)
// ========================================
function determinarCondicion(dias, diasPorOS) {
¬†   if (dias === null || dias === undefined) return 'Sin datos';
¬†
¬†   // Por ahora asumimos 15 d√≠as est√°ndar (TEMPORAL)
¬†   // En PARTE 3 lo haremos din√°mico seg√∫n tipolog√≠a
¬†   const plazoEstandar = diasPorOS || 15;
¬†
¬†   const diferencia = plazoEstandar - dias;
¬†
¬†   if (diferencia < 0) return 'VENCIDO';
¬†   if (diferencia === 0) return 'HOY';
¬†   if (diferencia === 1) return 'MA√ëANA';
¬†   return 'EN TIEMPO';
}


// ========================================
// üóÇÔ∏è AGRUPAR Y PROCESAR OS PENDIENTES
// ========================================
function procesarOSPendientes(osPendientes) {
¬†   const datosAgrupados = {
¬†       reguladas: {},
¬†       noReguladas: {}
¬†   };
¬†
¬†   osPendientes.forEach(os => {
¬†   // Determinar tipo primero
¬†   const valorTipo = os.Tipo_de_OS ? os.Tipo_de_OS.toLowerCase() : '';
¬†   const esRegulada = (valorTipo.includes('regulad') && !valorTipo.includes('no'));
¬†
¬†   // Calcular d√≠as seg√∫n tipo
¬†   const dias = esRegulada
¬†       ? calcularDiasHabiles(os['Fecha Gen.'])  // ‚úÖ H√°biles para Reguladas
¬†       : calcularDias(os['Fecha Gen.']);         // ‚ùå Normales para No Reguladas
¬†
¬†   const rango = determinarRango(dias);
¬†   const condicion = determinarCondicion(dias, os.Dias_por_OS);
¬†
¬†   const tipo = esRegulada ? 'reguladas' : 'noReguladas';
¬†
¬†      const unidad = os.Unidad || 'Sin Unidad';
¬†
¬†       // Inicializar unidad si no existe
¬†       if (!datosAgrupados[tipo][unidad]) {
¬†           datosAgrupados[tipo][unidad] = {
¬†               porRango: {
¬†                   '0-5': [],
¬†                   '6-10': [],
¬†                   '11-15': [],
¬†                   '16-20': [],
¬†                   '21-30': [],
¬†                   '31-45': [],
¬†                   '46-180': [],
¬†                   '>180': [],
¬†                   'Sin datos': []
¬†               },
¬†               porCondicion: {
¬†                   'HOY': [],
¬†                   'MA√ëANA': [],
¬†                   'EN TIEMPO': [],
¬†                   'VENCIDO': [],
¬†                   'Sin datos': []
¬†               }
¬†           };
¬†       }
¬†
¬†       // Agregar OS a sus categor√≠as
¬†       const osConDatos = {
¬†           ...os,
¬†           dias_calculados: dias,
¬†           rango: rango,
¬†           condicion: condicion
¬†       };
¬†
¬†       // Validar que el rango y condici√≥n existan antes de hacer push
¬†       if (datosAgrupados[tipo][unidad].porRango[rango]) {
¬†           datosAgrupados[tipo][unidad].porRango[rango].push(osConDatos);
¬†       } else {
¬†           console.warn('Rango no reconocido:', rango);
¬†           datosAgrupados[tipo][unidad].porRango['Sin datos'].push(osConDatos);
¬†       }
¬†
¬†       if (datosAgrupados[tipo][unidad].porCondicion[condicion]) {
¬†           datosAgrupados[tipo][unidad].porCondicion[condicion].push(osConDatos);
¬†       } else {
¬†           console.warn('Condici√≥n no reconocida:', condicion);
¬†           datosAgrupados[tipo][unidad].porCondicion['Sin datos'].push(osConDatos);
¬†       }
¬†   });
¬†
¬†   return datosAgrupados;
}



// ========================================
// üìä GENERAR TABLA POR RANGO DE D√çAS
// ========================================
function generarTablaPorRango(datos, tipoOS) {
¬†   const unidades = Object.keys(datos).sort();
¬†   if (unidades.length === 0) {
¬†       return `<p style="color: #666; text-align: center;">No hay datos de OS ${tipoOS}</p>`;
¬†   }
¬†   const rangos = ['0-5', '6-10', '11-15', '16-20', '21-30', '31-45', '46-180', '>180'];
¬†   // ‚úÖ DEFINIR 'condiciones' aqu√≠, igual que en generarTablaPorCondicion
¬†   const condiciones = ['HOY', 'MA√ëANA', 'EN TIEMPO', 'VENCIDO'];

¬†   let html = `
¬†       <div style="overflow-x: auto; margin: 20px 0;">
¬†           <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
¬†               <thead>
¬†   <tr style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
¬†       <th style="padding: 15px; text-align: left; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">Unidad</th>
¬†       ${rangos.map(r => `<th style="padding: 15px; text-align: center; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">${r}</th>`).join('')}
¬†       <th style="padding: 15px; text-align: center; font-weight: 700; background: rgba(0,0,0,0.2);">TOTAL</th>
¬†   </tr>
</thead>
¬†               <tbody>`;
¬†   unidades.forEach((unidad, idx) => {
¬†       const bgColor = idx % 2 === 0 ? '#f8f9fa' : 'white';
¬†       html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;" id="fila\_${tipoOS}\_rango\_${idx}">`;
¬†       html += `<td style="padding: 12px; font-weight: 600; color: #2d3748; border-right: 1px solid #e2e8f0;">${unidad}</td>`;
¬†       rangos.forEach(rango => {
¬†           const count = datos[unidad].porRango[rango].length;
¬†           const hasData = count > 0;
¬†           html += `
¬†               <td style="padding: 12px; text-align: center; border-right: 1px solid #e2e8f0; cursor: ${hasData ? 'pointer' : 'default'};"
¬†                   ${hasData ? `onclick="toggleDetalleRango('${unidad}', '${rango}', '${tipoOS}', ${idx})"` : ''}>
¬†                   <span style="
¬†                       display: inline-block;
¬†                       min-width: 30px;
¬†                       padding: 6px 12px;
¬†                       border-radius: 6px;
¬†                       font-weight: 600;
¬†                       background: ${hasData ? '#e3f2fd' : '#f5f5f5'};
¬†                       color: ${hasData ? '#1976d2' : '#999'};
¬†                       ${hasData ? 'box-shadow: 0 2px 4px rgba(25,118,210,0.2);' : ''}
¬†                   ">
¬†                       ${count}
¬†                   </span>
¬†               </td>`;
¬†       });
¬†       const total = condiciones.reduce((sum, c) => sum + (datos[unidad].porCondicion[c] || []).length, 0);
¬†       html += `<td style="padding: 12px; text-align: center; font-weight: 700; background: rgba(0,0,0,0.05); font-size: 16px; border-right: 1px solid #e2e8f0;">${total}</td>`;
¬†       html += `</tr>`;
¬†       // Fila oculta para el detalle
¬†       html += `
¬†           <tr id="detalle\_${tipoOS}\_rango\_${idx}" style="display: none; background: #fff3cd;">
¬†               <td colspan="${rangos.length + 1}" style="padding: 15px;">
¬†                   <div id="contenido\_detalle\_${tipoOS}\_rango\_${idx}"></div>
¬†               </td>
¬†           </tr>`;
¬†   });
¬†   html += `</tbody></table></div>`;
¬†   return html;
}

¬†	// ========================================
// ‚ö†Ô∏è GENERAR TABLA POR CONDICI√ìN
// ========================================
function generarTablaPorCondicion(datos, tipoOS) {
¬†   const unidades = Object.keys(datos).sort();
¬†
¬†   if (unidades.length === 0) {
¬†       return `<p style="color: #666; text-align: center;">No hay datos de OS ${tipoOS}</p>`;
¬†   }
¬†
¬†   const condiciones = ['HOY', 'MA√ëANA', 'EN TIEMPO', 'VENCIDO'];
¬†   const coloresCondicion = {
¬†       'HOY': '#ef5350',
¬†       'MA√ëANA': '#ffa726',
¬†       'EN TIEMPO': '#66bb6a',
¬†       'VENCIDO': '#d32f2f'
¬†   };
¬†
¬†   let html = `
¬†       <div style="overflow-x: auto; margin: 20px 0;">
¬†           <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
¬†               <thead>
¬†   <tr style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
¬†       <th style="padding: 15px; text-align: left; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">Unidad</th>
¬†       ${condiciones.map(c => `<th style="padding: 15px; text-align: center; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">${c}</th>`).join('')}
¬†       <th style="padding: 15px; text-align: center; font-weight: 700; background: rgba(0,0,0,0.2);">TOTAL</th>
¬†   </tr>
</thead>
¬†               <tbody>`;
¬†
¬†   unidades.forEach((unidad, idx) => {
¬†       const bgColor = idx % 2 === 0 ? '#f8f9fa' : 'white';
¬†       html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;" id="fila\_${tipoOS}\_condicion\_${idx}">`;
¬†       html += `<td style="padding: 12px; font-weight: 600; color: #2d3748; border-right: 1px solid #e2e8f0;">${unidad}</td>`;
¬†
¬†       condiciones.forEach(condicion => {
¬†           const count = datos[unidad].porCondicion[condicion].length;
¬†           const hasData = count > 0;
¬†           const color = coloresCondicion[condicion];
¬†
¬†
¬†           html += `
¬†               <td style="padding: 12px; text-align: center; border-right: 1px solid #e2e8f0; cursor: ${hasData ? 'pointer' : 'default'};"
¬†                   ${hasData ? `onclick="toggleDetalleCondicion('${unidad}', '${condicion}', '${tipoOS}', ${idx})"` : ''}>
¬†                   <span style="
¬†                       display: inline-block;
¬†                       min-width: 30px;
¬†                       padding: 6px 12px;
¬†                       border-radius: 6px;
¬†                       font-weight: 600;
¬†                       background: ${hasData ? color + '20' : '#f5f5f5'};
¬†                       color: ${hasData ? color : '#999'};
¬†                       ${hasData ? `box-shadow: 0 2px 4px ${color}40;` : ''}
¬†                   ">
¬†                       ${count}
¬†                   </span>
¬†               </td>`;
¬†       });
¬†
¬†       const total = condiciones.reduce((sum, c) => sum + datos[unidad].porCondicion[c].length, 0);
html += `<td style="padding: 12px; text-align: center; font-weight: 700; background: rgba(0,0,0,0.05); font-size: 16px; border-right: 1px solid #e2e8f0;">${total}</td>`;

html += `</tr>`;
¬†
¬†       // Fila oculta para el detalle
¬†       html += `
¬†           <tr id="detalle\_${tipoOS}\_condicion\_${idx}" style="display: none; background: #e8f5e9;">
¬†               <td colspan="${condiciones.length + 1}" style="padding: 15px;">
¬†                   <div id="contenido\_detalle\_${tipoOS}\_condicion\_${idx}"></div>
¬†               </td>
¬†           </tr>`;
¬†   });
¬†
¬†   html += `</tbody></table></div>`;
¬†
¬†   return html;
}

¬†	// ========================================
// üìä TABLA 2: ESTADO_ATOMO VS RANGOS
// ========================================
function generarTablaEstadoAtomoPorRango(datos) {
¬†   // Obtener todos los estados √∫nicos de AMBOS tipos
¬†   const estadosSet = new Set();
¬†   ['reguladas', 'noReguladas'].forEach(tipo => {
¬†       if (datos[tipo]) {
¬†           Object.values(datos[tipo]).forEach(unidad => {
¬†               Object.values(unidad.porRango).forEach(osList => {
¬†                   osList.forEach(os => {
¬†                       if (os.Estado_ATOMO) estadosSet.add(os.Estado_ATOMO);
¬†                   });
¬†               });
¬†           });
¬†       }
¬†   });
¬†
¬†   const estados = Array.from(estadosSet).sort();
¬†   const rangos = ['0-5', '6-10', '11-15', '16-20', '21-30', '31-45', '46-180', '>180'];
¬†
¬†   if (estados.length === 0) {
¬†       return '<p style="color: #666; text-align: center;">No hay datos de Estado_ATOMO</p>';
¬†   }
¬†
¬†   // Agrupar datos por Estado_ATOMO y Rango
¬†   const agrupado = {};
¬†   estados.forEach(estado => {
¬†       agrupado[estado] = {};
¬†       rangos.forEach(rango => {
¬†           agrupado[estado][rango] = [];
¬†       });
¬†   });
¬†
¬†   // Llenar con datos de reguladas y no reguladas
¬†   ['reguladas', 'noReguladas'].forEach(tipo => {
¬†       if (datos[tipo]) {
¬†           Object.values(datos[tipo]).forEach(unidad => {
¬†               Object.entries(unidad.porRango).forEach(([rango, osList]) => {
¬†                   osList.forEach(os => {
¬†                       const estado = os.Estado_ATOMO || 'Sin Estado';
¬†                       if (agrupado[estado] && agrupado[estado][rango]) {
¬†                           agrupado[estado][rango].push(os);
¬†                       }
¬†                   });
¬†               });
¬†           });
¬†       }
¬†   });
¬†
¬†   let html = `
¬†       <div style="overflow-x: auto; margin: 20px 0;">
¬†           <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
¬†               <thead>
¬†                   <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
¬†                       <th style="padding: 15px; text-align: left; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">Rango D√≠as</th>
¬†                       ${estados.map(e => `<th style="padding: 15px; text-align: center; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">${e}</th>`).join('')}
<th style="padding: 15px; text-align: center; font-weight: 700; background: rgba(0,0,0,0.2);">TOTAL</th>
</tr>
¬†               </thead>
¬†               <tbody>`;
¬†
¬†   rangos.forEach((rango, idx) => {
¬†       const bgColor = idx % 2 === 0 ? '#f8f9fa' : 'white';
¬†       html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;" id="fila\_estado\_rango\_${idx}">`;
¬†       html += `<td style="padding: 12px; font-weight: 600; color: #2d3748; border-right: 1px solid #e2e8f0;">${rango}</td>`;
¬†
¬†       estados.forEach(estado => {
¬†           const count = agrupado[estado][rango].length;
¬†           const hasData = count > 0;
¬†
¬†           html += `
¬†               <td style="padding: 12px; text-align: center; border-right: 1px solid #e2e8f0; cursor: ${hasData ? 'pointer' : 'default'};"
¬†                   ${hasData ? `onclick="toggleDetalleEstadoRango('${estado}', '${rango}', ${idx})"` : ''}>
¬†                   <span style="
¬†                       display: inline-block;
¬†                       min-width: 30px;
¬†                       padding: 6px 12px;
¬†                       border-radius: 6px;
¬†                       font-weight: 600;
¬†                       background: ${hasData ? '#e3f2fd' : '#f5f5f5'};
¬†                       color: ${hasData ? '#1976d2' : '#999'};
¬†                       ${hasData ? 'box-shadow: 0 2px 4px rgba(25,118,210,0.2);' : ''}
¬†                   ">
¬†                       ${count}
¬†                   </span>
¬†               </td>`;
¬†       });
¬†
¬†       const total = estados.reduce((sum, estado) => sum + agrupado[estado][rango].length, 0);
html += `<td style="padding: 12px; text-align: center; font-weight: 700; background: rgba(0,0,0,0.05); font-size: 16px;">${total}</td>`;

html += `</tr>`;
¬†
¬†       // Fila oculta para detalle
¬†       html += `
¬†           <tr id="detalle\_estado\_rango\_${idx}" style="display: none; background: #fff3cd;">
¬†               <td colspan="${estados.length + 2}" style="padding: 15px;">
¬†                   <div id="contenido\_detalle\_estado\_rango\_${idx}"></div>
¬†               </td>
¬†           </tr>`;
¬†   });
¬†
¬†   html += `</tbody></table></div>`;
¬†
¬†   // Guardar datos globalmente
¬†   window.datosEstadoAtomoPorRango = agrupado;
¬†
¬†   return html;
}

// ========================================
// üîΩ TOGGLE DETALLE ESTADO_ATOMO POR RANGO
// ========================================
function toggleDetalleEstadoRango(estado, rango, idx) {
¬†   const filaDetalle = document.getElementById(`detalle\_estado\_rango\_${idx}`);
¬†   const contenidoDetalle = document.getElementById(`contenido\_detalle\_estado\_rango\_${idx}`);
¬†
¬†   if (filaDetalle.style.display === 'table-row') {
¬†       filaDetalle.style.display = 'none';
¬†       return;
¬†   }
¬†
¬†   const osList = window.datosEstadoAtomoPorRango[estado][rango];
¬†
¬†   if (!osList || osList.length === 0) {
¬†       contenidoDetalle.innerHTML = '<p style="color: #666;">No hay OS en este cruce</p>';
¬†       filaDetalle.style.display = 'table-row';
¬†       return;
¬†   }
¬†
¬†   let html = `
¬†       <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
¬†           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
¬†               <strong style="color: #2d3748; font-size: 16px;">
¬†                   üìã ${estado} - Rango ${rango} d√≠as (${osList.length} OS)
¬†               </strong>
¬†               <button onclick="toggleDetalleEstadoRango('${estado}', '${rango}', ${idx})"
¬†                       style="background: #ef5350; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
¬†                   ‚úï Cerrar
¬†               </button>
¬†           </div>
¬†           <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto;">`;
¬†
¬†   osList.forEach((os, i) => {
¬†       html += `
¬†           <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid #1976d2;">
¬†               <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px;">
¬†                   ${i + 1}. OS: ${os.OSATMO || 'N/A'}
¬†               </div>
¬†               <div style="font-size: 14px; color: #666; line-height: 1.6;">
¬†                   <strong>Tipo:</strong> ${os.Tipo_de_OS || 'N/A'}<br>
¬†                   <strong>Tipolog√≠a:</strong> ${os.Tipologia || 'N/A'}<br>
¬†                   <strong>Medidor:</strong> ${os.Medidor || 'N/A'}<br>
¬†                   <strong>Unidad:</strong> ${os.Unidad || 'N/A'}<br>
¬†                   <strong>D√≠as:</strong> ${os.dias_calculados} d√≠as
¬†               </div>
¬†           </div>`;
¬†   });
¬†
¬†   html += `</div></div>`;
¬†
¬†   contenidoDetalle.innerHTML = html;
¬†   filaDetalle.style.display = 'table-row';
}


¬†	// ========================================
// üìä TABLA 3: ESTADO_SAP VS ESTADO_ATOMO
// ========================================
function generarTablaEstadoSapVsAtomo(datos) {
¬†   // Obtener todos los estados √∫nicos
¬†   const estadosSapSet = new Set();
¬†   const estadosAtomoSet = new Set();
¬†
¬†   ['reguladas', 'noReguladas'].forEach(tipo => {
¬†       if (datos[tipo]) {
¬†           Object.values(datos[tipo]).forEach(unidad => {
¬†               Object.values(unidad.porRango).forEach(osList => {
¬†                   osList.forEach(os => {
¬†                       if (os.Estado_SAP) estadosSapSet.add(os.Estado_SAP);
¬†                       if (os.Estado_ATOMO) estadosAtomoSet.add(os.Estado_ATOMO);
¬†                   });
¬†               });
¬†           });
¬†       }
¬†   });
¬†
¬†   const estadosSap = Array.from(estadosSapSet).sort();
¬†   const estadosAtomo = Array.from(estadosAtomoSet).sort();
¬†
¬†   if (estadosSap.length === 0 || estadosAtomo.length === 0) {
¬†       return '<p style="color: #666; text-align: center;">No hay datos de Estado_SAP o Estado_ATOMO</p>';
¬†   }
¬†
¬†   // Agrupar datos por cruce SAP x ATOMO
¬†   const agrupado = {};
¬†   estadosSap.forEach(sap => {
¬†       agrupado[sap] = {};
¬†       estadosAtomo.forEach(atomo => {
¬†           agrupado[sap][atomo] = [];
¬†       });
¬†   });
¬†
¬†   // Llenar con datos
¬†   ['reguladas', 'noReguladas'].forEach(tipo => {
¬†       if (datos[tipo]) {
¬†           Object.values(datos[tipo]).forEach(unidad => {
¬†               Object.values(unidad.porRango).forEach(osList => {
¬†                   osList.forEach(os => {
¬†                       const sap = os.Estado_SAP || 'Sin Estado SAP';
¬†                       const atomo = os.Estado_ATOMO || 'Sin Estado ATOMO';
¬†                       if (agrupado[sap] && agrupado[sap][atomo]) {
¬†                           agrupado[sap][atomo].push(os);
¬†                       }
¬†                   });
¬†               });
¬†           });
¬†       }
¬†   });
¬†
¬†   let html = `
¬†       <div style="overflow-x: auto; margin: 20px 0;">
¬†           <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
¬†               <thead>
¬†                   <tr style="background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%); color: white;">
¬†                       <th style="padding: 15px; text-align: left; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">Estado SAP</th>
¬†                       ${estadosAtomo.map(e => `<th style="padding: 15px; text-align: center; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">${e}</th>`).join('')}
<th style="padding: 15px; text-align: center; font-weight: 700; background: rgba(0,0,0,0.2);">TOTAL</th>
</tr>
¬†                   </tr>
¬†               </thead>
¬†               <tbody>`;
¬†
¬†   estadosSap.forEach((sap, idx) => {
¬†       const bgColor = idx % 2 === 0 ? '#f8f9fa' : 'white';
¬†       html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;" id="fila\_sap\_atomo\_${idx}">`;
¬†       html += `<td style="padding: 12px; font-weight: 600; color: #2d3748; border-right: 1px solid #e2e8f0;">${sap}</td>`;
¬†
¬†       estadosAtomo.forEach(atomo => {
¬†           const count = agrupado[sap][atomo].length;
¬†           const hasData = count > 0;
¬†
¬†           html += `
¬†               <td style="padding: 12px; text-align: center; border-right: 1px solid #e2e8f0; cursor: ${hasData ? 'pointer' : 'default'};"
¬†                   ${hasData ? `onclick="toggleDetalleSapAtomo('${sap}', '${atomo}', ${idx})"` : ''}>
¬†                   <span style="
¬†                       display: inline-block;
¬†                       min-width: 30px;
¬†                       padding: 6px 12px;
¬†                       border-radius: 6px;
¬†                       font-weight: 600;
¬†                       background: ${hasData ? '#e0f7fa' : '#f5f5f5'};
¬†                       color: ${hasData ? '#00838f' : '#999'};
¬†                       ${hasData ? 'box-shadow: 0 2px 4px rgba(0,131,143,0.2);' : ''}
¬†                   ">
¬†                       ${count}
¬†                   </span>
¬†               </td>`;
¬†       });

¬†	const total = estadosAtomo.reduce((sum, atomo) => sum + agrupado[sap][atomo].length, 0);
html += `<td style="padding: 12px; text-align: center; font-weight: 700; background: rgba(0,0,0,0.05); font-size: 16px;">${total}</td>`;

html += `</tr>`;
¬†
¬†       html += `</tr>`;
¬†
¬†       // Fila oculta para detalle
¬†       html += `
¬†           <tr id="detalle\_sap\_atomo\_${idx}" style="display: none; background: #e0f7fa;">
¬†               <td colspan="${estadosAtomo.length + 2}" style="padding: 15px;">
¬†                   <div id="contenido\_detalle\_sap\_atomo\_${idx}"></div>
¬†               </td>
¬†           </tr>`;
¬†   });
¬†
¬†   html += `</tbody></table></div>`;
¬†
¬†   // Guardar datos globalmente
¬†   window.datosSapVsAtomo = agrupado;
¬†
¬†   return html;
}

// ========================================
// üîΩ TOGGLE DETALLE SAP VS ATOMO
// ========================================
function toggleDetalleSapAtomo(sap, atomo, idx) {
¬†   const filaDetalle = document.getElementById(`detalle\_sap\_atomo\_${idx}`);
¬†   const contenidoDetalle = document.getElementById(`contenido\_detalle\_sap\_atomo\_${idx}`);
¬†
¬†   if (filaDetalle.style.display === 'table-row') {
¬†       filaDetalle.style.display = 'none';
¬†       return;
¬†   }
¬†
¬†   const osList = window.datosSapVsAtomo[sap][atomo];
¬†
¬†   if (!osList || osList.length === 0) {
¬†       contenidoDetalle.innerHTML = '<p style="color: #666;">No hay OS en este cruce</p>';
¬†       filaDetalle.style.display = 'table-row';
¬†       return;
¬†   }
¬†
¬†   let html = `
¬†       <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #00bcd4;">
¬†           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
¬†               <strong style="color: #2d3748; font-size: 16px;">
¬†                   üìã SAP: ${sap} | ATOMO: ${atomo} (${osList.length} OS)
¬†               </strong>
¬†               <button onclick="toggleDetalleSapAtomo('${sap}', '${atomo}', ${idx})"
¬†                       style="background: #00838f; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
¬†                   ‚úï Cerrar
¬†               </button>
¬†           </div>
¬†           <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto;">`;
¬†
¬†   osList.forEach((os, i) => {
¬†       html += `
¬†           <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid #00bcd4;">
¬†               <div style="font-weight: 600; color: #00838f; margin-bottom: 8px;">
¬†                   ${i + 1}. OS: ${os.OSATMO || 'N/A'}
¬†               </div>
¬†               <div style="font-size: 14px; color: #666; line-height: 1.6;">
¬†                   <strong>Tipo:</strong> ${os.Tipo_de_OS || 'N/A'}<br>
¬†                   <strong>Tipolog√≠a:</strong> ${os.Tipologia || 'N/A'}<br>
¬†                   <strong>Medidor:</strong> ${os.Medidor || 'N/A'}<br>
¬†                   <strong>Unidad:</strong> ${os.Unidad || 'N/A'}<br>
¬†                   <strong>D√≠as:</strong> ${os.dias_calculados} d√≠as
¬†               </div>
¬†           </div>`;
¬†   });
¬†
¬†   html += `</div></div>`;
¬†
¬†   contenidoDetalle.innerHTML = html;
¬†   filaDetalle.style.display = 'table-row';
}

¬†	// ========================================
// üö´ TABLA 4: SOLO BLOQUEADOS POR RANGO
// ========================================
function generarTablaBloqueados(datos) {
¬†   const rangos = ['0-5', '6-10', '11-15', '16-20', '21-30', '31-45', '46-180', '>180'];
¬†
¬†   // Filtrar solo OS bloqueadas de ambos tipos
¬†   const bloqueados = {};
¬†   rangos.forEach(rango => {
¬†       bloqueados[rango] = [];
¬†   });
¬†
¬†   ['reguladas', 'noReguladas'].forEach(tipo => {
¬†       if (datos[tipo]) {
¬†           Object.values(datos[tipo]).forEach(unidad => {
¬†               Object.entries(unidad.porRango).forEach(([rango, osList]) => {
¬†                   osList.forEach(os => {
¬†                       const estadoAtomo = os.Estado_ATOMO ? os.Estado_ATOMO.toLowerCase() : '';
¬†                       // ‚úÖ Acepta "Bloqueado", "Bloqueada", "bloqueado", "bloqueada"
¬†                       if (estadoAtomo.includes('bloquead')) {
¬†                           bloqueados[rango].push(os);
¬†                       }
¬†                   });
¬†               });
¬†           });
¬†       }
¬†   });
¬†
¬†   // Contar total
¬†   const totalBloqueados = Object.values(bloqueados).reduce((sum, lista) => sum + lista.length, 0);
¬†
¬†   if (totalBloqueados === 0) {
¬†       return '<p style="color: #666; text-align: center;">No hay OS bloqueadas</p>';
¬†   }
¬†
¬†   let html = `
¬†       <div style="background: #ffebee; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #f44336;">
¬†           <strong style="color: #c62828;">‚ö†Ô∏è Total de OS Bloqueadas: ${totalBloqueados}</strong>
¬†       </div>
¬†
¬†       <div style="overflow-x: auto; margin: 20px 0;">
¬†           <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
¬†               <thead>
¬†                   <tr style="background: linear-gradient(135deg, #f44336 0%, #c62828 100%); color: white;">
¬†                       <th style="padding: 15px; text-align: center; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">Rango de D√≠as</th>
¬†                       <th style="padding: 15px; text-align: center; font-weight: 600;">Cantidad</th>
¬†                   </tr>
¬†               </thead>
¬†               <tbody>`;
¬†
¬†   rangos.forEach((rango, idx) => {
¬†       const count = bloqueados[rango].length;
¬†       const bgColor = idx % 2 === 0 ? '#f8f9fa' : 'white';
¬†       const hasData = count > 0;
¬†
¬†       html += `
¬†           <tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;" id="fila\_bloqueados\_${idx}">
¬†               <td style="padding: 12px; font-weight: 600; color: #2d3748; text-align: center; border-right: 1px solid #e2e8f0;">${rango}</td>
¬†               <td style="padding: 12px; text-align: center; cursor: ${hasData ? 'pointer' : 'default'};"
¬†                   ${hasData ? `onclick="toggleDetalleBloqueados('${rango}', ${idx})"` : ''}>
¬†                   <span style="
¬†                       display: inline-block;
¬†                       min-width: 50px;
¬†                       padding: 8px 16px;
¬†                       border-radius: 6px;
¬†                       font-weight: 600;
¬†                       background: ${hasData ? '#ffcdd2' : '#f5f5f5'};
¬†                       color: ${hasData ? '#c62828' : '#999'};
¬†                       ${hasData ? 'box-shadow: 0 2px 4px rgba(198,40,40,0.3);' : ''}
¬†                   ">
¬†                       ${count}
¬†                   </span>
¬†               </td>
¬†           </tr>`;
¬†
¬†       // Fila oculta para detalle
¬†       html += `
¬†           <tr id="detalle\_bloqueados\_${idx}" style="display: none; background: #ffebee;">
¬†               <td colspan="2" style="padding: 15px;">
¬†                   <div id="contenido\_detalle\_bloqueados\_${idx}"></div>
¬†               </td>
¬†           </tr>`;
¬†   });
¬†
¬†   html += `</tbody></table></div>`;
¬†
¬†   // Guardar datos globalmente
¬†   window.datosBloqueados = bloqueados;
¬†
¬†   return html;
}

// ========================================
// üîΩ TOGGLE DETALLE BLOQUEADOS
// ========================================
function toggleDetalleBloqueados(rango, idx) {
¬†   const filaDetalle = document.getElementById(`detalle\_bloqueados\_${idx}`);
¬†   const contenidoDetalle = document.getElementById(`contenido\_detalle\_bloqueados\_${idx}`);
¬†
¬†   if (filaDetalle.style.display === 'table-row') {
¬†       filaDetalle.style.display = 'none';
¬†       return;
¬†   }
¬†
¬†   const osList = window.datosBloqueados[rango];
¬†
¬†   if (!osList || osList.length === 0) {
¬†       contenidoDetalle.innerHTML = '<p style="color: #666;">No hay OS bloqueadas en este rango</p>';
¬†       filaDetalle.style.display = 'table-row';
¬†       return;
¬†   }
¬†
¬†   let html = `
¬†       <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
¬†           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
¬†               <strong style="color: #2d3748; font-size: 16px;">
¬†                   üö´ OS Bloqueadas - Rango ${rango} d√≠as (${osList.length} OS)
¬†               </strong>
¬†               <button onclick="toggleDetalleBloqueados('${rango}', ${idx})"
¬†                       style="background: #c62828; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
¬†                   ‚úï Cerrar
¬†               </button>
¬†           </div>
¬†           <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto;">`;
¬†
¬†   osList.forEach((os, i) => {
¬†       const comentario = os.Comentario || 'Sin comentario';
¬†
¬†       html += `
¬†           <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid #f44336;">
¬†               <div style="font-weight: 600; color: #c62828; margin-bottom: 8px;">
¬†                   ${i + 1}. OS: ${os.OSATMO || 'N/A'}
¬†               </div>
¬†               <div style="font-size: 14px; color: #666; line-height: 1.6;">
¬†                   <strong>Tipo:</strong> ${os.Tipo_de_OS || 'N/A'}<br>
¬†                   <strong>Tipolog√≠a:</strong> ${os.Tipologia || 'Sin tipolog√≠a'}<br>
¬†                   <strong>Medidor:</strong> ${os.Medidor || 'N/A'}<br>
¬†                   <strong>Unidad:</strong> ${os.Unidad || 'N/A'}<br>
¬†                   <strong>D√≠as:</strong> ${os.dias_calculados} d√≠as<br>
¬†                   <strong>Estado ATOMO:</strong> ${os.Estado_ATOMO || 'N/A'}<br>
¬†                   <strong>Estado SAP:</strong> ${os.Estado_SAP || 'N/A'}
¬†               </div>
¬†               <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107;">
¬†                   <strong style="color: #e65100;">üí¨ Comentario:</strong><br>
¬†                   <span style="font-size: 13px; color: #555; word-break: break-word;">${comentario}</span>
¬†               </div>
¬†           </div>`;
¬†   });
¬†
¬†   html += `</div></div>`;
¬†
¬†   contenidoDetalle.innerHTML = html;
¬†   filaDetalle.style.display = 'table-row';
}


¬†
¬†	// ========================================
// üîΩ TOGGLE DETALLE POR RANGO
// ========================================
function toggleDetalleRango(unidad, rango, tipoOS, idx) {
¬†   const filaDetalle = document.getElementById(`detalle\_${tipoOS}\_rango\_${idx}`);
¬†   const contenidoDetalle = document.getElementById(`contenido\_detalle\_${tipoOS}\_rango\_${idx}`);
¬†
¬†   // Si ya est√° visible, ocultarlo
¬†   if (filaDetalle.style.display === 'table-row') {
¬†       filaDetalle.style.display = 'none';
¬†       return;
¬†   }
¬†
¬†   // Obtener OS de esa unidad y rango
¬†   const datos = tipoOS === 'reguladas' ? window.datosDetalleOS.reguladas : window.datosDetalleOS.noReguladas;
¬†   const osList = datos[unidad].porRango[rango];
¬†
¬†   if (!osList || osList.length === 0) {
¬†       contenidoDetalle.innerHTML = '<p style="color: #666;">No hay OS en este rango</p>';
¬†       filaDetalle.style.display = 'table-row';
¬†       return;
¬†   }
¬†
¬†   // Generar HTML del detalle
¬†   let html = `
¬†       <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
¬†           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
¬†               <strong style="color: #2d3748; font-size: 16px;">
¬†                   üìã ${unidad} - Rango ${rango} d√≠as (${osList.length} OS)
¬†               </strong>
¬†               <button onclick="toggleDetalleRango('${unidad}', '${rango}', '${tipoOS}', ${idx})"
¬†                       style="background: #ef5350; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
¬†                   ‚úï Cerrar
¬†               </button>
¬†           </div>
¬†           <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto;">`;
¬†
¬†   osList.forEach((os, i) => {
¬†       html += `
¬†           <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid #1976d2;">
¬†               <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px;">
¬†                   ${i + 1}. OS: ${os.OSATMO || 'N/A'}
¬†               </div>
¬†               <div style="font-size: 14px; color: #666; line-height: 1.6;">
¬†                   <strong>Tipolog√≠a:</strong> ${os.Tipologia || 'Sin tipolog√≠a'}<br>
¬†                   <strong>Medidor:</strong> ${os.Medidor || 'N/A'}<br>
¬†		    <strong>Unicom:</strong> ${os.Unicom || 'N/A'}<br>
¬†                   <strong>D√≠as:</strong> ${os.dias_calculados} d√≠as<br>
¬†		    <strong>Fecha Gen.:</strong> ${os['Fecha Gen.'] || 'N/A'}<br>
¬†                   <strong>Estado:</strong> ${os.Estado_ATOMO || 'N/A'}
¬†		    <strong>Direccion:</strong> ${os.Direccion || 'Sin Direccion'}<br>
¬†               </div>
¬†           </div>`;
¬†   });
¬†
¬†   html += `</div></div>`;
¬†
¬†   contenidoDetalle.innerHTML = html;
¬†   filaDetalle.style.display = 'table-row';
}


¬†	// ========================================
// üîΩ TOGGLE DETALLE POR CONDICI√ìN
// ========================================
function toggleDetalleCondicion(unidad, condicion, tipoOS, idx) {
¬†   const filaDetalle = document.getElementById(`detalle\_${tipoOS}\_condicion\_${idx}`);
¬†   const contenidoDetalle = document.getElementById(`contenido\_detalle\_${tipoOS}\_condicion\_${idx}`);
¬†
¬†   // Si ya est√° visible, ocultarlo
¬†   if (filaDetalle.style.display === 'table-row') {
¬†       filaDetalle.style.display = 'none';
¬†       return;
¬†   }
¬†
¬†   // Obtener OS de esa unidad y condici√≥n
¬†   const datos = tipoOS === 'reguladas' ? window.datosDetalleOS.reguladas : window.datosDetalleOS.noReguladas;
¬†   const osList = datos[unidad].porCondicion[condicion];
¬†
¬†   if (!osList || osList.length === 0) {
¬†       contenidoDetalle.innerHTML = '<p style="color: #666;">No hay OS en esta condici√≥n</p>';
¬†       filaDetalle.style.display = 'table-row';
¬†       return;
¬†   }
¬†
¬†   // Colores por condici√≥n
¬†   const coloresCondicion = {
¬†       'HOY': '#ef5350',
¬†       'MA√ëANA': '#ffa726',
¬†       'EN TIEMPO': '#66bb6a',
¬†       'VENCIDO': '#d32f2f'
¬†   };
¬†   const color = coloresCondicion[condicion];
¬†
¬†   // Generar HTML del detalle
¬†   let html = `
¬†       <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${color};">
¬†           <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
¬†               <strong style="color: #2d3748; font-size: 16px;">
¬†                   ‚ö†Ô∏è ${unidad} - ${condicion} (${osList.length} OS)
¬†               </strong>
¬†               <button onclick="toggleDetalleCondicion('${unidad}', '${condicion}', '${tipoOS}', ${idx})"
¬†                       style="background: ${color}; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
¬†                   ‚úï Cerrar
¬†               </button>
¬†           </div>
¬†           <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; max-height: 400px; overflow-y: auto;">`;
¬†
¬†   osList.forEach((os, i) => {
¬†       html += `
¬†           <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid ${color};">
¬†               <div style="font-weight: 600; color: ${color}; margin-bottom: 8px;">
¬†                   ${i + 1}. OS: ${os.OSATMO || 'N/A'}
¬†               </div>
¬†               <div style="font-size: 14px; color: #666; line-height: 1.6;">
¬†                   <strong>Tipolog√≠a:</strong> ${os.Tipologia || 'Sin tipolog√≠a'}<br>
¬†                   <strong>Medidor:</strong> ${os.Medidor || 'N/A'}<br>
¬†		    <strong>Uicom:</strong> ${os.Unicom || 'N/A'}<br>
¬†                   <strong>D√≠as:</strong> ${os.dias_calculados} d√≠as<br>
¬†		    <strong>Fecha Gen.:</strong> ${os['Fecha Gen.'] || 'N/A'}<br>
¬†                   <strong>Estado:</strong> ${os.Estado_ATOMO || 'N/A'}
¬†		    <strong>Direccion:</strong> ${os.Direccion || 'Sin Direccion'}<br>
¬†               </div>
¬†           </div>`;
¬†   });
¬†
¬†   html += `</div></div>`;
¬†
¬†   contenidoDetalle.innerHTML = html;
¬†   filaDetalle.style.display = 'table-row';
}


¬†	// ========================================
// üì° TABLA UNICOM POR RANGO (AGRUPADA)
// ========================================
function generarTablaUnicomPorRango(osPendientes) {
¬†   const rangos = ['0-5', '6-10', '11-15', '16-20', '21-30', '31-45', '46-180', '>180'];
¬†   const datosPorUnicom = {};
¬†
¬†   osPendientes.forEach(os => {
¬†       if (os.Unicom) {
¬†           const unicom = String(os.Unicom).trim();
¬†           const dias = calcularDias(os['Fecha Gen.']);
¬†           const rango = determinarRango(dias);
¬†
¬†           if (!datosPorUnicom[unicom]) {
¬†               datosPorUnicom[unicom] = {};
¬†               rangos.forEach(r => datosPorUnicom[unicom][r] = []);
¬†           }
¬†
¬†           if (datosPorUnicom[unicom][rango]) {
¬†               datosPorUnicom[unicom][rango].push({...os, dias_calculados: dias, rango: rango});
¬†           }
¬†       }
¬†   });
¬†
¬†   window.unicomPorRango = datosPorUnicom;
¬†
¬†   const unicoms = Object.keys(datosPorUnicom).sort();
¬†
¬†   if (unicoms.length === 0) {
¬†       return '<p style="color: #666; text-align: center;">No hay datos UNICOM</p>';
¬†   }
¬†
¬†   let html = `<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
¬†   <thead><tr style="background: #00acc1; color: white;"><th style="padding: 15px; text-align: left;">UNICOM</th>`;
¬†
¬†   rangos.forEach(r => html += `<th style="padding: 15px; text-align: center;">${r}</th>`);
¬†   html += `<th style="padding: 15px; text-align: center; background: rgba(0,0,0,0.1);">TOTAL</th>`;
¬†   html += `</tr></thead><tbody>`;
¬†
¬†   unicoms.forEach((unicom, idx) => {
¬†       const bgColor = idx % 2 === 0 ? '#f8f9fa' : 'white';
¬†       html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;"><td style="padding: 12px; font-weight: 600;">${unicom}</td>`;
¬†
¬†       rangos.forEach(rango => {
¬†           const count = datosPorUnicom[unicom][rango].length;
¬†           html += `<td style="padding: 12px; text-align: center; cursor: ${count > 0 ? 'pointer' : 'default'};" ${count > 0 ? `onclick="toggleDetalleUnicomRango('${unicom}', '${rango}')"` : ''}>
¬†           <span style="padding: 6px 12px; border-radius: 6px; font-weight: 600; background: ${count > 0 ? '#b2ebf2' : '#f5f5f5'}; color: ${count > 0 ? '#006064' : '#999'};">${count}</span></td>`;
¬†       });
¬†	const total = rangos.reduce((sum, rango) => sum + datosPorUnicom[unicom][rango].length, 0);
html += `<td style="padding: 12px; text-align: center; font-weight: 700; background: rgba(0,0,0,0.05);">${total}</td>`;
¬†
¬†       html += `</tr>`;
¬†   });
¬†
¬†   html += `</tbody></table></div>`;
¬†   return html;
}

// ========================================
// üì° TABLA UNICOM POR CONDICI√ìN (AGRUPADA)
// ========================================
function generarTablaUnicomPorCondicion(osPendientes) {
¬†   const condiciones = ['HOY', 'MA√ëANA', 'EN TIEMPO', 'VENCIDO'];
¬†   const datosPorUnicom = {};
¬†
¬†   osPendientes.forEach(os => {
¬†       if (os.Unicom) {
¬†           const unicom = String(os.Unicom).trim();
¬†           const dias = calcularDias(os['Fecha Gen.']);
¬†           const condicion = determinarCondicion(dias, os.Dias_por_OS);
¬†
¬†           if (!datosPorUnicom[unicom]) {
¬†               datosPorUnicom[unicom] = {};
¬†               condiciones.forEach(c => datosPorUnicom[unicom][c] = []);
¬†           }
¬†
¬†           if (datosPorUnicom[unicom][condicion]) {
¬†               datosPorUnicom[unicom][condicion].push({...os, dias_calculados: dias, condicion: condicion});
¬†           }
¬†       }
¬†   });
¬†
¬†   window.unicomPorCondicion = datosPorUnicom;
¬†
¬†   const unicoms = Object.keys(datosPorUnicom).sort();
¬†
¬†   if (unicoms.length === 0) {
¬†       return '<p style="color: #666; text-align: center;">No hay datos UNICOM</p>';
¬†   }
¬†
¬†   const colores = {'HOY': '#ef5350', 'MA√ëANA': '#ffa726', 'EN TIEMPO': '#66bb6a', 'VENCIDO': '#d32f2f'};
¬†
¬†   let html = `<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
¬†   <thead><tr style="background: #26c6da; color: white;"><th style="padding: 15px; text-align: left;">UNICOM</th>`;
¬†
¬†   condiciones.forEach(c => html += `<th style="padding: 15px; text-align: center;">${c}</th>`);
html += `<th style="padding: 15px; text-align: center; background: rgba(0,0,0,0.1);">TOTAL</th>`;
html += `</tr></thead><tbody>`;
¬†
¬†   unicoms.forEach((unicom, idx) => {
¬†       const bgColor = idx % 2 === 0 ? '#f8f9fa' : 'white';
¬†               html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #e2e8f0;"><td style="padding: 12px; font-weight: 600;">${unicom}</td>`;
¬†       condiciones.forEach(c => {
            const count = datosPorUnicom[unicom][c].length;
            html += `<td style="padding: 12px; text-align: center; cursor: ${count > 0 ? 'pointer' : 'default'};" ${count > 0 ? `onclick="toggleDetalleUnicomCondicion('${unicom}', '${c}')"` : ''}>
            <span style="padding: 6px 12px; border-radius: 6px; font-weight: 600; background: ${count > 0 ? colores[c] + '20' : '#f5f5f5'}; color: ${count > 0 ? colores[c] : '#999'};">${count}</span></td>`;
        });
¬†       // ‚úÖ CALCULAR Y MOSTRAR EL TOTAL PARA ESTA FILA
¬†       const total = condiciones.reduce((sum, c) => sum + datosPorUnicom[unicom][c].length, 0);
¬†       html += `<td style="padding: 12px; text-align: center; font-weight: 700; background: rgba(0,0,0,0.05);">${total}</td>`;
¬†       html += `</tr>`;

¬†   });
¬†
¬†   html += `</tbody></table></div>`;
¬†   return html;
}

// ========================================
// üîΩ TOGGLE UNICOM RANGO
// ========================================
function toggleDetalleUnicomRango(unicom, rango) {
¬†   const modalId = `modal\_unicom\_rango\_${unicom}\_${rango}`;
¬†   let modal = document.getElementById(modalId);
¬†
¬†   if (modal) {
¬†       modal.remove();
¬†       return;
¬†   }
¬†
¬†   const osList = window.unicomPorRango[unicom][rango];
¬†
¬†   let html = `<div id="${modalId}" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
¬†   <div style="background: white; padding: 20px; border-radius: 12px; max-width: 1000px; max-height: 80%; overflow-y: auto; width: 100%;" onclick="event.stopPropagation()">
¬†   <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #00acc1; padding-bottom: 10px;">
¬†   <strong style="color: #00acc1; font-size: 18px;">üì° UNICOM ${unicom} - Rango ${rango} (${osList.length} OS)</strong>
¬†   <button onclick="document.getElementById('${modalId}').remove()" style="background: #ef5350; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï Cerrar</button>
¬†   </div><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">`;
¬†
¬†   osList.forEach((os, i) => {
¬†       html += `<div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid #00acc1;">
¬†       <div style="font-weight: 600; color: #00acc1; margin-bottom: 8px;">${i + 1}. OS: ${os.OSATMO || 'N/A'}</div>
¬†       <div style="font-size: 14px; color: #666; line-height: 1.6;">
¬†       <strong>Tipolog√≠a:</strong> ${os.Tipologia || 'N/A'}<br>
¬†       <strong>Medidor:</strong> ${os.Medidor || 'N/A'}<br>
¬†       <strong>D√≠as:</strong> ${os.dias_calculados}<br>
¬†       <strong>Unidad:</strong> ${os.Unidad || 'N/A'}</div></div>`;
¬†   });
¬†
¬†   html += `</div></div></div>`;
¬†   document.body.insertAdjacentHTML('beforeend', html);
}

// ========================================
// üîΩ TOGGLE UNICOM CONDICI√ìN
// ========================================
function toggleDetalleUnicomCondicion(unicom, condicion) {
¬†   const modalId = `modal\_unicom\_cond\_${unicom}\_${condicion}`;
¬†   let modal = document.getElementById(modalId);
¬†
¬†   if (modal) {
¬†       modal.remove();
¬†       return;
¬†   }
¬†
¬†   const osList = window.unicomPorCondicion[unicom][condicion];
¬†   const colores = {'HOY': '#ef5350', 'MA√ëANA': '#ffa726', 'EN TIEMPO': '#66bb6a', 'VENCIDO': '#d32f2f'};
¬†   const color = colores[condicion];
¬†
¬†   let html = `<div id="${modalId}" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
¬†   <div style="background: white; padding: 20px; border-radius: 12px; max-width: 1000px; max-height: 80%; overflow-y: auto; width: 100%;" onclick="event.stopPropagation()">
¬†   <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid ${color}; padding-bottom: 10px;">
¬†   <strong style="color: ${color}; font-size: 18px;">üì° UNICOM ${unicom} - ${condicion} (${osList.length} OS)</strong>
¬†   <button onclick="document.getElementById('${modalId}').remove()" style="background: ${color}; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï Cerrar</button>
¬†   </div><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">`;
¬†
¬†   osList.forEach((os, i) => {
¬†       html += `<div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid ${color};">
¬†       <div style="font-weight: 600; color: ${color}; margin-bottom: 8px;">${i + 1}. OS: ${os.OSATMO || 'N/A'}</div>
¬†       <div style="font-size: 14px; color: #666; line-height: 1.6;">
¬†       <strong>Tipolog√≠a:</strong> ${os.Tipologia || 'N/A'}<br>
¬†       <strong>Medidor:</strong> ${os.Medidor || 'N/A'}<br>
¬†       <strong>D√≠as:</strong> ${os.dias_calculados}<br>
¬†       <strong>Condici√≥n:</strong> ${os.condicion}<br>
¬†       <strong>Unidad:</strong> ${os.Unidad || 'N/A'}</div></div>`;
¬†   });
¬†
¬†   html += `</div></div></div>`;
¬†   document.body.insertAdjacentHTML('beforeend', html);
}




¬†	// ========================================
// üìç CAPTURAR COORDENADA REAL
// ========================================
async function capturarCoordenadaReal(cuentaContrato, medidor, index) {
¬†   if (!navigator.geolocation) {
¬†       alert('Tu dispositivo no soporta geolocalizaci√≥n');
¬†       return;
¬†   }
¬†
¬†   const displayDiv = document.getElementById(`coordRealDisplay\_${index}`);
¬†   displayDiv.innerHTML = '<div class="loading" style="display: block; margin: 10px auto;"></div><p style="text-align: center; color: #666;">Obteniendo coordenadas GPS...</p>';
¬†
¬†   navigator.geolocation.getCurrentPosition(
¬†       async (position) => {
¬†           const lat = position.coords.latitude.toFixed(6);
¬†           const lng = position.coords.longitude.toFixed(6);
¬†           const coordenadas = `${lat}, ${lng}`;
¬†
¬†           const confirmar = confirm(`¬øGuardar esta coordenada?\\n\\nCuenta: ${cuentaContrato}\\nMedidor: ${medidor}\\nCoordenada: ${coordenadas}`);
¬†
¬†           if (!confirmar) {
¬†               displayDiv.innerHTML = '';
¬†               return;
¬†           }
¬†
¬†           // Guardar en tabla coordenadas_reales (upsert = inserta o actualiza)
¬†           const { error } = await supabaseClient
¬†               .from('coordenadas_reales')
¬†               .upsert({
¬†                   CuentaContrato: cuentaContrato,
¬†                   Medidor: medidor,
¬†                   CoordenadasReales: coordenadas,
¬†                   usuario_capturo: currentUser.usuario
¬†               }, {
¬†                   onConflict: 'CuentaContrato,Medidor'
¬†               });
¬†
¬†           if (error) {
¬†               alert('Error al guardar: ' + error.message);
¬†               displayDiv.innerHTML = '<p style="color: #d32f2f;">‚ùå Error al guardar</p>';
¬†               return;
¬†           }
¬†
¬†           displayDiv.innerHTML = `
¬†               <div style="background: #e8f5e9; padding: 10px; border-radius: 8px; border-left: 4px solid #4caf50;">
¬†                   <strong style="color: #2e7d32;">‚úÖ Coordenada Real Guardada:</strong><br>
¬†                   <a href="https://www.google.com/maps?q=${coordenadas}" target="\_blank" style="color: #1976d2; text-decoration: underline;">${coordenadas}</a>
¬†               </div>`;
¬†       },
¬†       (error) => {
¬†   console.error('Error GPS:', error);
¬†   let mensaje = 'No se pudo obtener ubicaci√≥n.\n\n';
¬†   if (error.code === 1) mensaje += 'Permiso denegado. Habilita ubicaci√≥n en el navegador.';
¬†   else if (error.code === 2) mensaje += 'Ubicaci√≥n no disponible. Activa GPS del dispositivo.';
¬†   else if (error.code === 3) mensaje += 'Tiempo agotado. Intenta de nuevo.';
¬†   alert(mensaje);
¬†           displayDiv.innerHTML = '<p style="color: #d32f2f;">‚ùå Error GPS</p>';
¬†       },
¬†       {
¬†           enableHighAccuracy: true,
¬†           timeout: 10000,
¬†           maximumAge: 0
¬†       }
¬†   );
}



// ========================================
// üßπ FUNCI√ìN: Limpiar autom√°ticamente otros campos de b√∫squeda
// ========================================
function limpiarOtrosCampos(campoActual) {
¬†   const config = tableConfigs[selectedTable];
¬†   if (!config || !config.fields) return;
¬†
¬†   // Recorrer todos los campos de la tabla actual
¬†   config.fields.forEach(field => {
¬†       // Si NO es el campo actual, limpiarlo
¬†       if (field.key !== campoActual) {
¬†           const input = document.getElementById(`search${field.key}`);
¬†           if (input) {
¬†               input.value = ''; // Limpiar el valor
¬†           }
¬†       }
¬†   });
¬†
¬†   console.log(`üßπ Campos limpiados. Buscando solo por: ${campoActual}`);
}


// ========================================
// üó∫Ô∏è B√öSQUEDA M√öLTIPLE PARA GENERAR KML
// ========================================
async function busquedaMultipleKML(campo, valores) {
¬†   console.log(`üîç B√∫squeda m√∫ltiple KML por ${campo}:`, valores);
¬†
¬†   mostrarIndicadorBusqueda();
¬†
¬†
¬†   // Buscar cada valor individualmente
¬†   const { data: todosLosResultados, error } = await supabaseClient
¬†   .from(selectedTable)
¬†   .select('*')
¬†   .in(campo, valores.filter(v => v)); // Filtra valores vac√≠os/nulos antes de la consulta.

ocultarIndicadorBusqueda();

if (error) {
¬†   console.error('Error al buscar m√∫ltiples valores:', error.message);
¬†   alert('‚ùå Error al buscar m√∫ltiples valores: ' + error.message);
¬†   return;
}

// Validar resultados
if (!todosLosResultados || todosLosResultados.length === 0) {
¬†   alert(`‚ùå No se encontraron resultados para los valores ingresados.\\n\\nValores buscados: ${valores.join(', ')}`);
¬†   return;
}
¬†
¬†   // Filtrar solo los que tienen coordenadas
¬†   const conCoordenadas = todosLosResultados.filter(item => {
¬†       const coords = item.Coordenadas || item.coordenadas || item.Coordenadasgis || item.coordenadasgis;
¬†       return coords && coords.includes(',');
¬†   });
¬†
¬†   if (conCoordenadas.length === 0) {
¬†       alert(`‚ö†Ô∏è Se encontraron ${todosLosResultados.length} resultado(s), pero ninguno tiene coordenadas v√°lidas.\\n\\nNo se puede generar KML.`);
¬†       mostrarResultados(todosLosResultados); // Mostrar resultados de todas formas
¬†       return;
¬†   }
¬†
¬†   // Guardar en consultasData para la funci√≥n de descarga
¬†   consultasData = todosLosResultados;
¬†
¬†   // Mostrar resultados
¬†   mostrarResultadosKML(conCoordenadas, todosLosResultados.length);
}


// ========================================
// üìä MOSTRAR RESULTADOS DE B√öSQUEDA KML
// ========================================
function mostrarResultadosKML(resultadosConCoordenadas, totalResultados) {
¬†   const container = document.getElementById('searchResults');
¬†
¬†   let html = `
¬†       <div class="result-card" style="background: #f0f9ff; border: 2px solid #3b82f6;">
¬†           <div class="result-header">
¬†               ‚úÖ B√∫squeda m√∫ltiple completada
¬†           </div>
¬†           <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
¬†               <strong>üìä Resumen:</strong><br>
¬†               ‚Ä¢ Total de resultados encontrados: <strong>${totalResultados}</strong><br>
¬†               ‚Ä¢ Con coordenadas v√°lidas: <strong>${resultadosConCoordenadas.length}</strong><br>
¬†               ‚Ä¢ Sin coordenadas: <strong>${totalResultados - resultadosConCoordenadas.length}</strong>
¬†           </div>
¬†
¬†           <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
¬†               <strong‚ÑπÔ∏è Informaci√≥n:</strong><br>
¬†               Los puntos en el KML usar√°n el <strong>Medidor</strong> como etiqueta de identificaci√≥n.
¬†           </div>
¬†
¬†           <div style="text-align: center; margin-top: 20px;">
¬†               <button class="btn btn-secondary" onclick="descargarKML()" style="font-size: 18px; padding: 18px 40px;">
¬†                   üì• Descargar KML (${resultadosConCoordenadas.length} puntos)
¬†               </button>
¬†           </div>
¬†       </div>
¬†   `;
¬†
¬†   container.innerHTML = html;
}


// ===================================================================
// üìä MOSTRAR RESULTADOS PRINCIPALES
// ===================================================================

function mostrarResultados(resultados) {
¬†   const container = document.getElementById('searchResults');
¬†   const config = tableConfigs[selectedTable];
¬†
¬†   consultasData = resultados;

¬†   if (resultados.length === 0) {
¬†       container.innerHTML = '<div class="result-card">‚ùå No se encontraron resultados</div>';
¬†       return;
¬†   }

¬†   let html = `<div class="result-header">‚úÖ Se encontraron ${resultados.length} resultado(s)</div>`;
¬†
¬†   resultados.forEach((item, index) => {
¬†       html += `<div class="result-card"><div class="result-header">Resultado ${index + 1}</div>`;

¬†	// Buscar si tiene coordenada real guardada
// Buscar si tiene coordenada real guardada
if (selectedTable === 'consultas_servicios' || selectedTable === 'OS Pendientes' || selectedTable === 'OSCerradas') {
¬†   verificarCoordenadaReal(item.CuentaContrato, item.Medidor, index);
}
¬†       config.resultFields.forEach(field => {
    // üö´ OCULTAR SOLO EN CONSULTAS_SERVICIOS Y SOLO PARA B√öSQUEDA, NO PARA VISUALIZACI√ìN
    // ‚úÖ PERMITIR QUE NOMBRECLIENTE SE MUESTRE EN RESULTADOS PARA TODOS (puede venir en comentario)
    
    
    let valor = String(item[field] || 'N/A');
    
    // ‚úÖ FORMATEAR COMENTARIOS (aqu√≠ s√≠ se muestra el nombre si viene dentro del texto)
    if ((field === 'Comentario' || field === 'ComentarioGeneral') && valor !== 'N/A') {
        valor = formatearComentario(valor);
        html += `<div class="result-item"><strong>${field}:</strong>
            <div style="margin-left: 10px; line-height: 1.6;">${valor}</div></div>`;
    } else {
¬†       html += `<div class="result-item"><strong>${field}:</strong> ${valor}</div>`;
¬†   }
});
¬†
¬†       html += generarBotonesAccion(item, index, config);

// Bot√≥n Coordenadas Reales (consultas_servicios, OS Pendientes, OS Cerradas)
if (selectedTable === 'consultas_servicios' || selectedTable === 'OS Pendientes' || selectedTable === 'OSCerradas') {
¬†   html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e2e8f0;">
¬†       <button class="btn btn-secondary" onclick="capturarCoordenadaReal('${item.CuentaContrato}', '${item.Medidor}', ${index})" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
¬†           üìç Capturar Coordenada Real
¬†       </button>
¬†       <div id="coordRealDisplay\_${index}" style="margin-top: 10px;"></div>
¬†   </div>`;
}
¬†       html += '</div>'; // Cierre result-card
¬†   });

¬†   // Bot√≥n KML si hay coordenadas
¬†   if (tieneCoordenadasValidas(resultados)) {
¬†       html += `<div style="margin-top: 20px; text-align: center; padding: 0 10px;">
¬†                   <button class="btn btn-secondary" onclick="descargarKML()" style="width: 100%; max-width: 280px;">üì• Descargar KML</button>
¬†                </div>`;
¬†   }
¬†
¬†   container.innerHTML = html;
}

¬†	// ========================================
// üîç VERIFICAR COORDENADA REAL EXISTENTE
// ========================================
async function verificarCoordenadaReal(cuentaContrato, medidor, index) {
¬†   try {
¬†       const { data, error } = await supabaseClient
¬†           .from('coordenadas_reales')
¬†           .select('CoordenadasReales')
¬†           .eq('CuentaContrato', cuentaContrato)
¬†           .eq('Medidor', medidor)
¬†           .maybeSingle(); // ‚úÖ CAMBIO CLAVE: usar maybeSingle() en lugar de single()
¬†
¬†       // Si hay error que NO sea "not found", loguearlo
¬†       if (error && error.code !== 'PGRST116') {
¬†           console.error('Error consultando coordenada real:', error);
¬†           return;
¬†       }
¬†
¬†       // Si hay datos, mostrarlos
¬†       if (data && data.CoordenadasReales) {
¬†           const displayDiv = document.getElementById(`coordRealDisplay\_${index}`);
¬†           if (displayDiv) {
¬†               displayDiv.innerHTML = `
¬†                   <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; border-left: 4px solid #2196f3; margin-top: 10px;">
¬†                       <strong style="color: #1565c0;">üìç Coordenada Real:</strong><br>
¬†                       <a href="https://www.google.com/maps?q=${data.CoordenadasReales}" target="\_blank" style="color: #1976d2; text-decoration: underline;">${data.CoordenadasReales}</a>
¬†                   </div>`;
¬†           }
¬†       }
¬†   } catch (err) {
¬†       // Capturar cualquier otro error silenciosamente
¬†       console.log('Coordenada real no disponible para este registro');
¬†   }
}


// ===================================================================
// üé® FUNCI√ìN AUXILIAR: FORMATEAR COMENTARIOS
// ===================================================================

function formatearComentario(valor, esDireccion = false) {
¬†   if (!valor || valor === "Sin Datos") return '<br><em>Sin Datos</em>';

¬†
¬†   let texto = valor.toString();

¬†   // Si sabemos que es la columna Direcci√≥n y no tiene la etiqueta, se la ponemos
¬†   if (esDireccion && !texto.toLowerCase().includes("direcci√≥n")) {
¬†       texto = "Direcci√≥n: " + texto;
¬†   }
¬†   return valor
¬†       .replace(/\*([^*]+)\*/g, '<br><strong>$1</strong>')
¬†       .replace(/OS SAP/g, '<br><strong>OS SAP</strong>')
¬†       .replace(/Fecha Generacion/g, '<br><strong>Fecha Generaci√≥n:</strong>')
¬†       .replace(/Medidor seg√∫n SAP/g, '<br><strong>Medidor seg√∫n SAP:</strong>')
¬†       .replace(/Cantidad OS/g, '<br><strong>Cantidad OS:</strong>')
¬†       .replace(/Comentario Generacion/g, '<br><strong>Comentario Generaci√≥n:</strong>')
¬†       .replace(/Comentario Incumplida o Adicional/g, '<br><strong>Comentario Incumplida o Adicional:</strong>')
¬†       .replace(/Comentario de Visita Fallida/g, '<br><strong>Comentario de Visita Fallida:</strong>')
¬†       .replace(/Comentario de visita Anterior/g, '<br><strong>Comentario de visita Anterior:</strong>')
¬†       .replace(/Foto Medidor o Suministr/g, '<br><strong>Foto Medidor o Suministro:</strong>')
¬†       .replace(/Coordenas Contiguo Previa/g, '<br><strong>Coordenadas Contiguo Previa:</strong>')
¬†       .replace(/Coordenadas Visita Anterior/g, '<br><strong>Coordenadas Visita Anterior:</strong>')
¬†       .replace(/Coordeadas lector/g, '<br><strong>Coordenadas lector:</strong>')
¬†       .replace(/Coordenadas de OS seg√∫n ATOMO/g, '<br><strong>Coordenadas de OS seg√∫n ATOMO:</strong>')
¬†       .replace(/Fecha Eje\. OS anterior/g, '<br><strong>Fecha Eje. OS anterior:</strong>')
¬†       .replace(/Unidad que Eje\. OS Anterior/g, '<br><strong>Unidad que Eje. OS Anterior:</strong>')
¬†       .replace(/Dias (\d+)/g, '<br><strong>D√≠as:</strong> $1')
¬†       .replace(/lectura[:\s]*(\d+)/gi, '<br><strong>Lectura:</strong> $1')
¬†       .replace(/Sin Datos/g, '<br><em>Sin Datos</em>')
¬†	.replace(/SUBESTACION SUB/g, '<br><strong>SUBESTACION SUB:</strong>')
¬†	.replace(/NOMBRE_CLIENTE/g, '<br><strong>NOMBRE_CLIENTE:</strong>')
¬†	.replace(/Tarifa/g, '<br><strong>Tarifa G:</strong>')
¬†	.replace(/Direccion/g, '<br></strong>Direccion:</strong>')
¬†       .replace(/Sin Comentario/g, '<br><em>Sin Comentario</em>')
¬†       .replace(/Sin Coordenadas/g, '<br><em>Sin Coordenadas</em>')
¬†       .replace(/Sin Foto/g, '<br><em>Sin Foto</em>')
¬†       .replace(/Nombre del Cliente/g, '<br><strong>Nombre del Cliente:</strong>')
¬†       .replace(/Cuenta contrato/g, '<br><strong>Cuenta contrato:</strong>')
¬†       .replace(/Direcci√≥n del cliente/g, '<br><strong>Direcci√≥n del cliente:</strong>')
¬†       .replace(/Medidor (\d+)/g, '<br><strong>Medidor:</strong> $1')
¬†       .replace(/Numero de OS/g, '<br><strong>N√∫mero de OS:</strong>')
¬†       .replace(/Tipologia/g, '<br><strong>Tipolog√≠a:</strong>')
¬†       .replace(/Comentario de Cierre/g, '<br><strong>Comentario de Cierre:</strong>')
¬†       .replace(/coordenadas del suministro/g, '<br><strong>Coordenadas del suministro:</strong>')
¬†       .replace(/Comentario de Generacion/g, '<br><strong>Comentario de Generaci√≥n:</strong>')
¬†       .replace(/Coordenadas De cierre/g, '<br><strong>Coordenadas De cierre:</strong>')
¬†       .replace(/Fecha Ejec/g, '<br><strong>Fecha Ejec:</strong>')
¬†       .replace(/Ejecutada por/g, '<br><strong>Ejecutada por:</strong>')
¬†       .replace(/Fecha Lect/g, '<br><strong>Fecha Lect:</strong>')
¬†	.replace(/Cliente/g, '<br><strong>Cliente:</strong>')
¬†	.replace(/Nombre Cliente/g, '<br><strong>Nombre Cliente:</strong>')
¬†       .replace(/Tension/g, '<br><strong>Tension:</strong>')
¬†	.replace(/Multiplicador/g, '<br><strong>Multiplicador:</strong>')
¬†	.replace(/Forma/g, '<br><strong>Forma:</strong>')
¬†	.replace(/Hilos/g, '<br><strong>Hilos:</strong>')
¬†       .replace(/(https?:\/\/[^\s]+)/g, '<br><a href="$1" target="\_blank" style="color: #3b54d3; text-decoration: underline; font-weight: 600;">üîó Ver enlace</a>');
}

// ===================================================================
// üîò FUNCI√ìN AUXILIAR: GENERAR BOTONES DE ACCI√ìN
// ===================================================================

function generarBotonesAccion(item, index, config) {
¬†   let html = '<div class="action-buttons">';
¬†
¬†   config.actions.forEach(action => {
¬†       const val = item[action];
¬†       if (!val) return;

¬†       const isCoordenadasLector = (action === 'Coordenadas' || action === 'CoordenadasLector');
¬†       const isCoordenadasGis = (action === 'Coordenadasgis' || action === 'CoordenadasGis');
¬†       const isFotoLink = (action === 'FotoLink' || action === 'fotolink');
¬†       const isGrafica = (action === 'Grafica');
¬†
¬†       // Roles sin acceso a gr√°ficas
¬†       const sinGraficas = ['Lectura', 'Contratista', 'ATTF', 'Poda'];
¬†       const puedeVerGraficas = currentUser && currentUser.rol && !sinGraficas.includes(currentUser.rol);
¬†
¬†       if (isCoordenadasLector) {
¬†           html += `<button class="btn btn-secondary" onclick="abrirCoordenadas('${val}')">üìç Coordenadas Lector</button>`;
¬†       } else if (isCoordenadasGis) {
¬†           html += `<button class="btn btn-secondary" onclick="abrirCoordenadas('${val}')">üó∫Ô∏è Coordenadas GIS</button>`;
¬†       } else if (isFotoLink) {
¬†           html += `<button class="btn btn-secondary" onclick="verFoto('${val}')">üì∏ Ver Foto</button>`;
¬†       } else if (isGrafica && puedeVerGraficas) {
¬†           html += `<button class="btn btn-secondary" onclick="verGraficasPorIndice(${index})">üìä Ver Consumos</button>`;
¬†       }
¬†   });
¬†
¬†   html += '</div></div>'; // Cierre action-buttons y result-card
¬†   return html;
}

// ===================================================================
// üîç B√öSQUEDA EN TABLAS RELACIONADAS (UNIFICADA)
// ===================================================================

async function busquedaEnTablasRelacionadas(campo, valor, resultadoPrincipal) {
¬†   // Determinar si se debe buscar OS o b√∫squeda adicional general
¬†   const esOS = resultadoPrincipal.length > 0 &&
¬†                (resultadoPrincipal[0].OSATMO || resultadoPrincipal[0].OSSAP || resultadoPrincipal[0].OSATOMO);
¬†
¬†   if (esOS) {
¬†       // B√∫squeda de OS relacionadas
¬†       setTimeout(() => {
¬†           buscarOSRelacionadas(resultadoPrincipal[0]).then(relacionadas => {
¬†               if (relacionadas) {
¬†                   mostrarResultadosRelacionados(relacionadas, resultadoPrincipal[0]);
¬†               }
¬†           });
¬†       }, 2000);
¬†   } else if (selectedTable === 'consultas_servicios') {
¬†       // B√∫squeda adicional en OS Pendientes y OSCerradas
¬†       mostrarIndicadorBusqueda();
¬†
¬†       const tablasAdicionales = ['OS Pendientes', 'OSCerradas'];
¬†       const resultadosAdicionales = {};
¬†
¬†       for (const tabla of tablasAdicionales) {
¬†           const config = tableConfigs[tabla];
¬†           if (!config) continue;
¬†
¬†           const campoEquivalente = encontrarCampoEquivalente(campo, config);
¬†           if (!campoEquivalente) continue;
¬†
¬†           let query = supabaseClient.from(tabla).select('*');
¬†           query = query.eq(campoEquivalente, valor);
¬†
¬†           const { data, error } = await query;
¬†           if (!error && data && data.length > 0) {
¬†               resultadosAdicionales[tabla] = data;
¬†           }
¬†       }
¬†
¬†       ocultarIndicadorBusqueda();
¬†
¬†       if (Object.keys(resultadosAdicionales).length > 0) {
¬†           mostrarBotonesResultadosAdicionales(resultadosAdicionales);
¬†       }
¬†   }
}

// ===================================================================
// üîó BUSCAR OS RELACIONADAS (OPTIMIZADA)
// ===================================================================

async function buscarOSRelacionadas(osData) {
¬†   const osNumero = osData.OSATMO || osData.OSSAP || osData.OSATOMO;
¬†   if (!osNumero) return null;
¬†
¬†   const criteriosBusqueda = [];
¬†
¬†   // Validar CuentaContrato
¬†   if (osData.CuentaContrato &&
¬†       String(osData.CuentaContrato).trim() !== '' &&
¬†       String(osData.CuentaContrato) !== '0' &&
¬†       String(osData.CuentaContrato) !== '200000000000') {
¬†       criteriosBusqueda.push({campo: 'CuentaContrato', valor: osData.CuentaContrato});
¬†   }
¬†
¬†   // Validar Medidor
¬†   if (osData.Medidor &&
¬†       String(osData.Medidor).trim() !== '' &&
¬†       String(osData.Medidor) !== '0') {
¬†       criteriosBusqueda.push({campo: 'Medidor', valor: osData.Medidor});
¬†   }
¬†
¬†   // Validar NombreCliente
¬†   if (osData.NombreCliente &&
¬†       String(osData.NombreCliente).trim() !== '' &&
¬†       String(osData.NombreCliente) !== '0' &&
¬†       String(osData.NombreCliente).toLowerCase() !== 'sin nombre') {
¬†       criteriosBusqueda.push({campo: 'NombreCliente', valor: osData.NombreCliente});
¬†   }
¬†
¬†   if (criteriosBusqueda.length === 0) return null;
¬†
¬†   mostrarIndicadorBusqueda();
¬†
¬†   const relacionadasPorTabla = {};
¬†   const tablasBusqueda = (selectedTable === 'OS Pendientes' || selectedTable === 'OSCerradas' || selectedTable === 'consultas_servicios')
¬†                          ? ['OS Pendientes', 'OSCerradas']
¬†                          : [];

¬†   for (const tabla of tablasBusqueda) {
¬†       if (!relacionadasPorTabla[tabla]) relacionadasPorTabla[tabla] = [];
¬†
¬†       for (const criterio of criteriosBusqueda) {
¬†           const campoEquivalente = encontrarCampoEquivalente(criterio.campo, tableConfigs[tabla]);
¬†           if (!campoEquivalente) continue;
¬†
¬†           const { data, error } = await supabaseClient
¬†               .from(tabla)
¬†               .select('*')
¬†               .eq(campoEquivalente, criterio.valor);
¬†
¬†           if (error || !data) continue;
¬†
¬†           data.forEach(item => {
¬†               const itemOS = item.OSATMO || item.OSSAP || item.OSATOMO;
¬†               const esMismaOS = (selectedTable === tabla && itemOS === osNumero);
¬†
¬†               if (itemOS && !esMismaOS) {
¬†                   const claveUnica = `${tabla}-${itemOS}-${item.CuentaContrato}-${item.Medidor}`;
¬†                   const existe = relacionadasPorTabla[tabla].find(r => {
¬†                       const rOS = r.OSATMO || r.OSSAP || r.OSATOMO;
¬†                       return `${tabla}-${rOS}-${r.CuentaContrato}-${r.Medidor}` === claveUnica;
¬†                   });
¬†
¬†                   if (!existe) {
¬†                       relacionadasPorTabla[tabla].push({...item, criterioRelacion: criterio.campo, tablaOrigen: tabla});
¬†                   }
¬†               }
¬†           });
¬†       }
¬†   }
¬†
¬†   ocultarIndicadorBusqueda();
¬†   return Object.keys(relacionadasPorTabla).length > 0 ? relacionadasPorTabla : null;
}

// ===================================================================
// üìã MOSTRAR RESULTADOS RELACIONADOS
// ===================================================================

function mostrarResultadosRelacionados(relacionadasPorTabla, datosOriginales) {
¬†   if (!relacionadasPorTabla || Object.keys(relacionadasPorTabla).length === 0) return;
¬†
¬†   window.resultadosRelacionados = relacionadasPorTabla;
¬†   const container = document.getElementById('searchResults');
¬†
¬†   const osOriginal = datosOriginales.OSATMO || datosOriginales.OSSAP || datosOriginales.OSATOMO || 'N/A';
¬†   const clienteOriginal = datosOriginales.NombreCliente || 'N/A';
¬†   const cuentaOriginal = datosOriginales.CuentaContrato || 'N/A';
¬†   const medidorOriginal = datosOriginales.Medidor || 'N/A';

¬†   let html = `
¬†       <div class="result-card" style="background: #fff3cd; border: 2px solid #ffc107; margin-top: 15px;">
¬†           <div class="result-header">üîó Informaci√≥n Relacionada Encontrada</div>
¬†           <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #ffc107;">
¬†               <strong>Relacionado con:</strong><br>
¬†               üìã OS: ${osOriginal}<br>
¬†               üë§ Cliente: ${clienteOriginal}<br>
¬†               üìÑ Cuenta: ${cuentaOriginal}<br>
¬†               ‚ö° Medidor: ${medidorOriginal}
¬†           </div>
¬†           <p>Se encontr√≥ informaci√≥n adicional. Haz clic para ver detalles:</p>
¬†           <div class="action-buttons">`;
¬†
¬†   for (const [tabla, datos] of Object.entries(relacionadasPorTabla)) {
¬†       const config = tableConfigs[tabla];
¬†       const icono = config ? config.icon : 'üìã';
¬†       html += `<button class="btn btn-secondary" onclick="mostrarDetalleRelacionados('${tabla}')">
¬†                   ${icono} Ver ${config.title} (${datos.length})
¬†                </button>`;
¬†   }
¬†
¬†   html += `</div></div>`;
¬†   container.innerHTML += html;
}

// ===================================================================
// üìÑ MOSTRAR DETALLE DE RESULTADOS RELACIONADOS
// ===================================================================

function mostrarDetalleRelacionados(tabla) {
¬† if (!window.resultadosRelacionados || !window.resultadosRelacionados[tabla]) {
¬†   alert('No hay datos disponibles');
¬†   return;
¬† }

¬† const datos = window.resultadosRelacionados[tabla];
¬† const config = tableConfigs[tabla];
¬† const container = document.getElementById('searchResults');

¬† // Guardar estado original
¬† window.contenidoOriginalBusqueda = container.innerHTML;

¬† let html = `
¬†   <div class="result-card" style="background: #e3f2fd; border: 2px solid #2196f3;">
¬†     <div class="result-header">üìã ${config.title} - Informaci√≥n Relacionada</div>
¬†     <div style="margin-bottom: 15px; text-align: center;">
¬†       <button class="btn btn-back" onclick="restaurarResultadosOriginales()">
¬†         ‚Üê Volver a Resultados Principales
¬†       </button>
¬†     </div>
¬†   </div>`;

¬† const selectedTableOriginal = selectedTable;
¬† selectedTable = tabla;

¬† datos.forEach((item, index) => {
¬†   html += `<div class="result-card"><div class="result-header">Resultado ${index + 1}</div>`;

¬†   config.resultFields.forEach(field => {
¬†     // üö´ Ocultar NombreCliente solo en consultas_servicios para roles no autorizados
¬†     if (
¬†       field === 'NombreCliente' &&
¬†       tabla === 'consultas_servicios' &&
¬†       !ROLES_CON_ACCESO_TOTAL_NOMBRE.includes(currentUser.rol)
¬†     ) {
¬†       return; // No mostrar este campo
¬†     }

¬†     let valor = String(item[field] || 'N/A');

¬†     if ((field === 'Comentario' || field === 'ComentarioGeneral') && valor !== 'N/A') {
¬†       valor = formatearComentario(valor);
¬†       html += `<div class="result-item"><strong>${field}:</strong><div style="margin-left: 10px; line-height: 1.6;">${valor}</div></div>`;
¬†     } else {
¬†       html += `<div class="result-item"><strong>${field}:</strong> ${valor}</div>`;
¬†     }
¬†   });

¬†   html += '<div class="action-buttons">';
¬†   config.actions.forEach(action => {
¬†     const val = item[action];
¬†     if (!val) return;

¬†     if (action.toLowerCase().includes('coordenadas')) {
¬†       html += `<button class="btn btn-secondary" onclick="abrirCoordenadas('${val}')">üìç Coordenadas</button>`;
¬†     } else if (action === 'FotoLink' || action === 'fotolink') {
¬†       html += `<button class="btn btn-secondary" onclick="verFoto('${val}')">üì∏ Ver Foto</button>`;
¬†     }
¬†   });
¬†   html += '</div></div>';
¬† });

¬† selectedTable = selectedTableOriginal;
¬† container.innerHTML = html;
}



// ===================================================================
// üìå MOSTRAR BOTONES DE RESULTADOS ADICIONALES
// ===================================================================

function mostrarBotonesResultadosAdicionales(resultadosAdicionales) {
¬†   const container = document.getElementById('searchResults');
¬†   let html = `
¬†       <div class="result-card" style="background: #f0fff4; border: 2px solid #22c55e;">
¬†           <div class="result-header">‚úÖ Informaci√≥n adicional encontrada</div>
¬†           <p>Se encontr√≥ informaci√≥n relacionada:</p>
¬†           <div class="action-buttons">`;
¬†
¬†   for (const [tabla, datos] of Object.entries(resultadosAdicionales)) {
¬†       const config = tableConfigs[tabla];
¬†       const icono = config ? config.icon : 'üìã';
¬†       html += `<button class="btn btn-secondary" onclick="mostrarDetalleRelacionados('${tabla}')">
¬†                   ${icono} Ver ${config.title} (${datos.length})
¬†                </button>`;
¬†   }
¬†
¬†   html += `</div></div>`;
¬†   container.innerHTML += html;
¬†   window.resultadosRelacionados = resultadosAdicionales;
}

// ===================================================================
// üîß FUNCIONES AUXILIARES
// ===================================================================

function restaurarResultadosOriginales() {
¬†   const container = document.getElementById('searchResults');
¬†   container.innerHTML = window.contenidoOriginalBusqueda || '<div class="result-card">Realice una nueva b√∫squeda</div>';
¬†   delete window.contenidoOriginalBusqueda;
}

function mostrarIndicadorBusqueda() {
¬†   const container = document.getElementById('searchResults');
¬†   container.innerHTML += `
¬†       <div id="indicadorBusqueda" class="result-card" style="background: #f0f9ff; border: 2px solid #3b54d3; text-align: center;">
¬†           <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
¬†               <div class="loading" style="display: block;"></div>
¬†               <span>Buscando informaci√≥n relacionada...</span>
¬†           </div>
¬†       </div>`;
}

function ocultarIndicadorBusqueda() {
¬†   const indicador = document.getElementById('indicadorBusqueda');
¬†   if (indicador) indicador.remove();
}

function encontrarCampoEquivalente(campoOriginal, configTabla) {
¬†   const mapaCampos = {
¬†       'CuentaContrato': ['CuentaContrato'],
¬†       'Medidor': ['Medidor'],
¬†       'NombreCliente': ['NombreCliente'],
¬†       'OSATMO': ['OSATMO', 'OSATOMO'],
¬†       'OSSAP': ['OSSAP']
¬†   };
¬†
¬†   const posiblesCampos = mapaCampos[campoOriginal] || [campoOriginal];
¬†
¬†   for (const field of configTabla.fields) {
¬†       if (posiblesCampos.includes(field.key)) {
¬†           return field.key;
¬†       }
¬†   }
¬†   return null;
}

function tieneCoordenadasValidas(resultados) {
¬†   return resultados.some(item => {
¬†       const coordenadas = item.Coordenadas || item.coordenadas || item.Coordenadasgis || item.coordenadasgis;
¬†       return coordenadas && coordenadas.includes(',');
¬†   });
}

function abrirCoordenadas(coordenadas) {
¬†   if (coordenadas) window.open(`https://www.google.com/maps?q=${coordenadas}`, '_blank');
}

function verFoto(link) {
¬†   if (link) window.open(link, '_blank');
}

async function capturarCoordenadasGPS() {
¬†   if (!navigator.geolocation || !currentUser) return;
¬†   try {
¬†       const posicion = await new Promise((resolve, reject) => {
¬†           const timeoutId = setTimeout(() => reject(new Error("Timeout")), 2000);
¬†           navigator.geolocation.getCurrentPosition(
¬†               pos => { clearTimeout(timeoutId); resolve(pos); },
¬†               error => { clearTimeout(timeoutId); reject(error); },
¬†               { enableHighAccuracy: false, timeout: 1500, maximumAge: 600000 }
¬†           );
¬†       });
¬†       const coordenadas = `${posicion.coords.latitude},${posicion.coords.longitude}`;
¬†       await supabaseClient.from("usuarios").update({
¬†           coordenadas,
¬†           ultimaconexion: formatearFechaCompletaElSalvador(getFechaElSalvador())
¬†       }).eq("id", currentUser.id);
¬†   } catch (error) {
¬†       if (currentUser) {
¬†           await supabaseClient.from("usuarios").update({
¬†               ultimaconexion: formatearFechaCompletaElSalvador(getFechaElSalvador())
¬†           }).eq("id", currentUser.id);
¬†       }
¬†   }
}

function volverAResultadosPrincipales(tablaAnterior) {
¬†   // Redirigir a la nueva funci√≥n que conserva los resultados
¬†   restaurarResultadosOriginales();
}


¬†function abrirCoordenadas(coordenadas) {
¬†     if (coordenadas) window.open(`https://www.google.com/maps?q=${coordenadas}`, '_blank');
¬†   }



function verFoto(link) {
¬†   if (link) window.open(link, '_blank');
}




// === FUNCI√ìN PARA GUARDAR DATOS OFFLINE ===
function guardarDatosOffline() {
    if (currentUser) {
        // Nos aseguramos de que el token est√© presente en el objeto antes de guardar
        console.log("üíæ Guardando sesi√≥n persistente para:", currentUser.usuario);
        
        sessionStorage.setItem('cleca_user_session', JSON.stringify({
            user: currentUser,
            timestamp: Date.now()
        }));
    }
}


function verificarDatosOffline() {
    const sessionData = localStorage.getItem('cleca_user_session') || sessionStorage.getItem('cleca_user_session');
    
    if (sessionData) {
        const data = JSON.parse(sessionData);
        const tiempoTranscurrido = (Date.now() - (data.timestamp || Date.now())) / 1000 / 60;

        if (tiempoTranscurrido < 45) {
            currentUser = data.user;
            
            const loginSection = document.getElementById('loginSection');
            if (loginSection) loginSection.style.display = 'none';

            const userInfo = document.getElementById('userInfo');
            if (userInfo) userInfo.classList.remove('hidden');
            document.getElementById('currentUser').textContent = `Bienvenido, ${currentUser.usuario}`;

            iniciarVerificacionSesion();

            // üõ°Ô∏è BLOQUE PARA ROL ATTF - DETENER FLUJO PRINCIPAL
            if (currentUser.rol === 'ATTF') {
                console.log('üîÑ Restaurando sesi√≥n ATTF - Delegando a loginATTF...');
                loginATTF(currentUser);
                return true; // ‚úÖ DETENER AQU√ç - No continuar con el flujo principal
            }

            // --- FLUJO PARA OTROS ROLES ---
            const menuTablas = document.getElementById('tableSelectionSection');
            if (menuTablas) menuTablas.style.display = 'block';
            mostrarTablasSegunRol();
            return true;
        }
    }
    return false;
}


/**
 * CONFIGURACI√ìN MAESTRA DE ACCESOS
 * Define qu√© roles pueden entrar a qu√© m√≥dulos.
 */
const PERMISOS_MODULOS = {
    'cargar_asignaciones': ['Administrador', 'Despacho'],
    'mapa_rutas':          ['Administrador', 'Despacho'],
    'usuarios':            ['Administrador'],
    'detalle_os':          ['Administrador', 'Supervisor'],
    'retiro_medidores':    ['Administrador', 'Supervisor', 'Bodega', 'ATTF', 'Contratista', 'Consulta'],
    'kml_ruta':            ['Administrador', 'Contratista', 'Despacho', 'Supervisor', 'Consulta'], 
    'OS Pendientes':       ['Administrador', 'Despacho', 'Supervisor', 'Contratista', 'Consulta'],
    'OSCerradas':          ['Administrador', 'Despacho', 'Supervisor', 'Contratista', 'Consulta'],
    'consultas_servicios': ['Administrador', 'Supervisor', 'Bodega', 'ATTF', 'Contratista', 'Consulta', 'Lectura', 'Poda'],
    'TX y Cortes':         ['Administrador', 'Supervisor', 'Bodega', 'ATTF', 'Contratista', 'Consulta', 'Poda']  // ‚úÖ Corregido
};


/**
 * Selecciona y valida el acceso a las tablas/m√≥dulos
 * Versi√≥n Corregida: Evita bucle infinito + Bloquea acceso durante configuraci√≥n + Verificaci√≥n robusta de contenedores
 */
function seleccionarTabla(tableName, retryCount = 0) {
    // ‚úÖ VALIDACI√ìN DE PERMISOS POR ROL (UNA SOLA VEZ)
    const rolActual = currentUser?.rol || 'Invitado';
    const permisosModulo = PERMISOS_MODULOS[tableName];
    
    // ‚úÖ BLOQUEO EXPL√çCITO PARA mapa_rutas
    if (tableName === 'mapa_rutas' && 
        !['Administrador', 'Despacho'].includes(rolActual)) {
        alert('‚õî ACCESO DENEGADO\n\nEl m√≥dulo "Mapa de Rutas" solo est√° disponible para:\n‚Ä¢ Administrador\n‚Ä¢ Despacho');
        return;
    }
    
    // ‚úÖ VALIDACI√ìN GEN√âRICA DE PERMISOS
    if (permisosModulo && !permisosModulo.includes(rolActual)) {
        alert(`‚õî ACCESO DENEGADO\n\nTu rol "${rolActual}" no tiene permisos para este m√≥dulo.`);
        return;
    }
    
    // ‚úÖ BLOQUEO CR√çTICO 1: Verificar existencia del contenedor de configuraci√≥n
    const configContainer = document.getElementById('configuracionInicialATTF');
    if (currentUser?.rol === 'ATTF' && !configContainer) {
        console.error('‚ùå CONTENEDOR CR√çTICO NO ENCONTRADO: #configuracionInicialATTF');
        alert('‚ö†Ô∏è Error de interfaz: Falta el contenedor de configuraci√≥n. Contacte al administrador.');
        return;
    }

    // ‚úÖ BLOQUEO CR√çTICO 2: Si est√° en configuraci√≥n de turnos (ATTF), BLOQUEAR acceso
    if (currentUser?.rol === 'ATTF' && configContainer) {
        const esVisible = configContainer.style.display !== 'none' && 
                         configContainer.style.display !== '' &&
                         configContainer.offsetHeight > 0;
        
        if (esVisible) {
            console.warn('‚ö†Ô∏è ACCESO BLOQUEADO: Configuraci√≥n de turnos activa');
            alert('‚ö†Ô∏è Debe completar la configuraci√≥n de turnos antes de acceder a los m√≥dulos.');
            return;
        }
    }

    // ‚úÖ BLOQUEO CR√çTICO 3: Verificar existencia de searchGrid
    const searchGrid = document.getElementById('searchGrid');
    if (!searchGrid) {
        if (retryCount < 10) {
            console.warn(`‚ö†Ô∏è searchGrid no est√° listo (intento ${retryCount + 1}/10), reintentando...`);
            setTimeout(() => seleccionarTabla(tableName, retryCount + 1), 100);
            return;
        } else {
            const searchSection = document.getElementById('searchSection');
            if (searchSection && searchSection.innerHTML.trim() === '') {
                console.error('‚ùå searchSection est√° vac√≠o. Posible destrucci√≥n por fallback de configuraci√≥n.');
                alert('‚ùå Error cr√≠tico: Interfaz da√±ada. Recargue la p√°gina o contacte al administrador.');
            } else {
                console.error('‚ùå searchGrid no disponible despu√©s de 10 intentos');
                alert('Error: La interfaz no est√° lista. Complete la configuraci√≥n de turnos o recargue la p√°gina.');
            }
            return;
        }
    }

    // ‚úÖ FLUJO NORMAL: Continuar con validaciones y carga
    renovarSesion();
    
    // ‚úÖ Usar la variable ya declarada (NO volver a declarar con const)
    console.log(`üîç Intento de acceso a: ${tableName} por usuario: ${currentUser?.usuario} (Rol: ${rolActual})`);

    // 2. EJECUCIONES ESPECIALES SEG√öN M√ìDULO
    switch (tableName) {
        case 'cargar_asignaciones':
            const tableSel = document.getElementById('tableSelectionSection');
            const searchSec = document.getElementById('searchSection');
            if (tableSel) tableSel.style.display = 'none';
            if (searchSec) {
                searchSec.style.display = 'block';
                searchSec.classList.remove('hidden');
            }
            if (searchGrid) searchGrid.innerHTML = '';
            cargarInterfazAsignaciones();
            return;
        case 'mapa_rutas':
            console.log("üìç Inicializando Mapa de Rutas...");
            break;
    }

    // 3. ACTUALIZAR INTERFAZ VISUAL
    const config = tableConfigs[tableName];
    if (!config) {
        console.error("‚ùå Configuraci√≥n no encontrada para:", tableName);
        alert("Error: M√≥dulo sin configuraci√≥n visual. Contacte al administrador.");
        return;
    }

    selectedTable = tableName;
    
    // Actualizar t√≠tulo
    const searchTitle = document.getElementById('searchTitle');
    if (searchTitle) {
        searchTitle.innerHTML = `${config.icon} ${config.title}`;
    }

    // ‚úÖ GENERAR CAMPOS
    generarCamposBusqueda(config);

    // Mostrar secci√≥n de b√∫squeda y ocultar men√∫
    const tableSelection = document.getElementById('tableSelectionSection');
    const searchSection = document.getElementById('searchSection');
    
    if (tableSelection) tableSelection.style.display = 'none';
    if (searchSection) {
        searchSection.style.display = 'block';
        searchSection.classList.remove('hidden');
        console.log('‚úÖ searchSection visible y activo');
    }
}



function getCoordsCompat(os, legacyMode = false) {
    if (legacyMode) {
        // Comportamiento antiguo para c√≥digo heredado
       const coords = extraerCoordenadas(os);
        if (!coordsStr || !coordsStr.includes(',')) return null;
        const [lat, lng] = coordsStr.split(',').map(c => parseFloat(c.trim()));
        return isNaN(lat) || isNaN(lng) ? null : { lat, lng };
    }
    // Nuevo comportamiento con prioridad de campos
    return extraerCoordenadas(os); // ‚Üê Nota: usa extraerCoordenadas (ya existe en tu c√≥digo)
}

// Alias para mantener compatibilidad con llamadas existentes
window.getCoordsCompat = getCoordsCompat;



// ==========================================================
// üöÄ INICIALIZACI√ìN Y EVENTOS
// ==========================================================
document.addEventListener('DOMContentLoaded', function() {

    console.log('üöÄ Sistema de Consultas Campo Inicializado');

    // Validaci√≥n de sesi√≥n
    if (!verificarDatosOffline()) {
        const loginSec = document.getElementById('loginSection');
        if (loginSec) loginSec.style.display = 'block';
    }

    // Conector del bot√≥n de Login
    const loginButton = document.getElementById('loginButton');
    if (loginButton) {
        loginButton.addEventListener('click', (e) => {
            e.preventDefault();
            login();
        });
    }
});


// ========================================
// üßπ LIMPIAR FILTROS OBSOLETOS (Autom√°tico silencioso)
// ========================================
async function limpiarFiltrosObsoletos() {
    try {
        // ‚úÖ Usar funci√≥n del sistema para consistencia de zona horaria
        const fechaLimite = new Date(Date.now() - 2 * 24 * 60 * 60 * 1000);
        const fechaLimiteStr = formatearFechaElSalvador(fechaLimite);

        // ‚úÖ SELECT consistente: excluir NULLs y obtener count
        const { data: filtrosViejos, count: countSelect, error: errorSelect } = await supabaseClient
            .from('filtros_por_unidad')
            .select('id', { count: 'exact' })
            .not('fecha_programada', 'is', null)
            .lt('fecha_programada', fechaLimiteStr);

        if (errorSelect) {
            console.error('‚ùå Error buscando filtros obsoletos:', errorSelect);
            return;
        }

        if (!filtrosViejos || filtrosViejos.length === 0) {
            console.log('‚úÖ No hay filtros obsoletos para eliminar');
            return;
        }

        // ‚úÖ DELETE con count real de eliminados
        const { count: eliminados, error: errorDelete } = await supabaseClient
            .from('filtros_por_unidad')
            .delete()
            .not('fecha_programada', 'is', null)
            .lt('fecha_programada', fechaLimiteStr)
            .select('id', { count: 'exact', head: true });

        if (errorDelete) {
            console.error('‚ùå Error eliminando filtros:', errorDelete);
            return;
        }

        console.log(`üóëÔ∏è ${eliminados || filtrosViejos.length} filtro(s) obsoleto(s) eliminado(s)`);

    } catch (err) {
        console.error('‚ùå Error en limpieza autom√°tica de filtros:', err);
    }
}



// ========================================
// üóëÔ∏è LIMPIAR FILTROS OBSOLETOS (Con confirmaci√≥n)
// ========================================
async function limpiarFiltrosObsoletosConConfirmacion() {
    try {
        const fechaLimiteStr = formatearFechaElSalvador(
    new Date(Date.now() - 2 * 24 * 60 * 60 * 1000)
);

// ... [inicio igual] ...

        // ‚úÖ SELECT consistente con NULL check
        const { data: filtrosViejos, error } = await supabaseClient
            .from('filtros_por_unidad')
            .select('id, Unidad, fecha_programada')
            .not('fecha_programada', 'is', null)  // ‚Üê Agregar para consistencia
            .lt('fecha_programada', fechaLimiteStr);

        if (error) {
            console.error('‚ùå Error buscando filtros viejos:', error);
            alert('‚ùå Error al buscar filtros obsoletos');
            return;
        }

        if (!filtrosViejos || filtrosViejos.length === 0) {
            alert('‚úÖ No hay filtros obsoletos para eliminar');
            return;
        }

        // ‚úÖ Reduce con validaci√≥n de null
        const resumen = filtrosViejos.reduce((acc, filtro) => {
            const fecha = filtro.fecha_programada;
            if (!fecha) return acc;  // ‚Üê Saltar si es null
            if (!acc[fecha]) acc[fecha] = { unidades: [], cantidad: 0 };
            acc[fecha].unidades.push(filtro.Unidad);
            acc[fecha].cantidad++;
            return acc;
        }, {});

        // ‚úÖ Limitar mensaje si hay muchos registros
        const mostrarHasta = Math.min(filtrosViejos.length, 30);
        let mensaje = `üóëÔ∏è LIMPIEZA DE FILTROS OBSOLETOS\n\n`;
        mensaje += `Se encontraron ${filtrosViejos.length} filtros anteriores a ${fechaLimiteStr}:\n\n`;

        Object.entries(resumen).slice(0, mostrarHasta).forEach(([fecha, data]) => {
            mensaje += `üìÖ ${fecha}: ${data.cantidad} filtro(s)\n`;
            const unidadesMostrar = data.unidades.slice(0, 5);
            mensaje += `   ‚Üí ${unidadesMostrar.join(', ')}${data.unidades.length > 5 ? `... (+${data.unidades.length - 5} m√°s)` : ''}\n`;
        });

        if (filtrosViejos.length > mostrarHasta) {
            mensaje += `\n‚ö†Ô∏è Mostrando solo ${mostrarHasta} de ${filtrosViejos.length} registros\n`;
        }

        mensaje += `\n‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER\n`;
        mensaje += `¬øDeseas eliminar estos ${filtrosViejos.length} registros?`;

        if (!confirm(mensaje)) return;

        // ‚úÖ DELETE con count verificado
        const { count: eliminados, error: errorDelete } = await supabaseClient
            .from('filtros_por_unidad')
            .delete()
            .not('fecha_programada', 'is', null)
            .lt('fecha_programada', fechaLimiteStr)
            .select('id', { count: 'exact', head: true });

        if (errorDelete) {
            throw errorDelete;
        }

        alert(`‚úÖ ${eliminados || filtrosViejos.length} filtro(s) eliminado(s) correctamente`);

// ... [resto igual] ...



    } catch (err) {
        console.error('‚ùå Error en limpieza de filtros:', err);
        alert('‚ùå Error al procesar la eliminaci√≥n');
    }
}

// Exponer funciones al scope global para eventos HTML
window.guardarConfiguracionDescanso = guardarConfiguracionDescanso;
window.mostrarConfiguracionDescansoCiclo = mostrarConfiguracionDescansoCiclo;
window.calcularFinDescansoCiclo = calcularFinDescansoCiclo;
window.guardarDescansoCiclo = guardarDescansoCiclo;
window.formatDate = formatDate;

// ========================================
// üß™ BLOQUE DE PRUEBA (SOLO PARA VALIDACI√ìN)
// ========================================
// ‚ö†Ô∏è Eliminar este bloque en producci√≥n o envolver en condici√≥n de debug
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    console.log('üß™ Validando funciones de coordenadas...');
    // Pegar en consola para validar la prioridad
const osPrueba = {
    OSATMO: 'TEST-001',
    Coordenadas: '14.0000,-90.0000',      // Deber√≠a ignorarse
    Coordendasgis: '13.6488,-89.9183',    // Deber√≠a usarse (prioridad 1)
    Latitud: '13.6400',
    Longitud: '-89.9100'
};

const resultado = extraerCoordenadas(osPrueba);
console.log('‚úÖ Resultado:', resultado);
// Esperado: { latitud: 13.6488, longitud: -89.9183, campoOrigen: 'Coordendasgis', ... }

    console.log('üîπ Modo legacy:', getCoordsCompat(osPrueba, true));
    console.log('üîπ Modo nuevo:', getCoordsCompat(osPrueba, false));
    console.log('‚úÖ Funciones de coordenadas cargadas correctamente');
}

// üß™ DIAGN√ìSTICO: Ejecutar en consola despu√©s del error
function diagnosticarMapa() {
    console.log('üîç === DIAGN√ìSTICO DE MAPA ===');
    console.log('1. #mapaLeaflet existe:', !!document.getElementById('mapaLeaflet'));
    
    const div = document.getElementById('mapaLeaflet');
    if (div) {
        const style = window.getComputedStyle(div);
        console.log('2. Dimensiones:', div.offsetWidth, 'x', div.offsetHeight);
        console.log('3. Display:', style.display, '| Visibility:', style.visibility);
        console.log('4. Parent visible:', div.offsetParent !== null);
    }
    
    console.log('5. Leaflet cargado:', typeof L !== 'undefined');
    if (typeof L !== 'undefined') {
        console.log('6. Versi√≥n Leaflet:', L.version);
    }
    
    console.log('7. window.mapaLeafletInstance:', window.mapaLeafletInstance);
    console.log('==============================');
}

function diagnosticarComentarios() {
    console.group('üîç DIAGN√ìSTICO COMENTARIOS');
    
    // 1. Verificar Map de comentarios
    console.log('1. comentariosPorMedidor size:', window.comentariosPorMedidor?.size || 'No definido');
    
    // 2. Verificar OS con medidor
    const osConMedidor = window.datosMapaExportar?.filter(os => os.Medidor)?.length || 0;
    console.log(`2. OS con medidor: ${osConMedidor}`);
    
    // 3. Probar b√∫squeda manual
    const osPrueba = window.datosMapaExportar?.find(o => o.OSATMO === '11126031');
    if (osPrueba?.Medidor) {
        const key = String(osPrueba.Medidor).trim().toUpperCase();
        const encontrado = window.comentariosPorMedidor?.get(key);
        console.log('3. B√∫squeda manual:', {
            medidor: osPrueba.Medidor,
            key: key,
            encontrado: !!encontrado,
            comentario: encontrado?.ComentarioGeneral?.substring(0, 50)
        });
    }
    
    // 4. Verificar funci√≥n mostrarDetalleOSEnPanel
    console.log('4. Funci√≥n disponible:', typeof mostrarDetalleOSEnPanel === 'function' ? '‚úÖ' : '‚ùå');
    
    console.groupEnd();
}



</script>
</body>
</html>
